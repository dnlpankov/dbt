[0m22:56:07.621998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73E4F9AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABDC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABC70>]}


============================== 22:56:07.739088 | e658d13a-3aea-45ae-96c8-380c5b933b1f ==============================
[0m22:56:07.739088 [info ] [MainThread]: Running with dbt=1.7.11
[0m22:56:07.760077 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'indirect_selection': 'eager', 'introspect': 'True', 'warn_error': 'None', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_cache_events': 'False', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'quiet': 'False', 'write_json': 'True', 'use_colors': 'True', 'invocation_command': 'dbt init', 'fail_fast': 'False', 'cache_selected_only': 'False', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'log_format': 'default', 'debug': 'False', 'partial_parse': 'True', 'target_path': 'None'}
[0m22:56:07.774041 [warn ] [MainThread]: [ConfigFolderDirectory]: Unable to parse dict {'dir': WindowsPath('C:/Users/Danila/.dbt')}
[0m22:56:07.774997 [info ] [MainThread]: Creating dbt configuration folder at 
[0m22:56:51.233243 [debug] [MainThread]: Starter project path: D:\Users\Danila\anaconda3\envs\dbt_env\lib\site-packages\dbt\include\starter_project
[0m22:56:51.541752 [info ] [MainThread]: 
Your new dbt project "campaign_performance" was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don't hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!

[0m22:56:51.542948 [info ] [MainThread]: Setting up your profile.
[0m23:05:35.210962 [info ] [MainThread]: Profile campaign_performance written to C:\Users\Danila\.dbt\profiles.yml using target's profile_template.yml and your supplied values. Run 'dbt debug' to validate the connection.
[0m23:05:35.626903 [debug] [MainThread]: Command `dbt init` succeeded at 23:05:35.258368 after 567.86 seconds
[0m23:05:35.672312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73E4F9AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABCD0>]}
[0m23:05:35.708216 [debug] [MainThread]: Flushing usage events
[0m23:15:15.432463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D63469D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C820>]}


============================== 23:15:15.573512 | 61319262-bf15-452b-a2d5-9e67fe184b2b ==============================
[0m23:15:15.573512 [info ] [MainThread]: Running with dbt=1.7.11
[0m23:15:15.604971 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'log_format': 'default', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'printer_width': '80', 'warn_error': 'None', 'indirect_selection': 'eager', 'static_parser': 'True', 'invocation_command': 'dbt test', 'quiet': 'False', 'fail_fast': 'False'}
[0m23:15:15.631123 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m23:15:15.683477 [debug] [MainThread]: Command `dbt test` failed at 23:15:15.634122 after 0.40 seconds
[0m23:15:15.684472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D63469D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2CD60>]}
[0m23:15:15.688463 [debug] [MainThread]: Flushing usage events
[0m01:12:41.668518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA6DF6AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA5F9A0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DDA00>]}


============================== 01:12:41.786091 | 1d747f0f-2e9f-4533-b232-cb7d88e2ca7d ==============================
[0m01:12:41.786091 [info ] [MainThread]: Running with dbt=1.7.11
[0m01:12:41.806607 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'debug': 'False', 'static_parser': 'True', 'indirect_selection': 'eager', 'introspect': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'cache_selected_only': 'False', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'no_print': 'None', 'printer_width': '80', 'quiet': 'False', 'fail_fast': 'False', 'log_path': 'logs'}
[0m01:12:41.808604 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m01:12:41.829961 [debug] [MainThread]: Command `dbt run` failed at 01:12:41.810604 after 0.31 seconds
[0m01:12:41.830960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA6DF6AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DD490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DD5E0>]}
[0m01:12:41.831958 [debug] [MainThread]: Flushing usage events
[0m01:13:05.616119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418E031A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241904667F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D9A0>]}


============================== 01:13:05.619147 | ced84743-8c0c-4886-a8f2-13495d16fd33 ==============================
[0m01:13:05.619147 [info ] [MainThread]: Running with dbt=1.7.11
[0m01:13:05.621104 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'target_path': 'None', 'log_cache_events': 'False', 'warn_error': 'None', 'log_format': 'default', 'fail_fast': 'False', 'log_path': 'logs', 'write_json': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'partial_parse': 'True', 'debug': 'False', 'no_print': 'None', 'quiet': 'False', 'use_experimental_parser': 'False', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'invocation_command': 'dbt run', 'printer_width': '80', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'use_colors': 'True'}
[0m01:13:05.784488 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m01:13:05.792792 [debug] [MainThread]: Command `dbt run` failed at 01:13:05.791806 after 0.26 seconds
[0m01:13:05.795750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418E031A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D190>]}
[0m01:13:05.798743 [debug] [MainThread]: Flushing usage events
[0m20:37:40.807979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10700b4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f8b150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070829d0>]}


============================== 20:37:40.809549 | 74a2d401-2971-489f-a9b4-4b18099f6724 ==============================
[0m20:37:40.809549 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:37:40.809876 [debug] [MainThread]: running dbt with arguments {'log_path': '/Users/danila/github/dbt/logs', 'fail_fast': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'use_experimental_parser': 'False', 'version_check': 'True', 'log_format': 'default', 'introspect': 'True', 'quiet': 'False', 'printer_width': '80', 'profiles_dir': '/Users/danila/.dbt', 'target_path': 'None', 'cache_selected_only': 'False', 'use_colors': 'True', 'debug': 'False', 'invocation_command': 'dbt build --select staging', 'log_cache_events': 'False', 'warn_error': 'None'}
[0m20:37:40.875373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10749b150>]}
[0m20:37:40.905313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10756b150>]}
[0m20:37:40.906503 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:37:40.913060 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:37:40.913505 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:37:40.913730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073bb750>]}
[0m20:37:41.341418 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:37:41.469997 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 0.6839943, "process_user_time": 1.226842, "process_kernel_time": 0.099768, "process_mem_max_rss": "120864768", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:37:41.470666 [debug] [MainThread]: Command `dbt build` failed at 20:37:41.470533 after 0.68 seconds
[0m20:37:41.471047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107082fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107083010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107854ad0>]}
[0m20:37:41.471410 [debug] [MainThread]: Flushing usage events
[0m20:43:08.177390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092bfd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109336310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093369d0>]}


============================== 20:43:08.178802 | 91799ebb-b5dc-43ca-b0ba-e22b19d3b6db ==============================
[0m20:43:08.178802 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:43:08.179144 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'static_parser': 'True', 'write_json': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'quiet': 'False', 'introspect': 'True', 'printer_width': '80', 'log_path': '/Users/danila/github/dbt/logs', 'partial_parse': 'True', 'fail_fast': 'False', 'log_format': 'default', 'use_colors': 'True', 'no_print': 'None', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --exclude brand_performance', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager'}
[0m20:43:08.244244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109881e50>]}
[0m20:43:08.274072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10988ea10>]}
[0m20:43:08.274790 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:43:08.281528 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:43:08.281975 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:43:08.282212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109955f90>]}
[0m20:43:08.724774 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:43:08.726844 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 0.5712106, "process_user_time": 1.220016, "process_kernel_time": 0.09036, "process_mem_max_rss": "121208832", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:43:08.727095 [debug] [MainThread]: Command `dbt run` failed at 20:43:08.727037 after 0.57 seconds
[0m20:43:08.727267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109310710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104bb8d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b7c850>]}
[0m20:43:08.727431 [debug] [MainThread]: Flushing usage events
[0m20:43:33.301284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10708b750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070dd210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10708b4d0>]}


============================== 20:43:33.302511 | d4151df4-94fc-46da-8755-145677dc48d1 ==============================
[0m20:43:33.302511 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:43:33.302841 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'introspect': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_format': 'default', 'warn_error': 'None', 'no_print': 'None', 'log_path': '/Users/danila/github/dbt/logs', 'static_parser': 'True', 'target_path': 'None', 'profiles_dir': '/Users/danila/.dbt', 'quiet': 'False', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --exclude outclick_cost_int_new', 'use_colors': 'True', 'printer_width': '80', 'indirect_selection': 'eager', 'fail_fast': 'False', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m20:43:33.366621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10713cc90>]}
[0m20:43:33.397424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107129410>]}
[0m20:43:33.397772 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:43:33.404077 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:43:33.404471 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:43:33.404701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077227d0>]}
[0m20:43:33.847167 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:43:33.848060 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 0.56731486, "process_user_time": 1.238614, "process_kernel_time": 0.082752, "process_mem_max_rss": "120389632", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:43:33.848303 [debug] [MainThread]: Command `dbt run` failed at 20:43:33.848245 after 0.57 seconds
[0m20:43:33.848477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107102750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107103690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102a0df10>]}
[0m20:43:33.848639 [debug] [MainThread]: Flushing usage events
[0m21:05:08.604221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d79310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dc1b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dde050>]}


============================== 21:05:08.605774 | f8797290-d42b-461e-8997-9797d038224c ==============================
[0m21:05:08.605774 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:05:08.606157 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'quiet': 'False', 'log_cache_events': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'invocation_command': 'dbt debug', 'debug': 'False', 'profiles_dir': '/Users/danila/.dbt', 'warn_error': 'None', 'version_check': 'True', 'log_format': 'default', 'static_parser': 'True', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'printer_width': '80', 'target_path': 'None', 'introspect': 'True', 'use_colors': 'True'}
[0m21:05:08.606478 [info ] [MainThread]: dbt version: 1.7.0
[0m21:05:08.606650 [info ] [MainThread]: python version: 3.11.9
[0m21:05:08.606811 [info ] [MainThread]: python path: /opt/anaconda3/envs/dbt_env/bin/python
[0m21:05:08.606957 [info ] [MainThread]: os info: macOS-14.4.1-arm64-arm-64bit
[0m21:05:08.642948 [info ] [MainThread]: Using profiles dir at /Users/danila/.dbt
[0m21:05:08.643216 [info ] [MainThread]: Using profiles.yml file at /Users/danila/.dbt/profiles.yml
[0m21:05:08.643383 [info ] [MainThread]: Using dbt_project.yml file at /Users/danila/github/dbt/dbt_project.yml
[0m21:05:08.643671 [info ] [MainThread]: adapter type: postgres
[0m21:05:08.643821 [info ] [MainThread]: adapter version: 1.7.0
[0m21:05:08.670149 [info ] [MainThread]: Configuration:
[0m21:05:08.670400 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m21:05:08.670558 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m21:05:08.670699 [info ] [MainThread]: Required dependencies:
[0m21:05:08.670879 [debug] [MainThread]: Executing "git --help"
[0m21:05:08.679940 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m21:05:08.680379 [debug] [MainThread]: STDERR: "b''"
[0m21:05:08.680551 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m21:05:08.680725 [info ] [MainThread]: Connection:
[0m21:05:08.680938 [info ] [MainThread]:   host: pg10-deepanalysis-db-do-user-3167072-0.b.db.ondigitalocean.com
[0m21:05:08.681079 [info ] [MainThread]:   port: 25060
[0m21:05:08.681216 [info ] [MainThread]:   user: doadmin
[0m21:05:08.681348 [info ] [MainThread]:   database: deep-analysis-console
[0m21:05:08.681479 [info ] [MainThread]:   schema: danila
[0m21:05:08.681604 [info ] [MainThread]:   connect_timeout: 50
[0m21:05:08.681731 [info ] [MainThread]:   role: None
[0m21:05:08.681860 [info ] [MainThread]:   search_path: None
[0m21:05:08.681983 [info ] [MainThread]:   keepalives_idle: 0
[0m21:05:08.682110 [info ] [MainThread]:   sslmode: require
[0m21:05:08.682236 [info ] [MainThread]:   sslcert: None
[0m21:05:08.682358 [info ] [MainThread]:   sslkey: None
[0m21:05:08.682481 [info ] [MainThread]:   sslrootcert: None
[0m21:05:08.682611 [info ] [MainThread]:   application_name: dbt
[0m21:05:08.682739 [info ] [MainThread]:   retries: 1
[0m21:05:08.682982 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:05:08.685923 [debug] [MainThread]: Acquiring new postgres connection 'debug'
[0m21:05:08.686331 [debug] [MainThread]: Using postgres connection "debug"
[0m21:05:08.686475 [debug] [MainThread]: On debug: select 1 as id
[0m21:05:08.686619 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:05:09.042089 [debug] [MainThread]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:09.046221 [debug] [MainThread]: On debug: Close
[0m21:05:09.047496 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m21:05:09.048349 [info ] [MainThread]: [32mAll checks passed![0m
[0m21:05:09.053659 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 0.47188365, "process_user_time": 0.779006, "process_kernel_time": 0.096975, "process_mem_max_rss": "113885184", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:05:09.054804 [debug] [MainThread]: Command `dbt debug` succeeded at 21:05:09.054561 after 0.47 seconds
[0m21:05:09.055481 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m21:05:09.056107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dde450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ddedd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2a9cd0>]}
[0m21:05:09.056835 [debug] [MainThread]: Flushing usage events
[0m21:05:13.103676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fd2f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10704aa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10704b0d0>]}


============================== 21:05:13.104876 | 9502d61d-8651-4f47-b855-61586a21c6f4 ==============================
[0m21:05:13.104876 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:05:13.105194 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'quiet': 'False', 'static_parser': 'True', 'profiles_dir': '/Users/danila/.dbt', 'indirect_selection': 'eager', 'log_path': '/Users/danila/github/dbt/logs', 'use_experimental_parser': 'False', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'write_json': 'True', 'printer_width': '80', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None'}
[0m21:05:13.171646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a16fd0>]}
[0m21:05:13.202253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075a7b10>]}
[0m21:05:13.202618 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:05:13.209260 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:05:13.229881 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:05:13.230112 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:05:13.233031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070855d0>]}
[0m21:05:13.237978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076aff50>]}
[0m21:05:13.238175 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:05:13.238351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107679f50>]}
[0m21:05:13.239398 [info ] [MainThread]: 
[0m21:05:13.239749 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:05:13.240449 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:05:13.245030 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:05:13.245255 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:05:13.245399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:05:13.532952 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:05:13.537077 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:05:13.541580 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:05:13.550857 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:05:13.551450 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:05:13.551801 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:05:13.902939 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:05:13.903597 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:05:13.904013 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:05:13.954098 [debug] [ThreadPool]: SQL status: SELECT 12 in 0.0 seconds
[0m21:05:13.957157 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:05:14.000622 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:05:14.015699 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.016218 [debug] [MainThread]: On master: BEGIN
[0m21:05:14.016645 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:05:14.319516 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.321197 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.322787 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:05:14.369508 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:05:14.373087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107548790>]}
[0m21:05:14.373762 [debug] [MainThread]: On master: ROLLBACK
[0m21:05:14.411052 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.411939 [debug] [MainThread]: On master: BEGIN
[0m21:05:14.484236 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.485767 [debug] [MainThread]: On master: COMMIT
[0m21:05:14.487083 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.488068 [debug] [MainThread]: On master: COMMIT
[0m21:05:14.524909 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:05:14.525778 [debug] [MainThread]: On master: Close
[0m21:05:14.527755 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:05:14.528412 [info ] [MainThread]: 
[0m21:05:14.534188 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.534941 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:05:14.536147 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:05:14.536840 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.548044 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.549195 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:05:14.537192 => 21:05:14.548972
[0m21:05:14.549579 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.574432 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.575094 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.575318 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:05:14.575523 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:14.899486 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.901654 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.903416 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:05:34.033431 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:05:34.045437 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.046051 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:05:34.086598 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.092262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.092869 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:05:34.134447 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.161620 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:05:34.162137 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.162490 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:05:34.202536 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:34.211559 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:05:34.216666 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.217129 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:05:34.272162 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:34.274869 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:05:14.549787 => 21:05:34.274504
[0m21:05:34.275636 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:05:34.277472 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076b5ad0>]}
[0m21:05:34.278522 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.74s]
[0m21:05:34.279450 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:05:34.280090 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:05:34.280900 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:05:34.282006 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:05:34.282626 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:05:34.286302 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:05:34.287576 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:05:34.282935 => 21:05:34.287302
[0m21:05:34.287996 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:05:34.292368 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:05:34.293144 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.293482 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:05:34.293795 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:34.609327 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:34.611091 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.611929 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:05:34.660541 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:05:34.668372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.669142 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:05:34.702386 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.712024 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.712817 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:05:34.745545 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.750660 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:05:34.751413 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.752085 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:05:34.783891 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:34.788970 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:05:34.790556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.791279 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:05:34.839316 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:34.843698 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:05:34.288236 => 21:05:34.842967
[0m21:05:34.844757 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:05:34.846556 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078e86d0>]}
[0m21:05:34.847652 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.56s]
[0m21:05:34.848660 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:05:34.849355 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.850189 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:05:34.851238 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:05:34.851818 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.855809 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.857306 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:05:34.852198 => 21:05:34.856820
[0m21:05:34.857959 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.863239 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.864145 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.864552 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:05:34.864932 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:35.142747 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:35.144344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.145226 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:05:35.197438 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:05:35.206860 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.207544 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:05:35.241318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.246958 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.247618 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:05:35.281532 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.287134 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:05:35.287926 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.288633 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:05:35.322147 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:35.324413 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:05:35.325043 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.325306 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:05:35.376671 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:35.377880 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:05:34.858282 => 21:05:35.377708
[0m21:05:35.378212 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:05:35.378886 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078a4e90>]}
[0m21:05:35.379340 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.53s]
[0m21:05:35.379802 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:05:35.380136 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:05:35.380468 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m21:05:35.381040 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:05:35.381354 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:05:35.383789 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:05:35.384423 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:05:35.381538 => 21:05:35.384247
[0m21:05:35.384703 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:05:35.387498 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:05:35.387978 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.388220 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:05:35.388453 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:35.645112 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:35.646709 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.647537 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:05:35.688492 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:05:35.696420 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.697171 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:05:35.728537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.734528 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.735251 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:05:35.766504 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.770700 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:05:35.771493 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.772113 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:05:35.804349 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:35.810142 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:05:35.811481 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.812063 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:05:35.861062 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:35.865718 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:05:35.384873 => 21:05:35.864945
[0m21:05:35.866776 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:05:35.868170 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078468d0>]}
[0m21:05:35.869246 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.49s]
[0m21:05:35.870189 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:05:35.870805 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.871376 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:05:35.872448 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:05:35.872892 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.878453 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.879293 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:05:35.873136 => 21:05:35.879094
[0m21:05:35.879632 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.883432 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.884110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.884414 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:05:35.884674 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:36.141779 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:36.143685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.144960 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:05:36.179328 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:05:36.187092 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.187802 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:05:36.220198 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:36.223934 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:05:36.224596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.225152 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:05:36.255861 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:36.261108 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:05:36.262792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.263550 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:05:36.295535 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:36.300216 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:05:35.879835 => 21:05:36.299438
[0m21:05:36.300788 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:05:36.302265 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107561190>]}
[0m21:05:36.303212 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 2[0m in 0.43s]
[0m21:05:36.303963 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:05:36.304522 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.305068 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:05:36.306037 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:05:36.306695 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.312236 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.313255 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:05:36.307066 => 21:05:36.313006
[0m21:05:36.313679 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.317461 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.318142 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.318484 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:05:36.318799 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:36.578264 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:36.580398 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.582470 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:05:43.863902 [debug] [Thread-1 (]: SQL status: SELECT 142657 in 7.0 seconds
[0m21:05:43.871067 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.871729 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:05:43.903117 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:43.906960 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:05:43.907730 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.908366 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:05:43.939075 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:43.944921 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:05:43.946660 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.947414 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:05:43.979667 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:43.983038 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:05:36.313917 => 21:05:43.982614
[0m21:05:43.983834 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:05:43.985492 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10790ca90>]}
[0m21:05:43.986499 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142657[0m in 7.68s]
[0m21:05:43.987426 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:43.988106 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:43.988940 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:05:43.989880 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:05:43.990372 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:43.994432 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:43.995666 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:05:43.990683 => 21:05:43.995409
[0m21:05:43.996112 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:44.000734 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.001486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.001828 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:05:44.002145 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:44.300448 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:44.302530 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.303997 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:05:44.342924 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:44.349979 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.350817 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:05:44.387096 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:44.392584 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:05:44.393048 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.393450 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:05:44.429877 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:44.434623 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:05:44.440238 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.440826 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:05:44.477167 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:44.481634 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:05:43.996357 => 21:05:44.480892
[0m21:05:44.483007 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:05:44.484964 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10794bcd0>]}
[0m21:05:44.485842 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.50s]
[0m21:05:44.486547 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:44.487070 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.487663 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:05:44.488394 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:05:44.488805 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.491667 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.492593 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:05:44.489058 => 21:05:44.492377
[0m21:05:44.492934 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.496822 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.497495 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.497800 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:05:44.498100 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:44.755066 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:44.756855 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.757746 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:05:44.795604 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:05:44.803339 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.804125 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.835720 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:44.841309 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:05:44.841918 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.842479 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:05:44.874284 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:44.882663 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:05:44.883743 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.884304 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:05:44.916026 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:44.918617 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:05:44.493140 => 21:05:44.918274
[0m21:05:44.919285 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:05:44.920863 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920dd0>]}
[0m21:05:44.921760 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.43s]
[0m21:05:44.922545 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.923157 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.924012 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:05:44.924984 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:05:44.925468 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.929381 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.930317 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:05:44.925772 => 21:05:44.930068
[0m21:05:44.930736 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.935336 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.936049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.936390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:05:44.936712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:45.194333 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:45.196388 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:45.198162 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:05:49.800755 [debug] [Thread-1 (]: SQL status: SELECT 37204 in 5.0 seconds
[0m21:05:49.808029 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.808658 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:05:49.840458 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:49.845640 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.846420 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:05:49.888673 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:49.895318 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:05:49.896111 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.896863 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:05:49.928865 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:49.936267 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:05:49.937573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.938154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:05:49.984087 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:49.987338 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:05:44.930984 => 21:05:49.986932
[0m21:05:49.988155 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:05:49.989987 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078b16d0>]}
[0m21:05:49.991097 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37204[0m in 5.07s]
[0m21:05:49.992222 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:49.993074 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:05:49.994097 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:05:49.995122 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:05:49.995708 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:05:49.999924 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.001509 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:05:49.996087 => 21:05:50.001123
[0m21:05:50.002029 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:05:50.007843 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.008616 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.009000 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:05:50.009371 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:50.264389 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:50.266346 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.268043 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:05:53.284837 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:05:53.294107 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.294823 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:05:53.326192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.331490 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.332193 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:05:53.363329 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.420128 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:05:53.420537 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.420785 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:05:53.451484 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:53.453279 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:05:53.453888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.454151 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:05:53.499039 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:53.500468 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:05:50.002323 => 21:05:53.500250
[0m21:05:53.500882 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:05:53.501767 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107004c50>]}
[0m21:05:53.502333 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.51s]
[0m21:05:53.502945 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:05:53.503390 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.503931 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:05:53.504695 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:05:53.505090 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.508526 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.509259 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:05:53.505343 => 21:05:53.509074
[0m21:05:53.509591 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.513187 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.513740 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.514022 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:05:53.514287 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:53.842697 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:53.844832 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.846417 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name, 
    NULL as brand_name, 
    NULL as unique_outclicks, 
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:05:53.928490 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:05:53.936779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.937376 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:05:53.977302 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.983314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.983991 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:05:54.023827 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:54.028901 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:05:54.029755 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:54.030483 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:05:54.069688 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:54.075825 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:05:54.077146 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:54.077731 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:05:54.135619 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:54.139354 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:05:53.509783 => 21:05:54.138930
[0m21:05:54.140123 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:05:54.141786 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075e2350>]}
[0m21:05:54.142748 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.64s]
[0m21:05:54.143704 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:54.144369 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:05:54.145084 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test ..................................... [RUN]
[0m21:05:54.145964 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:05:54.146425 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:05:54.150785 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:05:54.151951 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:05:54.146743 => 21:05:54.151687
[0m21:05:54.152377 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:05:54.156932 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:05:54.157674 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:05:54.158009 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:05:54.158326 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:54.575833 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:54.577814 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:05:54.578666 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  
    

  create  table "deep-analysis-console"."danila"."test__dbt_tmp"
  
  
    as
  
  (
    select 
    date_parsed, 
    date
    geo as country_code, 
    registrations as signups
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
    and geo='vn'
    and brand_name='20bet'
    and registrations>0
order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
  
[0m21:05:54.623671 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "as"
LINE 15:     geo as country_code, 
                 ^

[0m21:05:54.624710 [debug] [Thread-1 (]: On model.campaign_perfomance.test: ROLLBACK
[0m21:05:54.668699 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:05:54.152626 => 21:05:54.668037
[0m21:05:54.670179 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:05:54.683700 [debug] [Thread-1 (]: Database Error in model test (models/brand_performance/test.sql)
  syntax error at or near "as"
  LINE 15:     geo as country_code, 
                   ^
  compiled Code at target/run/campaign_perfomance/models/brand_performance/test.sql
[0m21:05:54.684423 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ac450>]}
[0m21:05:54.685419 [error] [Thread-1 (]: 12 of 17 ERROR creating sql table model danila.test ............................ [[31mERROR[0m in 0.54s]
[0m21:05:54.686293 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:05:54.686843 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:05:54.687487 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.test_write ............................... [RUN]
[0m21:05:54.688314 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:05:54.688775 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:05:54.692198 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:05:54.693137 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:05:54.689054 => 21:05:54.692918
[0m21:05:54.693519 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:05:54.697904 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:05:54.698535 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:54.698845 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:05:54.699139 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:54.955838 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:54.957679 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:54.958662 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:05:54.992725 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:55.001060 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.001844 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:05:55.033951 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.043045 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.043637 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:05:55.074708 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.078781 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:05:55.079379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.079922 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:05:55.110920 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:55.116527 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:05:55.118190 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.118905 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:05:55.167108 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:55.171397 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:05:54.693743 => 21:05:55.170706
[0m21:05:55.171893 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:05:55.173283 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076a9950>]}
[0m21:05:55.174272 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m21:05:55.175054 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:05:55.175615 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:05:55.176261 [info ] [Thread-1 (]: 14 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:05:55.177136 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:05:55.177544 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:05:55.181070 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.181994 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:05:55.177794 => 21:05:55.181761
[0m21:05:55.182388 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:05:55.186605 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.187253 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.187582 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:05:55.187880 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:55.563900 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:55.565849 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.567227 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:05:55.818357 [debug] [Thread-1 (]: SQL status: SELECT 54001 in 0.0 seconds
[0m21:05:55.827440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.828044 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:05:55.867406 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.872596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.873362 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:05:55.912965 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.920298 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:05:55.920889 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.921434 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:05:55.960927 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:55.967191 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:05:55.968239 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.969032 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:05:56.026105 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:56.030177 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:05:55.182623 => 21:05:56.029750
[0m21:05:56.031026 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:05:56.032990 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10764c450>]}
[0m21:05:56.034254 [info ] [Thread-1 (]: 14 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54001[0m in 0.86s]
[0m21:05:56.035505 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:05:56.036424 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.037524 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.my_second_dbt_model ...................... [RUN]
[0m21:05:56.038580 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m21:05:56.039190 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.043325 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.044780 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:05:56.039573 => 21:05:56.044546
[0m21:05:56.045557 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.051354 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.052165 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.052558 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:05:56.052919 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:56.312365 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:56.314415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.315919 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
  
  
    as
  
  (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
  
[0m21:05:56.349843 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:56.356965 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.358136 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:05:56.389522 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:56.395317 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:05:56.395964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.396491 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:05:56.427559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:56.434560 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:05:56.435637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.436076 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:05:56.466960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:56.469457 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:05:56.045916 => 21:05:56.469050
[0m21:05:56.470231 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:05:56.471906 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076ad450>]}
[0m21:05:56.472850 [info ] [Thread-1 (]: 15 of 17 OK created sql table model danila.my_second_dbt_model ................. [[32mSELECT 1[0m in 0.43s]
[0m21:05:56.473737 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.474429 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.475237 [info ] [Thread-1 (]: 16 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:05:56.476165 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:05:56.476688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.481371 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.482657 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:05:56.477026 => 21:05:56.482346
[0m21:05:56.483125 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.490095 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.490931 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.491279 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:05:56.491613 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:56.804397 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:56.806512 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.808259 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:05:57.278519 [debug] [Thread-1 (]: SQL status: SELECT 123957 in 0.0 seconds
[0m21:05:57.287392 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.287976 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:05:57.326570 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.332487 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.333182 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:05:57.373223 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.379824 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:05:57.380504 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.381055 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:05:57.419453 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:57.425208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:05:57.426511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.427049 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:05:57.486212 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:57.490786 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:05:56.483362 => 21:05:57.490017
[0m21:05:57.492180 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:05:57.493494 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107067510>]}
[0m21:05:57.494514 [info ] [Thread-1 (]: 16 of 17 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123957[0m in 1.02s]
[0m21:05:57.495419 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:57.496015 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.496568 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:05:57.497516 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:05:57.498001 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.501440 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.502348 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:05:57.498255 => 21:05:57.502120
[0m21:05:57.502740 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.506983 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.507675 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.508004 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:05:57.508319 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:57.761796 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:57.763553 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.764455 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:05:57.824775 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:05:57.833262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.833836 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:05:57.864665 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.869427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.869987 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:05:57.900884 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.905755 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:05:57.906692 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.907418 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:05:57.938183 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:57.943673 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:05:57.945402 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.946158 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:05:57.996609 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:58.000522 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:05:57.502975 => 21:05:58.000095
[0m21:05:58.001332 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:05:58.003290 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076d5890>]}
[0m21:05:58.004490 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.51s]
[0m21:05:58.005677 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:05:58.008532 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:58.009103 [debug] [MainThread]: On master: BEGIN
[0m21:05:58.009607 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:05:58.322118 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:58.323895 [debug] [MainThread]: On master: COMMIT
[0m21:05:58.325119 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:58.326288 [debug] [MainThread]: On master: COMMIT
[0m21:05:58.364343 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:05:58.365550 [debug] [MainThread]: On master: Close
[0m21:05:58.368438 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:05:58.369458 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:05:58.370138 [info ] [MainThread]: 
[0m21:05:58.370785 [info ] [MainThread]: Finished running 17 table models in 0 hours 0 minutes and 45.13 seconds (45.13s).
[0m21:05:58.374520 [debug] [MainThread]: Command end result
[0m21:05:58.387902 [info ] [MainThread]: 
[0m21:05:58.388418 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:05:58.388730 [info ] [MainThread]: 
[0m21:05:58.389016 [error] [MainThread]:   Database Error in model test (models/brand_performance/test.sql)
  syntax error at or near "as"
  LINE 15:     geo as country_code, 
                   ^
  compiled Code at target/run/campaign_perfomance/models/brand_performance/test.sql
[0m21:05:58.389324 [info ] [MainThread]: 
[0m21:05:58.389636 [info ] [MainThread]: Done. PASS=16 WARN=0 ERROR=1 SKIP=0 TOTAL=17
[0m21:05:58.391135 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 45.307163, "process_user_time": 1.991761, "process_kernel_time": 0.204073, "process_mem_max_rss": "125321216", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:05:58.391618 [debug] [MainThread]: Command `dbt run` failed at 21:05:58.391503 after 45.31 seconds
[0m21:05:58.391972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1028ccdd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102955f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107072ed0>]}
[0m21:05:58.392310 [debug] [MainThread]: Flushing usage events
[0m21:19:57.328665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a4a350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aae510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aaebd0>]}


============================== 21:19:57.330038 | 7459d65c-69ff-4e6c-b1e6-1d6998fe308a ==============================
[0m21:19:57.330038 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:19:57.330405 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'version_check': 'True', 'printer_width': '80', 'log_path': '/Users/danila/github/dbt/logs', 'log_cache_events': 'False', 'use_colors': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'quiet': 'False', 'fail_fast': 'False', 'no_print': 'None', 'static_parser': 'True', 'invocation_command': 'dbt build', 'partial_parse': 'True', 'debug': 'False'}
[0m21:19:57.394212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109acf950>]}
[0m21:19:57.424546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a01f690>]}
[0m21:19:57.425718 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:19:57.432065 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:19:57.445874 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:19:57.446113 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:19:57.448954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ec190>]}
[0m21:19:57.454287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2240d0>]}
[0m21:19:57.454504 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:19:57.455639 [info ] [MainThread]: 
[0m21:19:57.456026 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:19:57.456771 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:19:57.461299 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:19:57.461496 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:19:57.461647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:57.837810 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:19:57.843465 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:19:57.847432 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:19:57.854331 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:19:57.854758 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:19:57.855091 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:58.205710 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.207462 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:19:58.208926 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:19:58.257733 [debug] [ThreadPool]: SQL status: SELECT 17 in 0.0 seconds
[0m21:19:58.263900 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:19:58.307526 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:19:58.321334 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.321815 [debug] [MainThread]: On master: BEGIN
[0m21:19:58.322227 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:19:58.582428 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.584201 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.587712 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:19:58.629721 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:19:58.633997 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a20ec50>]}
[0m21:19:58.635375 [debug] [MainThread]: On master: ROLLBACK
[0m21:19:58.666387 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.667418 [debug] [MainThread]: On master: BEGIN
[0m21:19:58.730216 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.731265 [debug] [MainThread]: On master: COMMIT
[0m21:19:58.731911 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.732391 [debug] [MainThread]: On master: COMMIT
[0m21:19:58.763238 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:19:58.764816 [debug] [MainThread]: On master: Close
[0m21:19:58.767358 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:19:58.768226 [info ] [MainThread]: 
[0m21:19:58.774798 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.775832 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:19:58.776987 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:19:58.777585 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.791013 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.792070 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:19:58.777973 => 21:19:58.791833
[0m21:19:58.792475 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.818310 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.818861 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.819101 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:19:58.819322 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:19:59.072758 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:19:59.074489 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:59.076130 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:20:16.323859 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:20:16.335307 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.335932 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:20:16.367210 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.371875 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.372470 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:20:16.403445 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.425631 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:20:16.426036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.426369 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:20:16.456637 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:16.462558 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:20:16.466651 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.467005 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:20:16.510365 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:16.512138 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:19:58.792712 => 21:20:16.511865
[0m21:20:16.512644 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:20:16.513774 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a0b18d0>]}
[0m21:20:16.514555 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 17.74s]
[0m21:20:16.515299 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:20:16.515839 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:20:16.516524 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:20:16.517379 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:20:16.517854 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:20:16.521147 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:20:16.522098 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:20:16.518155 => 21:20:16.521870
[0m21:20:16.522497 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:20:16.526708 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:20:16.527321 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.527645 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:20:16.527952 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:16.805633 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:16.807720 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.809201 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:20:16.857960 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:20:16.866703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.867289 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:20:16.898895 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.907055 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.907853 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:20:16.938739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.943240 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:20:16.943992 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.944681 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:20:16.975990 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:16.982572 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:20:16.983629 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.984073 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:20:17.032267 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:17.034831 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:20:16.522736 => 21:20:17.034433
[0m21:20:17.035637 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:20:17.037506 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a480590>]}
[0m21:20:17.038708 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.52s]
[0m21:20:17.039797 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:20:17.040496 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.041382 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:20:17.042372 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:20:17.042914 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.047315 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.048605 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:20:17.043271 => 21:20:17.048315
[0m21:20:17.049096 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.054253 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.055202 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.055620 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:20:17.055989 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:17.313333 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:17.315328 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.316836 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:20:17.368219 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:20:17.376396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.376894 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:20:17.408304 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.413533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.414277 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:20:17.445850 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.453147 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:20:17.454503 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.455247 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:20:17.486798 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:17.493196 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:20:17.494213 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.494638 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:20:17.544966 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:17.546757 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:20:17.049385 => 21:20:17.546564
[0m21:20:17.547132 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:20:17.547891 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a401190>]}
[0m21:20:17.548339 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.51s]
[0m21:20:17.548801 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.549151 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:20:17.549593 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:20:17.550137 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:20:17.550434 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:20:17.552661 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:20:17.553191 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:20:17.550614 => 21:20:17.553048
[0m21:20:17.553449 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:20:17.556295 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:20:17.556822 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.557061 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:20:17.557281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:17.883248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:17.885291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.886866 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:20:17.934438 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:20:17.942985 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.943634 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:20:17.982813 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.988011 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.988663 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:20:18.027772 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.032786 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:20:18.033593 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:18.034289 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:20:18.073979 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:18.080433 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:20:18.082132 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:18.082871 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:20:18.140337 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:18.144673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:20:17.553606 => 21:20:18.144243
[0m21:20:18.145486 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:20:18.147313 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a454810>]}
[0m21:20:18.148308 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.60s]
[0m21:20:18.149224 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:20:18.149941 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.150845 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:20:18.151802 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:20:18.152293 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.159122 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.160224 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:20:18.152617 => 21:20:18.159929
[0m21:20:18.160666 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.164903 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.165483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.165830 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:20:18.166148 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:18.422474 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:18.424522 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.426025 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:20:18.460392 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:20:18.468042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.468836 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:20:18.500655 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.507435 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.508185 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:20:18.539682 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.544763 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:20:18.545609 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.546363 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:20:18.578229 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:18.585790 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:20:18.587458 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.588233 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:20:18.637796 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:18.640391 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:20:18.160910 => 21:20:18.639983
[0m21:20:18.641202 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:20:18.643068 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c9090>]}
[0m21:20:18.644217 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 2[0m in 0.49s]
[0m21:20:18.645354 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.646054 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.647170 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:20:18.648239 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:20:18.648854 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.655431 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.656483 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:20:18.649246 => 21:20:18.656219
[0m21:20:18.657003 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.661859 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.662607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.663009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:20:18.663364 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:19.014820 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:19.016687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:19.018179 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:20:26.360817 [debug] [Thread-1 (]: SQL status: SELECT 142662 in 7.0 seconds
[0m21:20:26.369268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.370024 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:20:26.413762 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.420738 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.421559 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:20:26.464960 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.469486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:20:26.470350 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.471122 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:20:26.515043 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:26.521204 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:20:26.522665 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.523173 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:20:26.586379 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:26.590806 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:20:18.657298 => 21:20:26.590471
[0m21:20:26.591580 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:20:26.593072 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a262810>]}
[0m21:20:26.593975 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142662[0m in 7.95s]
[0m21:20:26.594759 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:26.595326 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.595953 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:20:26.596695 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:20:26.597095 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.600129 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.601100 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:20:26.597345 => 21:20:26.600868
[0m21:20:26.601505 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.605383 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.606194 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.606527 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:20:26.606837 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:26.862675 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:26.864716 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.866241 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:20:26.900022 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:26.911426 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.911986 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:20:26.942921 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.948399 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.949097 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:20:26.979519 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.983649 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:20:26.984318 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.984875 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:20:27.016617 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:27.022937 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:20:27.024212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:27.024760 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:20:27.071944 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:27.076995 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:20:26.601746 => 21:20:27.076223
[0m21:20:27.077839 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:20:27.079472 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a26fc10>]}
[0m21:20:27.080345 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.48s]
[0m21:20:27.081101 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:27.081695 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.082340 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:20:27.083177 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:20:27.083579 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.086792 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.087696 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:20:27.083819 => 21:20:27.087452
[0m21:20:27.088100 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.092038 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.092712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.093037 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:20:27.093352 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:27.371664 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:27.373871 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.375474 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:20:27.415254 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:20:27.423365 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.423956 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:20:27.457443 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:27.463063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.463860 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.499042 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:27.505451 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:20:27.506223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.506928 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:20:27.540606 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:27.548259 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:20:27.549989 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.550750 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:20:27.603263 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:27.605949 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:20:27.088338 => 21:20:27.605533
[0m21:20:27.606691 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:20:27.608269 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a003190>]}
[0m21:20:27.609190 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.53s]
[0m21:20:27.610071 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.610725 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.611494 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:20:27.612611 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:20:27.613172 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.618811 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.620014 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:20:27.613529 => 21:20:27.619715
[0m21:20:27.620461 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.624803 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.625423 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.625762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:20:27.626078 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:27.954588 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:27.956615 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.958398 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:20:32.604447 [debug] [Thread-1 (]: SQL status: SELECT 37209 in 5.0 seconds
[0m21:20:32.610367 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.610978 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:20:32.650354 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:32.652414 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.652686 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:20:32.691121 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:32.692708 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:20:32.693012 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.693293 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:20:32.732106 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:32.737184 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:20:32.738073 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.738475 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:20:32.792166 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:32.795053 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:20:27.620708 => 21:20:32.794714
[0m21:20:32.795679 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:20:32.797062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a490c90>]}
[0m21:20:32.797988 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37209[0m in 5.18s]
[0m21:20:32.798765 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:32.799383 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.800106 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:20:32.800955 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:20:32.801431 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.839398 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.840029 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:20:32.801992 => 21:20:32.839883
[0m21:20:32.840289 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.842913 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.843303 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.843518 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:20:32.843723 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:33.095672 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:33.097618 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:33.099345 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:20:36.086272 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:20:36.093776 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.094740 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:20:36.128397 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.134826 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.135638 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:20:36.167771 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.173526 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:20:36.174119 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.174584 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:20:36.205429 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:36.209895 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:20:36.211520 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.212252 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:20:36.260260 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:36.264763 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:20:32.840435 => 21:20:36.263985
[0m21:20:36.265589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:20:36.267484 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c403a50>]}
[0m21:20:36.268581 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.47s]
[0m21:20:36.269512 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:20:36.270203 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.271219 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:20:36.272298 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:20:36.272891 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.277673 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.279069 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:20:36.273230 => 21:20:36.278742
[0m21:20:36.279619 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.284871 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.285633 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.286056 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:20:36.286427 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:36.610954 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:36.612648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.614318 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:20:36.695684 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:20:36.703848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.704665 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:20:36.744256 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.749677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.750474 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:20:36.790719 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.796418 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:20:36.797199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.797909 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:20:36.838647 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:36.844939 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:20:36.846578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.847367 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:20:36.905369 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:36.908591 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:20:36.279928 => 21:20:36.908199
[0m21:20:36.909390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:20:36.911237 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4a8b50>]}
[0m21:20:36.912354 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.64s]
[0m21:20:36.913475 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.914331 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:20:36.915354 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test ..................................... [RUN]
[0m21:20:36.916660 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:20:36.917255 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:20:36.921584 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:20:36.923666 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:20:36.917643 => 21:20:36.922718
[0m21:20:36.924341 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:20:36.931148 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:20:36.932083 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:36.932473 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:20:36.932832 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:37.210570 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:37.212559 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.214046 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  
    

  create  table "deep-analysis-console"."danila"."test__dbt_tmp"
  
  
    as
  
  (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
  
[0m21:20:37.248972 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:37.256307 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.257090 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:20:37.288274 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.292293 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:20:37.293055 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.293739 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:20:37.325674 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:37.331382 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:20:37.332997 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.333769 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop table if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:20:37.366064 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:37.370498 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:20:36.924659 => 21:20:37.369770
[0m21:20:37.371656 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:20:37.373153 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f9ddd0>]}
[0m21:20:37.374071 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test ................................ [[32mSELECT 1[0m in 0.46s]
[0m21:20:37.374949 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:20:37.375619 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:20:37.376362 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:20:37.377301 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:20:37.377792 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:20:37.381549 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:20:37.382719 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:20:37.378127 => 21:20:37.382413
[0m21:20:37.383225 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:20:37.388662 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:20:37.389434 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.389781 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:20:37.390099 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:37.644436 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:37.644830 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.645073 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:20:37.677528 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:37.679762 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.680033 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:20:37.710633 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.712885 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.713338 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:20:37.743704 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.746106 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:20:37.746560 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.746979 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:20:37.778233 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:37.782487 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:20:37.783794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.784447 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:20:37.832289 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:37.835639 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:20:37.383515 => 21:20:37.835192
[0m21:20:37.836484 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:20:37.838421 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a41ee90>]}
[0m21:20:37.839604 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.46s]
[0m21:20:37.840747 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:20:37.841633 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:20:37.842416 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:20:37.843410 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:20:37.843972 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:20:37.848844 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.850387 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:20:37.844329 => 21:20:37.849967
[0m21:20:37.850977 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:20:37.856524 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.857291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.857690 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:20:37.858056 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:38.182858 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:38.184819 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.185958 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:20:38.439653 [debug] [Thread-1 (]: SQL status: SELECT 54020 in 0.0 seconds
[0m21:20:38.447834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.448372 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:20:38.487751 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:38.493053 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.493809 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:20:38.533565 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:38.539996 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:20:38.540446 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.540842 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:20:38.580230 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:38.588682 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:20:38.590344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.591070 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:20:38.651071 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:38.654095 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:20:37.851279 => 21:20:38.653692
[0m21:20:38.654933 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:20:38.656736 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a235a10>]}
[0m21:20:38.657844 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54020[0m in 0.81s]
[0m21:20:38.658960 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:20:38.659830 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.660934 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:20:38.662156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:20:38.662727 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.677902 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.679082 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:20:38.663125 => 21:20:38.678835
[0m21:20:38.679534 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.690797 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.691407 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.691716 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:20:38.691959 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.016814 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.018793 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:39.019685 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:20:39.060831 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:39.065852 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:20:38.679782 => 21:20:39.065393
[0m21:20:39.066702 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:20:39.106249 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:20:39.109209 [error] [Thread-1 (]: 15 of 21 FAIL 1 not_null_my_first_dbt_model_id ................................. [[31mFAIL 1[0m in 0.45s]
[0m21:20:39.110420 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:39.111226 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.112059 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:20:39.113074 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:20:39.113628 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.123630 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.124777 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:20:39.113985 => 21:20:39.124521
[0m21:20:39.125231 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.127712 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.128378 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.128716 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:20:39.129029 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.385332 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.387407 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.388589 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:20:39.421574 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:39.425687 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:20:39.125476 => 21:20:39.425230
[0m21:20:39.426584 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:20:39.457453 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:20:39.460665 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m21:20:39.462003 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.463010 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.464524 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:20:39.466022 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:20:39.466836 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.473705 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.475169 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:20:39.467410 => 21:20:39.474911
[0m21:20:39.475922 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.481277 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.482257 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.482661 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:20:39.483033 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.797494 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.798907 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.799904 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:20:40.387198 [debug] [Thread-1 (]: SQL status: SELECT 123962 in 1.0 seconds
[0m21:20:40.397080 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.397809 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:20:40.437055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:40.443488 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.444100 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:20:40.482959 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:40.488438 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:20:40.489235 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.489952 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:20:40.528276 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:40.536106 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:20:40.537097 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.537760 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:20:40.598471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:40.602958 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:20:39.476360 => 21:20:40.602670
[0m21:20:40.603511 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:20:40.604634 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a28d1d0>]}
[0m21:20:40.605395 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123962[0m in 1.14s]
[0m21:20:40.606096 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:40.606623 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.607239 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:20:40.608063 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:20:40.608488 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.612060 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.612843 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:20:40.608736 => 21:20:40.612646
[0m21:20:40.613189 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.616873 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.617425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.617749 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:20:40.618048 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:40.980813 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:40.981960 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.982622 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:20:41.058711 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:20:41.069427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.070069 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:20:41.114282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:41.119109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.119625 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:20:41.163232 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:41.167928 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:20:41.168701 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.169380 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:20:41.213506 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:41.220748 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:20:41.222454 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.223115 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:20:41.285779 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:41.288611 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:20:40.613393 => 21:20:41.288271
[0m21:20:41.289266 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:20:41.290813 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a260150>]}
[0m21:20:41.291692 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.68s]
[0m21:20:41.292441 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:20:41.293026 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:20:41.293923 [info ] [Thread-1 (]: 19 of 21 SKIP relation danila.my_second_dbt_model .............................. [[33mSKIP[0m]
[0m21:20:41.294570 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:20:41.295567 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:20:41.296213 [info ] [Thread-1 (]: 20 of 21 SKIP test not_null_my_second_dbt_model_id ............................. [[33mSKIP[0m]
[0m21:20:41.296874 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:20:41.297406 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:20:41.297945 [info ] [Thread-1 (]: 21 of 21 SKIP test unique_my_second_dbt_model_id ............................... [[33mSKIP[0m]
[0m21:20:41.298494 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:20:41.299975 [debug] [MainThread]: Using postgres connection "master"
[0m21:20:41.300340 [debug] [MainThread]: On master: BEGIN
[0m21:20:41.300655 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:20:41.582538 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:20:41.584408 [debug] [MainThread]: On master: COMMIT
[0m21:20:41.585662 [debug] [MainThread]: Using postgres connection "master"
[0m21:20:41.586829 [debug] [MainThread]: On master: COMMIT
[0m21:20:41.619079 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:20:41.619894 [debug] [MainThread]: On master: Close
[0m21:20:41.621910 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:20:41.622546 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:20:41.623435 [info ] [MainThread]: 
[0m21:20:41.624174 [info ] [MainThread]: Finished running 17 table models, 4 tests in 0 hours 0 minutes and 44.17 seconds (44.17s).
[0m21:20:41.629377 [debug] [MainThread]: Command end result
[0m21:20:41.644115 [info ] [MainThread]: 
[0m21:20:41.644605 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:20:41.644962 [info ] [MainThread]: 
[0m21:20:41.645294 [error] [MainThread]: [31mFailure in test not_null_my_first_dbt_model_id (models/example/schema.yml)[0m
[0m21:20:41.645618 [error] [MainThread]:   Got 1 result, configured to fail if != 0
[0m21:20:41.645926 [info ] [MainThread]: 
[0m21:20:41.646230 [info ] [MainThread]:   compiled Code at target/compiled/campaign_perfomance/models/example/schema.yml/not_null_my_first_dbt_model_id.sql
[0m21:20:41.646580 [info ] [MainThread]: 
[0m21:20:41.646949 [info ] [MainThread]: Done. PASS=17 WARN=0 ERROR=1 SKIP=3 TOTAL=21
[0m21:20:41.649332 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 44.342804, "process_user_time": 2.073458, "process_kernel_time": 0.210257, "process_mem_max_rss": "124616704", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:20:41.649941 [debug] [MainThread]: Command `dbt build` failed at 21:20:41.649805 after 44.34 seconds
[0m21:20:41.650369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105330dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aae150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aaf9d0>]}
[0m21:20:41.650756 [debug] [MainThread]: Flushing usage events
[0m21:24:20.007080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cefb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109733150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d66d50>]}


============================== 21:24:20.008330 | 3afbd538-2027-485a-ae0e-a18dbbdab62e ==============================
[0m21:24:20.008330 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:24:20.008644 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'log_path': '/Users/danila/github/dbt/logs', 'no_print': 'None', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/danila/.dbt', 'fail_fast': 'False', 'write_json': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'target_path': 'None', 'static_parser': 'True', 'introspect': 'True', 'use_colors': 'True', 'log_format': 'default', 'debug': 'False', 'invocation_command': 'dbt build', 'version_check': 'True', 'partial_parse': 'True', 'warn_error': 'None'}
[0m21:24:20.071922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d6b50>]}
[0m21:24:20.101847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2c3e10>]}
[0m21:24:20.102177 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:24:20.108168 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:24:20.121007 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:24:20.121218 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:24:20.121713 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:24:20.124480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a241510>]}
[0m21:24:20.129609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3bbcd0>]}
[0m21:24:20.129843 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:24:20.130966 [info ] [MainThread]: 
[0m21:24:20.131326 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:24:20.132101 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:24:20.136396 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:24:20.136580 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:24:20.136724 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:20.559128 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:24:20.565115 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:24:20.568886 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:24:20.575876 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:24:20.576323 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:24:20.576659 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:24:20.930773 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:24:20.932668 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:24:20.934109 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:24:20.982851 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:24:20.987516 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:24:21.029488 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:24:21.043236 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.043925 [debug] [MainThread]: On master: BEGIN
[0m21:24:21.044483 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:24:21.405750 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.406873 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.407584 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:24:21.460681 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:24:21.465962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093cddd0>]}
[0m21:24:21.466836 [debug] [MainThread]: On master: ROLLBACK
[0m21:24:21.510481 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.511215 [debug] [MainThread]: On master: BEGIN
[0m21:24:21.597437 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.598329 [debug] [MainThread]: On master: COMMIT
[0m21:24:21.598763 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.599103 [debug] [MainThread]: On master: COMMIT
[0m21:24:21.643065 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:24:21.643862 [debug] [MainThread]: On master: Close
[0m21:24:21.645820 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:24:21.646512 [info ] [MainThread]: 
[0m21:24:21.652346 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.653399 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:24:21.654574 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:24:21.655163 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.668970 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.670040 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:24:21.655563 => 21:24:21.669767
[0m21:24:21.670476 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.697224 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.697794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.698029 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:24:21.698248 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:21.951151 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.952837 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.954339 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:24:39.089629 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:24:39.102563 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.103323 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:24:39.191327 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:39.194608 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.195033 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:24:39.427563 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:39.455374 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:24:39.455994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.456360 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:24:39.685600 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:39.696999 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:24:39.702515 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.703035 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:24:39.771895 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:39.775417 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:24:21.670724 => 21:24:39.775011
[0m21:24:39.776205 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:24:39.777929 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3de8d0>]}
[0m21:24:39.779025 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 18.12s]
[0m21:24:39.780120 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:24:39.780906 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:24:39.781814 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:24:39.782767 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:24:39.783288 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:24:39.787354 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:24:39.788333 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:24:39.783615 => 21:24:39.788085
[0m21:24:39.788778 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:24:39.791468 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:24:39.791938 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:39.792121 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:24:39.792291 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:40.907982 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:40.908425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:40.908768 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:24:41.282481 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:24:41.288468 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.289276 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:24:41.357399 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:41.368565 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.369273 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:24:41.507720 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:41.512433 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:24:41.513026 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.513557 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:24:41.591009 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:41.597302 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:24:41.599066 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.599810 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:24:41.756049 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:41.759451 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:24:39.789028 => 21:24:41.759038
[0m21:24:41.760262 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:24:41.762297 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5e9890>]}
[0m21:24:41.763532 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 1.98s]
[0m21:24:41.764692 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:24:41.765558 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.766391 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:24:41.767435 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:24:41.767961 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.773088 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.774434 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:24:41.768313 => 21:24:41.774105
[0m21:24:41.774943 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.780363 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.781314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.781729 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:24:41.782109 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:42.931237 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:42.933379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:42.934526 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:24:43.016563 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:24:43.023896 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.024715 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:24:43.101083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.107419 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.108169 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:24:43.156192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.161453 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:24:43.162192 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.162853 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:24:43.209653 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:43.215982 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:24:43.217117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.217584 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:24:43.282013 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:43.286496 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:24:41.775245 => 21:24:43.285684
[0m21:24:43.287972 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:24:43.290097 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5da3d0>]}
[0m21:24:43.291010 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 1.52s]
[0m21:24:43.291821 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:24:43.292424 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:24:43.293126 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:24:43.293906 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:24:43.294339 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:24:43.299064 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:24:43.300420 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:24:43.294632 => 21:24:43.300141
[0m21:24:43.300896 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:24:43.305592 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:24:43.306200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.306534 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:24:43.306841 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:43.573026 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:43.575352 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.576884 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:24:43.614537 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:24:43.621445 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.622119 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:24:43.661570 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.666970 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.667738 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:24:43.700120 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.704925 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:24:43.705567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.706008 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:24:43.748607 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:43.753744 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:24:43.755460 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.756206 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:24:43.812686 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:43.817296 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:24:43.301158 => 21:24:43.816488
[0m21:24:43.818716 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:24:43.820501 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4dbb50>]}
[0m21:24:43.821268 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.53s]
[0m21:24:43.822404 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:24:43.823031 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.823720 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:24:43.824778 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:24:43.825268 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.830759 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.831652 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:24:43.825534 => 21:24:43.831452
[0m21:24:43.831986 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.835783 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.836419 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.836748 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:24:43.837060 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:44.498641 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:44.500850 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.502260 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:24:44.557807 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:24:44.566970 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.567805 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:24:44.621854 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:44.628116 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.628896 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:24:44.683405 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:44.688363 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:24:44.689125 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.689823 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:24:44.751978 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:44.757609 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:24:44.759036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.759691 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:24:44.836790 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:44.840850 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:24:43.832195 => 21:24:44.840567
[0m21:24:44.841440 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:24:44.842920 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4b77d0>]}
[0m21:24:44.843789 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 1.02s]
[0m21:24:44.844536 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:24:44.845095 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.845746 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:24:44.846705 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:24:44.847184 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.852510 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.853460 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:24:44.847471 => 21:24:44.853231
[0m21:24:44.853864 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.857719 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.858303 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.858624 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:24:44.858927 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:45.205088 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:45.207033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:45.209041 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:24:52.809434 [debug] [Thread-1 (]: SQL status: SELECT 142662 in 8.0 seconds
[0m21:24:52.816681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:52.817541 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:24:52.954635 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:52.961564 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:52.962172 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:24:53.006705 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:53.011983 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:24:53.012473 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:53.012898 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:24:53.043889 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:53.048271 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:24:53.049614 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:53.050216 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:24:53.097806 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:53.102410 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:24:44.854071 => 21:24:53.101657
[0m21:24:53.103176 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:24:53.104588 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4a42d0>]}
[0m21:24:53.105842 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142662[0m in 8.26s]
[0m21:24:53.106712 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:53.107346 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.108055 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:24:53.108998 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:24:53.109443 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.112645 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.113601 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:24:53.109702 => 21:24:53.113353
[0m21:24:53.114029 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.117936 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.118604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.118936 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:24:53.119261 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:53.867573 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:53.869795 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.871328 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:24:54.020794 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:24:54.032632 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.033239 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:24:54.116887 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:54.125243 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.125977 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:24:54.244081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:54.250335 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:24:54.251293 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.252114 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:24:54.328421 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:54.335385 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:24:54.337487 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.338234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:24:54.431402 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:54.436630 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:24:53.114269 => 21:24:54.435839
[0m21:24:54.437776 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:24:54.439859 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a26e690>]}
[0m21:24:54.441053 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 1.33s]
[0m21:24:54.442028 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:54.442748 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.443592 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:24:54.444642 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:24:54.445226 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.450510 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.451922 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:24:54.445601 => 21:24:54.451591
[0m21:24:54.452472 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.457419 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.458244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.458676 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:24:54.459057 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:55.543122 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:55.545355 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.546961 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:24:55.833526 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:24:55.835578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.835836 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:24:55.931982 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:55.936806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.937405 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.123526 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:56.128420 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:24:56.129136 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.129759 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:24:56.316249 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:56.319060 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:24:56.319808 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.320126 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:24:56.423666 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:56.429619 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:24:54.452773 => 21:24:56.428768
[0m21:24:56.431177 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:24:56.433228 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3d12d0>]}
[0m21:24:56.434301 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 1.99s]
[0m21:24:56.435266 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:56.435876 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.436538 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:24:56.437411 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:24:56.437870 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.441688 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.442644 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:24:56.438118 => 21:24:56.442403
[0m21:24:56.443053 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.446948 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.447708 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.448044 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:24:56.448355 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:57.150562 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:57.152366 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:57.153562 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:25:02.022417 [debug] [Thread-1 (]: SQL status: SELECT 37209 in 5.0 seconds
[0m21:25:02.030375 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.031283 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:25:02.080101 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:02.085759 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.086317 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:25:02.134647 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:02.139762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:25:02.140479 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.141030 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:25:02.188109 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:02.198287 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:25:02.199411 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.199843 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:25:02.264404 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:02.267375 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:24:56.443288 => 21:25:02.266939
[0m21:25:02.268111 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:25:02.269701 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a690210>]}
[0m21:25:02.270691 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37209[0m in 5.83s]
[0m21:25:02.271600 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:25:02.272237 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.273011 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:25:02.273956 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:25:02.274467 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.318187 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.318812 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:25:02.274853 => 21:25:02.318674
[0m21:25:02.319043 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.321458 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.321842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.322067 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:25:02.322274 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:02.707788 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:02.709369 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.710331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:25:05.711059 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:25:05.720338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.721009 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:25:05.760011 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:05.765433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.766224 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:25:05.798033 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:05.804085 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:25:05.804699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.805249 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:25:05.836430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:05.838661 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:25:05.839293 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.839569 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:25:05.891053 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:05.892266 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:25:02.319176 => 21:25:05.892094
[0m21:25:05.892586 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:25:05.893228 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a690490>]}
[0m21:25:05.893657 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.62s]
[0m21:25:05.894110 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:25:05.894458 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.894955 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:25:05.895553 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:25:05.895872 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.898534 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.899149 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:25:05.896066 => 21:25:05.898978
[0m21:25:05.899450 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.902591 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.903062 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.903339 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:25:05.903583 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:06.279034 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:06.281133 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.282861 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:25:06.368127 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:25:06.375438 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.376257 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:25:06.491310 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:06.499265 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.499898 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:25:06.555131 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:06.560720 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:25:06.561225 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.561872 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:25:06.628441 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:06.635036 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:25:06.636669 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.637259 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:25:06.711398 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:06.714538 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:25:05.899618 => 21:25:06.714185
[0m21:25:06.715227 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:25:06.716749 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a65d990>]}
[0m21:25:06.717636 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.82s]
[0m21:25:06.718411 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:06.718969 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:25:06.719596 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:25:06.720717 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:25:06.721420 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:25:06.725187 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:25:06.726557 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:25:06.721740 => 21:25:06.725902
[0m21:25:06.727004 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:25:06.743241 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:25:06.743794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:06.744050 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:25:06.744297 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:07.427547 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:07.429653 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.431183 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:25:07.483427 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:25:07.491223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.491764 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:25:07.537055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:07.544239 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.544773 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:25:07.589488 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:07.595884 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:25:07.596768 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.597186 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:25:07.639642 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:07.645371 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:25:07.646995 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.647708 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop table if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:25:07.708759 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:07.711994 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:25:06.727240 => 21:25:07.711454
[0m21:25:07.713120 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:25:07.714681 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a64b450>]}
[0m21:25:07.715528 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.99s]
[0m21:25:07.716322 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:25:07.716894 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:25:07.717595 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:25:07.718490 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:25:07.718963 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:25:07.722111 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:25:07.723038 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:25:07.719218 => 21:25:07.722804
[0m21:25:07.723446 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:25:07.727362 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:25:07.727942 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:07.728268 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:25:07.728572 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:07.982418 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:07.983866 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:07.984676 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:25:08.018016 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:08.025719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.026474 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:25:08.057816 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.064082 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.064839 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:25:08.096792 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.101695 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:25:08.102430 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.103090 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:25:08.134770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:08.140005 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:25:08.141596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.142297 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:25:08.190984 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:08.195256 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:25:07.723684 => 21:25:08.194532
[0m21:25:08.196618 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:25:08.199284 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109028890>]}
[0m21:25:08.200162 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.48s]
[0m21:25:08.201020 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:25:08.201621 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:25:08.202316 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:25:08.203208 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:25:08.203688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:25:08.208520 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.209829 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:25:08.203997 => 21:25:08.209521
[0m21:25:08.210336 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:25:08.215241 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.216003 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.216392 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:25:08.216731 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:08.580390 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:08.582337 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.583900 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:25:08.850409 [debug] [Thread-1 (]: SQL status: SELECT 54032 in 0.0 seconds
[0m21:25:08.858035 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.858622 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:25:08.967322 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.979300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.979982 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:25:09.092929 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:09.098025 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:25:09.098645 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:09.099204 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:25:09.209235 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:09.217003 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:25:09.218171 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:09.218846 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:25:09.284087 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:09.288285 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:25:08.210620 => 21:25:09.287700
[0m21:25:09.289420 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:25:09.291452 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5eaf10>]}
[0m21:25:09.292711 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54032[0m in 1.09s]
[0m21:25:09.293910 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:25:09.294834 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.295990 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:25:09.297266 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:25:09.297906 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.313886 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.314908 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:25:09.298270 => 21:25:09.314672
[0m21:25:09.315321 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.326265 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.326751 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.327033 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:25:09.327286 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:09.597645 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:09.599583 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.600872 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:25:09.633912 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:09.639365 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:25:09.315531 => 21:25:09.638909
[0m21:25:09.640220 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:25:09.671089 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:25:09.674487 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.38s]
[0m21:25:09.675668 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.676577 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.677543 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:25:09.678909 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:25:09.679679 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.690883 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.692220 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:25:09.680203 => 21:25:09.691919
[0m21:25:09.692736 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.695705 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.696501 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.696893 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:25:09.697262 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:09.949616 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:09.951239 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.952320 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:25:09.985458 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:09.988770 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:25:09.693035 => 21:25:09.988321
[0m21:25:09.989597 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:25:10.020645 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:25:10.023878 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.34s]
[0m21:25:10.025113 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:10.026010 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.027294 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:25:10.028663 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:25:10.029405 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.035800 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.037297 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:25:10.029921 => 21:25:10.037059
[0m21:25:10.038100 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.043937 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.044870 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.045264 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:25:10.045663 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:10.422831 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:10.424888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.426634 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:25:10.926575 [debug] [Thread-1 (]: SQL status: SELECT 123962 in 0.0 seconds
[0m21:25:10.930046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.930468 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:25:10.982900 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:10.988869 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.989483 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:25:11.040607 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:11.045486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:25:11.046265 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:11.046961 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:25:11.098077 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:11.103765 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:25:11.105443 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:11.106178 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:25:11.179857 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:11.181515 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:25:10.038602 => 21:25:11.181278
[0m21:25:11.181949 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:25:11.182878 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a654c90>]}
[0m21:25:11.183484 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123962[0m in 1.15s]
[0m21:25:11.184088 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:11.184545 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.185110 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:25:11.185824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:25:11.186173 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.190957 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.191629 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:25:11.186386 => 21:25:11.191459
[0m21:25:11.191916 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.195292 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.195927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.196214 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:25:11.196484 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:11.872629 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:11.874657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.875778 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:25:11.962288 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:25:11.970453 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.971102 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:25:12.109486 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:12.115711 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.116501 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:25:12.228659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:12.234790 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:25:12.235511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.236045 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:25:12.329372 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:12.336009 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:25:12.337237 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.337805 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:25:12.465006 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:12.468810 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:25:11.192087 => 21:25:12.468389
[0m21:25:12.469431 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:25:12.470890 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a46f490>]}
[0m21:25:12.471682 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 1.29s]
[0m21:25:12.472420 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:25:12.472978 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.473612 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:25:12.474417 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:25:12.475175 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.479422 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.480594 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:25:12.475637 => 21:25:12.480294
[0m21:25:12.481033 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.485786 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.486557 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.486897 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:25:12.487217 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:13.164599 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:13.166712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.167782 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:25:13.211242 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:25:13.220932 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.221937 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model" rename to "my_second_dbt_model__dbt_backup"
[0m21:25:13.262262 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:13.269565 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.270127 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:25:13.309465 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:13.314901 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:25:13.315502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.316034 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:25:13.355574 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:13.364613 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:25:13.365994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.366506 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:25:13.424611 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:13.429661 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:25:12.481285 => 21:25:13.428900
[0m21:25:13.430967 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:25:13.432233 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a431590>]}
[0m21:25:13.432999 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.96s]
[0m21:25:13.433737 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:25:13.434743 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.435242 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:25:13.435918 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:25:13.436319 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.440995 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.441901 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:25:13.436559 => 21:25:13.441702
[0m21:25:13.442238 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.444286 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.444908 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.445252 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:25:13.445575 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:13.749093 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:13.751039 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.752147 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:25:13.787467 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:13.791422 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:25:13.442436 => 21:25:13.790969
[0m21:25:13.792278 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:25:13.825813 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:25:13.829164 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.39s]
[0m21:25:13.830151 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.830893 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.831588 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:25:13.832599 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:25:13.833136 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.843465 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.844631 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:25:13.833465 => 21:25:13.844357
[0m21:25:13.845073 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.847558 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.848243 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.848602 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:25:13.848906 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:14.353427 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:14.355370 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:14.356486 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:25:14.397400 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:14.401209 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:25:13.845317 => 21:25:14.400760
[0m21:25:14.402053 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:25:14.441693 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:25:14.445460 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.61s]
[0m21:25:14.446499 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:14.449000 [debug] [MainThread]: Using postgres connection "master"
[0m21:25:14.449515 [debug] [MainThread]: On master: BEGIN
[0m21:25:14.449918 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:25:14.750296 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:25:14.751787 [debug] [MainThread]: On master: COMMIT
[0m21:25:14.752679 [debug] [MainThread]: Using postgres connection "master"
[0m21:25:14.753509 [debug] [MainThread]: On master: COMMIT
[0m21:25:14.789845 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:25:14.790542 [debug] [MainThread]: On master: Close
[0m21:25:14.792241 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:25:14.792870 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:25:14.793728 [info ] [MainThread]: 
[0m21:25:14.794432 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 54.66 seconds (54.66s).
[0m21:25:14.798934 [debug] [MainThread]: Command end result
[0m21:25:14.811582 [info ] [MainThread]: 
[0m21:25:14.812125 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:25:14.812486 [info ] [MainThread]: 
[0m21:25:14.812825 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:25:14.814657 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 54.83329, "process_user_time": 2.23321, "process_kernel_time": 0.215548, "process_mem_max_rss": "126107648", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:25:14.815164 [debug] [MainThread]: Command `dbt build` succeeded at 21:25:14.815051 after 54.83 seconds
[0m21:25:14.815532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105671f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055e8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055e8210>]}
[0m21:25:14.815885 [debug] [MainThread]: Flushing usage events
[0m21:38:10.439632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ddf450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e56710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e56dd0>]}


============================== 21:38:10.440973 | b3847aeb-0698-406e-bebb-c55418e8106d ==============================
[0m21:38:10.440973 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:38:10.441340 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/danila/.dbt', 'log_path': '/Users/danila/github/dbt/logs', 'printer_width': '80', 'no_print': 'None', 'indirect_selection': 'eager', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'quiet': 'False', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'static_parser': 'True', 'log_cache_events': 'False', 'introspect': 'True', 'invocation_command': 'dbt build', 'warn_error': 'None', 'debug': 'False'}
[0m21:38:10.505627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107df17d0>]}
[0m21:38:10.535721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b38d0>]}
[0m21:38:10.536246 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:38:10.542725 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:38:10.557998 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:38:10.558212 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:38:10.558714 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:38:10.561310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085b91d0>]}
[0m21:38:10.566931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084c3cd0>]}
[0m21:38:10.567194 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:38:10.568320 [info ] [MainThread]: 
[0m21:38:10.568711 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:38:10.569474 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:38:10.573806 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:38:10.573998 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:38:10.574154 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:38:10.967375 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:38:10.972195 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:38:10.976297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:38:10.985056 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:38:10.985534 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:38:10.985870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:38:11.341398 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:38:11.343200 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:38:11.344618 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:38:11.463190 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:38:11.468345 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:38:11.510915 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:38:11.526720 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.527257 [debug] [MainThread]: On master: BEGIN
[0m21:38:11.527648 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:38:11.834910 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:11.836091 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.836891 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:38:11.888028 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:38:11.892502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107114c10>]}
[0m21:38:11.893509 [debug] [MainThread]: On master: ROLLBACK
[0m21:38:11.930346 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.931363 [debug] [MainThread]: On master: BEGIN
[0m21:38:12.004833 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:12.005811 [debug] [MainThread]: On master: COMMIT
[0m21:38:12.006951 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:12.008048 [debug] [MainThread]: On master: COMMIT
[0m21:38:12.045246 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:38:12.046511 [debug] [MainThread]: On master: Close
[0m21:38:12.049701 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:38:12.050454 [info ] [MainThread]: 
[0m21:38:12.056204 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.057073 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:38:12.058157 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:38:12.058724 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.071470 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.072386 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:38:12.059092 => 21:38:12.072169
[0m21:38:12.072763 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.097756 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.098337 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.098570 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:38:12.098787 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:12.375833 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:12.377861 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.379378 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:38:31.181684 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:38:31.193793 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.194490 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:38:31.229007 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:31.234671 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.235477 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:38:31.269870 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:31.297806 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:38:31.298415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.298836 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:38:31.332542 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:31.339970 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:38:31.344739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.345097 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:38:31.392786 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:31.395535 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:38:12.072975 => 21:38:31.395191
[0m21:38:31.396224 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:38:31.397781 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108573450>]}
[0m21:38:31.398764 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.34s]
[0m21:38:31.399555 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:38:31.400336 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:38:31.401242 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:38:31.402294 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:38:31.402818 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:38:31.406308 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:38:31.407353 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:38:31.403140 => 21:38:31.407099
[0m21:38:31.407768 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:38:31.411944 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:38:31.412545 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:31.412883 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:38:31.413195 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:32.009717 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:38:32.011445 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.012806 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:38:32.063299 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:38:32.072042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.072890 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:38:32.104657 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.113177 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.113953 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:38:32.144976 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.149531 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:38:32.150542 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.151118 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:38:32.182381 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:32.186625 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:38:32.188004 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.188543 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:38:32.239454 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:32.244163 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:38:31.408013 => 21:38:32.243391
[0m21:38:32.245355 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:38:32.246970 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086de0d0>]}
[0m21:38:32.247946 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.84s]
[0m21:38:32.248774 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:38:32.249405 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.250096 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:38:32.250989 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:38:32.251721 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.255831 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.256873 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:38:32.252075 => 21:38:32.256589
[0m21:38:32.257309 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.261760 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.262532 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.262919 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:38:32.263234 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:32.535297 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:32.535714 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.535953 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:38:32.584837 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:38:32.587502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.587831 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:38:32.618296 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.620786 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.621088 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:38:32.651838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.653933 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:38:32.654329 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.654703 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:38:32.685575 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:32.688779 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:38:32.689808 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.690261 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:38:32.738960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:32.742303 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:38:32.257551 => 21:38:32.741880
[0m21:38:32.743150 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:38:32.744979 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086f88d0>]}
[0m21:38:32.746181 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.49s]
[0m21:38:32.747287 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.748069 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:38:32.748872 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:38:32.749895 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:38:32.750421 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:38:32.755468 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:38:32.756687 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:38:32.750721 => 21:38:32.756362
[0m21:38:32.757226 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:38:32.762449 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:38:32.763178 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:32.763566 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:38:32.763923 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:33.018581 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:33.020164 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.021182 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:38:33.059691 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:38:33.068236 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.069045 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:38:33.100273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.105591 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.106349 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:38:33.137946 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.142649 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:38:33.143510 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.144268 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:38:33.175099 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:33.180769 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:38:33.182343 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.182933 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:38:33.231562 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:33.234247 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:38:32.757524 => 21:38:33.233949
[0m21:38:33.234853 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:38:33.236491 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108732050>]}
[0m21:38:33.237466 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.49s]
[0m21:38:33.238261 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:38:33.238855 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.239623 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:38:33.240353 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:38:33.240748 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.245814 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.246656 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:38:33.241001 => 21:38:33.246462
[0m21:38:33.247007 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.250689 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.251284 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.251607 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:38:33.251904 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:33.568611 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:33.570676 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.572240 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:38:33.613369 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:33.622170 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.623038 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:38:33.661974 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.667550 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.668332 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:38:33.706809 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.711701 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:38:33.712314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.712845 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:38:33.751469 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:33.757846 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:38:33.759476 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.760200 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:38:33.815616 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:33.819217 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:38:33.247205 => 21:38:33.818821
[0m21:38:33.820039 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:38:33.821907 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108730990>]}
[0m21:38:33.823035 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.58s]
[0m21:38:33.823962 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.824635 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.825657 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:38:33.826639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:38:33.827185 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.834055 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.835327 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:38:33.827522 => 21:38:33.835030
[0m21:38:33.835823 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.840534 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.841257 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.841604 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:38:33.841929 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:34.098690 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:34.100719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:34.101868 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:38:41.186365 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:38:41.188747 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.189034 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:38:41.220390 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.222480 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.222742 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:38:41.253937 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.255590 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:38:41.255894 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.256118 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:38:41.287006 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:41.289063 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:38:41.289664 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.289890 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:38:41.336083 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:41.337337 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:38:33.836091 => 21:38:41.337180
[0m21:38:41.337652 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:38:41.338411 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10857d9d0>]}
[0m21:38:41.338837 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.51s]
[0m21:38:41.339229 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:41.339530 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.339961 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:38:41.340516 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:38:41.340793 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.342732 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.343367 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:38:41.340944 => 21:38:41.343241
[0m21:38:41.343607 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.346005 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.346440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.346635 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:38:41.346828 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:41.695081 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:41.695574 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.695830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:38:41.741201 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:41.746269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.746583 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:38:41.789653 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.792912 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.793379 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:38:41.836912 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.841356 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:38:41.842008 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.842571 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:38:41.885581 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:41.893489 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:38:41.894889 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.895608 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:38:41.958207 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:41.961672 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:38:41.343743 => 21:38:41.961252
[0m21:38:41.962504 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:38:41.964544 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086b86d0>]}
[0m21:38:41.965739 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.62s]
[0m21:38:41.966891 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.967806 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.968900 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:38:41.970058 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:38:41.970647 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.975773 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.977003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:38:41.971013 => 21:38:41.976689
[0m21:38:41.977567 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.982964 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.983780 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.984178 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:38:41.984556 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:42.237937 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:42.239062 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.239719 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:38:42.277275 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:38:42.284569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.285338 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:38:42.317027 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:42.323338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.324250 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.356291 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:42.360625 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:38:42.361450 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.362188 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:38:42.393333 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:42.399064 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:38:42.400821 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.401613 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:38:42.450830 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:42.452336 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:38:41.977861 => 21:38:42.452160
[0m21:38:42.452686 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:38:42.453498 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10876d6d0>]}
[0m21:38:42.453962 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.48s]
[0m21:38:42.454424 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:42.454775 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.455094 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:38:42.455694 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:38:42.456029 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.458389 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.458955 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:38:42.456209 => 21:38:42.458807
[0m21:38:42.459216 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.461795 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.462220 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.462447 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:38:42.462658 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:42.835155 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:42.836517 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.837447 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:38:47.360384 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:38:47.364685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.365172 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:38:47.404776 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:47.408806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.409386 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:38:47.448537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:47.450020 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:38:47.450287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.450522 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:38:47.489760 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:47.493086 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:38:47.493703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.493960 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:38:47.548358 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:47.549734 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:38:42.459363 => 21:38:47.549513
[0m21:38:47.550147 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:38:47.550968 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087806d0>]}
[0m21:38:47.551456 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.10s]
[0m21:38:47.551951 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:47.552323 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.552693 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:38:47.553411 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:38:47.553840 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.584380 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.584954 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:38:47.554074 => 21:38:47.584824
[0m21:38:47.585178 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.587617 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.587988 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.588191 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:38:47.588400 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:47.845293 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:47.847415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.849119 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:38:50.534709 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:38:50.537685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.538078 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:38:50.570032 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:50.572852 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.573215 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:38:50.605135 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:50.607412 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:38:50.607761 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.608078 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:38:50.640645 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:50.643099 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:38:50.643807 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.644099 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:38:50.689471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:50.690784 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:38:47.585312 => 21:38:50.690594
[0m21:38:50.691133 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:38:50.691880 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108780490>]}
[0m21:38:50.692380 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.14s]
[0m21:38:50.692896 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:38:50.693303 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.693690 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:38:50.694422 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:38:50.694869 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.697782 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.698538 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:38:50.695173 => 21:38:50.698356
[0m21:38:50.698860 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.702373 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.702877 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.703156 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:38:50.703400 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:51.162113 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:51.162835 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:51.163355 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:38:51.208531 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
LINE 26:     campaign_names_mapping.traffic_source,
             ^

[0m21:38:51.209185 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: ROLLBACK
[0m21:38:51.254063 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:38:50.699036 => 21:38:51.253687
[0m21:38:51.254589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:38:51.262407 [debug] [Thread-1 (]: Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 26:     campaign_names_mapping.traffic_source,
               ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m21:38:51.263020 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108740cd0>]}
[0m21:38:51.263616 [error] [Thread-1 (]: 11 of 21 ERROR creating sql table model danila.stg_records_gam_campaign__campaign_costs  [[31mERROR[0m in 0.57s]
[0m21:38:51.264192 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:51.264604 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:38:51.265037 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:38:51.265546 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:38:51.265826 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:38:51.268215 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:38:51.268772 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:38:51.265998 => 21:38:51.268611
[0m21:38:51.269047 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:38:51.281515 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:38:51.282038 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.282280 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:38:51.282505 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:51.536451 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:51.537028 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.537481 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:38:51.570833 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:38:51.573982 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.574356 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:38:51.605130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:51.608258 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.608568 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:38:51.639424 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:51.641212 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:38:51.641555 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.641864 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:38:51.674589 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:51.678266 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:38:51.681270 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.681639 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop view if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:38:51.714206 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:38:51.715526 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:38:51.269212 => 21:38:51.715334
[0m21:38:51.715894 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:38:51.716654 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084d0b50>]}
[0m21:38:51.717139 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.45s]
[0m21:38:51.717641 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:38:51.718027 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:38:51.718398 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:38:51.719000 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:38:51.719319 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:38:51.721215 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:38:51.721815 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:38:51.719520 => 21:38:51.721655
[0m21:38:51.722104 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:38:51.725475 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:38:51.725927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:51.726200 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:38:51.726461 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:52.017753 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:52.019696 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.021152 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:38:52.055110 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:52.062647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.063202 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:38:52.094793 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.100189 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.100980 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:38:52.132915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.137461 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:38:52.138263 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.138963 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:38:52.169753 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:52.176264 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:38:52.177402 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.177876 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:38:52.226023 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:52.228277 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:38:51.722271 => 21:38:52.227989
[0m21:38:52.228829 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:38:52.230043 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086856d0>]}
[0m21:38:52.230678 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.51s]
[0m21:38:52.231351 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:38:52.231815 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:38:52.232269 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:38:52.233072 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:38:52.233585 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:38:52.236615 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.237365 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:38:52.233866 => 21:38:52.237163
[0m21:38:52.237716 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:38:52.241503 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.241977 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.242255 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:38:52.242519 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:52.500967 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:52.501392 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.501697 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:38:52.730860 [debug] [Thread-1 (]: SQL status: SELECT 54043 in 0.0 seconds
[0m21:38:52.736372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.737034 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:38:52.768353 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.773646 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.774308 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:38:52.806149 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.810311 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:38:52.810890 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.811357 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:38:52.842768 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:52.847794 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:38:52.849113 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.849709 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:38:52.899234 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:52.902239 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:38:52.237925 => 21:38:52.901830
[0m21:38:52.903074 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:38:52.905092 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086555d0>]}
[0m21:38:52.906290 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54043[0m in 0.67s]
[0m21:38:52.907455 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:38:52.908377 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.909569 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:38:52.910863 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:38:52.911454 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.928061 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.929100 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:38:52.911832 => 21:38:52.928882
[0m21:38:52.929469 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.940516 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.941042 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.941306 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:38:52.941552 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.198777 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.199311 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:53.199722 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:38:53.232270 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:53.236050 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:38:52.929678 => 21:38:53.235672
[0m21:38:53.236751 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:38:53.268075 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:38:53.270476 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.36s]
[0m21:38:53.271615 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:53.272433 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.273263 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:38:53.274291 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:38:53.274800 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.283652 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.284715 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:38:53.275121 => 21:38:53.284463
[0m21:38:53.285161 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.287684 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.288312 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.288630 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:38:53.288930 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.544645 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.546633 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.547549 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:38:53.581257 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:53.584951 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:38:53.285416 => 21:38:53.584483
[0m21:38:53.585853 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:38:53.617707 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:38:53.621556 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m21:38:53.622832 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.623777 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.625148 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:38:53.626442 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:38:53.627066 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.633057 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.634554 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:38:53.627495 => 21:38:53.634071
[0m21:38:53.635159 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.640470 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.641312 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.641708 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:38:53.642088 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.901376 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.903569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.904556 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:38:54.336279 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 0.0 seconds
[0m21:38:54.345623 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.346197 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:38:54.377456 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.382721 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.383352 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:38:54.414427 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.418546 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:38:54.419291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.419842 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:38:54.451000 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:54.459403 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:38:54.460433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.460983 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:38:54.512295 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:54.516641 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:38:53.635467 => 21:38:54.516204
[0m21:38:54.517486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:38:54.519452 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10872b8d0>]}
[0m21:38:54.520479 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 0.89s]
[0m21:38:54.521397 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:54.522115 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.522941 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:38:54.523987 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:38:54.524518 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.529309 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.530375 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:38:54.524856 => 21:38:54.530095
[0m21:38:54.530867 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.535698 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.536462 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.536845 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:38:54.537220 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:54.794529 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:54.796575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.798187 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:38:54.856432 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:38:54.865606 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.866226 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:38:54.898377 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.907593 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.908244 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:38:54.940008 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.943365 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:38:54.944016 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.944574 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:38:54.975802 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:54.980711 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:38:54.982195 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.982770 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:38:55.032641 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:55.036037 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:38:54.531155 => 21:38:55.035633
[0m21:38:55.036837 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:38:55.038756 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083cb390>]}
[0m21:38:55.039889 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.51s]
[0m21:38:55.041040 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:38:55.041928 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.042988 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:38:55.044167 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:38:55.044765 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.049024 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.050545 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:38:55.045173 => 21:38:55.050306
[0m21:38:55.051061 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.056474 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.057338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.057733 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:38:55.058112 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:55.309877 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:55.311100 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.311891 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:38:55.345809 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:38:55.353249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.353765 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:38:55.384739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:55.387631 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:38:55.388345 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.388984 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:38:55.420132 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:55.426707 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:38:55.428037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.428804 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:38:55.460797 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:38:55.463626 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:38:55.051463 => 21:38:55.463211
[0m21:38:55.464355 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:38:55.465888 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871a450>]}
[0m21:38:55.466875 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.42s]
[0m21:38:55.467801 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.469281 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.469876 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:38:55.470763 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:38:55.471254 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.477414 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.478626 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:38:55.471557 => 21:38:55.478371
[0m21:38:55.479100 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.481699 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.482371 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.482687 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:38:55.482997 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:55.740488 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:55.742403 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.743258 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:38:55.776543 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:55.780570 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:38:55.479369 => 21:38:55.780115
[0m21:38:55.781398 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:38:55.813006 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:38:55.815989 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.35s]
[0m21:38:55.817134 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.818008 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.818972 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:38:55.820092 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:38:55.820670 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.828157 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.829204 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:38:55.821033 => 21:38:55.828925
[0m21:38:55.829689 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.832841 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.833668 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.834051 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:38:55.834417 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:56.159653 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:56.161685 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:56.163293 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:38:56.205707 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:56.210225 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:38:55.829975 => 21:38:56.209774
[0m21:38:56.211068 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:38:56.250607 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:38:56.254557 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.43s]
[0m21:38:56.256811 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:56.259512 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:56.259985 [debug] [MainThread]: On master: BEGIN
[0m21:38:56.260407 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:38:56.611425 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:56.612676 [debug] [MainThread]: On master: COMMIT
[0m21:38:56.613375 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:56.614010 [debug] [MainThread]: On master: COMMIT
[0m21:38:56.657047 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:38:56.658279 [debug] [MainThread]: On master: Close
[0m21:38:56.660413 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:38:56.661064 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:38:56.661908 [info ] [MainThread]: 
[0m21:38:56.662614 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 46.09 seconds (46.09s).
[0m21:38:56.667038 [debug] [MainThread]: Command end result
[0m21:38:56.682150 [info ] [MainThread]: 
[0m21:38:56.682620 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:38:56.682916 [info ] [MainThread]: 
[0m21:38:56.683210 [error] [MainThread]:   Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 26:     campaign_names_mapping.traffic_source,
               ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m21:38:56.683540 [info ] [MainThread]: 
[0m21:38:56.683850 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=1 SKIP=0 TOTAL=21
[0m21:38:56.686078 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 46.26934, "process_user_time": 1.991585, "process_kernel_time": 0.207605, "process_mem_max_rss": "126517248", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:38:56.686668 [debug] [MainThread]: Command `dbt build` failed at 21:38:56.686536 after 46.27 seconds
[0m21:38:56.687063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1036d8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103761f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10369c850>]}
[0m21:38:56.687425 [debug] [MainThread]: Flushing usage events
[0m21:41:11.748258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721f790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292a50>]}


============================== 21:41:11.749840 | aeab40e7-d630-4f76-a718-2b02e2defc5a ==============================
[0m21:41:11.749840 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:41:11.750193 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'profiles_dir': '/Users/danila/.dbt', 'static_parser': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'no_print': 'None', 'printer_width': '80', 'log_cache_events': 'False', 'invocation_command': 'dbt build', 'quiet': 'False', 'warn_error': 'None', 'version_check': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'use_colors': 'True', 'partial_parse': 'True', 'fail_fast': 'False', 'log_format': 'default', 'target_path': 'None'}
[0m21:41:11.818981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721ecd0>]}
[0m21:41:11.849006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c7650>]}
[0m21:41:11.849413 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:41:11.856318 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:41:11.875726 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:41:11.875943 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:41:11.876449 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:41:11.879260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079d7950>]}
[0m21:41:11.885242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107903ed0>]}
[0m21:41:11.885505 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:41:11.886635 [info ] [MainThread]: 
[0m21:41:11.887014 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:41:11.887703 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:41:11.891945 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:41:11.892126 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:41:11.892282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:41:12.187242 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:41:12.191048 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:41:12.195855 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:41:12.205182 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:41:12.205858 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:41:12.206284 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:41:12.559663 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:41:12.561160 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:41:12.562063 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:41:12.612171 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:41:12.617221 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:41:12.660607 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:41:12.674779 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:12.675365 [debug] [MainThread]: On master: BEGIN
[0m21:41:12.675788 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:41:12.994086 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:12.995385 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:12.996259 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:41:13.045116 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:41:13.046939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107770410>]}
[0m21:41:13.047351 [debug] [MainThread]: On master: ROLLBACK
[0m21:41:13.086052 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:13.086394 [debug] [MainThread]: On master: BEGIN
[0m21:41:13.161118 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:13.162204 [debug] [MainThread]: On master: COMMIT
[0m21:41:13.162898 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:13.163469 [debug] [MainThread]: On master: COMMIT
[0m21:41:13.201321 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:41:13.202591 [debug] [MainThread]: On master: Close
[0m21:41:13.205762 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:41:13.206735 [info ] [MainThread]: 
[0m21:41:13.213087 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.214089 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:41:13.215264 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:41:13.215887 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.229217 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.230417 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:41:13.216269 => 21:41:13.230150
[0m21:41:13.230856 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.256657 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.257463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.257731 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:41:13.257956 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:13.539352 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:13.541425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.544049 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:41:30.328907 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:41:30.343779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.345580 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:41:30.377516 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:30.384665 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.385402 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:41:30.417395 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:30.450319 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:41:30.451418 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.451951 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:41:30.483472 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:30.495742 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:41:30.503129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.503868 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:41:30.547711 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:30.551067 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:41:13.231100 => 21:41:30.550729
[0m21:41:30.551742 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:41:30.553281 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078f8b50>]}
[0m21:41:30.554253 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 17.34s]
[0m21:41:30.555244 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:41:30.555995 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:41:30.556785 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:41:30.557888 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:41:30.558447 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:41:30.564273 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:41:30.565584 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:41:30.558973 => 21:41:30.565313
[0m21:41:30.566113 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:41:30.571307 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:41:30.572059 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:30.572458 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:41:30.572848 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:30.967003 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:30.968509 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:30.970071 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:41:31.031769 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:41:31.039817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.040447 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:41:31.084065 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.093961 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.095488 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:41:31.139454 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.142310 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:41:31.142788 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.143194 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:41:31.185838 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:31.192271 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:41:31.193484 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.193981 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:41:31.256836 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:31.260359 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:41:30.566417 => 21:41:31.259615
[0m21:41:31.261734 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:41:31.264690 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b364d0>]}
[0m21:41:31.266724 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.71s]
[0m21:41:31.268754 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:41:31.270287 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.271822 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:41:31.273549 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:41:31.274644 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.280737 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.282798 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:41:31.275246 => 21:41:31.282437
[0m21:41:31.283486 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.289741 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.290967 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.291525 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:41:31.292358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:31.568633 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:31.570278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.571195 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:41:31.625064 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:41:31.627254 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.627507 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:41:31.660993 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.663118 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.663406 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:41:31.698998 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.701077 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:41:31.701467 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.701850 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:41:31.735136 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:31.740175 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:41:31.741573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.742121 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:41:31.793345 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:31.796690 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:41:31.283829 => 21:41:31.796335
[0m21:41:31.797391 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:41:31.799256 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b3b4d0>]}
[0m21:41:31.800280 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.53s]
[0m21:41:31.801275 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.802013 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:41:31.802962 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:41:31.804491 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:41:31.805082 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:41:31.810642 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:41:31.812231 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:41:31.805482 => 21:41:31.811940
[0m21:41:31.812853 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:41:31.819462 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:41:31.820983 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:31.821671 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:41:31.822350 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:32.082965 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:32.084203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.084941 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:41:32.122709 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:41:32.130206 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.131112 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:41:32.163725 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.173616 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.174470 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:41:32.206048 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.213633 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:41:32.215061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.216404 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:41:32.247819 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:32.256937 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:41:32.259897 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.260883 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:41:32.311208 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:32.316097 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:41:31.813238 => 21:41:32.315302
[0m21:41:32.317557 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:41:32.320721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10778a990>]}
[0m21:41:32.322681 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.52s]
[0m21:41:32.324727 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:41:32.326056 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.327587 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:41:32.329329 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:41:32.330128 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.338985 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.340824 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:41:32.330622 => 21:41:32.340408
[0m21:41:32.341513 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.348559 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.349649 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.350149 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:41:32.350549 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:32.692205 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:32.693822 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.695379 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:41:32.729550 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:32.737863 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.738494 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:41:32.769779 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.775077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.775750 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:41:32.807475 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.814970 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:41:32.816406 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.817840 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:41:32.850192 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:32.860272 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:41:32.862232 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.863078 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:41:32.912354 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:32.915292 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:41:32.341917 => 21:41:32.914998
[0m21:41:32.915838 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:41:32.917437 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a09a90>]}
[0m21:41:32.918606 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.59s]
[0m21:41:32.919337 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.920181 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.921360 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:41:32.923171 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:41:32.923896 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.933781 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.934973 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:41:32.924406 => 21:41:32.934641
[0m21:41:32.935510 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.941631 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.942543 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.943028 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:41:32.943598 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:33.294338 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:33.295667 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:33.296646 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:41:40.499157 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:41:40.508395 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.509462 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:41:40.560325 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:40.563049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.563398 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:41:40.611824 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:40.620466 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:41:40.621935 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.623253 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:41:40.671447 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:40.677659 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:41:40.678764 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.679209 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:41:40.747472 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:40.750003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:41:32.935819 => 21:41:40.749676
[0m21:41:40.750716 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:41:40.752180 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10790c690>]}
[0m21:41:40.753165 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.83s]
[0m21:41:40.753957 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:40.754498 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.755169 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:41:40.756100 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:41:40.756645 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.759010 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.759710 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:41:40.757140 => 21:41:40.759570
[0m21:41:40.759945 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.762775 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.763802 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.764019 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:41:40.764213 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:41.023279 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:41.024700 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.025573 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:41:41.058828 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:41.069330 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.070292 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:41:41.102407 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.109479 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.110213 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:41:41.142081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.148254 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:41:41.149025 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.149652 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:41:41.180684 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:41.186089 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:41:41.187536 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.188473 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:41:41.239250 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:41.244353 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:41:40.760071 => 21:41:41.243725
[0m21:41:41.245346 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:41:41.246928 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077435d0>]}
[0m21:41:41.247953 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.49s]
[0m21:41:41.248960 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:41.249734 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.250997 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:41:41.252251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:41:41.252858 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.258827 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.260265 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:41:41.253328 => 21:41:41.259961
[0m21:41:41.260787 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.266742 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.268026 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.268552 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:41:41.269005 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:41.525807 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:41.527280 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.528025 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:41:41.565306 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:41:41.572899 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.574230 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:41:41.606542 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.614719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.615408 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.647169 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.653346 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:41:41.654836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.656166 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:41:41.688258 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:41.698370 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:41:41.701489 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.702734 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:41:41.751726 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:41.756834 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:41:41.261108 => 21:41:41.756055
[0m21:41:41.758286 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:41:41.761442 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079a3510>]}
[0m21:41:41.763424 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.51s]
[0m21:41:41.765139 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.766307 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.767670 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:41:41.769510 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:41:41.770636 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.778174 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.779835 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:41:41.771620 => 21:41:41.779456
[0m21:41:41.780546 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.787747 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.789196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.790151 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:41:41.790704 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:42.142024 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:42.144000 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:42.145693 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:41:46.722725 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:41:46.734657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.735794 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:41:46.779033 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:46.783878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.784484 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:41:46.827706 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:46.829421 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:41:46.829701 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.829950 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:41:46.872501 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:46.876713 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:41:46.877486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.877832 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:41:46.937323 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:46.939879 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:41:41.780957 => 21:41:46.939545
[0m21:41:46.940487 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:41:46.941908 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107bc1dd0>]}
[0m21:41:46.942844 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.17s]
[0m21:41:46.943699 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:46.944354 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.945076 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:41:46.945960 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:41:46.946423 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.990514 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.991164 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:41:46.946731 => 21:41:46.991022
[0m21:41:46.991406 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.993920 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.994236 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.994408 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:41:46.994565 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:47.349067 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:47.351050 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:47.352624 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:41:50.135358 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:41:50.147584 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.149072 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:41:50.193600 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.204308 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.205368 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:41:50.249722 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.258342 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:41:50.259581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.260482 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:41:50.304331 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:50.313741 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:41:50.316771 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.317742 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:41:50.377735 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:50.382458 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:41:46.991551 => 21:41:50.381715
[0m21:41:50.383808 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:41:50.386685 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107bc4450>]}
[0m21:41:50.388544 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.44s]
[0m21:41:50.390137 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:41:50.391207 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.392554 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:41:50.394148 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:41:50.395073 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.402112 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.403598 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:41:50.395679 => 21:41:50.403302
[0m21:41:50.404197 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.410305 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.411650 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.412181 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:41:50.412633 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:50.669397 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:50.671344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.672949 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:41:50.746245 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:41:50.759065 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.760591 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:41:50.791933 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.802264 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.803615 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:41:50.835294 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.843188 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:41:50.844511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.845775 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:41:50.877385 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:50.887214 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:41:50.889384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.890327 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:41:50.939525 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:50.944289 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:41:50.404588 => 21:41:50.943529
[0m21:41:50.945666 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:41:50.948523 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b9c950>]}
[0m21:41:50.950425 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.55s]
[0m21:41:50.952046 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.953118 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:41:50.954352 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:41:50.955892 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:41:50.956569 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:41:50.962706 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:41:50.964805 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:41:50.957024 => 21:41:50.963963
[0m21:41:50.965376 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:41:50.989620 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:41:50.990546 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:50.990891 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:41:50.991208 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:51.316386 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:51.318400 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.319830 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:41:51.363256 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:41:51.376556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.377858 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:41:51.431838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:51.443338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.444440 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:41:51.484649 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:51.491226 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:41:51.492511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.493748 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:41:51.533674 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:51.543628 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:41:51.553302 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.554071 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop view if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:41:51.595975 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:41:51.600733 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:41:50.965750 => 21:41:51.599982
[0m21:41:51.602061 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:41:51.604931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b4a350>]}
[0m21:41:51.606803 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.65s]
[0m21:41:51.608717 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:41:51.610029 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:41:51.611260 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:41:51.612938 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:41:51.613877 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:41:51.619316 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:41:51.620841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:41:51.614375 => 21:41:51.620509
[0m21:41:51.621399 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:41:51.628177 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:41:51.629582 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:51.630031 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:41:51.630442 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:52.013907 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:52.015895 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.017316 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:41:52.057522 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:52.070046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.071361 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:41:52.109381 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.120909 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.122336 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:41:52.159906 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.167456 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:41:52.168807 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.170086 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:41:52.206717 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:52.216690 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:41:52.219677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.220955 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:41:52.276383 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:52.281075 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:41:51.621746 => 21:41:52.280344
[0m21:41:52.282419 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:41:52.285361 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ae47d0>]}
[0m21:41:52.287310 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.67s]
[0m21:41:52.288983 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:41:52.290109 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:41:52.291442 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:41:52.293225 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:41:52.294187 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:41:52.301236 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.303801 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:41:52.294820 => 21:41:52.303450
[0m21:41:52.304433 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:41:52.310985 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.312380 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.313057 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:41:52.313698 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:52.659868 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:52.661877 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.663480 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:41:52.908405 [debug] [Thread-1 (]: SQL status: SELECT 54046 in 0.0 seconds
[0m21:41:52.921693 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.923230 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:41:52.964374 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.980296 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.981323 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:41:53.021723 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:53.029795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:41:53.031161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:53.032410 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:41:53.072235 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:53.081767 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:41:53.084093 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:53.085048 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:41:53.144251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:53.147360 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:41:52.304786 => 21:41:53.146924
[0m21:41:53.148225 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:41:53.149851 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107816fd0>]}
[0m21:41:53.151088 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54046[0m in 0.86s]
[0m21:41:53.152769 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:41:53.154344 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.156260 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:41:53.158354 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:41:53.159413 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.178620 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.180604 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:41:53.160072 => 21:41:53.180292
[0m21:41:53.181155 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.195535 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.196215 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.196548 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:41:53.196858 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:53.452387 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:53.454485 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.456015 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:41:53.488038 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:53.495540 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:41:53.181462 => 21:41:53.494648
[0m21:41:53.497093 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:41:53.528023 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:41:53.531641 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.37s]
[0m21:41:53.533717 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.535244 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.536803 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:41:53.539235 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:41:53.540247 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.553886 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.555742 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:41:53.540877 => 21:41:53.555389
[0m21:41:53.556383 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.560466 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.561452 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.561926 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:41:53.562405 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:53.821401 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:53.823501 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.824962 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:41:53.858657 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:53.863897 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:41:53.556726 => 21:41:53.863079
[0m21:41:53.865319 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:41:53.897252 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:41:53.900808 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.36s]
[0m21:41:53.902816 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.904197 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.905665 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:41:53.907291 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:41:53.908335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.916489 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.918084 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:41:53.909058 => 21:41:53.917750
[0m21:41:53.918708 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.925257 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.926714 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.927231 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:41:53.927894 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:54.182251 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:54.184295 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.185953 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:41:54.652095 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 0.0 seconds
[0m21:41:54.664605 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.665682 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:41:54.719670 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:54.730648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.731693 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:41:54.764276 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:54.771891 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:41:54.773245 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.774519 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:41:54.806246 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:54.816062 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:41:54.818211 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.819125 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:41:54.873107 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:54.878177 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:41:53.919094 => 21:41:54.877384
[0m21:41:54.879571 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:41:54.882536 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107773650>]}
[0m21:41:54.884480 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 0.98s]
[0m21:41:54.886123 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:54.887212 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.888426 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:41:54.890142 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:41:54.891104 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.902261 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.904072 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:41:54.891747 => 21:41:54.903737
[0m21:41:54.904641 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.911061 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.912473 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.913005 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:41:54.913454 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:55.168782 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:55.170763 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.172329 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:41:55.228837 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:41:55.242376 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.243830 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:41:55.275909 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.286621 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.288032 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:41:55.319594 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.327061 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:41:55.328481 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.329800 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:41:55.360430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:55.370240 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:41:55.373334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.374632 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:41:55.427429 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:55.432135 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:41:54.904962 => 21:41:55.431363
[0m21:41:55.433518 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:41:55.436485 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b7d190>]}
[0m21:41:55.438074 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.55s]
[0m21:41:55.439520 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:41:55.440607 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.441885 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:41:55.443587 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:41:55.444555 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.450440 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.451955 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:41:55.445193 => 21:41:55.451647
[0m21:41:55.452542 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.459045 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.460587 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.461138 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:41:55.461764 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:55.738458 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:55.740514 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.741938 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:41:55.779375 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:41:55.791990 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.793495 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:41:55.828100 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.834684 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:41:55.836154 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.837471 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:41:55.871964 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:55.882827 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:41:55.885981 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.887322 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:41:55.922198 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:41:55.927247 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:41:55.452929 => 21:41:55.926480
[0m21:41:55.928626 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:41:55.931594 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b7d750>]}
[0m21:41:55.933508 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.49s]
[0m21:41:55.935349 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.937576 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.938575 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:41:55.939827 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:41:55.940581 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.948828 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.951883 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:41:55.941068 => 21:41:55.951459
[0m21:41:55.952539 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.956327 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.957636 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.958135 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:41:55.958676 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:56.216700 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.218773 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:56.220247 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:41:56.254060 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:56.259438 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:41:55.952909 => 21:41:56.258622
[0m21:41:56.260876 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:41:56.292899 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:41:56.296545 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.36s]
[0m21:41:56.298642 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:56.300173 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.301735 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:41:56.304182 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:41:56.305546 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.315567 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.317353 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:41:56.306342 => 21:41:56.316997
[0m21:41:56.318059 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.325786 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.327237 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.327897 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:41:56.328377 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:56.585576 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.587673 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.589145 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:41:56.622451 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:56.627830 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:41:56.318428 => 21:41:56.626976
[0m21:41:56.629252 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:41:56.660535 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:41:56.664040 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.36s]
[0m21:41:56.666096 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.669640 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:56.670529 [debug] [MainThread]: On master: BEGIN
[0m21:41:56.671305 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:41:56.925716 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.926657 [debug] [MainThread]: On master: COMMIT
[0m21:41:56.927196 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:56.927683 [debug] [MainThread]: On master: COMMIT
[0m21:41:56.959124 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:41:56.960483 [debug] [MainThread]: On master: Close
[0m21:41:56.963453 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:41:56.964544 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:41:56.966007 [info ] [MainThread]: 
[0m21:41:56.967099 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 45.08 seconds (45.08s).
[0m21:41:56.973846 [debug] [MainThread]: Command end result
[0m21:41:56.991263 [info ] [MainThread]: 
[0m21:41:56.991841 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:41:56.992273 [info ] [MainThread]: 
[0m21:41:56.992702 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:41:56.995402 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 45.27271, "process_user_time": 2.665297, "process_kernel_time": 0.234102, "process_mem_max_rss": "127303680", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:41:56.996121 [debug] [MainThread]: Command `dbt build` succeeded at 21:41:56.995965 after 45.27 seconds
[0m21:41:56.996596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106afa790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102ba1f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b85750>]}
[0m21:41:56.997009 [debug] [MainThread]: Flushing usage events
[0m21:43:43.964837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10738fb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107406cd0>]}


============================== 21:43:43.966288 | de570ae7-7030-447a-9a3a-ad7cb80f2b71 ==============================
[0m21:43:43.966288 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:43:43.966621 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'log_format': 'default', 'use_colors': 'True', 'static_parser': 'True', 'invocation_command': 'dbt build', 'version_check': 'True', 'write_json': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_path': '/Users/danila/github/dbt/logs', 'warn_error': 'None', 'no_print': 'None', 'debug': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'profiles_dir': '/Users/danila/.dbt', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'quiet': 'False', 'introspect': 'True'}
[0m21:43:44.033271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1b90>]}
[0m21:43:44.064645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107963cd0>]}
[0m21:43:44.065204 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:43:44.072000 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:43:44.085277 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:43:44.085625 [debug] [MainThread]: Partial parsing: added file: campaign_perfomance://models/brand_performance/outclick_cost_int_new.sql
[0m21:43:44.136050 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:43:44.138277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c97890>]}
[0m21:43:44.143936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c63f90>]}
[0m21:43:44.144224 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:43:44.145344 [info ] [MainThread]: 
[0m21:43:44.145726 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:43:44.146427 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:43:44.150496 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:43:44.150696 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:43:44.150855 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:43:44.560011 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:43:44.563016 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:43:44.565900 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:43:44.572399 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:43:44.572824 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:43:44.573127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:43:45.124808 [debug] [ThreadPool]: SQL status: BEGIN in 1.0 seconds
[0m21:43:45.125976 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:43:45.126686 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:43:45.164099 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:43:45.168537 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:43:45.202536 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:43:45.218362 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.218818 [debug] [MainThread]: On master: BEGIN
[0m21:43:45.219143 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:43:45.532238 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:43:45.533546 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.534505 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:43:45.579745 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:43:45.583575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b2e010>]}
[0m21:43:45.584294 [debug] [MainThread]: On master: ROLLBACK
[0m21:43:45.641467 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.642604 [debug] [MainThread]: On master: BEGIN
[0m21:43:45.709160 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:43:45.710445 [debug] [MainThread]: On master: COMMIT
[0m21:43:45.711256 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.711958 [debug] [MainThread]: On master: COMMIT
[0m21:43:45.746701 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:43:45.747909 [debug] [MainThread]: On master: Close
[0m21:43:45.750074 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:43:45.750825 [info ] [MainThread]: 
[0m21:43:45.754876 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.755622 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:43:45.756578 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:43:45.757067 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.767345 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.768252 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:43:45.757331 => 21:43:45.768030
[0m21:43:45.768606 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.792862 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.793471 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.793689 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:43:45.793892 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:43:46.097946 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:43:46.098941 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:46.100154 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:44:05.081888 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:44:05.099604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.100505 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:44:05.140701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.149220 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.150336 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:44:05.187944 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.210586 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:05.211110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.211444 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:05.248937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:05.256826 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:44:05.260650 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.260962 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:44:05.311739 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:05.313634 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:43:45.768812 => 21:44:05.313299
[0m21:44:05.314142 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:44:05.315363 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d41a10>]}
[0m21:44:05.316125 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.56s]
[0m21:44:05.316875 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:44:05.317413 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:44:05.318032 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:44:05.318852 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:44:05.319285 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:44:05.322457 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:44:05.323321 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:44:05.319544 => 21:44:05.323095
[0m21:44:05.323668 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:44:05.327417 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:44:05.328040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.328376 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:44:05.328680 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:05.640612 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:05.642615 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.644013 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:05.693136 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:44:05.701072 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.701818 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:44:05.733395 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.740704 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.741326 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:44:05.772354 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.779716 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:05.780997 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.782124 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:05.812141 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:05.814786 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:44:05.815607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.815938 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:44:05.863118 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:05.864902 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:44:05.323877 => 21:44:05.864636
[0m21:44:05.865391 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:44:05.866476 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1650>]}
[0m21:44:05.867215 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.55s]
[0m21:44:05.867941 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:44:05.868494 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.869059 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:44:05.869777 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:44:05.870166 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.873294 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.874120 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:44:05.870407 => 21:44:05.873897
[0m21:44:05.874516 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.878175 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.878773 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.879095 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:44:05.879435 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:06.202982 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:06.205011 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.206454 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:06.268293 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:44:06.281267 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.281793 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:44:06.321629 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.328948 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.329741 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:44:06.369437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.371269 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:06.371561 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.371804 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:06.410498 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:06.412625 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:44:06.413294 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.413584 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:44:06.472534 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:06.474173 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:44:05.874719 => 21:44:06.473902
[0m21:44:06.474658 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:44:06.475671 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079d7550>]}
[0m21:44:06.476366 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.61s]
[0m21:44:06.477084 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:06.477627 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:44:06.478266 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:44:06.479079 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:44:06.479534 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:44:06.482607 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:44:06.483373 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:44:06.479775 => 21:44:06.483164
[0m21:44:06.483753 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:44:06.489294 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:44:06.489909 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.490217 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:44:06.490508 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:06.749309 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:06.751426 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.752547 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:44:06.790884 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:44:06.800217 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.800628 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:44:06.831713 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.834848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.835256 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:44:06.865929 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.868362 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:06.868809 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.869232 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:06.899493 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:06.904208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:44:06.905540 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.906085 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:44:06.954613 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:06.958705 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:44:06.483982 => 21:44:06.958101
[0m21:44:06.959629 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:44:06.961443 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b79950>]}
[0m21:44:06.962415 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.48s]
[0m21:44:06.963261 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:44:06.963932 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.964872 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:44:06.965848 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:44:06.966329 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.971574 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.972814 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:44:06.966610 => 21:44:06.972511
[0m21:44:06.973369 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.978374 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.979131 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.979458 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:44:06.979771 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:07.261817 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:07.263872 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.265359 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:44:07.299477 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:07.305841 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.306448 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:44:07.337417 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:07.342681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.343536 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:44:07.375299 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:07.380049 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:07.380792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.381330 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:07.412644 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:07.419302 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:44:07.421112 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.421837 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:44:07.471063 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:07.475709 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:44:06.973679 => 21:44:07.475232
[0m21:44:07.476570 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:44:07.478231 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cd2210>]}
[0m21:44:07.479186 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.51s]
[0m21:44:07.480030 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:07.480683 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.481655 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:44:07.482548 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:44:07.483027 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.489907 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.490993 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:44:07.483321 => 21:44:07.490730
[0m21:44:07.491474 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.496095 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.496704 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.497040 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:44:07.497358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:07.767399 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:07.769516 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.771543 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:44:14.643699 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:44:14.654101 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.654681 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:44:14.685470 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:14.690981 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.691389 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:44:14.722671 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:14.725756 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:14.726300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.726716 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:14.757053 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:14.812911 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:44:14.813651 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.813896 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:44:14.861567 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:14.862700 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:44:07.491740 => 21:44:14.862534
[0m21:44:14.863009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:44:14.863720 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10797bb90>]}
[0m21:44:14.864162 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.38s]
[0m21:44:14.864616 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:14.864970 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.865421 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:44:14.866008 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:44:14.866319 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.868332 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.868944 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:44:14.866499 => 21:44:14.868792
[0m21:44:14.869217 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.872169 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.872633 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.872888 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:44:14.873127 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:15.125606 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:15.127622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.129102 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:44:15.162638 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:15.168423 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.169009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:44:15.200093 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.204561 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.205103 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:44:15.236224 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.240882 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:15.241580 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.242213 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:15.273434 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:15.282197 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:44:15.283336 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.283723 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:44:15.331251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:15.333361 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:44:14.869384 => 21:44:15.333101
[0m21:44:15.333830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:44:15.335208 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b06d50>]}
[0m21:44:15.336021 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.47s]
[0m21:44:15.337083 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:15.337718 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.338442 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:44:15.339369 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:44:15.339850 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.343135 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.344053 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:44:15.340153 => 21:44:15.343802
[0m21:44:15.344476 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.348972 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.349622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.349955 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:44:15.350280 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:15.625722 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:15.627433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.628311 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:44:15.667958 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:44:15.678790 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.679385 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:15.713297 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.719184 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.719960 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.754428 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.759856 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:15.760533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.761059 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:15.795059 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:15.801120 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:15.802250 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.802758 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:44:15.854065 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:15.859329 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:44:15.344729 => 21:44:15.858553
[0m21:44:15.860721 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:44:15.862628 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d25dd0>]}
[0m21:44:15.863428 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.52s]
[0m21:44:15.864060 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.864497 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.864991 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:44:15.865607 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:44:15.865951 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.868992 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.869769 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:44:15.866177 => 21:44:15.869580
[0m21:44:15.870067 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.874871 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.875368 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.875660 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:44:15.875936 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:16.178650 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:16.180663 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:16.182376 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:44:20.778552 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:44:20.788962 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.789773 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:20.826846 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:20.832025 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.832707 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:44:20.869795 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:20.875110 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:20.875865 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.876471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:20.913896 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:20.923965 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:20.925269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.925762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:44:20.977918 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:20.981384 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:44:15.870242 => 21:44:20.980925
[0m21:44:20.982224 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:44:20.984068 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e36d0>]}
[0m21:44:20.985248 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.12s]
[0m21:44:20.986353 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:20.987202 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:20.988004 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:44:20.989003 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:44:20.989565 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:44:20.994546 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:20.995948 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:44:20.989909 => 21:44:20.995554
[0m21:44:20.996519 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:44:21.002098 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.003040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.003492 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:44:21.003867 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:21.283029 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:21.284757 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.285640 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:44:24.135882 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:44:24.146261 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.146829 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:44:24.180368 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.186168 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.186797 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:44:24.220621 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.229369 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:24.230743 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.232086 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:24.284994 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:24.292335 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:44:24.293476 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.293942 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:44:24.343136 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:24.346618 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:44:20.996815 => 21:44:24.346189
[0m21:44:24.347331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:44:24.348982 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf5990>]}
[0m21:44:24.350015 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.36s]
[0m21:44:24.351029 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:24.351812 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.352693 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:44:24.354051 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:44:24.354647 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.359875 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.361442 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:44:24.354964 => 21:44:24.360897
[0m21:44:24.362080 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.367961 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.368994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.369502 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:44:24.369915 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:24.756432 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:24.758648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.760353 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:44:24.861590 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:44:24.871305 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.871866 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:24.915550 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.919145 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.919641 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:44:24.963723 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.969361 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:24.970244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.970932 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:25.015280 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:25.023560 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:25.024637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:25.025066 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:44:25.087712 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:25.091990 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:44:24.362379 => 21:44:25.091537
[0m21:44:25.092833 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:44:25.094641 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b79950>]}
[0m21:44:25.095794 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.74s]
[0m21:44:25.096856 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:25.097667 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:44:25.098613 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:44:25.099850 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:44:25.100369 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:44:25.104920 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:44:25.106139 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:44:25.100690 => 21:44:25.105798
[0m21:44:25.106622 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:44:25.112430 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:44:25.113367 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.113776 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:44:25.114149 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:25.461367 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:25.463511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.465011 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:44:25.506577 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:25.514191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.514759 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:44:25.555161 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:25.565018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.565498 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:44:25.605463 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:25.613121 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:25.613712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.614138 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:25.652791 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:25.657693 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:44:25.658923 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.659349 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:44:25.718273 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:25.722936 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:44:25.106901 => 21:44:25.722512
[0m21:44:25.723677 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:44:25.725475 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ab09d0>]}
[0m21:44:25.726539 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.63s]
[0m21:44:25.727354 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:44:25.727985 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:44:25.728684 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:44:25.729619 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:44:25.730137 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:44:25.735180 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.736257 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:44:25.730455 => 21:44:25.735968
[0m21:44:25.736742 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:44:25.741977 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.742731 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.743121 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:44:25.743492 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:26.019516 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:26.021599 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.023099 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:44:26.307220 [debug] [Thread-1 (]: SQL status: SELECT 54050 in 0.0 seconds
[0m21:44:26.317521 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.318007 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:44:26.351007 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:26.353630 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.353933 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:44:26.387494 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:26.388991 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:26.389218 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.389434 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:26.422876 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:26.425989 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:44:26.426638 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.426918 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:44:26.479369 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:26.480691 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:44:25.737036 => 21:44:26.480476
[0m21:44:26.481091 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:44:26.481924 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cd4150>]}
[0m21:44:26.482486 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54050[0m in 0.75s]
[0m21:44:26.483113 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:44:26.483557 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.484067 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:44:26.484895 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:44:26.485314 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.495468 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.496149 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:44:26.485558 => 21:44:26.495981
[0m21:44:26.496455 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.506076 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.506598 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.506842 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:44:26.507065 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:26.913477 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:26.915512 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.916554 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:44:26.953956 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:26.959130 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:44:26.496633 => 21:44:26.958765
[0m21:44:26.959722 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:44:26.995725 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:44:26.997872 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.51s]
[0m21:44:26.998996 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.999830 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.000648 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:44:27.001903 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:44:27.002581 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.013100 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.014393 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:44:27.003008 => 21:44:27.014041
[0m21:44:27.014950 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.017911 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.018601 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.018990 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:44:27.019366 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:27.354089 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:27.356125 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.357571 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:44:27.399540 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:27.404528 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:44:27.015243 => 21:44:27.404138
[0m21:44:27.405120 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:44:27.444311 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:44:27.446606 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.45s]
[0m21:44:27.447597 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.448288 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.449276 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:44:27.450162 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:44:27.450627 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.456502 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.457587 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:44:27.450907 => 21:44:27.457311
[0m21:44:27.458067 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.462801 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.463530 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.463908 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:44:27.464272 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:27.740518 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:27.742566 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.744241 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:44:28.254799 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 1.0 seconds
[0m21:44:28.265568 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.266092 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:44:28.299297 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.304163 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.304722 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:44:28.338437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.342387 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:44:28.343078 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.343604 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:44:28.376745 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:28.387698 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:44:28.390836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.391683 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:44:28.451225 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:28.453827 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:44:27.458347 => 21:44:28.453480
[0m21:44:28.454450 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:44:28.455940 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ab2c50>]}
[0m21:44:28.456840 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 1.01s]
[0m21:44:28.457604 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:28.458186 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.458823 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m21:44:28.459582 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m21:44:28.460009 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.465873 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.466943 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 21:44:28.460260 => 21:44:28.466680
[0m21:44:28.467384 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.473959 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.474629 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.474961 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m21:44:28.475274 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:28.731252 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:28.733296 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.735201 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        betting_type,
        NULL as brand_name, 
        NULL as unique_outclicks,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:44:28.843621 [debug] [Thread-1 (]: SQL status: SELECT 45246 in 0.0 seconds
[0m21:44:28.854021 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.854536 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m21:44:28.885505 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.889331 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.889795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m21:44:28.921132 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.925005 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:44:28.925657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.926176 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:44:28.957246 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:28.963239 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m21:44:28.964911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.965456 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m21:44:29.018233 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:29.021923 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 21:44:28.467629 => 21:44:29.021427
[0m21:44:29.022810 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m21:44:29.024759 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e344d0>]}
[0m21:44:29.026013 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45246[0m in 0.57s]
[0m21:44:29.027132 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:29.027844 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.028635 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:44:29.029652 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:44:29.030189 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.035775 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.037367 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:44:29.030502 => 21:44:29.037023
[0m21:44:29.037904 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.043205 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.043911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.044285 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:44:29.044632 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:29.304018 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:29.306061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.307676 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:44:29.368213 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:44:29.378189 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.378773 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:44:29.410636 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.416465 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.417192 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:44:29.449141 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.455452 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:44:29.455888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.456251 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:44:29.486727 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:29.491602 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:44:29.492817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.493326 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:44:29.542073 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:29.546852 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:44:29.038195 => 21:44:29.546088
[0m21:44:29.548202 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:44:29.550169 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e00750>]}
[0m21:44:29.551049 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.52s]
[0m21:44:29.551844 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.552411 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.553071 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:44:29.553821 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:44:29.554245 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.557162 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.558082 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:44:29.554502 => 21:44:29.557832
[0m21:44:29.558504 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.573183 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.573741 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.574004 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:44:29.574252 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:29.830106 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:29.832248 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.833455 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:44:29.868321 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:44:29.878354 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.878903 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:44:29.909667 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.912317 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:29.912842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.913279 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:29.943709 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:29.952432 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:44:29.957347 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.957808 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:44:29.989041 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:44:29.991859 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:44:29.558749 => 21:44:29.991430
[0m21:44:29.992595 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:44:29.994317 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b06390>]}
[0m21:44:29.995425 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.44s]
[0m21:44:29.996465 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.997762 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:29.998450 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:44:29.999355 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:44:29.999863 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.006576 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.007671 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:44:30.000190 => 21:44:30.007381
[0m21:44:30.008177 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.010595 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.011256 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.011644 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:44:30.012016 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:30.315712 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:30.316939 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.317712 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:44:30.356660 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:30.360888 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:44:30.008434 => 21:44:30.360620
[0m21:44:30.361357 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:44:30.398048 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:44:30.400154 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.40s]
[0m21:44:30.401266 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.402073 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.402895 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:44:30.404096 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:44:30.404772 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.412201 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.413630 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:44:30.405188 => 21:44:30.413397
[0m21:44:30.414084 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.417298 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.418439 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.418915 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:44:30.419334 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:30.675648 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:30.677401 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.678181 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:44:30.711792 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:30.718483 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:44:30.414363 => 21:44:30.717599
[0m21:44:30.719976 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:44:30.751832 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:44:30.755484 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.35s]
[0m21:44:30.756713 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.759208 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:30.759715 [debug] [MainThread]: On master: BEGIN
[0m21:44:30.760147 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:44:31.113103 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:31.114809 [debug] [MainThread]: On master: COMMIT
[0m21:44:31.115984 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:31.117078 [debug] [MainThread]: On master: COMMIT
[0m21:44:31.160115 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:44:31.161597 [debug] [MainThread]: On master: Close
[0m21:44:31.164315 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:44:31.164918 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:44:31.165776 [info ] [MainThread]: 
[0m21:44:31.166452 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 47.02 seconds (47.02s).
[0m21:44:31.171291 [debug] [MainThread]: Command end result
[0m21:44:31.184685 [info ] [MainThread]: 
[0m21:44:31.185276 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:44:31.185665 [info ] [MainThread]: 
[0m21:44:31.186056 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:44:31.188002 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 47.245525, "process_user_time": 2.317974, "process_kernel_time": 0.198467, "process_mem_max_rss": "130678784", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:44:31.188503 [debug] [MainThread]: Command `dbt build` succeeded at 21:44:31.188385 after 47.25 seconds
[0m21:44:31.188878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d11f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cf9610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c4c850>]}
[0m21:44:31.189229 [debug] [MainThread]: Flushing usage events
[0m21:47:32.730067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11270b510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112782790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112782e50>]}


============================== 21:47:32.731363 | 68185f43-60ea-4c59-9387-45ae80d92e26 ==============================
[0m21:47:32.731363 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:47:32.731707 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager', 'static_parser': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt build', 'log_format': 'default', 'log_path': '/Users/danila/github/dbt/logs', 'write_json': 'True', 'introspect': 'True', 'fail_fast': 'False', 'version_check': 'True', 'partial_parse': 'True', 'quiet': 'False', 'use_colors': 'True', 'log_cache_events': 'False', 'debug': 'False', 'no_print': 'None', 'warn_error': 'None'}
[0m21:47:32.794643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11346f3d0>]}
[0m21:47:32.824910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1134a3dd0>]}
[0m21:47:32.825267 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:47:32.831438 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:47:32.844443 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:47:32.844693 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:47:32.845246 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:47:32.847813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127a5490>]}
[0m21:47:32.853120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113737fd0>]}
[0m21:47:32.853353 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:47:32.854555 [info ] [MainThread]: 
[0m21:47:32.854981 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:47:32.855790 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:47:32.860428 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:47:32.860660 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:47:32.860824 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:47:33.293463 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:47:33.298432 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:47:33.302930 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:47:33.312114 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:47:33.312735 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:47:33.313127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:47:33.571829 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:47:33.573598 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:47:33.575022 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:47:33.612371 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:47:33.617892 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:47:33.649213 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:47:33.665763 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:33.666270 [debug] [MainThread]: On master: BEGIN
[0m21:47:33.666695 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:47:33.922979 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:33.923494 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:33.923962 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:47:33.969410 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:47:33.974157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11279f550>]}
[0m21:47:33.974833 [debug] [MainThread]: On master: ROLLBACK
[0m21:47:34.005067 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:34.005551 [debug] [MainThread]: On master: BEGIN
[0m21:47:34.066409 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:34.068224 [debug] [MainThread]: On master: COMMIT
[0m21:47:34.069004 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:34.069691 [debug] [MainThread]: On master: COMMIT
[0m21:47:34.101149 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:47:34.102598 [debug] [MainThread]: On master: Close
[0m21:47:34.105791 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:47:34.106590 [info ] [MainThread]: 
[0m21:47:34.111795 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.112729 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:47:34.114301 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:47:34.114995 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.128085 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.129052 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:47:34.115464 => 21:47:34.128800
[0m21:47:34.129426 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.155859 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.156384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.156613 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:47:34.156827 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:34.411292 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:34.412706 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.414266 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:48:02.597861 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 28.0 seconds
[0m21:48:02.610199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.611301 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:48:02.643341 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:02.651648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.652828 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:48:02.685751 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:02.720041 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:48:02.720763 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.721308 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:48:02.753538 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:02.763361 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:48:02.770556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.771278 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:48:02.816071 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:02.819516 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:47:34.129634 => 21:48:02.819243
[0m21:48:02.820146 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:48:02.821825 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113538290>]}
[0m21:48:02.823074 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 28.71s]
[0m21:48:02.824023 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:48:02.824556 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:48:02.825192 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:48:02.826436 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:48:02.827051 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:48:02.832895 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:48:02.834296 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:48:02.827402 => 21:48:02.833917
[0m21:48:02.834939 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:48:02.841496 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:48:02.842681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:02.843177 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:48:02.843628 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:03.231205 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:03.232454 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.233031 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:48:03.287920 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:48:03.295579 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.296414 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:48:03.334436 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.344115 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.344979 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:48:03.382846 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.387035 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:48:03.387767 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.388342 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:48:03.425236 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:03.432960 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:48:03.434695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.435440 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:48:03.490267 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:03.493233 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:48:02.835273 => 21:48:03.492817
[0m21:48:03.494070 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:48:03.496022 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139549d0>]}
[0m21:48:03.497485 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.67s]
[0m21:48:03.498560 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:48:03.499142 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.499715 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:48:03.500823 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:48:03.501444 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.508075 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.509725 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:48:03.501780 => 21:48:03.509350
[0m21:48:03.510239 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.517683 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.519452 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.520424 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:48:03.520954 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:03.794352 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:03.796203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.797727 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:48:03.891444 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:48:03.894631 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.894947 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:48:03.979273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.983982 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.984567 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:48:04.016064 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.020214 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:48:04.021018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:04.021491 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:48:04.052376 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:04.057242 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:48:04.058739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:04.059347 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:48:04.108215 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:04.111452 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:48:03.510464 => 21:48:04.111041
[0m21:48:04.112085 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:48:04.113443 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11393a810>]}
[0m21:48:04.115251 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.61s]
[0m21:48:04.116390 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:48:04.117021 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:48:04.117756 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:48:04.118738 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:48:04.119487 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:48:04.125113 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:48:04.126582 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:48:04.119887 => 21:48:04.126216
[0m21:48:04.127172 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:48:04.134868 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:48:04.136324 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.136928 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:48:04.137349 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:04.409134 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:04.410287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.411248 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:48:04.448998 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:48:04.457218 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.458348 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:48:04.489926 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.497301 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.498758 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:48:04.530386 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.533963 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:48:04.534538 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.535012 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:48:04.565828 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:04.570858 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:48:04.572431 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.572953 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:48:04.625636 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:04.629314 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:48:04.127568 => 21:48:04.628870
[0m21:48:04.630179 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:48:04.631651 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ad310>]}
[0m21:48:04.632864 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.51s]
[0m21:48:04.634029 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:48:04.634941 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.636146 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:48:04.637412 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:48:04.637986 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.647400 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.649294 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:48:04.638213 => 21:48:04.648778
[0m21:48:04.650093 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.657234 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.658917 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.659578 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:48:04.660044 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:04.934456 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:04.935797 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.936487 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:48:04.972697 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:04.980050 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.980632 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:48:05.014825 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:05.019037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.019546 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:48:05.054158 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:05.059286 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:48:05.060117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.060988 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:48:05.094964 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:05.102522 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:48:05.105590 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.107020 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:48:05.160512 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:05.162841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:48:04.650794 => 21:48:05.162563
[0m21:48:05.163434 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:48:05.164892 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113511990>]}
[0m21:48:05.165734 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.53s]
[0m21:48:05.166573 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:48:05.167214 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.168186 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:48:05.169180 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:48:05.169751 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.177893 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.179945 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:48:05.170161 => 21:48:05.179603
[0m21:48:05.180566 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.187965 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.189547 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.190175 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:48:05.190707 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:05.450447 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:05.451673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.452387 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:48:12.318708 [debug] [Thread-1 (]: SQL status: SELECT 142664 in 7.0 seconds
[0m21:48:12.329581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.330480 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:48:12.362356 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.372569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.374080 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:48:12.406755 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.414831 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:48:12.416312 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.417366 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:48:12.449548 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:12.459208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:48:12.462063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.463089 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:48:12.511587 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:12.516713 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:48:05.180936 => 21:48:12.515945
[0m21:48:12.518160 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:48:12.521407 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11373eed0>]}
[0m21:48:12.523480 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142664[0m in 7.35s]
[0m21:48:12.525536 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:12.526968 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.528382 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:48:12.530275 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:48:12.531181 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.536687 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.538172 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:48:12.531716 => 21:48:12.537862
[0m21:48:12.538756 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.544477 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.545532 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.545994 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:48:12.546394 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:12.857549 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:12.859248 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.860395 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:48:12.897331 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:12.911262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.912156 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:48:12.948019 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.955948 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.957559 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:48:12.991423 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.995482 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:48:12.996483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.997133 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:48:13.031190 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:13.036922 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:48:13.039200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:13.039995 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:48:13.091439 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:13.094731 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:48:12.539152 => 21:48:13.094345
[0m21:48:13.095376 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:48:13.097661 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139b0310>]}
[0m21:48:13.099402 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.57s]
[0m21:48:13.100290 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:13.100997 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.101814 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:48:13.103035 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:48:13.103956 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.110910 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.112776 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:48:13.104327 => 21:48:13.112277
[0m21:48:13.113597 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.121862 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.123913 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.124805 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:48:13.125752 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:13.435667 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:13.437066 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.437862 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:48:13.482083 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:48:13.489146 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.489795 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:48:13.527480 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:13.534273 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.535549 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.574220 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:13.578332 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:48:13.579109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.579766 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:48:13.618011 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:13.623132 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:48:13.624884 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.625696 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:48:13.681853 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:13.685276 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:48:13.114039 => 21:48:13.684789
[0m21:48:13.686201 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:48:13.687530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11378dc50>]}
[0m21:48:13.689197 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.58s]
[0m21:48:13.690978 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.691631 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.692436 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:48:13.693589 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:48:13.694524 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.701956 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.703858 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:48:13.694872 => 21:48:13.703346
[0m21:48:13.704569 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.712758 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.714275 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.714802 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:48:13.715226 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:13.994800 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:13.995720 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.996347 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:48:18.450432 [debug] [Thread-1 (]: SQL status: SELECT 37211 in 4.0 seconds
[0m21:48:18.462427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.463952 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:48:18.500832 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:18.510834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.511908 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:48:18.544192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:18.551530 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:48:18.552953 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.554189 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:48:18.586203 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:18.598525 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:48:18.600190 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.600958 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:48:18.646992 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:18.651144 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:48:13.705037 => 21:48:18.650623
[0m21:48:18.652047 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:48:18.654232 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113702110>]}
[0m21:48:18.655466 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37211[0m in 4.96s]
[0m21:48:18.657255 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:18.658238 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.659443 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:48:18.660865 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:48:18.662124 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.723602 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.724280 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:48:18.662999 => 21:48:18.724136
[0m21:48:18.724521 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.726953 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.727328 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.727544 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:48:18.727743 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:18.981067 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:18.982039 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.982728 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:48:21.829326 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:48:21.837130 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.837776 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:48:21.869268 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:21.876880 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.877659 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:48:21.910165 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:21.917154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:48:21.918138 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.918730 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:48:21.951031 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:21.961212 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:48:21.963774 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.964791 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:48:22.014702 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:22.017786 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:48:18.724663 => 21:48:22.017518
[0m21:48:22.018328 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:48:22.020533 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114003210>]}
[0m21:48:22.021457 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.36s]
[0m21:48:22.022297 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:48:22.023489 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.025596 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:48:22.026770 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:48:22.027437 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.033915 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.035617 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:48:22.027952 => 21:48:22.035283
[0m21:48:22.036256 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.043606 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.045407 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.046044 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:48:22.047080 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:22.422317 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:22.424206 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.425909 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:48:22.500144 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:48:22.511782 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.512898 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:48:22.544369 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:22.552027 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.553381 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:48:22.584618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:22.590972 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:48:22.591676 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.592215 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:48:22.624075 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:22.628998 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:48:22.630384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.630850 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:48:22.679691 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:22.685342 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:48:22.036666 => 21:48:22.684532
[0m21:48:22.686913 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:48:22.689732 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139a5ed0>]}
[0m21:48:22.690548 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.66s]
[0m21:48:22.691382 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.691954 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:48:22.692673 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:48:22.693573 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:48:22.694161 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:48:22.699101 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:48:22.700621 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:48:22.694676 => 21:48:22.700160
[0m21:48:22.701417 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:48:22.712000 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:48:22.714014 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:22.714797 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:48:22.715588 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:22.970330 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:22.972295 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:22.973494 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:48:23.007116 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:23.017806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.018444 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:48:23.049773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.056790 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.057924 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:48:23.089514 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.094511 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:48:23.095075 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.095452 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:48:23.126220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:23.133988 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:48:23.134924 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.135660 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:48:23.183714 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:23.188180 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:48:22.701840 => 21:48:23.187463
[0m21:48:23.189492 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:48:23.192275 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137fb110>]}
[0m21:48:23.194057 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.50s]
[0m21:48:23.195436 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:48:23.196505 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:48:23.197738 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:48:23.199438 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:48:23.200402 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:48:23.206910 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.208463 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:48:23.201046 => 21:48:23.208153
[0m21:48:23.209069 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:48:23.215767 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.217230 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.217715 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:48:23.218157 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:23.495283 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:23.497063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.498625 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:48:23.736144 [debug] [Thread-1 (]: SQL status: SELECT 54053 in 0.0 seconds
[0m21:48:23.749019 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.750644 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:48:23.785671 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.796527 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.797996 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:48:23.832234 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.836436 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:48:23.837098 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.837663 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:48:23.871304 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:23.875084 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:48:23.876210 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.876694 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:48:23.929378 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:23.930781 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:48:23.209466 => 21:48:23.930603
[0m21:48:23.931126 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:48:23.931956 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137ed2d0>]}
[0m21:48:23.932433 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54053[0m in 0.73s]
[0m21:48:23.932890 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:48:23.933257 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.933681 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:48:23.934418 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:48:23.934783 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.942902 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.943514 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:48:23.934984 => 21:48:23.943363
[0m21:48:23.943781 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.951580 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.952016 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.952223 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:48:23.952421 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:24.206346 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:24.208526 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:24.210136 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:48:24.243376 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:24.251808 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:48:23.943933 => 21:48:24.250909
[0m21:48:24.253413 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:48:24.288845 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:48:24.293480 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.36s]
[0m21:48:24.295922 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:24.297560 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.299114 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:48:24.300140 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:48:24.300928 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.317458 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.319386 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:48:24.301621 => 21:48:24.318931
[0m21:48:24.319950 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.322951 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.323770 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.324213 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:48:24.324633 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:24.671541 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:24.673730 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.676446 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:48:24.719084 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:24.724426 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:48:24.320248 => 21:48:24.723504
[0m21:48:24.725307 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:48:24.765821 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:48:24.768757 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.47s]
[0m21:48:24.770447 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.771757 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.773790 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:48:24.775824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:48:24.776985 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.783665 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.785069 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:48:24.777772 => 21:48:24.784693
[0m21:48:24.785890 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.792392 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.793282 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.793723 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:48:24.794120 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:25.049133 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:25.051268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.053289 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:48:25.618285 [debug] [Thread-1 (]: SQL status: SELECT 123964 in 1.0 seconds
[0m21:48:25.627574 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.628475 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:48:25.659269 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:25.668001 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.669518 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:48:25.702848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:25.709856 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:48:25.710581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.711234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:48:25.742270 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:25.750071 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:48:25.752911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.753891 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:48:25.804387 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:25.808937 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:48:24.786285 => 21:48:25.808199
[0m21:48:25.810331 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:48:25.813200 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113834810>]}
[0m21:48:25.815078 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123964[0m in 1.04s]
[0m21:48:25.817035 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:25.818295 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.819524 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m21:48:25.821213 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m21:48:25.822186 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.830940 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.832739 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 21:48:25.822820 => 21:48:25.832314
[0m21:48:25.833419 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.840174 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.841575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.842067 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m21:48:25.842754 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:26.104546 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:26.106143 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.107989 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:48:26.216949 [debug] [Thread-1 (]: SQL status: SELECT 45247 in 0.0 seconds
[0m21:48:26.224416 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.224927 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m21:48:26.256174 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.266881 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.267640 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m21:48:26.299318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.307665 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:48:26.309034 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.310287 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:48:26.342437 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:26.352095 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m21:48:26.355657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.357134 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m21:48:26.429738 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:26.434698 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 21:48:25.833868 => 21:48:26.433914
[0m21:48:26.436126 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m21:48:26.439268 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ac810>]}
[0m21:48:26.441290 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45247[0m in 0.62s]
[0m21:48:26.442978 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:26.444104 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.445387 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:48:26.447156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:48:26.448160 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.454984 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.456521 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:48:26.448834 => 21:48:26.456207
[0m21:48:26.457102 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.466246 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.468002 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.468635 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:48:26.469112 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:26.747281 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:26.748853 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.750475 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:48:26.810966 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:48:26.816122 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.816805 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:48:26.850513 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.857379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.858220 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:48:26.891959 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.896058 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:48:26.896649 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.897073 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:48:26.931182 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:26.939049 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:48:26.941957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.943013 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:48:26.997063 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:27.000880 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:48:26.457495 => 21:48:27.000334
[0m21:48:27.001911 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:48:27.004235 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ba690>]}
[0m21:48:27.005645 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.56s]
[0m21:48:27.007131 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:48:27.008320 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.009762 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:48:27.011639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:48:27.012760 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.018885 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.020625 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:48:27.013422 => 21:48:27.020291
[0m21:48:27.021256 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.045716 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.046698 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.047052 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:48:27.047376 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:27.322674 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:27.324119 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.324929 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:48:27.362059 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:48:27.369497 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.370211 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:48:27.403693 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:27.408534 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:48:27.409677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.410441 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:48:27.444459 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:27.451483 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:48:27.457555 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.458634 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:48:27.493419 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:48:27.496003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:48:27.021731 => 21:48:27.495737
[0m21:48:27.496541 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:48:27.498146 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11376c7d0>]}
[0m21:48:27.499315 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.49s]
[0m21:48:27.500550 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.502179 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.503237 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:48:27.504194 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:48:27.504578 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.513901 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.516262 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:48:27.504812 => 21:48:27.515403
[0m21:48:27.517130 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.521504 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.522943 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.523388 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:48:27.523796 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:27.804900 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:27.806624 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.807522 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:48:27.842877 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:27.845477 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:48:27.517593 => 21:48:27.844978
[0m21:48:27.846189 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:48:27.879916 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:48:27.882075 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.38s]
[0m21:48:27.883177 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.883886 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.884587 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:48:27.885710 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:48:27.886587 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.897900 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.900410 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:48:27.886922 => 21:48:27.899585
[0m21:48:27.901309 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.905190 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.906642 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.907053 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:48:27.907462 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:28.231356 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:28.233333 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:28.234920 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:48:28.277870 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:28.283818 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:48:27.901773 => 21:48:28.283002
[0m21:48:28.285283 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:48:28.325310 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:48:28.327758 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.44s]
[0m21:48:28.329054 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:28.333417 [debug] [MainThread]: Using postgres connection "master"
[0m21:48:28.334737 [debug] [MainThread]: On master: BEGIN
[0m21:48:28.335571 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:48:28.659152 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:48:28.660912 [debug] [MainThread]: On master: COMMIT
[0m21:48:28.661427 [debug] [MainThread]: Using postgres connection "master"
[0m21:48:28.661786 [debug] [MainThread]: On master: COMMIT
[0m21:48:28.692725 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:48:28.693863 [debug] [MainThread]: On master: Close
[0m21:48:28.696224 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:48:28.696738 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:48:28.697301 [info ] [MainThread]: 
[0m21:48:28.698155 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 55.84 seconds (55.84s).
[0m21:48:28.702587 [debug] [MainThread]: Command end result
[0m21:48:28.721225 [info ] [MainThread]: 
[0m21:48:28.722225 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:48:28.722763 [info ] [MainThread]: 
[0m21:48:28.723281 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:48:28.725607 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 56.015503, "process_user_time": 2.516233, "process_kernel_time": 0.245119, "process_mem_max_rss": "126287872", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:48:28.726351 [debug] [MainThread]: Command `dbt build` succeeded at 21:48:28.726174 after 56.02 seconds
[0m21:48:28.726853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11275d0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f7df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f7ded0>]}
[0m21:48:28.727363 [debug] [MainThread]: Flushing usage events
[0m11:20:54.918025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530b4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382d90>]}


============================== 11:20:54.919581 | fb68269a-fb15-4ca6-9cdc-b14d74da6fe4 ==============================
[0m11:20:54.919581 [info ] [MainThread]: Running with dbt=1.7.0
[0m11:20:54.919942 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'debug': 'False', 'target_path': 'None', 'log_format': 'default', 'cache_selected_only': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'warn_error': 'None', 'printer_width': '80', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'quiet': 'False', 'version_check': 'True', 'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'use_colors': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'fail_fast': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt build', 'static_parser': 'True', 'use_experimental_parser': 'False'}
[0m11:20:54.988897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103d1ff50>]}
[0m11:20:55.018446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10617b9d0>]}
[0m11:20:55.018843 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m11:20:55.025442 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m11:20:55.043123 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:20:55.043375 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:20:55.043890 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m11:20:55.046448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106413150>]}
[0m11:20:55.052554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10633fdd0>]}
[0m11:20:55.052840 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:20:55.054156 [info ] [MainThread]: 
[0m11:20:55.054648 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:20:55.055493 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m11:20:55.059984 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m11:20:55.060149 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m11:20:55.060292 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:20:55.319808 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m11:20:55.325608 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m11:20:55.328854 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m11:20:55.333913 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:20:55.334234 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m11:20:55.334491 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:20:55.590655 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:20:55.592458 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:20:55.593838 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m11:20:55.629547 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m11:20:55.634041 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m11:20:55.664751 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m11:20:55.678842 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:55.679281 [debug] [MainThread]: On master: BEGIN
[0m11:20:55.679612 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:20:56.100552 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.102318 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.103842 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:20:56.157848 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m11:20:56.165410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10437c990>]}
[0m11:20:56.165953 [debug] [MainThread]: On master: ROLLBACK
[0m11:20:56.207962 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.208699 [debug] [MainThread]: On master: BEGIN
[0m11:20:56.292999 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.294818 [debug] [MainThread]: On master: COMMIT
[0m11:20:56.296108 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.296765 [debug] [MainThread]: On master: COMMIT
[0m11:20:56.339094 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:20:56.340798 [debug] [MainThread]: On master: Close
[0m11:20:56.343992 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m11:20:56.344760 [info ] [MainThread]: 
[0m11:20:56.351499 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.352536 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m11:20:56.353712 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m11:20:56.354315 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.367044 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.368015 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 11:20:56.354718 => 11:20:56.367746
[0m11:20:56.368455 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.394215 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.395116 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.395411 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m11:20:56.395644 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:20:56.717049 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.719080 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.721790 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m11:21:16.887732 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 20.0 seconds
[0m11:21:16.902144 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:16.902816 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m11:21:16.942366 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:16.946162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:16.946643 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m11:21:16.985769 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.013270 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:21:17.013738 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:17.014088 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:21:17.052965 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:17.060287 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m11:21:17.065224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:17.065587 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m11:21:17.119004 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:17.122542 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 11:20:56.368698 => 11:21:17.122122
[0m11:21:17.123310 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m11:21:17.125084 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106421b10>]}
[0m11:21:17.126212 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 20.77s]
[0m11:21:17.127087 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m11:21:17.127669 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m11:21:17.128423 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m11:21:17.129472 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m11:21:17.129998 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m11:21:17.133663 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m11:21:17.134673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 11:21:17.130316 => 11:21:17.134446
[0m11:21:17.135080 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m11:21:17.139382 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m11:21:17.140109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.140434 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m11:21:17.140755 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:17.481840 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:17.483782 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.485194 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:21:17.538205 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:21:17.545447 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.546187 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m11:21:17.579834 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.589804 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.590332 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m11:21:17.624409 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.627758 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:21:17.628269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.628690 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:21:17.661435 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:17.667231 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m11:21:17.668878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.669550 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m11:21:17.722021 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:17.725888 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 11:21:17.135324 => 11:21:17.725613
[0m11:21:17.726443 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m11:21:17.727885 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106578890>]}
[0m11:21:17.728770 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.60s]
[0m11:21:17.729515 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m11:21:17.730066 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.730692 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m11:21:17.731523 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m11:21:17.731916 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.735270 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.736164 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 11:21:17.732169 => 11:21:17.735931
[0m11:21:17.736568 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.740503 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.741240 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.741576 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m11:21:17.741893 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:18.108017 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.110128 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.111629 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:21:18.172590 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:21:18.174624 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.174869 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m11:21:18.213229 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.215286 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.215548 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m11:21:18.254331 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.256405 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:21:18.256792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.257160 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:21:18.295660 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:18.300115 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m11:21:18.301428 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.301986 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m11:21:18.358590 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:18.364056 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 11:21:17.736805 => 11:21:18.363281
[0m11:21:18.365495 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m11:21:18.367431 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1062a3510>]}
[0m11:21:18.368518 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.64s]
[0m11:21:18.369522 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m11:21:18.370138 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m11:21:18.370822 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m11:21:18.371666 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m11:21:18.372116 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m11:21:18.375713 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m11:21:18.376574 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 11:21:18.372391 => 11:21:18.376359
[0m11:21:18.376964 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m11:21:18.381192 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m11:21:18.381878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.382194 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m11:21:18.382493 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:18.637004 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.639132 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.640495 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m11:21:18.678414 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m11:21:18.688798 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.689155 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m11:21:18.719560 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.722657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.723070 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m11:21:18.753949 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.757381 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:21:18.757905 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.758337 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:21:18.789102 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:18.795164 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m11:21:18.796498 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.797057 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m11:21:18.846479 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:18.851507 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 11:21:18.377195 => 11:21:18.850742
[0m11:21:18.852515 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m11:21:18.854468 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064213d0>]}
[0m11:21:18.855732 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.48s]
[0m11:21:18.856905 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m11:21:18.857773 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.858759 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m11:21:18.859750 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m11:21:18.860274 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.867994 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.869075 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 11:21:18.860620 => 11:21:18.868788
[0m11:21:18.869568 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.874158 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.874881 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.875267 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m11:21:18.875626 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:19.243850 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:19.245985 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.247523 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m11:21:19.294206 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:19.303834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.304439 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m11:21:19.348726 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:19.355598 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.356447 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m11:21:19.401646 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:19.407472 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:21:19.408046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.408520 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:21:19.452813 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:19.462624 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m11:21:19.463690 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.464123 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m11:21:19.525828 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:19.530709 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 11:21:18.869836 => 11:21:19.530387
[0m11:21:19.531298 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m11:21:19.532721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105358910>]}
[0m11:21:19.533580 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.67s]
[0m11:21:19.534511 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m11:21:19.535216 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.535946 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m11:21:19.536984 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m11:21:19.537442 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.543065 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.543943 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 11:21:19.537719 => 11:21:19.543714
[0m11:21:19.544313 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.548068 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.548626 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.548942 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m11:21:19.549240 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:19.802546 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:19.804721 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.806839 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m11:21:27.228562 [debug] [Thread-1 (]: SQL status: SELECT 143172 in 7.0 seconds
[0m11:21:27.233334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.233923 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m11:21:27.264866 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.268403 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.268815 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m11:21:27.300318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.304253 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:21:27.304876 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.305444 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:21:27.336871 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:27.342420 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m11:21:27.343703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.344338 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m11:21:27.391450 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:27.395358 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 11:21:19.544516 => 11:21:27.394913
[0m11:21:27.396303 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m11:21:27.398518 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065bb810>]}
[0m11:21:27.399782 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143172[0m in 7.86s]
[0m11:21:27.400771 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:27.401562 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.402429 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m11:21:27.403467 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m11:21:27.404023 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.408831 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.410001 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 11:21:27.404373 => 11:21:27.409706
[0m11:21:27.410500 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.415260 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.416161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.416556 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m11:21:27.416926 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:27.742480 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:27.743135 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.743513 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m11:21:27.784907 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:27.791660 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.792098 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m11:21:27.831823 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.837533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.838064 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m11:21:27.880162 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.884554 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:21:27.885276 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.885807 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:21:27.937184 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:27.942925 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m11:21:27.944389 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.945025 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m11:21:28.000954 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:28.004976 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 11:21:27.410787 => 11:21:28.004513
[0m11:21:28.005910 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m11:21:28.008061 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10644d610>]}
[0m11:21:28.009240 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.60s]
[0m11:21:28.010335 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:28.011210 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.012190 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m11:21:28.013211 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m11:21:28.013751 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.019152 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.020343 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 11:21:28.014087 => 11:21:28.020056
[0m11:21:28.020796 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.025447 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.026176 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.026549 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m11:21:28.026861 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:28.280354 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:28.282033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.283087 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m11:21:28.320996 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m11:21:28.329563 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.330137 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:21:28.361370 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:28.366699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.367262 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.397574 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:28.401416 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:21:28.402076 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.402602 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:21:28.433460 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:28.435975 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:21:28.436591 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.436857 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m11:21:28.485341 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:28.486562 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 11:21:28.021035 => 11:21:28.486410
[0m11:21:28.486849 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m11:21:28.487461 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065e6a90>]}
[0m11:21:28.487868 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.47s]
[0m11:21:28.488280 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.488585 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.488889 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m11:21:28.489425 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m11:21:28.489737 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.491998 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.492523 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 11:21:28.489902 => 11:21:28.492381
[0m11:21:28.492771 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.495332 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.495737 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.495958 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m11:21:28.496167 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:28.824094 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:28.826256 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.827988 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m11:21:33.807192 [debug] [Thread-1 (]: SQL status: SELECT 37355 in 5.0 seconds
[0m11:21:33.815837 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.816555 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:21:33.854864 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:33.862810 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.864203 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m11:21:33.902178 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:33.906259 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:21:33.906734 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.907646 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:21:33.945515 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:33.957248 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:21:33.958558 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.959139 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m11:21:34.011476 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:34.015790 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 11:21:28.492915 => 11:21:34.014987
[0m11:21:34.017174 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m11:21:34.019824 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065f8b10>]}
[0m11:21:34.021542 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37355[0m in 5.53s]
[0m11:21:34.023034 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:34.024146 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.025344 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m11:21:34.026630 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m11:21:34.027335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.084721 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.085450 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 11:21:34.027803 => 11:21:34.085306
[0m11:21:34.085709 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.088190 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.088556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.088757 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m11:21:34.088946 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:34.342794 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:34.344693 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.346471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m11:21:37.386911 [debug] [Thread-1 (]: SQL status: SELECT 114590 in 3.0 seconds
[0m11:21:37.391625 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.393162 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m11:21:37.426048 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:37.431957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.433747 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m11:21:37.465842 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:37.471410 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:21:37.472018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.472512 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:21:37.503734 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:37.510128 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m11:21:37.511871 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.512359 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m11:21:37.559679 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:37.562530 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 11:21:34.085842 => 11:21:37.562260
[0m11:21:37.563139 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m11:21:37.564313 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065c0990>]}
[0m11:21:37.565612 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114590[0m in 3.54s]
[0m11:21:37.567542 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m11:21:37.568656 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.569737 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m11:21:37.571161 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m11:21:37.571949 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.579545 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.581248 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 11:21:37.572239 => 11:21:37.580847
[0m11:21:37.581965 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.589759 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.591019 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.591646 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m11:21:37.592311 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:37.866621 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:37.867801 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.868379 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m11:21:37.959911 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m11:21:37.968129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.968811 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:21:38.000073 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.006246 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.007213 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m11:21:38.038214 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.043074 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:21:38.043730 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.044387 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:21:38.076136 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:38.081688 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:21:38.082963 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.083589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m11:21:38.138383 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:38.142107 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 11:21:37.582464 => 11:21:38.141324
[0m11:21:38.142933 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m11:21:38.145065 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065c2810>]}
[0m11:21:38.146234 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.57s]
[0m11:21:38.147474 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:38.148766 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m11:21:38.150894 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m11:21:38.152785 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m11:21:38.153772 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m11:21:38.160130 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m11:21:38.162107 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 11:21:38.154256 => 11:21:38.161524
[0m11:21:38.162963 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m11:21:38.174582 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m11:21:38.176021 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.176562 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m11:21:38.177020 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:38.434023 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:38.434838 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.435383 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m11:21:38.468588 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:38.471291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.471605 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m11:21:38.502054 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.504567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.504874 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m11:21:38.535277 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.537329 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:21:38.537711 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.538069 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:21:38.568237 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:38.572225 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m11:21:38.573304 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.573792 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m11:21:38.621494 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:38.626294 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 11:21:38.163440 => 11:21:38.625569
[0m11:21:38.627695 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m11:21:38.630204 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106433a10>]}
[0m11:21:38.631510 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.48s]
[0m11:21:38.632723 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m11:21:38.633595 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m11:21:38.634653 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m11:21:38.636060 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m11:21:38.636688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m11:21:38.643247 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.646097 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 11:21:38.637147 => 11:21:38.645672
[0m11:21:38.646900 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m11:21:38.653147 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.654249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.654742 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m11:21:38.655184 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:38.978895 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:38.979886 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.980775 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m11:21:39.314573 [debug] [Thread-1 (]: SQL status: SELECT 54835 in 0.0 seconds
[0m11:21:39.321827 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.322694 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m11:21:39.361816 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:39.368464 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.369113 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m11:21:39.409063 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:39.414247 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:21:39.415162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.415874 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:21:39.456034 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:39.461083 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m11:21:39.462556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.463042 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m11:21:39.519203 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:39.523174 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 11:21:38.647463 => 11:21:39.522855
[0m11:21:39.523898 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m11:21:39.525623 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064314d0>]}
[0m11:21:39.526555 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54835[0m in 0.89s]
[0m11:21:39.527374 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m11:21:39.528337 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.529935 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m11:21:39.531371 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m11:21:39.531968 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.550959 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.553335 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 11:21:39.532337 => 11:21:39.552870
[0m11:21:39.553958 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.569313 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.570178 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.570517 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m11:21:39.570840 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:39.891374 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:39.893208 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.894205 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:21:39.935066 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:39.939840 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 11:21:39.554273 => 11:21:39.939286
[0m11:21:39.940660 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m11:21:39.979410 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m11:21:39.981907 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.45s]
[0m11:21:39.983101 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.983847 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:39.984487 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m11:21:39.985538 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m11:21:39.986142 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.002796 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.004903 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 11:21:39.986550 => 11:21:40.004483
[0m11:21:40.005632 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.009743 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.011113 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.011627 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m11:21:40.012068 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:40.367386 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:40.368906 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.370885 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:21:40.415637 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:40.419290 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 11:21:40.006051 => 11:21:40.418842
[0m11:21:40.420168 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m11:21:40.463727 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m11:21:40.467283 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.48s]
[0m11:21:40.468863 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.469687 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.470998 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m11:21:40.472423 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m11:21:40.473100 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.481512 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.483305 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 11:21:40.473803 => 11:21:40.482869
[0m11:21:40.483996 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.492284 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.494157 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.494683 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m11:21:40.495141 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:40.831054 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:40.832161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.833018 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        betting_type,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    betting_type, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, 
    sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
  );
  
[0m11:21:40.873588 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "date_cet" does not exist
LINE 42:     date_cet, 
             ^
HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.

[0m11:21:40.875353 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: ROLLBACK
[0m11:21:40.913238 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 11:21:40.484442 => 11:21:40.912647
[0m11:21:40.914120 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m11:21:40.931225 [debug] [Thread-1 (]: Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "date_cet" does not exist
  LINE 42:     date_cet, 
               ^
  HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m11:21:40.932111 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10653c150>]}
[0m11:21:40.933095 [error] [Thread-1 (]: 16 of 21 ERROR creating sql table model danila.outclick_by_brand_int_new ....... [[31mERROR[0m in 0.46s]
[0m11:21:40.934084 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.934783 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.935696 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m11:21:40.936806 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m11:21:40.937535 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.944932 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.946451 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 11:21:40.937999 => 11:21:40.946123
[0m11:21:40.947004 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.952689 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.953567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.953960 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m11:21:40.954325 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:41.206718 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:41.208831 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.210306 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m11:21:41.303746 [debug] [Thread-1 (]: SQL status: SELECT 45422 in 0.0 seconds
[0m11:21:41.312292 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.313074 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m11:21:41.344763 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:41.352104 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.353282 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m11:21:41.384826 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:41.389826 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:21:41.390699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.391462 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:21:41.422030 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:41.428195 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m11:21:41.429607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.430401 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m11:21:41.480283 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:41.484523 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 11:21:40.947293 => 11:21:41.483942
[0m11:21:41.485647 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m11:21:41.488141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106169c10>]}
[0m11:21:41.489428 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45422[0m in 0.55s]
[0m11:21:41.491474 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:41.492944 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.494207 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m11:21:41.496223 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m11:21:41.497165 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.505352 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.507482 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 11:21:41.497709 => 11:21:41.506942
[0m11:21:41.508513 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.516360 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.518191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.518856 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m11:21:41.519351 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:41.867802 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:41.869838 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.870843 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m11:21:41.952185 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m11:21:41.961284 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.962532 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m11:21:42.005644 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.019697 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.020800 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m11:21:42.063574 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.067776 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:21:42.068506 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.069094 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:21:42.111884 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:42.117660 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m11:21:42.119400 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.120149 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m11:21:42.182623 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:42.186958 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 11:21:41.509062 => 11:21:42.186226
[0m11:21:42.187866 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m11:21:42.189872 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106388290>]}
[0m11:21:42.191071 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.69s]
[0m11:21:42.192303 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m11:21:42.193261 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.194846 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m11:21:42.197003 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m11:21:42.197864 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.203758 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.206341 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 11:21:42.198476 => 11:21:42.205971
[0m11:21:42.207021 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.231223 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.232028 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.232388 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m11:21:42.232712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:42.587138 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:42.589117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.590592 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m11:21:42.636858 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m11:21:42.642893 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.643593 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m11:21:42.686669 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.691306 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:21:42.692009 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.692433 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:21:42.734642 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:42.742495 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m11:21:42.750957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.752215 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m11:21:42.795957 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m11:21:42.800082 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 11:21:42.208349 => 11:21:42.799798
[0m11:21:42.800544 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m11:21:42.801772 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064f9910>]}
[0m11:21:42.803461 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.61s]
[0m11:21:42.805456 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.807696 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.808202 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m11:21:42.809251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m11:21:42.810222 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.820939 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.823821 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 11:21:42.810745 => 11:21:42.823314
[0m11:21:42.824547 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.828479 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.830216 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.830821 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m11:21:42.831267 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:43.087718 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.088941 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:43.089417 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:21:43.122407 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:43.127868 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 11:21:42.824971 => 11:21:43.126989
[0m11:21:43.129394 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m11:21:43.160873 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m11:21:43.164320 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.36s]
[0m11:21:43.165145 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:43.165863 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.166800 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m11:21:43.167678 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m11:21:43.168150 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.177796 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.179492 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 11:21:43.168372 => 11:21:43.179023
[0m11:21:43.180259 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.184800 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.186204 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.186671 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m11:21:43.187105 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:43.442053 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.442916 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.443432 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:21:43.476878 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:43.478888 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 11:21:43.180750 => 11:21:43.478609
[0m11:21:43.479297 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m11:21:43.511571 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m11:21:43.513311 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.35s]
[0m11:21:43.513944 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.515114 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:43.515429 [debug] [MainThread]: On master: BEGIN
[0m11:21:43.515647 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m11:21:43.895913 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.897646 [debug] [MainThread]: On master: COMMIT
[0m11:21:43.898953 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:43.900066 [debug] [MainThread]: On master: COMMIT
[0m11:21:43.974558 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:21:43.976002 [debug] [MainThread]: On master: Close
[0m11:21:43.978805 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:21:43.979901 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m11:21:43.980353 [info ] [MainThread]: 
[0m11:21:43.980702 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 48.93 seconds (48.93s).
[0m11:21:43.987168 [debug] [MainThread]: Command end result
[0m11:21:44.006323 [info ] [MainThread]: 
[0m11:21:44.006713 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m11:21:44.006922 [info ] [MainThread]: 
[0m11:21:44.007132 [error] [MainThread]:   Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "date_cet" does not exist
  LINE 42:     date_cet, 
               ^
  HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m11:21:44.007349 [info ] [MainThread]: 
[0m11:21:44.007556 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=1 SKIP=0 TOTAL=21
[0m11:21:44.010697 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 49.12375, "process_user_time": 2.297957, "process_kernel_time": 0.233555, "process_mem_max_rss": "125042688", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m11:21:44.011134 [debug] [MainThread]: Command `dbt build` failed at 11:21:44.011049 after 49.12 seconds
[0m11:21:44.011398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100851f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1007c8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1007c8f50>]}
[0m11:21:44.011649 [debug] [MainThread]: Flushing usage events
[0m11:30:24.901194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092ab650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109322590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109322c50>]}


============================== 11:30:24.902938 | b1fcdff9-6831-4985-a81f-1e6ecd8fea08 ==============================
[0m11:30:24.902938 [info ] [MainThread]: Running with dbt=1.7.0
[0m11:30:24.903266 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'no_print': 'None', 'printer_width': '80', 'debug': 'False', 'version_check': 'True', 'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'target_path': 'None', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'log_format': 'default', 'use_colors': 'True', 'introspect': 'True', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'static_parser': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt build', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m11:30:24.975447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092fdb90>]}
[0m11:30:25.006028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092f97d0>]}
[0m11:30:25.006584 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m11:30:25.014072 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m11:30:25.037741 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:30:25.038074 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:30:25.038708 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m11:30:25.041500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10984b5d0>]}
[0m11:30:25.047509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10998fd50>]}
[0m11:30:25.047774 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:30:25.048949 [info ] [MainThread]: 
[0m11:30:25.049327 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:30:25.050086 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m11:30:25.054801 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m11:30:25.055019 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m11:30:25.055184 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:30:25.455357 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m11:30:25.457538 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m11:30:25.460299 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m11:30:25.468200 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:30:25.468760 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m11:30:25.469224 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:30:25.747245 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:30:25.749131 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:30:25.750542 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m11:30:25.788991 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m11:30:25.792397 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m11:30:25.825949 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m11:30:25.838717 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:25.839313 [debug] [MainThread]: On master: BEGIN
[0m11:30:25.839787 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:30:26.194525 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.195166 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.195724 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:30:26.242832 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m11:30:26.248921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109893890>]}
[0m11:30:26.249778 [debug] [MainThread]: On master: ROLLBACK
[0m11:30:26.286646 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.287869 [debug] [MainThread]: On master: BEGIN
[0m11:30:26.363375 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.364291 [debug] [MainThread]: On master: COMMIT
[0m11:30:26.364825 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.365262 [debug] [MainThread]: On master: COMMIT
[0m11:30:26.403830 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:30:26.404298 [debug] [MainThread]: On master: Close
[0m11:30:26.405042 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m11:30:26.405336 [info ] [MainThread]: 
[0m11:30:26.407339 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.407759 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m11:30:26.408257 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m11:30:26.408542 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.415498 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.416209 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 11:30:26.408712 => 11:30:26.416047
[0m11:30:26.416467 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.437005 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.437687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.437932 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m11:30:26.438132 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:26.790877 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.792839 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.795623 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m11:30:45.542820 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m11:30:45.557429 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.558312 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m11:30:45.601894 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:45.608472 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.609184 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m11:30:45.653595 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:45.682131 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:30:45.682817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.683289 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:30:45.726983 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:45.740036 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m11:30:45.745927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.746518 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m11:30:45.802559 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:45.806574 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 11:30:26.416621 => 11:30:45.806306
[0m11:30:45.807444 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m11:30:45.810263 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10998dc10>]}
[0m11:30:45.811361 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.40s]
[0m11:30:45.812573 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m11:30:45.813193 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m11:30:45.814437 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m11:30:45.815433 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m11:30:45.816734 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m11:30:45.822879 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m11:30:45.825118 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 11:30:45.817327 => 11:30:45.824775
[0m11:30:45.825723 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m11:30:45.831688 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m11:30:45.832504 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:45.832914 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m11:30:45.833328 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:46.117879 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:46.118757 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.119240 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:30:46.167864 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:30:46.175396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.176327 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m11:30:46.207038 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.216789 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.217736 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m11:30:46.249057 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.253016 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:30:46.254058 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.255307 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:30:46.287039 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:46.294812 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m11:30:46.297001 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.298180 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m11:30:46.347771 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:46.352369 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 11:30:45.826076 => 11:30:46.352114
[0m11:30:46.353224 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m11:30:46.355346 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bc3fd0>]}
[0m11:30:46.357201 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.54s]
[0m11:30:46.358682 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m11:30:46.359765 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.360421 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m11:30:46.361310 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m11:30:46.361784 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.367835 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.369477 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 11:30:46.362183 => 11:30:46.369069
[0m11:30:46.370104 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.376765 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.377990 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.378391 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m11:30:46.378741 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:46.701840 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:46.702540 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.703175 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:30:46.763134 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:30:46.772061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.773537 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m11:30:46.814934 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.823149 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.824460 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m11:30:46.865064 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.867239 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:30:46.867597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.867879 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:30:46.906193 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:46.908745 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m11:30:46.909429 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.909721 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m11:30:46.967184 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:46.969533 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 11:30:46.370412 => 11:30:46.969271
[0m11:30:46.970071 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m11:30:46.971342 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bda4d0>]}
[0m11:30:46.972110 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.61s]
[0m11:30:46.972814 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.973357 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m11:30:46.974253 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m11:30:46.975253 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m11:30:46.975650 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m11:30:46.978663 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m11:30:46.979821 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 11:30:46.975906 => 11:30:46.979533
[0m11:30:46.980336 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m11:30:46.984716 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m11:30:46.985356 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:46.985673 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m11:30:46.985944 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:47.260606 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:47.261785 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.262751 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m11:30:47.305176 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m11:30:47.313955 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.315339 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m11:30:47.349788 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.357602 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.358730 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m11:30:47.393289 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.399046 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:30:47.400179 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.401247 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:30:47.434846 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:47.442219 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m11:30:47.443869 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.444350 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m11:30:47.499510 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:47.502670 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 11:30:46.980624 => 11:30:47.502375
[0m11:30:47.503542 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m11:30:47.506516 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b80810>]}
[0m11:30:47.508103 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.53s]
[0m11:30:47.509821 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m11:30:47.510432 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.511176 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m11:30:47.513012 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m11:30:47.514364 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.525667 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.527796 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 11:30:47.515279 => 11:30:47.527227
[0m11:30:47.528667 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.535655 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.537038 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.537465 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m11:30:47.537813 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:47.792417 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:47.793673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.794108 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m11:30:47.827474 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:30:47.836424 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.837483 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m11:30:47.869621 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.877779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.879091 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m11:30:47.911637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.918702 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:30:47.919378 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.919737 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:30:47.950788 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:47.958509 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m11:30:47.960739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.961300 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m11:30:48.009617 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:48.013115 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 11:30:47.528979 => 11:30:48.012320
[0m11:30:48.014544 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m11:30:48.016932 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a73810>]}
[0m11:30:48.018628 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.50s]
[0m11:30:48.019589 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m11:30:48.020170 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.021597 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m11:30:48.023290 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m11:30:48.024236 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.033373 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.035939 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 11:30:48.024763 => 11:30:48.035200
[0m11:30:48.036788 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.041983 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.042854 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.043149 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m11:30:48.043424 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:48.296475 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:48.298300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.299878 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m11:30:55.447370 [debug] [Thread-1 (]: SQL status: SELECT 143172 in 7.0 seconds
[0m11:30:55.453915 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.454977 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m11:30:55.488711 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:55.494415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.495830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m11:30:55.527849 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:55.535056 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:30:55.536437 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.537663 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:30:55.569143 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:55.578355 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m11:30:55.580707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.581711 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m11:30:55.629274 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:55.631571 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 11:30:48.037251 => 11:30:55.631264
[0m11:30:55.632236 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m11:30:55.633930 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c11b50>]}
[0m11:30:55.634999 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143172[0m in 7.61s]
[0m11:30:55.635941 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:55.636669 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.637532 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m11:30:55.638684 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m11:30:55.639325 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.644248 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.646273 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 11:30:55.639734 => 11:30:55.645884
[0m11:30:55.646887 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.653927 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.655384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.655795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m11:30:55.656277 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:56.002756 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:56.004687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.006139 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m11:30:56.051680 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:30:56.069689 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.070739 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m11:30:56.113019 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.123060 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.124511 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m11:30:56.168339 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.175787 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:30:56.177212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.178585 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:30:56.222271 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:56.228597 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m11:30:56.229700 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.230182 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m11:30:56.288189 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:56.292839 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 11:30:55.647151 => 11:30:56.292071
[0m11:30:56.294383 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m11:30:56.297612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b77610>]}
[0m11:30:56.299661 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.66s]
[0m11:30:56.301767 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:56.303420 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.305274 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m11:30:56.307253 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m11:30:56.308364 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.314912 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.316761 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 11:30:56.309067 => 11:30:56.316338
[0m11:30:56.317758 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.325000 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.326480 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.327029 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m11:30:56.327521 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:56.671495 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:56.673501 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.675024 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m11:30:56.718381 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m11:30:56.730579 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.731396 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:30:56.768409 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.778965 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.779989 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.816963 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.822074 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:30:56.822856 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.823545 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:30:56.860711 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:56.863705 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:30:56.864556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.864918 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m11:30:56.922471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:56.923787 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 11:30:56.318236 => 11:30:56.923590
[0m11:30:56.924154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m11:30:56.924947 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999c9d0>]}
[0m11:30:56.925459 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.62s]
[0m11:30:56.925988 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.926394 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.926920 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m11:30:56.927626 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m11:30:56.928007 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.931070 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.932492 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 11:30:56.928232 => 11:30:56.932310
[0m11:30:56.932802 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.935922 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.936756 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.937030 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m11:30:56.937281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:57.239043 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:57.241037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:57.241970 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m11:31:01.860383 [debug] [Thread-1 (]: SQL status: SELECT 37355 in 5.0 seconds
[0m11:31:01.864490 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.864983 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:31:01.901335 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:01.903204 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.903449 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m11:31:01.939796 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:01.941380 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:31:01.941688 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.941968 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:31:01.977869 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:01.982967 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:31:01.983859 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.984260 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m11:31:02.036457 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:02.039930 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 11:30:56.932981 => 11:31:02.039486
[0m11:31:02.040773 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m11:31:02.042501 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c308a10>]}
[0m11:31:02.043675 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37355[0m in 5.11s]
[0m11:31:02.044750 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:31:02.045590 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.046596 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m11:31:02.047687 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m11:31:02.048212 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.096048 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.096690 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 11:31:02.048527 => 11:31:02.096544
[0m11:31:02.096934 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.099515 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.099940 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.100168 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m11:31:02.100383 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:02.399538 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:02.401514 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.403304 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m11:31:05.333968 [debug] [Thread-1 (]: SQL status: SELECT 114590 in 3.0 seconds
[0m11:31:05.346160 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.347704 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m11:31:05.380622 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:05.390896 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.392048 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m11:31:05.423618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:05.432179 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:31:05.433686 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.435056 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:31:05.467637 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:05.475779 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m11:31:05.478074 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.478903 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m11:31:05.527269 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:05.531997 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 11:31:02.097076 => 11:31:05.531714
[0m11:31:05.532627 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m11:31:05.534129 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c1f610>]}
[0m11:31:05.536152 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114590[0m in 3.49s]
[0m11:31:05.538151 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m11:31:05.539721 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.541623 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m11:31:05.544026 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m11:31:05.545154 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.551802 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.553206 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 11:31:05.545830 => 11:31:05.552803
[0m11:31:05.553858 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.559821 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.560677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.561101 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m11:31:05.561496 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:05.865705 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:05.867527 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.869357 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m11:31:05.951562 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m11:31:05.964036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.965584 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:31:06.004109 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.014153 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.015716 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m11:31:06.053859 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.061762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:31:06.063234 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.064612 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:31:06.102128 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:06.110820 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:31:06.114203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.115621 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m11:31:06.171203 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:06.176394 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 11:31:05.554221 => 11:31:06.175626
[0m11:31:06.177874 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m11:31:06.180707 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c41ed0>]}
[0m11:31:06.182660 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.64s]
[0m11:31:06.184585 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:06.185778 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m11:31:06.186977 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m11:31:06.188806 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m11:31:06.189607 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m11:31:06.195054 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m11:31:06.196335 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 11:31:06.190106 => 11:31:06.195937
[0m11:31:06.197006 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m11:31:06.205885 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m11:31:06.206703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.207038 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m11:31:06.207314 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:06.481992 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:06.484130 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.485870 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m11:31:06.522761 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:06.535191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.536657 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m11:31:06.571084 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.581452 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.582861 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m11:31:06.616809 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.624086 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:31:06.625486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.626699 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:31:06.660653 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:06.669769 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m11:31:06.672906 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.674275 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m11:31:06.725665 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:06.730673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 11:31:06.197369 => 11:31:06.729925
[0m11:31:06.732133 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m11:31:06.735218 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a61f50>]}
[0m11:31:06.736223 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.55s]
[0m11:31:06.738128 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m11:31:06.739505 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m11:31:06.740700 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m11:31:06.742639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m11:31:06.743699 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m11:31:06.750101 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.752481 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 11:31:06.744393 => 11:31:06.751946
[0m11:31:06.753143 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m11:31:06.758726 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.760046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.760590 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m11:31:06.760966 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:07.118257 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:07.120129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.121690 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m11:31:07.388068 [debug] [Thread-1 (]: SQL status: SELECT 54842 in 0.0 seconds
[0m11:31:07.399964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.401372 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m11:31:07.441211 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:07.451746 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.453206 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m11:31:07.493853 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:07.501307 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:31:07.502707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.504037 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:31:07.544840 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:07.553756 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m11:31:07.556784 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.558105 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m11:31:07.619110 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:07.623785 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 11:31:06.753444 => 11:31:07.623015
[0m11:31:07.625261 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m11:31:07.628614 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a61350>]}
[0m11:31:07.630618 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54842[0m in 0.89s]
[0m11:31:07.632683 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m11:31:07.634169 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.635641 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m11:31:07.637406 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m11:31:07.638300 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.654293 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.657099 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 11:31:07.638783 => 11:31:07.656563
[0m11:31:07.657752 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.672162 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.672868 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.673215 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m11:31:07.673535 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:07.926305 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:07.928131 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.929635 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:31:07.962768 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:07.970432 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 11:31:07.658073 => 11:31:07.969620
[0m11:31:07.970952 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m11:31:08.001578 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m11:31:08.004879 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.37s]
[0m11:31:08.006942 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:08.008432 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.009976 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m11:31:08.011802 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m11:31:08.012792 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.026253 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.027325 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 11:31:08.013401 => 11:31:08.027055
[0m11:31:08.027795 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.030346 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.030897 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.031100 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m11:31:08.031276 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:08.284707 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.287151 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.289368 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:31:08.321990 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:08.324919 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 11:31:08.028101 => 11:31:08.324428
[0m11:31:08.325515 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m11:31:08.356131 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m11:31:08.357798 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m11:31:08.358710 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.359463 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.360438 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m11:31:08.361489 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m11:31:08.362037 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.368326 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.369815 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 11:31:08.362308 => 11:31:08.369420
[0m11:31:08.370726 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.379082 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.380401 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.380906 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m11:31:08.381310 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:08.707437 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.709462 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.711268 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        betting_type,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    betting_type, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
  );
  
[0m11:31:09.066650 [debug] [Thread-1 (]: SQL status: SELECT 151945 in 0.0 seconds
[0m11:31:09.076242 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.077112 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m11:31:09.117176 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.128194 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.129382 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m11:31:09.169561 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.177995 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m11:31:09.179247 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.180303 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m11:31:09.220278 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:09.230537 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m11:31:09.233647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.234962 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m11:31:09.294863 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:09.300118 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 11:31:08.371410 => 11:31:09.299491
[0m11:31:09.301226 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m11:31:09.302676 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bc26d0>]}
[0m11:31:09.303599 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 151945[0m in 0.94s]
[0m11:31:09.304896 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:09.306253 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.307437 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m11:31:09.309250 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m11:31:09.310479 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.318773 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.321378 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 11:31:09.311251 => 11:31:09.320842
[0m11:31:09.322226 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.329804 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.331110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.331614 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m11:31:09.332091 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:09.633037 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:09.635049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.636817 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m11:31:09.755503 [debug] [Thread-1 (]: SQL status: SELECT 45422 in 0.0 seconds
[0m11:31:09.768496 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.769772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m11:31:09.806732 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.817268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.818376 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m11:31:09.855352 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.864119 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:31:09.865381 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.866357 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:31:09.903095 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:09.912951 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m11:31:09.916064 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.917418 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m11:31:09.974165 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:09.978944 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 11:31:09.322648 => 11:31:09.978181
[0m11:31:09.980364 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m11:31:09.983464 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097e3510>]}
[0m11:31:09.985448 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45422[0m in 0.67s]
[0m11:31:09.987100 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.988220 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m11:31:09.989524 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m11:31:09.991270 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m11:31:09.992295 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m11:31:09.999110 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.000597 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 11:31:09.992986 => 11:31:10.000288
[0m11:31:10.001209 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m11:31:10.010741 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.012518 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.013088 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m11:31:10.013558 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:10.337283 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:10.338212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.338832 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m11:31:10.407375 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m11:31:10.419077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.420138 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m11:31:10.460313 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:10.471410 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.472700 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m11:31:10.513348 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:10.522176 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:31:10.523695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.525023 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:31:10.564725 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:10.573756 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m11:31:10.576188 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.577306 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m11:31:10.635080 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:10.638841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 11:31:10.001632 => 11:31:10.638394
[0m11:31:10.639741 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m11:31:10.642156 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099b1510>]}
[0m11:31:10.643762 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.65s]
[0m11:31:10.644995 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m11:31:10.645950 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.647111 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m11:31:10.648614 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m11:31:10.649447 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.654879 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.656509 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 11:31:10.649931 => 11:31:10.656185
[0m11:31:10.657018 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.678664 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.679365 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.679689 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m11:31:10.679975 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:10.933729 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:10.935421 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.936912 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m11:31:10.971280 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m11:31:10.983224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.984676 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m11:31:11.016750 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:11.022241 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:31:11.023578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:11.024837 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:31:11.056184 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:11.064955 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m11:31:11.071225 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:11.072166 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m11:31:11.103565 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m11:31:11.108120 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 11:31:10.657321 => 11:31:11.107574
[0m11:31:11.109259 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m11:31:11.111154 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a73790>]}
[0m11:31:11.112208 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.46s]
[0m11:31:11.112872 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m11:31:11.114155 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.114734 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m11:31:11.115546 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m11:31:11.115985 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.122639 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.125330 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 11:31:11.116225 => 11:31:11.124783
[0m11:31:11.126497 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.130800 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.131986 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.132468 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m11:31:11.132929 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:11.385316 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:11.386945 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.388424 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:31:11.421135 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:11.423442 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 11:31:11.127100 => 11:31:11.423114
[0m11:31:11.424042 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m11:31:11.454448 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m11:31:11.456809 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.34s]
[0m11:31:11.457929 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.458772 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.459585 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m11:31:11.460592 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m11:31:11.461125 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.471920 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.474317 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 11:31:11.461488 => 11:31:11.473748
[0m11:31:11.475204 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.479387 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.480808 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.481316 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m11:31:11.481723 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:11.786839 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:11.787944 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.788515 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:31:11.827135 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:11.831085 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 11:31:11.475702 => 11:31:11.830547
[0m11:31:11.831971 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m11:31:11.869392 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m11:31:11.871042 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.41s]
[0m11:31:11.871774 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.873448 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:11.873916 [debug] [MainThread]: On master: BEGIN
[0m11:31:11.874259 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m11:31:12.177258 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:31:12.178658 [debug] [MainThread]: On master: COMMIT
[0m11:31:12.179490 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:12.180105 [debug] [MainThread]: On master: COMMIT
[0m11:31:12.216685 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:31:12.217325 [debug] [MainThread]: On master: Close
[0m11:31:12.218633 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:31:12.219049 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m11:31:12.219630 [info ] [MainThread]: 
[0m11:31:12.220125 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 47.17 seconds (47.17s).
[0m11:31:12.227325 [debug] [MainThread]: Command end result
[0m11:31:12.247049 [info ] [MainThread]: 
[0m11:31:12.247809 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:31:12.248276 [info ] [MainThread]: 
[0m11:31:12.248724 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m11:31:12.252377 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 47.374134, "process_user_time": 2.58209, "process_kernel_time": 0.240323, "process_mem_max_rss": "123699200", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m11:31:12.253202 [debug] [MainThread]: Command `dbt build` succeeded at 11:31:12.253025 after 47.38 seconds
[0m11:31:12.253769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ceefd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2ded0>]}
[0m11:31:12.254236 [debug] [MainThread]: Flushing usage events
