[0m22:56:07.621998 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73E4F9AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABDC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABC70>]}


============================== 22:56:07.739088 | e658d13a-3aea-45ae-96c8-380c5b933b1f ==============================
[0m22:56:07.739088 [info ] [MainThread]: Running with dbt=1.7.11
[0m22:56:07.760077 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'indirect_selection': 'eager', 'introspect': 'True', 'warn_error': 'None', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_cache_events': 'False', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'quiet': 'False', 'write_json': 'True', 'use_colors': 'True', 'invocation_command': 'dbt init', 'fail_fast': 'False', 'cache_selected_only': 'False', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'printer_width': '80', 'log_format': 'default', 'debug': 'False', 'partial_parse': 'True', 'target_path': 'None'}
[0m22:56:07.774041 [warn ] [MainThread]: [ConfigFolderDirectory]: Unable to parse dict {'dir': WindowsPath('C:/Users/Danila/.dbt')}
[0m22:56:07.774997 [info ] [MainThread]: Creating dbt configuration folder at 
[0m22:56:51.233243 [debug] [MainThread]: Starter project path: D:\Users\Danila\anaconda3\envs\dbt_env\lib\site-packages\dbt\include\starter_project
[0m22:56:51.541752 [info ] [MainThread]: 
Your new dbt project "campaign_performance" was created!

For more information on how to configure the profiles.yml file,
please consult the dbt documentation here:

  https://docs.getdbt.com/docs/configure-your-profile

One more thing:

Need help? Don't hesitate to reach out to us via GitHub issues or on Slack:

  https://community.getdbt.com/

Happy modeling!

[0m22:56:51.542948 [info ] [MainThread]: Setting up your profile.
[0m23:05:35.210962 [info ] [MainThread]: Profile campaign_performance written to C:\Users\Danila\.dbt\profiles.yml using target's profile_template.yml and your supplied values. Run 'dbt debug' to validate the connection.
[0m23:05:35.626903 [debug] [MainThread]: Command `dbt init` succeeded at 23:05:35.258368 after 567.86 seconds
[0m23:05:35.672312 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73E4F9AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABB80>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000001F73DFABCD0>]}
[0m23:05:35.708216 [debug] [MainThread]: Flushing usage events
[0m23:15:15.432463 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D63469D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C820>]}


============================== 23:15:15.573512 | 61319262-bf15-452b-a2d5-9e67fe184b2b ==============================
[0m23:15:15.573512 [info ] [MainThread]: Running with dbt=1.7.11
[0m23:15:15.604971 [debug] [MainThread]: running dbt with arguments {'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'introspect': 'True', 'log_path': 'logs', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'write_json': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'log_format': 'default', 'use_colors': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'printer_width': '80', 'warn_error': 'None', 'indirect_selection': 'eager', 'static_parser': 'True', 'invocation_command': 'dbt test', 'quiet': 'False', 'fail_fast': 'False'}
[0m23:15:15.631123 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m23:15:15.683477 [debug] [MainThread]: Command `dbt test` failed at 23:15:15.634122 after 0.40 seconds
[0m23:15:15.684472 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D63469D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2C850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000263D5E2CD60>]}
[0m23:15:15.688463 [debug] [MainThread]: Flushing usage events
[0m01:12:41.668518 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA6DF6AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA5F9A0D0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DDA00>]}


============================== 01:12:41.786091 | 1d747f0f-2e9f-4533-b232-cb7d88e2ca7d ==============================
[0m01:12:41.786091 [info ] [MainThread]: Running with dbt=1.7.11
[0m01:12:41.806607 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'debug': 'False', 'static_parser': 'True', 'indirect_selection': 'eager', 'introspect': 'True', 'version_check': 'True', 'log_cache_events': 'False', 'invocation_command': 'dbt run', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'cache_selected_only': 'False', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'no_print': 'None', 'printer_width': '80', 'quiet': 'False', 'fail_fast': 'False', 'log_path': 'logs'}
[0m01:12:41.808604 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m01:12:41.829961 [debug] [MainThread]: Command `dbt run` failed at 01:12:41.810604 after 0.31 seconds
[0m01:12:41.830960 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA6DF6AC0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DD490>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x0000020EA68DD5E0>]}
[0m01:12:41.831958 [debug] [MainThread]: Flushing usage events
[0m01:13:05.616119 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418E031A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x00000241904667F0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D9A0>]}


============================== 01:13:05.619147 | ced84743-8c0c-4886-a8f2-13495d16fd33 ==============================
[0m01:13:05.619147 [info ] [MainThread]: Running with dbt=1.7.11
[0m01:13:05.621104 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'target_path': 'None', 'log_cache_events': 'False', 'warn_error': 'None', 'log_format': 'default', 'fail_fast': 'False', 'log_path': 'logs', 'write_json': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'version_check': 'True', 'partial_parse': 'True', 'debug': 'False', 'no_print': 'None', 'quiet': 'False', 'use_experimental_parser': 'False', 'profiles_dir': 'C:\\Users\\Danila\\.dbt', 'invocation_command': 'dbt run', 'printer_width': '80', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'use_colors': 'True'}
[0m01:13:05.784488 [error] [MainThread]: Encountered an error:
Runtime Error
  No dbt_project.yml found at expected path D:\GitHub\dbt\dbt_project.yml
  Verify that each entry within packages.yml (and their transitive dependencies) contains a file named dbt_project.yml
  
[0m01:13:05.792792 [debug] [MainThread]: Command `dbt run` failed at 01:13:05.791806 after 0.26 seconds
[0m01:13:05.795750 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418E031A60>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D100>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x000002418DB1D190>]}
[0m01:13:05.798743 [debug] [MainThread]: Flushing usage events
[0m20:37:40.807979 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10700b4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105f8b150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070829d0>]}


============================== 20:37:40.809549 | 74a2d401-2971-489f-a9b4-4b18099f6724 ==============================
[0m20:37:40.809549 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:37:40.809876 [debug] [MainThread]: running dbt with arguments {'log_path': '/Users/danila/github/dbt/logs', 'fail_fast': 'False', 'static_parser': 'True', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'indirect_selection': 'eager', 'no_print': 'None', 'use_experimental_parser': 'False', 'version_check': 'True', 'log_format': 'default', 'introspect': 'True', 'quiet': 'False', 'printer_width': '80', 'profiles_dir': '/Users/danila/.dbt', 'target_path': 'None', 'cache_selected_only': 'False', 'use_colors': 'True', 'debug': 'False', 'invocation_command': 'dbt build --select staging', 'log_cache_events': 'False', 'warn_error': 'None'}
[0m20:37:40.875373 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10749b150>]}
[0m20:37:40.905313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10756b150>]}
[0m20:37:40.906503 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:37:40.913060 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:37:40.913505 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:37:40.913730 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '74a2d401-2971-489f-a9b4-4b18099f6724', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073bb750>]}
[0m20:37:41.341418 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:37:41.469997 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 0.6839943, "process_user_time": 1.226842, "process_kernel_time": 0.099768, "process_mem_max_rss": "120864768", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:37:41.470666 [debug] [MainThread]: Command `dbt build` failed at 20:37:41.470533 after 0.68 seconds
[0m20:37:41.471047 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107082fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107083010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107854ad0>]}
[0m20:37:41.471410 [debug] [MainThread]: Flushing usage events
[0m20:43:08.177390 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092bfd50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109336310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093369d0>]}


============================== 20:43:08.178802 | 91799ebb-b5dc-43ca-b0ba-e22b19d3b6db ==============================
[0m20:43:08.178802 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:43:08.179144 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'static_parser': 'True', 'write_json': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None', 'version_check': 'True', 'debug': 'False', 'quiet': 'False', 'introspect': 'True', 'printer_width': '80', 'log_path': '/Users/danila/github/dbt/logs', 'partial_parse': 'True', 'fail_fast': 'False', 'log_format': 'default', 'use_colors': 'True', 'no_print': 'None', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --exclude brand_performance', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager'}
[0m20:43:08.244244 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109881e50>]}
[0m20:43:08.274072 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10988ea10>]}
[0m20:43:08.274790 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:43:08.281528 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:43:08.281975 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:43:08.282212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': '91799ebb-b5dc-43ca-b0ba-e22b19d3b6db', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109955f90>]}
[0m20:43:08.724774 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:43:08.726844 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 0.5712106, "process_user_time": 1.220016, "process_kernel_time": 0.09036, "process_mem_max_rss": "121208832", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:43:08.727095 [debug] [MainThread]: Command `dbt run` failed at 20:43:08.727037 after 0.57 seconds
[0m20:43:08.727267 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109310710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104bb8d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104b7c850>]}
[0m20:43:08.727431 [debug] [MainThread]: Flushing usage events
[0m20:43:33.301284 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10708b750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070dd210>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10708b4d0>]}


============================== 20:43:33.302511 | d4151df4-94fc-46da-8755-145677dc48d1 ==============================
[0m20:43:33.302511 [info ] [MainThread]: Running with dbt=1.7.0
[0m20:43:33.302841 [debug] [MainThread]: running dbt with arguments {'debug': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'introspect': 'True', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_format': 'default', 'warn_error': 'None', 'no_print': 'None', 'log_path': '/Users/danila/github/dbt/logs', 'static_parser': 'True', 'target_path': 'None', 'profiles_dir': '/Users/danila/.dbt', 'quiet': 'False', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'invocation_command': 'dbt run --exclude outclick_cost_int_new', 'use_colors': 'True', 'printer_width': '80', 'indirect_selection': 'eager', 'fail_fast': 'False', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m20:43:33.366621 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10713cc90>]}
[0m20:43:33.397424 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107129410>]}
[0m20:43:33.397772 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m20:43:33.404077 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m20:43:33.404471 [info ] [MainThread]: Unable to do partial parsing because saved manifest not found. Starting full parse.
[0m20:43:33.404701 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'partial_parser', 'label': 'd4151df4-94fc-46da-8755-145677dc48d1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077227d0>]}
[0m20:43:33.847167 [error] [MainThread]: Encountered an error:
Compilation Error
  Model 'model.campaign_perfomance.outclick_cost_int_new' (models/brand_performance/outclick_cost_int_new.sql) depends on a node named 'stg_campaing_names_mapping__traffic_sources' which was not found
[0m20:43:33.848060 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 0.56731486, "process_user_time": 1.238614, "process_kernel_time": 0.082752, "process_mem_max_rss": "120389632", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m20:43:33.848303 [debug] [MainThread]: Command `dbt run` failed at 20:43:33.848245 after 0.57 seconds
[0m20:43:33.848477 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107102750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107103690>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102a0df10>]}
[0m20:43:33.848639 [debug] [MainThread]: Flushing usage events
[0m21:05:08.604221 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d79310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dc1b10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dde050>]}


============================== 21:05:08.605774 | f8797290-d42b-461e-8997-9797d038224c ==============================
[0m21:05:08.605774 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:05:08.606157 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'quiet': 'False', 'log_cache_events': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'send_anonymous_usage_stats': 'True', 'write_json': 'True', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'invocation_command': 'dbt debug', 'debug': 'False', 'profiles_dir': '/Users/danila/.dbt', 'warn_error': 'None', 'version_check': 'True', 'log_format': 'default', 'static_parser': 'True', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'printer_width': '80', 'target_path': 'None', 'introspect': 'True', 'use_colors': 'True'}
[0m21:05:08.606478 [info ] [MainThread]: dbt version: 1.7.0
[0m21:05:08.606650 [info ] [MainThread]: python version: 3.11.9
[0m21:05:08.606811 [info ] [MainThread]: python path: /opt/anaconda3/envs/dbt_env/bin/python
[0m21:05:08.606957 [info ] [MainThread]: os info: macOS-14.4.1-arm64-arm-64bit
[0m21:05:08.642948 [info ] [MainThread]: Using profiles dir at /Users/danila/.dbt
[0m21:05:08.643216 [info ] [MainThread]: Using profiles.yml file at /Users/danila/.dbt/profiles.yml
[0m21:05:08.643383 [info ] [MainThread]: Using dbt_project.yml file at /Users/danila/github/dbt/dbt_project.yml
[0m21:05:08.643671 [info ] [MainThread]: adapter type: postgres
[0m21:05:08.643821 [info ] [MainThread]: adapter version: 1.7.0
[0m21:05:08.670149 [info ] [MainThread]: Configuration:
[0m21:05:08.670400 [info ] [MainThread]:   profiles.yml file [[32mOK found and valid[0m]
[0m21:05:08.670558 [info ] [MainThread]:   dbt_project.yml file [[32mOK found and valid[0m]
[0m21:05:08.670699 [info ] [MainThread]: Required dependencies:
[0m21:05:08.670879 [debug] [MainThread]: Executing "git --help"
[0m21:05:08.679940 [debug] [MainThread]: STDOUT: "b"usage: git [-v | --version] [-h | --help] [-C <path>] [-c <name>=<value>]\n           [--exec-path[=<path>]] [--html-path] [--man-path] [--info-path]\n           [-p | --paginate | -P | --no-pager] [--no-replace-objects] [--bare]\n           [--git-dir=<path>] [--work-tree=<path>] [--namespace=<name>]\n           [--super-prefix=<path>] [--config-env=<name>=<envvar>]\n           <command> [<args>]\n\nThese are common Git commands used in various situations:\n\nstart a working area (see also: git help tutorial)\n   clone     Clone a repository into a new directory\n   init      Create an empty Git repository or reinitialize an existing one\n\nwork on the current change (see also: git help everyday)\n   add       Add file contents to the index\n   mv        Move or rename a file, a directory, or a symlink\n   restore   Restore working tree files\n   rm        Remove files from the working tree and from the index\n\nexamine the history and state (see also: git help revisions)\n   bisect    Use binary search to find the commit that introduced a bug\n   diff      Show changes between commits, commit and working tree, etc\n   grep      Print lines matching a pattern\n   log       Show commit logs\n   show      Show various types of objects\n   status    Show the working tree status\n\ngrow, mark and tweak your common history\n   branch    List, create, or delete branches\n   commit    Record changes to the repository\n   merge     Join two or more development histories together\n   rebase    Reapply commits on top of another base tip\n   reset     Reset current HEAD to the specified state\n   switch    Switch branches\n   tag       Create, list, delete or verify a tag object signed with GPG\n\ncollaborate (see also: git help workflows)\n   fetch     Download objects and refs from another repository\n   pull      Fetch from and integrate with another repository or a local branch\n   push      Update remote refs along with associated objects\n\n'git help -a' and 'git help -g' list available subcommands and some\nconcept guides. See 'git help <command>' or 'git help <concept>'\nto read about a specific subcommand or concept.\nSee 'git help git' for an overview of the system.\n""
[0m21:05:08.680379 [debug] [MainThread]: STDERR: "b''"
[0m21:05:08.680551 [info ] [MainThread]:  - git [[32mOK found[0m]

[0m21:05:08.680725 [info ] [MainThread]: Connection:
[0m21:05:08.680938 [info ] [MainThread]:   host: pg10-deepanalysis-db-do-user-3167072-0.b.db.ondigitalocean.com
[0m21:05:08.681079 [info ] [MainThread]:   port: 25060
[0m21:05:08.681216 [info ] [MainThread]:   user: doadmin
[0m21:05:08.681348 [info ] [MainThread]:   database: deep-analysis-console
[0m21:05:08.681479 [info ] [MainThread]:   schema: danila
[0m21:05:08.681604 [info ] [MainThread]:   connect_timeout: 50
[0m21:05:08.681731 [info ] [MainThread]:   role: None
[0m21:05:08.681860 [info ] [MainThread]:   search_path: None
[0m21:05:08.681983 [info ] [MainThread]:   keepalives_idle: 0
[0m21:05:08.682110 [info ] [MainThread]:   sslmode: require
[0m21:05:08.682236 [info ] [MainThread]:   sslcert: None
[0m21:05:08.682358 [info ] [MainThread]:   sslkey: None
[0m21:05:08.682481 [info ] [MainThread]:   sslrootcert: None
[0m21:05:08.682611 [info ] [MainThread]:   application_name: dbt
[0m21:05:08.682739 [info ] [MainThread]:   retries: 1
[0m21:05:08.682982 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:05:08.685923 [debug] [MainThread]: Acquiring new postgres connection 'debug'
[0m21:05:08.686331 [debug] [MainThread]: Using postgres connection "debug"
[0m21:05:08.686475 [debug] [MainThread]: On debug: select 1 as id
[0m21:05:08.686619 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:05:09.042089 [debug] [MainThread]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:09.046221 [debug] [MainThread]: On debug: Close
[0m21:05:09.047496 [info ] [MainThread]:   Connection test: [[32mOK connection ok[0m]

[0m21:05:09.048349 [info ] [MainThread]: [32mAll checks passed![0m
[0m21:05:09.053659 [debug] [MainThread]: Resource report: {"command_name": "debug", "command_success": true, "command_wall_clock_time": 0.47188365, "process_user_time": 0.779006, "process_kernel_time": 0.096975, "process_mem_max_rss": "113885184", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:05:09.054804 [debug] [MainThread]: Command `dbt debug` succeeded at 21:05:09.054561 after 0.47 seconds
[0m21:05:09.055481 [debug] [MainThread]: Connection 'debug' was properly closed.
[0m21:05:09.056107 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dde450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ddedd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2a9cd0>]}
[0m21:05:09.056835 [debug] [MainThread]: Flushing usage events
[0m21:05:13.103676 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106fd2f10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10704aa10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10704b0d0>]}


============================== 21:05:13.104876 | 9502d61d-8651-4f47-b855-61586a21c6f4 ==============================
[0m21:05:13.104876 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:05:13.105194 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'cache_selected_only': 'False', 'debug': 'False', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'partial_parse': 'True', 'quiet': 'False', 'static_parser': 'True', 'profiles_dir': '/Users/danila/.dbt', 'indirect_selection': 'eager', 'log_path': '/Users/danila/github/dbt/logs', 'use_experimental_parser': 'False', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'write_json': 'True', 'printer_width': '80', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'log_format': 'default', 'invocation_command': 'dbt run', 'target_path': 'None'}
[0m21:05:13.171646 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106a16fd0>]}
[0m21:05:13.202253 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075a7b10>]}
[0m21:05:13.202618 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:05:13.209260 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:05:13.229881 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:05:13.230112 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:05:13.233031 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1070855d0>]}
[0m21:05:13.237978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076aff50>]}
[0m21:05:13.238175 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:05:13.238351 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107679f50>]}
[0m21:05:13.239398 [info ] [MainThread]: 
[0m21:05:13.239749 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:05:13.240449 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:05:13.245030 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:05:13.245255 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:05:13.245399 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:05:13.532952 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:05:13.537077 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:05:13.541580 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:05:13.550857 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:05:13.551450 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:05:13.551801 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:05:13.902939 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:05:13.903597 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:05:13.904013 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:05:13.954098 [debug] [ThreadPool]: SQL status: SELECT 12 in 0.0 seconds
[0m21:05:13.957157 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:05:14.000622 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:05:14.015699 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.016218 [debug] [MainThread]: On master: BEGIN
[0m21:05:14.016645 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:05:14.319516 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.321197 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.322787 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:05:14.369508 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:05:14.373087 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107548790>]}
[0m21:05:14.373762 [debug] [MainThread]: On master: ROLLBACK
[0m21:05:14.411052 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.411939 [debug] [MainThread]: On master: BEGIN
[0m21:05:14.484236 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.485767 [debug] [MainThread]: On master: COMMIT
[0m21:05:14.487083 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:14.488068 [debug] [MainThread]: On master: COMMIT
[0m21:05:14.524909 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:05:14.525778 [debug] [MainThread]: On master: Close
[0m21:05:14.527755 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:05:14.528412 [info ] [MainThread]: 
[0m21:05:14.534188 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.534941 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:05:14.536147 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:05:14.536840 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.548044 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.549195 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:05:14.537192 => 21:05:14.548972
[0m21:05:14.549579 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:05:14.574432 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.575094 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.575318 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:05:14.575523 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:14.899486 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:14.901654 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:14.903416 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:05:34.033431 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:05:34.045437 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.046051 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:05:34.086598 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.092262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.092869 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:05:34.134447 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.161620 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:05:34.162137 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.162490 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:05:34.202536 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:34.211559 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:05:34.216666 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:05:34.217129 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:05:34.272162 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:34.274869 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:05:14.549787 => 21:05:34.274504
[0m21:05:34.275636 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:05:34.277472 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076b5ad0>]}
[0m21:05:34.278522 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.74s]
[0m21:05:34.279450 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:05:34.280090 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:05:34.280900 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:05:34.282006 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:05:34.282626 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:05:34.286302 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:05:34.287576 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:05:34.282935 => 21:05:34.287302
[0m21:05:34.287996 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:05:34.292368 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:05:34.293144 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.293482 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:05:34.293795 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:34.609327 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:34.611091 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.611929 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:05:34.660541 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:05:34.668372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.669142 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:05:34.702386 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.712024 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.712817 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:05:34.745545 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:34.750660 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:05:34.751413 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.752085 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:05:34.783891 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:34.788970 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:05:34.790556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:05:34.791279 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:05:34.839316 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:34.843698 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:05:34.288236 => 21:05:34.842967
[0m21:05:34.844757 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:05:34.846556 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078e86d0>]}
[0m21:05:34.847652 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.56s]
[0m21:05:34.848660 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:05:34.849355 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.850189 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:05:34.851238 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:05:34.851818 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.855809 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.857306 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:05:34.852198 => 21:05:34.856820
[0m21:05:34.857959 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:05:34.863239 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.864145 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:34.864552 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:05:34.864932 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:35.142747 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:35.144344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.145226 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:05:35.197438 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:05:35.206860 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.207544 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:05:35.241318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.246958 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.247618 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:05:35.281532 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.287134 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:05:35.287926 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.288633 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:05:35.322147 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:35.324413 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:05:35.325043 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:05:35.325306 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:05:35.376671 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:35.377880 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:05:34.858282 => 21:05:35.377708
[0m21:05:35.378212 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:05:35.378886 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078a4e90>]}
[0m21:05:35.379340 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.53s]
[0m21:05:35.379802 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:05:35.380136 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:05:35.380468 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m21:05:35.381040 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:05:35.381354 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:05:35.383789 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:05:35.384423 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:05:35.381538 => 21:05:35.384247
[0m21:05:35.384703 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:05:35.387498 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:05:35.387978 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.388220 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:05:35.388453 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:35.645112 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:35.646709 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.647537 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:05:35.688492 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:05:35.696420 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.697171 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:05:35.728537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.734528 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.735251 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:05:35.766504 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:35.770700 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:05:35.771493 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.772113 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:05:35.804349 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:35.810142 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:05:35.811481 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:05:35.812063 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:05:35.861062 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:35.865718 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:05:35.384873 => 21:05:35.864945
[0m21:05:35.866776 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:05:35.868170 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078468d0>]}
[0m21:05:35.869246 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.49s]
[0m21:05:35.870189 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:05:35.870805 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.871376 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:05:35.872448 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:05:35.872892 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.878453 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.879293 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:05:35.873136 => 21:05:35.879094
[0m21:05:35.879632 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:05:35.883432 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.884110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:35.884414 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:05:35.884674 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:36.141779 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:36.143685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.144960 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:05:36.179328 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:05:36.187092 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.187802 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:05:36.220198 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:36.223934 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:05:36.224596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.225152 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:05:36.255861 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:36.261108 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:05:36.262792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:05:36.263550 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:05:36.295535 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:36.300216 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:05:35.879835 => 21:05:36.299438
[0m21:05:36.300788 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:05:36.302265 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107561190>]}
[0m21:05:36.303212 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 2[0m in 0.43s]
[0m21:05:36.303963 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:05:36.304522 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.305068 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:05:36.306037 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:05:36.306695 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.312236 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.313255 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:05:36.307066 => 21:05:36.313006
[0m21:05:36.313679 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:36.317461 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.318142 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.318484 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:05:36.318799 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:36.578264 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:36.580398 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:36.582470 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:05:43.863902 [debug] [Thread-1 (]: SQL status: SELECT 142657 in 7.0 seconds
[0m21:05:43.871067 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.871729 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:05:43.903117 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:43.906960 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:05:43.907730 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.908366 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:05:43.939075 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:43.944921 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:05:43.946660 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:05:43.947414 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:05:43.979667 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:43.983038 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:05:36.313917 => 21:05:43.982614
[0m21:05:43.983834 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:05:43.985492 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10790ca90>]}
[0m21:05:43.986499 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142657[0m in 7.68s]
[0m21:05:43.987426 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:05:43.988106 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:43.988940 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:05:43.989880 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:05:43.990372 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:43.994432 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:43.995666 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:05:43.990683 => 21:05:43.995409
[0m21:05:43.996112 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:44.000734 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.001486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.001828 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:05:44.002145 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:44.300448 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:44.302530 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.303997 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:05:44.342924 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:44.349979 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.350817 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:05:44.387096 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:44.392584 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:05:44.393048 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.393450 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:05:44.429877 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:44.434623 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:05:44.440238 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:05:44.440826 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:05:44.477167 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:44.481634 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:05:43.996357 => 21:05:44.480892
[0m21:05:44.483007 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:05:44.484964 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10794bcd0>]}
[0m21:05:44.485842 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.50s]
[0m21:05:44.486547 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:05:44.487070 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.487663 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:05:44.488394 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:05:44.488805 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.491667 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.492593 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:05:44.489058 => 21:05:44.492377
[0m21:05:44.492934 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.496822 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.497495 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.497800 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:05:44.498100 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:44.755066 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:44.756855 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.757746 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:05:44.795604 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:05:44.803339 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.804125 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.835720 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:44.841309 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:05:44.841918 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.842479 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:05:44.874284 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:44.882663 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:05:44.883743 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:05:44.884304 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:05:44.916026 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:44.918617 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:05:44.493140 => 21:05:44.918274
[0m21:05:44.919285 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:05:44.920863 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107920dd0>]}
[0m21:05:44.921760 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.43s]
[0m21:05:44.922545 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:05:44.923157 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.924012 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:05:44.924984 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:05:44.925468 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.929381 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.930317 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:05:44.925772 => 21:05:44.930068
[0m21:05:44.930736 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:44.935336 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.936049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:44.936390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:05:44.936712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:45.194333 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:45.196388 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:45.198162 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:05:49.800755 [debug] [Thread-1 (]: SQL status: SELECT 37204 in 5.0 seconds
[0m21:05:49.808029 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.808658 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:05:49.840458 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:49.845640 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.846420 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:05:49.888673 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:49.895318 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:05:49.896111 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.896863 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:05:49.928865 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:49.936267 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:05:49.937573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:05:49.938154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:05:49.984087 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:49.987338 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:05:44.930984 => 21:05:49.986932
[0m21:05:49.988155 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:05:49.989987 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078b16d0>]}
[0m21:05:49.991097 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37204[0m in 5.07s]
[0m21:05:49.992222 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:05:49.993074 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:05:49.994097 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:05:49.995122 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:05:49.995708 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:05:49.999924 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.001509 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:05:49.996087 => 21:05:50.001123
[0m21:05:50.002029 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:05:50.007843 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.008616 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.009000 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:05:50.009371 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:50.264389 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:50.266346 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:50.268043 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:05:53.284837 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:05:53.294107 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.294823 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:05:53.326192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.331490 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.332193 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:05:53.363329 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.420128 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:05:53.420537 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.420785 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:05:53.451484 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:53.453279 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:05:53.453888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:05:53.454151 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:05:53.499039 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:53.500468 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:05:50.002323 => 21:05:53.500250
[0m21:05:53.500882 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:05:53.501767 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107004c50>]}
[0m21:05:53.502333 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.51s]
[0m21:05:53.502945 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:05:53.503390 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.503931 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:05:53.504695 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:05:53.505090 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.508526 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.509259 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:05:53.505343 => 21:05:53.509074
[0m21:05:53.509591 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:53.513187 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.513740 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.514022 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:05:53.514287 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:53.842697 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:53.844832 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.846417 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name, 
    NULL as brand_name, 
    NULL as unique_outclicks, 
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:05:53.928490 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:05:53.936779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.937376 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:05:53.977302 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:53.983314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:53.983991 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:05:54.023827 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:54.028901 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:05:54.029755 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:54.030483 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:05:54.069688 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:54.075825 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:05:54.077146 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:05:54.077731 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:05:54.135619 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:54.139354 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:05:53.509783 => 21:05:54.138930
[0m21:05:54.140123 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:05:54.141786 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1075e2350>]}
[0m21:05:54.142748 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.64s]
[0m21:05:54.143704 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:05:54.144369 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:05:54.145084 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test ..................................... [RUN]
[0m21:05:54.145964 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:05:54.146425 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:05:54.150785 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:05:54.151951 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:05:54.146743 => 21:05:54.151687
[0m21:05:54.152377 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:05:54.156932 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:05:54.157674 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:05:54.158009 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:05:54.158326 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:54.575833 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:54.577814 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:05:54.578666 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  
    

  create  table "deep-analysis-console"."danila"."test__dbt_tmp"
  
  
    as
  
  (
    select 
    date_parsed, 
    date
    geo as country_code, 
    registrations as signups
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
    and geo='vn'
    and brand_name='20bet'
    and registrations>0
order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
  
[0m21:05:54.623671 [debug] [Thread-1 (]: Postgres adapter: Postgres error: syntax error at or near "as"
LINE 15:     geo as country_code, 
                 ^

[0m21:05:54.624710 [debug] [Thread-1 (]: On model.campaign_perfomance.test: ROLLBACK
[0m21:05:54.668699 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:05:54.152626 => 21:05:54.668037
[0m21:05:54.670179 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:05:54.683700 [debug] [Thread-1 (]: Database Error in model test (models/brand_performance/test.sql)
  syntax error at or near "as"
  LINE 15:     geo as country_code, 
                   ^
  compiled Code at target/run/campaign_perfomance/models/brand_performance/test.sql
[0m21:05:54.684423 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078ac450>]}
[0m21:05:54.685419 [error] [Thread-1 (]: 12 of 17 ERROR creating sql table model danila.test ............................ [[31mERROR[0m in 0.54s]
[0m21:05:54.686293 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:05:54.686843 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:05:54.687487 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.test_write ............................... [RUN]
[0m21:05:54.688314 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:05:54.688775 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:05:54.692198 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:05:54.693137 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:05:54.689054 => 21:05:54.692918
[0m21:05:54.693519 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:05:54.697904 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:05:54.698535 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:54.698845 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:05:54.699139 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:54.955838 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:54.957679 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:54.958662 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:05:54.992725 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:55.001060 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.001844 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:05:55.033951 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.043045 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.043637 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:05:55.074708 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.078781 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:05:55.079379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.079922 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:05:55.110920 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:55.116527 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:05:55.118190 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:05:55.118905 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:05:55.167108 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:55.171397 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:05:54.693743 => 21:05:55.170706
[0m21:05:55.171893 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:05:55.173283 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076a9950>]}
[0m21:05:55.174272 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m21:05:55.175054 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:05:55.175615 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:05:55.176261 [info ] [Thread-1 (]: 14 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:05:55.177136 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:05:55.177544 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:05:55.181070 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.181994 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:05:55.177794 => 21:05:55.181761
[0m21:05:55.182388 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:05:55.186605 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.187253 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.187582 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:05:55.187880 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:55.563900 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:55.565849 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.567227 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:05:55.818357 [debug] [Thread-1 (]: SQL status: SELECT 54001 in 0.0 seconds
[0m21:05:55.827440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.828044 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:05:55.867406 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.872596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.873362 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:05:55.912965 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:55.920298 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:05:55.920889 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.921434 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:05:55.960927 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:55.967191 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:05:55.968239 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:05:55.969032 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:05:56.026105 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:56.030177 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:05:55.182623 => 21:05:56.029750
[0m21:05:56.031026 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:05:56.032990 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10764c450>]}
[0m21:05:56.034254 [info ] [Thread-1 (]: 14 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54001[0m in 0.86s]
[0m21:05:56.035505 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:05:56.036424 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.037524 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.my_second_dbt_model ...................... [RUN]
[0m21:05:56.038580 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m21:05:56.039190 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.043325 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.044780 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:05:56.039573 => 21:05:56.044546
[0m21:05:56.045557 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.051354 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.052165 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.052558 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:05:56.052919 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:56.312365 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:56.314415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.315919 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
  
  
    as
  
  (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
  
[0m21:05:56.349843 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:05:56.356965 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.358136 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:05:56.389522 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:56.395317 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:05:56.395964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.396491 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:05:56.427559 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:56.434560 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:05:56.435637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:05:56.436076 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:05:56.466960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:56.469457 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:05:56.045916 => 21:05:56.469050
[0m21:05:56.470231 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:05:56.471906 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076ad450>]}
[0m21:05:56.472850 [info ] [Thread-1 (]: 15 of 17 OK created sql table model danila.my_second_dbt_model ................. [[32mSELECT 1[0m in 0.43s]
[0m21:05:56.473737 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:05:56.474429 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.475237 [info ] [Thread-1 (]: 16 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:05:56.476165 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:05:56.476688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.481371 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.482657 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:05:56.477026 => 21:05:56.482346
[0m21:05:56.483125 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:56.490095 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.490931 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.491279 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:05:56.491613 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:56.804397 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:56.806512 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:56.808259 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:05:57.278519 [debug] [Thread-1 (]: SQL status: SELECT 123957 in 0.0 seconds
[0m21:05:57.287392 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.287976 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:05:57.326570 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.332487 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.333182 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:05:57.373223 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.379824 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:05:57.380504 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.381055 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:05:57.419453 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:57.425208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:05:57.426511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:05:57.427049 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:05:57.486212 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:57.490786 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:05:56.483362 => 21:05:57.490017
[0m21:05:57.492180 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:05:57.493494 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107067510>]}
[0m21:05:57.494514 [info ] [Thread-1 (]: 16 of 17 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123957[0m in 1.02s]
[0m21:05:57.495419 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:05:57.496015 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.496568 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:05:57.497516 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:05:57.498001 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.501440 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.502348 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:05:57.498255 => 21:05:57.502120
[0m21:05:57.502740 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:05:57.506983 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.507675 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.508004 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:05:57.508319 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:05:57.761796 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:05:57.763553 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.764455 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:05:57.824775 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:05:57.833262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.833836 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:05:57.864665 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.869427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.869987 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:05:57.900884 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:05:57.905755 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:05:57.906692 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.907418 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:05:57.938183 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:05:57.943673 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:05:57.945402 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:05:57.946158 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:05:57.996609 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:05:58.000522 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:05:57.502975 => 21:05:58.000095
[0m21:05:58.001332 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:05:58.003290 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '9502d61d-8651-4f47-b855-61586a21c6f4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1076d5890>]}
[0m21:05:58.004490 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.51s]
[0m21:05:58.005677 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:05:58.008532 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:58.009103 [debug] [MainThread]: On master: BEGIN
[0m21:05:58.009607 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:05:58.322118 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:05:58.323895 [debug] [MainThread]: On master: COMMIT
[0m21:05:58.325119 [debug] [MainThread]: Using postgres connection "master"
[0m21:05:58.326288 [debug] [MainThread]: On master: COMMIT
[0m21:05:58.364343 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:05:58.365550 [debug] [MainThread]: On master: Close
[0m21:05:58.368438 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:05:58.369458 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:05:58.370138 [info ] [MainThread]: 
[0m21:05:58.370785 [info ] [MainThread]: Finished running 17 table models in 0 hours 0 minutes and 45.13 seconds (45.13s).
[0m21:05:58.374520 [debug] [MainThread]: Command end result
[0m21:05:58.387902 [info ] [MainThread]: 
[0m21:05:58.388418 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:05:58.388730 [info ] [MainThread]: 
[0m21:05:58.389016 [error] [MainThread]:   Database Error in model test (models/brand_performance/test.sql)
  syntax error at or near "as"
  LINE 15:     geo as country_code, 
                   ^
  compiled Code at target/run/campaign_perfomance/models/brand_performance/test.sql
[0m21:05:58.389324 [info ] [MainThread]: 
[0m21:05:58.389636 [info ] [MainThread]: Done. PASS=16 WARN=0 ERROR=1 SKIP=0 TOTAL=17
[0m21:05:58.391135 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 45.307163, "process_user_time": 1.991761, "process_kernel_time": 0.204073, "process_mem_max_rss": "125321216", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:05:58.391618 [debug] [MainThread]: Command `dbt run` failed at 21:05:58.391503 after 45.31 seconds
[0m21:05:58.391972 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1028ccdd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102955f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107072ed0>]}
[0m21:05:58.392310 [debug] [MainThread]: Flushing usage events
[0m21:19:57.328665 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a4a350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aae510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aaebd0>]}


============================== 21:19:57.330038 | 7459d65c-69ff-4e6c-b1e6-1d6998fe308a ==============================
[0m21:19:57.330038 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:19:57.330405 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'version_check': 'True', 'printer_width': '80', 'log_path': '/Users/danila/github/dbt/logs', 'log_cache_events': 'False', 'use_colors': 'True', 'warn_error': 'None', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'log_format': 'default', 'use_experimental_parser': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'target_path': 'None', 'quiet': 'False', 'fail_fast': 'False', 'no_print': 'None', 'static_parser': 'True', 'invocation_command': 'dbt build', 'partial_parse': 'True', 'debug': 'False'}
[0m21:19:57.394212 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109acf950>]}
[0m21:19:57.424546 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a01f690>]}
[0m21:19:57.425718 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:19:57.432065 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:19:57.445874 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:19:57.446113 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:19:57.448954 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ec190>]}
[0m21:19:57.454287 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2240d0>]}
[0m21:19:57.454504 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:19:57.455639 [info ] [MainThread]: 
[0m21:19:57.456026 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:19:57.456771 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:19:57.461299 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:19:57.461496 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:19:57.461647 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:19:57.837810 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:19:57.843465 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:19:57.847432 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:19:57.854331 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:19:57.854758 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:19:57.855091 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:19:58.205710 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.207462 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:19:58.208926 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:19:58.257733 [debug] [ThreadPool]: SQL status: SELECT 17 in 0.0 seconds
[0m21:19:58.263900 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:19:58.307526 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:19:58.321334 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.321815 [debug] [MainThread]: On master: BEGIN
[0m21:19:58.322227 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:19:58.582428 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.584201 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.587712 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:19:58.629721 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:19:58.633997 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a20ec50>]}
[0m21:19:58.635375 [debug] [MainThread]: On master: ROLLBACK
[0m21:19:58.666387 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.667418 [debug] [MainThread]: On master: BEGIN
[0m21:19:58.730216 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:19:58.731265 [debug] [MainThread]: On master: COMMIT
[0m21:19:58.731911 [debug] [MainThread]: Using postgres connection "master"
[0m21:19:58.732391 [debug] [MainThread]: On master: COMMIT
[0m21:19:58.763238 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:19:58.764816 [debug] [MainThread]: On master: Close
[0m21:19:58.767358 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:19:58.768226 [info ] [MainThread]: 
[0m21:19:58.774798 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.775832 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:19:58.776987 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:19:58.777585 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.791013 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.792070 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:19:58.777973 => 21:19:58.791833
[0m21:19:58.792475 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:19:58.818310 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.818861 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:58.819101 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:19:58.819322 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:19:59.072758 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:19:59.074489 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:19:59.076130 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:20:16.323859 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:20:16.335307 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.335932 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:20:16.367210 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.371875 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.372470 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:20:16.403445 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.425631 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:20:16.426036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.426369 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:20:16.456637 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:16.462558 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:20:16.466651 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:20:16.467005 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:20:16.510365 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:16.512138 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:19:58.792712 => 21:20:16.511865
[0m21:20:16.512644 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:20:16.513774 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a0b18d0>]}
[0m21:20:16.514555 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 17.74s]
[0m21:20:16.515299 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:20:16.515839 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:20:16.516524 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:20:16.517379 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:20:16.517854 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:20:16.521147 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:20:16.522098 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:20:16.518155 => 21:20:16.521870
[0m21:20:16.522497 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:20:16.526708 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:20:16.527321 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.527645 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:20:16.527952 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:16.805633 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:16.807720 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.809201 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:20:16.857960 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:20:16.866703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.867289 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:20:16.898895 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.907055 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.907853 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:20:16.938739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:16.943240 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:20:16.943992 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.944681 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:20:16.975990 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:16.982572 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:20:16.983629 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:20:16.984073 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:20:17.032267 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:17.034831 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:20:16.522736 => 21:20:17.034433
[0m21:20:17.035637 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:20:17.037506 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a480590>]}
[0m21:20:17.038708 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.52s]
[0m21:20:17.039797 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:20:17.040496 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.041382 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:20:17.042372 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:20:17.042914 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.047315 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.048605 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:20:17.043271 => 21:20:17.048315
[0m21:20:17.049096 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.054253 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.055202 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.055620 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:20:17.055989 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:17.313333 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:17.315328 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.316836 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:20:17.368219 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:20:17.376396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.376894 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:20:17.408304 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.413533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.414277 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:20:17.445850 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.453147 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:20:17.454503 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.455247 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:20:17.486798 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:17.493196 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:20:17.494213 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:20:17.494638 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:20:17.544966 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:17.546757 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:20:17.049385 => 21:20:17.546564
[0m21:20:17.547132 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:20:17.547891 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a401190>]}
[0m21:20:17.548339 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.51s]
[0m21:20:17.548801 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:20:17.549151 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:20:17.549593 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:20:17.550137 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:20:17.550434 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:20:17.552661 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:20:17.553191 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:20:17.550614 => 21:20:17.553048
[0m21:20:17.553449 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:20:17.556295 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:20:17.556822 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.557061 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:20:17.557281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:17.883248 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:17.885291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.886866 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:20:17.934438 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:20:17.942985 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.943634 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:20:17.982813 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:17.988011 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:17.988663 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:20:18.027772 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.032786 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:20:18.033593 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:18.034289 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:20:18.073979 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:18.080433 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:20:18.082132 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:20:18.082871 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:20:18.140337 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:18.144673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:20:17.553606 => 21:20:18.144243
[0m21:20:18.145486 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:20:18.147313 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a454810>]}
[0m21:20:18.148308 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.60s]
[0m21:20:18.149224 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:20:18.149941 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.150845 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:20:18.151802 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:20:18.152293 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.159122 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.160224 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:20:18.152617 => 21:20:18.159929
[0m21:20:18.160666 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.164903 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.165483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.165830 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:20:18.166148 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:18.422474 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:18.424522 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.426025 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
    union all
    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:20:18.460392 [debug] [Thread-1 (]: SQL status: SELECT 2 in 0.0 seconds
[0m21:20:18.468042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.468836 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:20:18.500655 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.507435 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.508185 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:20:18.539682 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:18.544763 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:20:18.545609 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.546363 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:20:18.578229 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:18.585790 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:20:18.587458 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:20:18.588233 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:20:18.637796 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:18.640391 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:20:18.160910 => 21:20:18.639983
[0m21:20:18.641202 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:20:18.643068 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4c9090>]}
[0m21:20:18.644217 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 2[0m in 0.49s]
[0m21:20:18.645354 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:20:18.646054 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.647170 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:20:18.648239 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:20:18.648854 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.655431 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.656483 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:20:18.649246 => 21:20:18.656219
[0m21:20:18.657003 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:18.661859 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.662607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:18.663009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:20:18.663364 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:19.014820 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:19.016687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:19.018179 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:20:26.360817 [debug] [Thread-1 (]: SQL status: SELECT 142662 in 7.0 seconds
[0m21:20:26.369268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.370024 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:20:26.413762 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.420738 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.421559 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:20:26.464960 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.469486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:20:26.470350 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.471122 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:20:26.515043 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:26.521204 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:20:26.522665 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:20:26.523173 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:20:26.586379 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:26.590806 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:20:18.657298 => 21:20:26.590471
[0m21:20:26.591580 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:20:26.593072 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a262810>]}
[0m21:20:26.593975 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142662[0m in 7.95s]
[0m21:20:26.594759 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:20:26.595326 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.595953 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:20:26.596695 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:20:26.597095 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.600129 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.601100 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:20:26.597345 => 21:20:26.600868
[0m21:20:26.601505 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:26.605383 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.606194 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.606527 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:20:26.606837 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:26.862675 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:26.864716 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.866241 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:20:26.900022 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:26.911426 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.911986 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:20:26.942921 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.948399 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.949097 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:20:26.979519 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:26.983649 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:20:26.984318 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:26.984875 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:20:27.016617 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:27.022937 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:20:27.024212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:20:27.024760 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:20:27.071944 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:27.076995 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:20:26.601746 => 21:20:27.076223
[0m21:20:27.077839 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:20:27.079472 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a26fc10>]}
[0m21:20:27.080345 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.48s]
[0m21:20:27.081101 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:20:27.081695 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.082340 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:20:27.083177 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:20:27.083579 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.086792 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.087696 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:20:27.083819 => 21:20:27.087452
[0m21:20:27.088100 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.092038 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.092712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.093037 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:20:27.093352 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:27.371664 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:27.373871 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.375474 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:20:27.415254 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:20:27.423365 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.423956 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:20:27.457443 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:27.463063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.463860 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.499042 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:27.505451 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:20:27.506223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.506928 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:20:27.540606 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:27.548259 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:20:27.549989 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:20:27.550750 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:20:27.603263 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:27.605949 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:20:27.088338 => 21:20:27.605533
[0m21:20:27.606691 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:20:27.608269 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a003190>]}
[0m21:20:27.609190 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.53s]
[0m21:20:27.610071 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:20:27.610725 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.611494 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:20:27.612611 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:20:27.613172 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.618811 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.620014 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:20:27.613529 => 21:20:27.619715
[0m21:20:27.620461 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:27.624803 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.625423 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.625762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:20:27.626078 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:27.954588 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:27.956615 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:27.958398 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:20:32.604447 [debug] [Thread-1 (]: SQL status: SELECT 37209 in 5.0 seconds
[0m21:20:32.610367 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.610978 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:20:32.650354 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:32.652414 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.652686 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:20:32.691121 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:32.692708 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:20:32.693012 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.693293 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:20:32.732106 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:32.737184 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:20:32.738073 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:20:32.738475 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:20:32.792166 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:32.795053 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:20:27.620708 => 21:20:32.794714
[0m21:20:32.795679 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:20:32.797062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a490c90>]}
[0m21:20:32.797988 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37209[0m in 5.18s]
[0m21:20:32.798765 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:20:32.799383 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.800106 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:20:32.800955 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:20:32.801431 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.839398 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.840029 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:20:32.801992 => 21:20:32.839883
[0m21:20:32.840289 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:20:32.842913 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.843303 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:32.843518 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:20:32.843723 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:33.095672 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:33.097618 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:33.099345 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:20:36.086272 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:20:36.093776 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.094740 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:20:36.128397 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.134826 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.135638 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:20:36.167771 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.173526 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:20:36.174119 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.174584 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:20:36.205429 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:36.209895 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:20:36.211520 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:20:36.212252 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:20:36.260260 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:36.264763 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:20:32.840435 => 21:20:36.263985
[0m21:20:36.265589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:20:36.267484 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c403a50>]}
[0m21:20:36.268581 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.47s]
[0m21:20:36.269512 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:20:36.270203 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.271219 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:20:36.272298 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:20:36.272891 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.277673 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.279069 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:20:36.273230 => 21:20:36.278742
[0m21:20:36.279619 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.284871 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.285633 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.286056 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:20:36.286427 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:36.610954 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:36.612648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.614318 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:20:36.695684 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:20:36.703848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.704665 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:20:36.744256 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.749677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.750474 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:20:36.790719 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:36.796418 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:20:36.797199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.797909 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:20:36.838647 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:36.844939 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:20:36.846578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:20:36.847367 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:20:36.905369 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:36.908591 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:20:36.279928 => 21:20:36.908199
[0m21:20:36.909390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:20:36.911237 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4a8b50>]}
[0m21:20:36.912354 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.64s]
[0m21:20:36.913475 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:20:36.914331 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:20:36.915354 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test ..................................... [RUN]
[0m21:20:36.916660 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:20:36.917255 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:20:36.921584 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:20:36.923666 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:20:36.917643 => 21:20:36.922718
[0m21:20:36.924341 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:20:36.931148 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:20:36.932083 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:36.932473 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:20:36.932832 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:37.210570 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:37.212559 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.214046 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  
    

  create  table "deep-analysis-console"."danila"."test__dbt_tmp"
  
  
    as
  
  (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
  
[0m21:20:37.248972 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:37.256307 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.257090 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:20:37.288274 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.292293 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:20:37.293055 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.293739 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:20:37.325674 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:37.331382 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:20:37.332997 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:20:37.333769 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop table if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:20:37.366064 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:37.370498 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:20:36.924659 => 21:20:37.369770
[0m21:20:37.371656 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:20:37.373153 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109f9ddd0>]}
[0m21:20:37.374071 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test ................................ [[32mSELECT 1[0m in 0.46s]
[0m21:20:37.374949 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:20:37.375619 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:20:37.376362 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:20:37.377301 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:20:37.377792 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:20:37.381549 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:20:37.382719 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:20:37.378127 => 21:20:37.382413
[0m21:20:37.383225 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:20:37.388662 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:20:37.389434 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.389781 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:20:37.390099 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:37.644436 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:37.644830 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.645073 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:20:37.677528 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:37.679762 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.680033 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:20:37.710633 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.712885 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.713338 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:20:37.743704 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:37.746106 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:20:37.746560 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.746979 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:20:37.778233 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:37.782487 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:20:37.783794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:20:37.784447 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:20:37.832289 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:37.835639 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:20:37.383515 => 21:20:37.835192
[0m21:20:37.836484 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:20:37.838421 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a41ee90>]}
[0m21:20:37.839604 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.46s]
[0m21:20:37.840747 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:20:37.841633 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:20:37.842416 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:20:37.843410 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:20:37.843972 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:20:37.848844 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.850387 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:20:37.844329 => 21:20:37.849967
[0m21:20:37.850977 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:20:37.856524 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.857291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:37.857690 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:20:37.858056 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:38.182858 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:38.184819 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.185958 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:20:38.439653 [debug] [Thread-1 (]: SQL status: SELECT 54020 in 0.0 seconds
[0m21:20:38.447834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.448372 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:20:38.487751 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:38.493053 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.493809 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:20:38.533565 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:38.539996 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:20:38.540446 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.540842 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:20:38.580230 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:38.588682 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:20:38.590344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:20:38.591070 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:20:38.651071 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:38.654095 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:20:37.851279 => 21:20:38.653692
[0m21:20:38.654933 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:20:38.656736 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a235a10>]}
[0m21:20:38.657844 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54020[0m in 0.81s]
[0m21:20:38.658960 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:20:38.659830 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.660934 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:20:38.662156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:20:38.662727 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.677902 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.679082 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:20:38.663125 => 21:20:38.678835
[0m21:20:38.679534 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:38.690797 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.691407 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:38.691716 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:20:38.691959 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.016814 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.018793 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:20:39.019685 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:20:39.060831 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:39.065852 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:20:38.679782 => 21:20:39.065393
[0m21:20:39.066702 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:20:39.106249 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:20:39.109209 [error] [Thread-1 (]: 15 of 21 FAIL 1 not_null_my_first_dbt_model_id ................................. [[31mFAIL 1[0m in 0.45s]
[0m21:20:39.110420 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:20:39.111226 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.112059 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:20:39.113074 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:20:39.113628 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.123630 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.124777 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:20:39.113985 => 21:20:39.124521
[0m21:20:39.125231 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.127712 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.128378 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.128716 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:20:39.129029 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.385332 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.387407 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:20:39.388589 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:20:39.421574 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:20:39.425687 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:20:39.125476 => 21:20:39.425230
[0m21:20:39.426584 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:20:39.457453 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:20:39.460665 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m21:20:39.462003 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:20:39.463010 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.464524 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:20:39.466022 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:20:39.466836 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.473705 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.475169 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:20:39.467410 => 21:20:39.474911
[0m21:20:39.475922 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:39.481277 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.482257 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.482661 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:20:39.483033 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:39.797494 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:39.798907 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:39.799904 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:20:40.387198 [debug] [Thread-1 (]: SQL status: SELECT 123962 in 1.0 seconds
[0m21:20:40.397080 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.397809 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:20:40.437055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:40.443488 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.444100 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:20:40.482959 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:40.488438 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:20:40.489235 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.489952 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:20:40.528276 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:40.536106 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:20:40.537097 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:20:40.537760 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:20:40.598471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:40.602958 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:20:39.476360 => 21:20:40.602670
[0m21:20:40.603511 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:20:40.604634 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a28d1d0>]}
[0m21:20:40.605395 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123962[0m in 1.14s]
[0m21:20:40.606096 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:20:40.606623 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.607239 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:20:40.608063 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:20:40.608488 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.612060 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.612843 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:20:40.608736 => 21:20:40.612646
[0m21:20:40.613189 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:20:40.616873 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.617425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.617749 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:20:40.618048 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:20:40.980813 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:20:40.981960 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:40.982622 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:20:41.058711 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:20:41.069427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.070069 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:20:41.114282 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:41.119109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.119625 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:20:41.163232 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:20:41.167928 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:20:41.168701 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.169380 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:20:41.213506 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:20:41.220748 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:20:41.222454 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:20:41.223115 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:20:41.285779 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:20:41.288611 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:20:40.613393 => 21:20:41.288271
[0m21:20:41.289266 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:20:41.290813 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '7459d65c-69ff-4e6c-b1e6-1d6998fe308a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a260150>]}
[0m21:20:41.291692 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.68s]
[0m21:20:41.292441 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:20:41.293026 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:20:41.293923 [info ] [Thread-1 (]: 19 of 21 SKIP relation danila.my_second_dbt_model .............................. [[33mSKIP[0m]
[0m21:20:41.294570 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:20:41.295567 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:20:41.296213 [info ] [Thread-1 (]: 20 of 21 SKIP test not_null_my_second_dbt_model_id ............................. [[33mSKIP[0m]
[0m21:20:41.296874 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:20:41.297406 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:20:41.297945 [info ] [Thread-1 (]: 21 of 21 SKIP test unique_my_second_dbt_model_id ............................... [[33mSKIP[0m]
[0m21:20:41.298494 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:20:41.299975 [debug] [MainThread]: Using postgres connection "master"
[0m21:20:41.300340 [debug] [MainThread]: On master: BEGIN
[0m21:20:41.300655 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:20:41.582538 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:20:41.584408 [debug] [MainThread]: On master: COMMIT
[0m21:20:41.585662 [debug] [MainThread]: Using postgres connection "master"
[0m21:20:41.586829 [debug] [MainThread]: On master: COMMIT
[0m21:20:41.619079 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:20:41.619894 [debug] [MainThread]: On master: Close
[0m21:20:41.621910 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:20:41.622546 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:20:41.623435 [info ] [MainThread]: 
[0m21:20:41.624174 [info ] [MainThread]: Finished running 17 table models, 4 tests in 0 hours 0 minutes and 44.17 seconds (44.17s).
[0m21:20:41.629377 [debug] [MainThread]: Command end result
[0m21:20:41.644115 [info ] [MainThread]: 
[0m21:20:41.644605 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:20:41.644962 [info ] [MainThread]: 
[0m21:20:41.645294 [error] [MainThread]: [31mFailure in test not_null_my_first_dbt_model_id (models/example/schema.yml)[0m
[0m21:20:41.645618 [error] [MainThread]:   Got 1 result, configured to fail if != 0
[0m21:20:41.645926 [info ] [MainThread]: 
[0m21:20:41.646230 [info ] [MainThread]:   compiled Code at target/compiled/campaign_perfomance/models/example/schema.yml/not_null_my_first_dbt_model_id.sql
[0m21:20:41.646580 [info ] [MainThread]: 
[0m21:20:41.646949 [info ] [MainThread]: Done. PASS=17 WARN=0 ERROR=1 SKIP=3 TOTAL=21
[0m21:20:41.649332 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 44.342804, "process_user_time": 2.073458, "process_kernel_time": 0.210257, "process_mem_max_rss": "124616704", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:20:41.649941 [debug] [MainThread]: Command `dbt build` failed at 21:20:41.649805 after 44.34 seconds
[0m21:20:41.650369 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105330dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aae150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109aaf9d0>]}
[0m21:20:41.650756 [debug] [MainThread]: Flushing usage events
[0m21:24:20.007080 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cefb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109733150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d66d50>]}


============================== 21:24:20.008330 | 3afbd538-2027-485a-ae0e-a18dbbdab62e ==============================
[0m21:24:20.008330 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:24:20.008644 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'log_path': '/Users/danila/github/dbt/logs', 'no_print': 'None', 'use_experimental_parser': 'False', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/danila/.dbt', 'fail_fast': 'False', 'write_json': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'target_path': 'None', 'static_parser': 'True', 'introspect': 'True', 'use_colors': 'True', 'log_format': 'default', 'debug': 'False', 'invocation_command': 'dbt build', 'version_check': 'True', 'partial_parse': 'True', 'warn_error': 'None'}
[0m21:24:20.071922 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2d6b50>]}
[0m21:24:20.101847 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2c3e10>]}
[0m21:24:20.102177 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:24:20.108168 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:24:20.121007 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:24:20.121218 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:24:20.121713 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:24:20.124480 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a241510>]}
[0m21:24:20.129609 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3bbcd0>]}
[0m21:24:20.129843 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:24:20.130966 [info ] [MainThread]: 
[0m21:24:20.131326 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:24:20.132101 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:24:20.136396 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:24:20.136580 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:24:20.136724 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:24:20.559128 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:24:20.565115 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:24:20.568886 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:24:20.575876 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:24:20.576323 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:24:20.576659 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:24:20.930773 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:24:20.932668 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:24:20.934109 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:24:20.982851 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:24:20.987516 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:24:21.029488 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:24:21.043236 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.043925 [debug] [MainThread]: On master: BEGIN
[0m21:24:21.044483 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:24:21.405750 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.406873 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.407584 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:24:21.460681 [debug] [MainThread]: SQL status: SELECT 46 in 0.0 seconds
[0m21:24:21.465962 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093cddd0>]}
[0m21:24:21.466836 [debug] [MainThread]: On master: ROLLBACK
[0m21:24:21.510481 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.511215 [debug] [MainThread]: On master: BEGIN
[0m21:24:21.597437 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.598329 [debug] [MainThread]: On master: COMMIT
[0m21:24:21.598763 [debug] [MainThread]: Using postgres connection "master"
[0m21:24:21.599103 [debug] [MainThread]: On master: COMMIT
[0m21:24:21.643065 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:24:21.643862 [debug] [MainThread]: On master: Close
[0m21:24:21.645820 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:24:21.646512 [info ] [MainThread]: 
[0m21:24:21.652346 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.653399 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:24:21.654574 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:24:21.655163 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.668970 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.670040 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:24:21.655563 => 21:24:21.669767
[0m21:24:21.670476 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:24:21.697224 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.697794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.698029 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:24:21.698248 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:21.951151 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:21.952837 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:21.954339 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:24:39.089629 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:24:39.102563 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.103323 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:24:39.191327 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:39.194608 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.195033 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:24:39.427563 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:39.455374 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:24:39.455994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.456360 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:24:39.685600 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:39.696999 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:24:39.702515 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:24:39.703035 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:24:39.771895 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:39.775417 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:24:21.670724 => 21:24:39.775011
[0m21:24:39.776205 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:24:39.777929 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3de8d0>]}
[0m21:24:39.779025 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 18.12s]
[0m21:24:39.780120 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:24:39.780906 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:24:39.781814 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:24:39.782767 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:24:39.783288 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:24:39.787354 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:24:39.788333 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:24:39.783615 => 21:24:39.788085
[0m21:24:39.788778 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:24:39.791468 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:24:39.791938 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:39.792121 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:24:39.792291 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:40.907982 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:40.908425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:40.908768 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:24:41.282481 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:24:41.288468 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.289276 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:24:41.357399 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:41.368565 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.369273 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:24:41.507720 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:41.512433 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:24:41.513026 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.513557 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:24:41.591009 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:41.597302 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:24:41.599066 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:24:41.599810 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:24:41.756049 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:41.759451 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:24:39.789028 => 21:24:41.759038
[0m21:24:41.760262 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:24:41.762297 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5e9890>]}
[0m21:24:41.763532 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 1.98s]
[0m21:24:41.764692 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:24:41.765558 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.766391 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:24:41.767435 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:24:41.767961 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.773088 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.774434 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:24:41.768313 => 21:24:41.774105
[0m21:24:41.774943 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:24:41.780363 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.781314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:41.781729 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:24:41.782109 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:42.931237 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:42.933379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:42.934526 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:24:43.016563 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:24:43.023896 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.024715 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:24:43.101083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.107419 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.108169 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:24:43.156192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.161453 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:24:43.162192 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.162853 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:24:43.209653 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:43.215982 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:24:43.217117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:24:43.217584 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:24:43.282013 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:43.286496 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:24:41.775245 => 21:24:43.285684
[0m21:24:43.287972 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:24:43.290097 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5da3d0>]}
[0m21:24:43.291010 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 1.52s]
[0m21:24:43.291821 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:24:43.292424 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:24:43.293126 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:24:43.293906 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:24:43.294339 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:24:43.299064 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:24:43.300420 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:24:43.294632 => 21:24:43.300141
[0m21:24:43.300896 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:24:43.305592 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:24:43.306200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.306534 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:24:43.306841 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:43.573026 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:43.575352 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.576884 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:24:43.614537 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:24:43.621445 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.622119 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:24:43.661570 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.666970 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.667738 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:24:43.700120 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:43.704925 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:24:43.705567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.706008 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:24:43.748607 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:43.753744 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:24:43.755460 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:24:43.756206 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:24:43.812686 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:43.817296 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:24:43.301158 => 21:24:43.816488
[0m21:24:43.818716 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:24:43.820501 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4dbb50>]}
[0m21:24:43.821268 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.53s]
[0m21:24:43.822404 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:24:43.823031 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.823720 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:24:43.824778 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:24:43.825268 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.830759 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.831652 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:24:43.825534 => 21:24:43.831452
[0m21:24:43.831986 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:24:43.835783 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.836419 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:43.836748 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:24:43.837060 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:44.498641 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:44.500850 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.502260 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:24:44.557807 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:24:44.566970 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.567805 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:24:44.621854 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:44.628116 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.628896 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:24:44.683405 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:44.688363 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:24:44.689125 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.689823 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:24:44.751978 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:44.757609 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:24:44.759036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:24:44.759691 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:24:44.836790 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:44.840850 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:24:43.832195 => 21:24:44.840567
[0m21:24:44.841440 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:24:44.842920 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4b77d0>]}
[0m21:24:44.843789 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 1.02s]
[0m21:24:44.844536 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:24:44.845095 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.845746 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:24:44.846705 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:24:44.847184 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.852510 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.853460 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:24:44.847471 => 21:24:44.853231
[0m21:24:44.853864 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:44.857719 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.858303 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:44.858624 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:24:44.858927 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:45.205088 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:24:45.207033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:45.209041 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:24:52.809434 [debug] [Thread-1 (]: SQL status: SELECT 142662 in 8.0 seconds
[0m21:24:52.816681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:52.817541 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:24:52.954635 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:52.961564 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:52.962172 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:24:53.006705 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:53.011983 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:24:53.012473 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:53.012898 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:24:53.043889 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:53.048271 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:24:53.049614 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:24:53.050216 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:24:53.097806 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:53.102410 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:24:44.854071 => 21:24:53.101657
[0m21:24:53.103176 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:24:53.104588 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a4a42d0>]}
[0m21:24:53.105842 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142662[0m in 8.26s]
[0m21:24:53.106712 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:24:53.107346 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.108055 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:24:53.108998 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:24:53.109443 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.112645 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.113601 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:24:53.109702 => 21:24:53.113353
[0m21:24:53.114029 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:53.117936 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.118604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.118936 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:24:53.119261 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:53.867573 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:53.869795 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:53.871328 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:24:54.020794 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:24:54.032632 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.033239 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:24:54.116887 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:54.125243 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.125977 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:24:54.244081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:54.250335 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:24:54.251293 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.252114 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:24:54.328421 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:54.335385 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:24:54.337487 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:24:54.338234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:24:54.431402 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:54.436630 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:24:53.114269 => 21:24:54.435839
[0m21:24:54.437776 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:24:54.439859 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a26e690>]}
[0m21:24:54.441053 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 1.33s]
[0m21:24:54.442028 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:24:54.442748 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.443592 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:24:54.444642 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:24:54.445226 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.450510 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.451922 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:24:54.445601 => 21:24:54.451591
[0m21:24:54.452472 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:54.457419 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.458244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:54.458676 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:24:54.459057 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:55.543122 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:55.545355 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.546961 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:24:55.833526 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:24:55.835578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.835836 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:24:55.931982 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:55.936806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:55.937405 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.123526 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:24:56.128420 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:24:56.129136 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.129759 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:24:56.316249 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:24:56.319060 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:24:56.319808 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:24:56.320126 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:24:56.423666 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:24:56.429619 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:24:54.452773 => 21:24:56.428768
[0m21:24:56.431177 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:24:56.433228 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3d12d0>]}
[0m21:24:56.434301 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 1.99s]
[0m21:24:56.435266 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:24:56.435876 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.436538 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:24:56.437411 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:24:56.437870 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.441688 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.442644 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:24:56.438118 => 21:24:56.442403
[0m21:24:56.443053 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:24:56.446948 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.447708 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:56.448044 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:24:56.448355 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:24:57.150562 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:24:57.152366 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:24:57.153562 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:25:02.022417 [debug] [Thread-1 (]: SQL status: SELECT 37209 in 5.0 seconds
[0m21:25:02.030375 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.031283 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:25:02.080101 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:02.085759 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.086317 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:25:02.134647 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:02.139762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:25:02.140479 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.141030 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:25:02.188109 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:02.198287 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:25:02.199411 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:25:02.199843 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:25:02.264404 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:02.267375 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:24:56.443288 => 21:25:02.266939
[0m21:25:02.268111 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:25:02.269701 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a690210>]}
[0m21:25:02.270691 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37209[0m in 5.83s]
[0m21:25:02.271600 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:25:02.272237 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.273011 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:25:02.273956 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:25:02.274467 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.318187 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.318812 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:25:02.274853 => 21:25:02.318674
[0m21:25:02.319043 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:25:02.321458 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.321842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.322067 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:25:02.322274 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:02.707788 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:02.709369 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:02.710331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:25:05.711059 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:25:05.720338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.721009 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:25:05.760011 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:05.765433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.766224 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:25:05.798033 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:05.804085 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:25:05.804699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.805249 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:25:05.836430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:05.838661 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:25:05.839293 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:25:05.839569 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:25:05.891053 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:05.892266 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:25:02.319176 => 21:25:05.892094
[0m21:25:05.892586 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:25:05.893228 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a690490>]}
[0m21:25:05.893657 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.62s]
[0m21:25:05.894110 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:25:05.894458 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.894955 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:25:05.895553 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:25:05.895872 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.898534 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.899149 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:25:05.896066 => 21:25:05.898978
[0m21:25:05.899450 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:05.902591 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.903062 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:05.903339 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:25:05.903583 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:06.279034 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:06.281133 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.282861 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:25:06.368127 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:25:06.375438 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.376257 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:25:06.491310 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:06.499265 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.499898 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:25:06.555131 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:06.560720 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:25:06.561225 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.561872 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:25:06.628441 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:06.635036 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:25:06.636669 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:25:06.637259 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:25:06.711398 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:06.714538 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:25:05.899618 => 21:25:06.714185
[0m21:25:06.715227 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:25:06.716749 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a65d990>]}
[0m21:25:06.717636 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.82s]
[0m21:25:06.718411 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:25:06.718969 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:25:06.719596 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:25:06.720717 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:25:06.721420 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:25:06.725187 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:25:06.726557 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:25:06.721740 => 21:25:06.725902
[0m21:25:06.727004 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:25:06.743241 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:25:06.743794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:06.744050 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:25:06.744297 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:07.427547 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:07.429653 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.431183 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:25:07.483427 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:25:07.491223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.491764 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:25:07.537055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:07.544239 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.544773 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:25:07.589488 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:07.595884 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:25:07.596768 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.597186 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:25:07.639642 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:07.645371 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:25:07.646995 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:25:07.647708 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop table if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:25:07.708759 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:07.711994 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:25:06.727240 => 21:25:07.711454
[0m21:25:07.713120 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:25:07.714681 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a64b450>]}
[0m21:25:07.715528 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.99s]
[0m21:25:07.716322 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:25:07.716894 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:25:07.717595 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:25:07.718490 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:25:07.718963 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:25:07.722111 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:25:07.723038 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:25:07.719218 => 21:25:07.722804
[0m21:25:07.723446 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:25:07.727362 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:25:07.727942 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:07.728268 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:25:07.728572 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:07.982418 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:07.983866 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:07.984676 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:25:08.018016 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:08.025719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.026474 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:25:08.057816 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.064082 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.064839 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:25:08.096792 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.101695 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:25:08.102430 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.103090 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:25:08.134770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:08.140005 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:25:08.141596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:25:08.142297 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:25:08.190984 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:08.195256 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:25:07.723684 => 21:25:08.194532
[0m21:25:08.196618 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:25:08.199284 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109028890>]}
[0m21:25:08.200162 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.48s]
[0m21:25:08.201020 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:25:08.201621 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:25:08.202316 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:25:08.203208 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:25:08.203688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:25:08.208520 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.209829 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:25:08.203997 => 21:25:08.209521
[0m21:25:08.210336 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:25:08.215241 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.216003 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.216392 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:25:08.216731 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:08.580390 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:08.582337 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.583900 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:25:08.850409 [debug] [Thread-1 (]: SQL status: SELECT 54032 in 0.0 seconds
[0m21:25:08.858035 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.858622 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:25:08.967322 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:08.979300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:08.979982 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:25:09.092929 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:09.098025 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:25:09.098645 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:09.099204 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:25:09.209235 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:09.217003 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:25:09.218171 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:25:09.218846 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:25:09.284087 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:09.288285 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:25:08.210620 => 21:25:09.287700
[0m21:25:09.289420 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:25:09.291452 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a5eaf10>]}
[0m21:25:09.292711 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54032[0m in 1.09s]
[0m21:25:09.293910 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:25:09.294834 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.295990 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:25:09.297266 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:25:09.297906 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.313886 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.314908 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:25:09.298270 => 21:25:09.314672
[0m21:25:09.315321 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.326265 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.326751 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.327033 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:25:09.327286 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:09.597645 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:09.599583 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:25:09.600872 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:25:09.633912 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:09.639365 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:25:09.315531 => 21:25:09.638909
[0m21:25:09.640220 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:25:09.671089 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:25:09.674487 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.38s]
[0m21:25:09.675668 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:25:09.676577 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.677543 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:25:09.678909 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:25:09.679679 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.690883 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.692220 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:25:09.680203 => 21:25:09.691919
[0m21:25:09.692736 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:09.695705 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.696501 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.696893 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:25:09.697262 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:09.949616 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:09.951239 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:25:09.952320 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:25:09.985458 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:09.988770 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:25:09.693035 => 21:25:09.988321
[0m21:25:09.989597 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:25:10.020645 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:25:10.023878 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.34s]
[0m21:25:10.025113 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:25:10.026010 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.027294 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:25:10.028663 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:25:10.029405 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.035800 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.037297 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:25:10.029921 => 21:25:10.037059
[0m21:25:10.038100 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:10.043937 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.044870 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.045264 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:25:10.045663 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:10.422831 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:10.424888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.426634 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:25:10.926575 [debug] [Thread-1 (]: SQL status: SELECT 123962 in 0.0 seconds
[0m21:25:10.930046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.930468 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:25:10.982900 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:10.988869 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:10.989483 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:25:11.040607 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:11.045486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:25:11.046265 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:11.046961 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:25:11.098077 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:11.103765 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:25:11.105443 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:25:11.106178 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:25:11.179857 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:11.181515 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:25:10.038602 => 21:25:11.181278
[0m21:25:11.181949 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:25:11.182878 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a654c90>]}
[0m21:25:11.183484 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123962[0m in 1.15s]
[0m21:25:11.184088 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:25:11.184545 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.185110 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:25:11.185824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:25:11.186173 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.190957 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.191629 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:25:11.186386 => 21:25:11.191459
[0m21:25:11.191916 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:25:11.195292 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.195927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.196214 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:25:11.196484 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:11.872629 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:11.874657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.875778 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:25:11.962288 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:25:11.970453 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:11.971102 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:25:12.109486 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:12.115711 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.116501 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:25:12.228659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:12.234790 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:25:12.235511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.236045 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:25:12.329372 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:12.336009 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:25:12.337237 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:25:12.337805 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:25:12.465006 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:12.468810 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:25:11.192087 => 21:25:12.468389
[0m21:25:12.469431 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:25:12.470890 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a46f490>]}
[0m21:25:12.471682 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 1.29s]
[0m21:25:12.472420 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:25:12.472978 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.473612 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:25:12.474417 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:25:12.475175 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.479422 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.480594 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:25:12.475637 => 21:25:12.480294
[0m21:25:12.481033 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:25:12.485786 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.486557 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:12.486897 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:25:12.487217 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:13.164599 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:13.166712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.167782 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:25:13.211242 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:25:13.220932 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.221937 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model" rename to "my_second_dbt_model__dbt_backup"
[0m21:25:13.262262 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:13.269565 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.270127 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:25:13.309465 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:25:13.314901 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:25:13.315502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.316034 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:25:13.355574 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:25:13.364613 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:25:13.365994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:25:13.366506 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:25:13.424611 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:25:13.429661 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:25:12.481285 => 21:25:13.428900
[0m21:25:13.430967 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:25:13.432233 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3afbd538-2027-485a-ae0e-a18dbbdab62e', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a431590>]}
[0m21:25:13.432999 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.96s]
[0m21:25:13.433737 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:25:13.434743 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.435242 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:25:13.435918 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:25:13.436319 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.440995 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.441901 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:25:13.436559 => 21:25:13.441702
[0m21:25:13.442238 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.444286 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.444908 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.445252 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:25:13.445575 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:13.749093 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:25:13.751039 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:25:13.752147 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:25:13.787467 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:13.791422 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:25:13.442436 => 21:25:13.790969
[0m21:25:13.792278 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:25:13.825813 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:25:13.829164 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.39s]
[0m21:25:13.830151 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:25:13.830893 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.831588 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:25:13.832599 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:25:13.833136 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.843465 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.844631 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:25:13.833465 => 21:25:13.844357
[0m21:25:13.845073 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:13.847558 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.848243 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:13.848602 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:25:13.848906 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:25:14.353427 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:25:14.355370 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:25:14.356486 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:25:14.397400 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:25:14.401209 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:25:13.845317 => 21:25:14.400760
[0m21:25:14.402053 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:25:14.441693 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:25:14.445460 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.61s]
[0m21:25:14.446499 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:25:14.449000 [debug] [MainThread]: Using postgres connection "master"
[0m21:25:14.449515 [debug] [MainThread]: On master: BEGIN
[0m21:25:14.449918 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:25:14.750296 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:25:14.751787 [debug] [MainThread]: On master: COMMIT
[0m21:25:14.752679 [debug] [MainThread]: Using postgres connection "master"
[0m21:25:14.753509 [debug] [MainThread]: On master: COMMIT
[0m21:25:14.789845 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:25:14.790542 [debug] [MainThread]: On master: Close
[0m21:25:14.792241 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:25:14.792870 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:25:14.793728 [info ] [MainThread]: 
[0m21:25:14.794432 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 54.66 seconds (54.66s).
[0m21:25:14.798934 [debug] [MainThread]: Command end result
[0m21:25:14.811582 [info ] [MainThread]: 
[0m21:25:14.812125 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:25:14.812486 [info ] [MainThread]: 
[0m21:25:14.812825 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:25:14.814657 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 54.83329, "process_user_time": 2.23321, "process_kernel_time": 0.215548, "process_mem_max_rss": "126107648", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:25:14.815164 [debug] [MainThread]: Command `dbt build` succeeded at 21:25:14.815051 after 54.83 seconds
[0m21:25:14.815532 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105671f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055e8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1055e8210>]}
[0m21:25:14.815885 [debug] [MainThread]: Flushing usage events
[0m21:38:10.439632 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ddf450>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e56710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e56dd0>]}


============================== 21:38:10.440973 | b3847aeb-0698-406e-bebb-c55418e8106d ==============================
[0m21:38:10.440973 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:38:10.441340 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'version_check': 'True', 'use_colors': 'True', 'cache_selected_only': 'False', 'profiles_dir': '/Users/danila/.dbt', 'log_path': '/Users/danila/github/dbt/logs', 'printer_width': '80', 'no_print': 'None', 'indirect_selection': 'eager', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'write_json': 'True', 'quiet': 'False', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'static_parser': 'True', 'log_cache_events': 'False', 'introspect': 'True', 'invocation_command': 'dbt build', 'warn_error': 'None', 'debug': 'False'}
[0m21:38:10.505627 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107df17d0>]}
[0m21:38:10.535721 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083b38d0>]}
[0m21:38:10.536246 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:38:10.542725 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:38:10.557998 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:38:10.558212 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:38:10.558714 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:38:10.561310 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1085b91d0>]}
[0m21:38:10.566931 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084c3cd0>]}
[0m21:38:10.567194 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:38:10.568320 [info ] [MainThread]: 
[0m21:38:10.568711 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:38:10.569474 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:38:10.573806 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:38:10.573998 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:38:10.574154 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:38:10.967375 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:38:10.972195 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:38:10.976297 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:38:10.985056 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:38:10.985534 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:38:10.985870 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:38:11.341398 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:38:11.343200 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:38:11.344618 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:38:11.463190 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:38:11.468345 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:38:11.510915 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:38:11.526720 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.527257 [debug] [MainThread]: On master: BEGIN
[0m21:38:11.527648 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:38:11.834910 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:11.836091 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.836891 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:38:11.888028 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:38:11.892502 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107114c10>]}
[0m21:38:11.893509 [debug] [MainThread]: On master: ROLLBACK
[0m21:38:11.930346 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:11.931363 [debug] [MainThread]: On master: BEGIN
[0m21:38:12.004833 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:12.005811 [debug] [MainThread]: On master: COMMIT
[0m21:38:12.006951 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:12.008048 [debug] [MainThread]: On master: COMMIT
[0m21:38:12.045246 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:38:12.046511 [debug] [MainThread]: On master: Close
[0m21:38:12.049701 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:38:12.050454 [info ] [MainThread]: 
[0m21:38:12.056204 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.057073 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:38:12.058157 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:38:12.058724 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.071470 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.072386 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:38:12.059092 => 21:38:12.072169
[0m21:38:12.072763 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:38:12.097756 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.098337 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.098570 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:38:12.098787 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:12.375833 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:12.377861 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:12.379378 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:38:31.181684 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:38:31.193793 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.194490 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:38:31.229007 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:31.234671 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.235477 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:38:31.269870 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:31.297806 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:38:31.298415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.298836 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:38:31.332542 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:31.339970 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:38:31.344739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:38:31.345097 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:38:31.392786 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:31.395535 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:38:12.072975 => 21:38:31.395191
[0m21:38:31.396224 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:38:31.397781 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108573450>]}
[0m21:38:31.398764 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.34s]
[0m21:38:31.399555 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:38:31.400336 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:38:31.401242 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:38:31.402294 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:38:31.402818 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:38:31.406308 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:38:31.407353 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:38:31.403140 => 21:38:31.407099
[0m21:38:31.407768 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:38:31.411944 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:38:31.412545 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:31.412883 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:38:31.413195 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:32.009717 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m21:38:32.011445 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.012806 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:38:32.063299 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:38:32.072042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.072890 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:38:32.104657 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.113177 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.113953 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:38:32.144976 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.149531 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:38:32.150542 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.151118 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:38:32.182381 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:32.186625 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:38:32.188004 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:38:32.188543 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:38:32.239454 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:32.244163 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:38:31.408013 => 21:38:32.243391
[0m21:38:32.245355 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:38:32.246970 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086de0d0>]}
[0m21:38:32.247946 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.84s]
[0m21:38:32.248774 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:38:32.249405 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.250096 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:38:32.250989 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:38:32.251721 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.255831 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.256873 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:38:32.252075 => 21:38:32.256589
[0m21:38:32.257309 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.261760 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.262532 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.262919 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:38:32.263234 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:32.535297 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:32.535714 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.535953 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:38:32.584837 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:38:32.587502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.587831 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:38:32.618296 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.620786 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.621088 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:38:32.651838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:32.653933 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:38:32.654329 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.654703 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:38:32.685575 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:32.688779 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:38:32.689808 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:38:32.690261 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:38:32.738960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:32.742303 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:38:32.257551 => 21:38:32.741880
[0m21:38:32.743150 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:38:32.744979 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086f88d0>]}
[0m21:38:32.746181 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.49s]
[0m21:38:32.747287 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:38:32.748069 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:38:32.748872 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:38:32.749895 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:38:32.750421 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:38:32.755468 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:38:32.756687 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:38:32.750721 => 21:38:32.756362
[0m21:38:32.757226 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:38:32.762449 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:38:32.763178 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:32.763566 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:38:32.763923 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:33.018581 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:33.020164 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.021182 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:38:33.059691 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:38:33.068236 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.069045 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:38:33.100273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.105591 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.106349 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:38:33.137946 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.142649 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:38:33.143510 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.144268 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:38:33.175099 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:33.180769 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:38:33.182343 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:38:33.182933 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:38:33.231562 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:33.234247 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:38:32.757524 => 21:38:33.233949
[0m21:38:33.234853 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:38:33.236491 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108732050>]}
[0m21:38:33.237466 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.49s]
[0m21:38:33.238261 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:38:33.238855 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.239623 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:38:33.240353 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:38:33.240748 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.245814 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.246656 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:38:33.241001 => 21:38:33.246462
[0m21:38:33.247007 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.250689 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.251284 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.251607 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:38:33.251904 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:33.568611 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:33.570676 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.572240 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:38:33.613369 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:33.622170 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.623038 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:38:33.661974 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.667550 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.668332 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:38:33.706809 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:33.711701 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:38:33.712314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.712845 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:38:33.751469 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:33.757846 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:38:33.759476 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:38:33.760200 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:38:33.815616 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:33.819217 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:38:33.247205 => 21:38:33.818821
[0m21:38:33.820039 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:38:33.821907 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108730990>]}
[0m21:38:33.823035 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.58s]
[0m21:38:33.823962 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:38:33.824635 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.825657 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:38:33.826639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:38:33.827185 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.834055 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.835327 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:38:33.827522 => 21:38:33.835030
[0m21:38:33.835823 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:33.840534 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.841257 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:33.841604 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:38:33.841929 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:34.098690 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:34.100719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:34.101868 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:38:41.186365 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:38:41.188747 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.189034 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:38:41.220390 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.222480 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.222742 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:38:41.253937 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.255590 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:38:41.255894 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.256118 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:38:41.287006 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:41.289063 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:38:41.289664 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:38:41.289890 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:38:41.336083 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:41.337337 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:38:33.836091 => 21:38:41.337180
[0m21:38:41.337652 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:38:41.338411 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10857d9d0>]}
[0m21:38:41.338837 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.51s]
[0m21:38:41.339229 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:38:41.339530 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.339961 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:38:41.340516 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:38:41.340793 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.342732 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.343367 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:38:41.340944 => 21:38:41.343241
[0m21:38:41.343607 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.346005 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.346440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.346635 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:38:41.346828 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:41.695081 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:41.695574 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.695830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:38:41.741201 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:41.746269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.746583 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:38:41.789653 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.792912 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.793379 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:38:41.836912 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:41.841356 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:38:41.842008 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.842571 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:38:41.885581 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:41.893489 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:38:41.894889 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:38:41.895608 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:38:41.958207 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:41.961672 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:38:41.343743 => 21:38:41.961252
[0m21:38:41.962504 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:38:41.964544 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086b86d0>]}
[0m21:38:41.965739 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.62s]
[0m21:38:41.966891 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:38:41.967806 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.968900 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:38:41.970058 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:38:41.970647 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.975773 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.977003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:38:41.971013 => 21:38:41.976689
[0m21:38:41.977567 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:41.982964 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.983780 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:41.984178 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:38:41.984556 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:42.237937 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:42.239062 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.239719 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:38:42.277275 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:38:42.284569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.285338 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:38:42.317027 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:42.323338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.324250 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.356291 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:42.360625 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:38:42.361450 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.362188 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:38:42.393333 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:42.399064 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:38:42.400821 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:38:42.401613 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:38:42.450830 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:42.452336 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:38:41.977861 => 21:38:42.452160
[0m21:38:42.452686 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:38:42.453498 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10876d6d0>]}
[0m21:38:42.453962 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.48s]
[0m21:38:42.454424 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:38:42.454775 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.455094 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:38:42.455694 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:38:42.456029 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.458389 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.458955 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:38:42.456209 => 21:38:42.458807
[0m21:38:42.459216 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:42.461795 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.462220 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.462447 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:38:42.462658 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:42.835155 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:42.836517 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:42.837447 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:38:47.360384 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:38:47.364685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.365172 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:38:47.404776 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:47.408806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.409386 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:38:47.448537 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:47.450020 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:38:47.450287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.450522 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:38:47.489760 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:47.493086 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:38:47.493703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:38:47.493960 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:38:47.548358 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:47.549734 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:38:42.459363 => 21:38:47.549513
[0m21:38:47.550147 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:38:47.550968 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1087806d0>]}
[0m21:38:47.551456 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.10s]
[0m21:38:47.551951 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:38:47.552323 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.552693 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:38:47.553411 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:38:47.553840 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.584380 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.584954 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:38:47.554074 => 21:38:47.584824
[0m21:38:47.585178 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:38:47.587617 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.587988 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.588191 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:38:47.588400 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:47.845293 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:47.847415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:47.849119 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:38:50.534709 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:38:50.537685 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.538078 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:38:50.570032 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:50.572852 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.573215 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:38:50.605135 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:50.607412 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:38:50.607761 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.608078 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:38:50.640645 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:50.643099 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:38:50.643807 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:38:50.644099 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:38:50.689471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:50.690784 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:38:47.585312 => 21:38:50.690594
[0m21:38:50.691133 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:38:50.691880 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108780490>]}
[0m21:38:50.692380 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.14s]
[0m21:38:50.692896 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:38:50.693303 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.693690 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:38:50.694422 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:38:50.694869 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.697782 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.698538 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:38:50.695173 => 21:38:50.698356
[0m21:38:50.698860 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:50.702373 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.702877 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:50.703156 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:38:50.703400 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:51.162113 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:51.162835 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:38:51.163355 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:38:51.208531 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
LINE 26:     campaign_names_mapping.traffic_source,
             ^

[0m21:38:51.209185 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: ROLLBACK
[0m21:38:51.254063 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:38:50.699036 => 21:38:51.253687
[0m21:38:51.254589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:38:51.262407 [debug] [Thread-1 (]: Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 26:     campaign_names_mapping.traffic_source,
               ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m21:38:51.263020 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108740cd0>]}
[0m21:38:51.263616 [error] [Thread-1 (]: 11 of 21 ERROR creating sql table model danila.stg_records_gam_campaign__campaign_costs  [[31mERROR[0m in 0.57s]
[0m21:38:51.264192 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:38:51.264604 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:38:51.265037 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:38:51.265546 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:38:51.265826 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:38:51.268215 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:38:51.268772 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:38:51.265998 => 21:38:51.268611
[0m21:38:51.269047 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:38:51.281515 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:38:51.282038 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.282280 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:38:51.282505 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:51.536451 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:51.537028 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.537481 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:38:51.570833 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:38:51.573982 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.574356 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:38:51.605130 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:51.608258 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.608568 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:38:51.639424 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:51.641212 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:38:51.641555 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.641864 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:38:51.674589 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:51.678266 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:38:51.681270 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:38:51.681639 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop view if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:38:51.714206 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:38:51.715526 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:38:51.269212 => 21:38:51.715334
[0m21:38:51.715894 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:38:51.716654 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1084d0b50>]}
[0m21:38:51.717139 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.45s]
[0m21:38:51.717641 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:38:51.718027 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:38:51.718398 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:38:51.719000 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:38:51.719319 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:38:51.721215 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:38:51.721815 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:38:51.719520 => 21:38:51.721655
[0m21:38:51.722104 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:38:51.725475 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:38:51.725927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:51.726200 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:38:51.726461 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:52.017753 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:52.019696 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.021152 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:38:52.055110 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:52.062647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.063202 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:38:52.094793 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.100189 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.100980 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:38:52.132915 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.137461 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:38:52.138263 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.138963 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:38:52.169753 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:52.176264 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:38:52.177402 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:38:52.177876 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:38:52.226023 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:52.228277 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:38:51.722271 => 21:38:52.227989
[0m21:38:52.228829 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:38:52.230043 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086856d0>]}
[0m21:38:52.230678 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.51s]
[0m21:38:52.231351 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:38:52.231815 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:38:52.232269 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:38:52.233072 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:38:52.233585 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:38:52.236615 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.237365 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:38:52.233866 => 21:38:52.237163
[0m21:38:52.237716 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:38:52.241503 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.241977 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.242255 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:38:52.242519 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:52.500967 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:52.501392 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.501697 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:38:52.730860 [debug] [Thread-1 (]: SQL status: SELECT 54043 in 0.0 seconds
[0m21:38:52.736372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.737034 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:38:52.768353 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.773646 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.774308 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:38:52.806149 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:52.810311 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:38:52.810890 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.811357 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:38:52.842768 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:52.847794 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:38:52.849113 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:38:52.849709 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:38:52.899234 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:52.902239 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:38:52.237925 => 21:38:52.901830
[0m21:38:52.903074 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:38:52.905092 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1086555d0>]}
[0m21:38:52.906290 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54043[0m in 0.67s]
[0m21:38:52.907455 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:38:52.908377 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.909569 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:38:52.910863 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:38:52.911454 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.928061 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.929100 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:38:52.911832 => 21:38:52.928882
[0m21:38:52.929469 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:52.940516 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.941042 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:52.941306 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:38:52.941552 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.198777 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.199311 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:38:53.199722 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:38:53.232270 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:53.236050 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:38:52.929678 => 21:38:53.235672
[0m21:38:53.236751 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:38:53.268075 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:38:53.270476 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.36s]
[0m21:38:53.271615 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:38:53.272433 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.273263 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:38:53.274291 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:38:53.274800 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.283652 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.284715 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:38:53.275121 => 21:38:53.284463
[0m21:38:53.285161 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.287684 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.288312 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.288630 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:38:53.288930 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.544645 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.546633 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:38:53.547549 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:38:53.581257 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:53.584951 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:38:53.285416 => 21:38:53.584483
[0m21:38:53.585853 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:38:53.617707 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:38:53.621556 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m21:38:53.622832 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:38:53.623777 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.625148 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:38:53.626442 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:38:53.627066 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.633057 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.634554 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:38:53.627495 => 21:38:53.634071
[0m21:38:53.635159 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:53.640470 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.641312 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.641708 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:38:53.642088 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:53.901376 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:53.903569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:53.904556 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:38:54.336279 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 0.0 seconds
[0m21:38:54.345623 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.346197 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:38:54.377456 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.382721 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.383352 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:38:54.414427 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.418546 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:38:54.419291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.419842 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:38:54.451000 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:54.459403 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:38:54.460433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:38:54.460983 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:38:54.512295 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:54.516641 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:38:53.635467 => 21:38:54.516204
[0m21:38:54.517486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:38:54.519452 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10872b8d0>]}
[0m21:38:54.520479 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 0.89s]
[0m21:38:54.521397 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:38:54.522115 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.522941 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:38:54.523987 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:38:54.524518 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.529309 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.530375 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:38:54.524856 => 21:38:54.530095
[0m21:38:54.530867 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:38:54.535698 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.536462 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.536845 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:38:54.537220 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:54.794529 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:54.796575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.798187 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:38:54.856432 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:38:54.865606 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.866226 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:38:54.898377 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.907593 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.908244 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:38:54.940008 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:54.943365 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:38:54.944016 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.944574 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:38:54.975802 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:54.980711 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:38:54.982195 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:38:54.982770 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:38:55.032641 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:38:55.036037 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:38:54.531155 => 21:38:55.035633
[0m21:38:55.036837 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:38:55.038756 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1083cb390>]}
[0m21:38:55.039889 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.51s]
[0m21:38:55.041040 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:38:55.041928 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.042988 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:38:55.044167 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:38:55.044765 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.049024 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.050545 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:38:55.045173 => 21:38:55.050306
[0m21:38:55.051061 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.056474 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.057338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.057733 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:38:55.058112 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:55.309877 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:55.311100 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.311891 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:38:55.345809 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:38:55.353249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.353765 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:38:55.384739 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:38:55.387631 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:38:55.388345 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.388984 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:38:55.420132 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:38:55.426707 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:38:55.428037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:38:55.428804 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:38:55.460797 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:38:55.463626 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:38:55.051463 => 21:38:55.463211
[0m21:38:55.464355 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:38:55.465888 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b3847aeb-0698-406e-bebb-c55418e8106d', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10871a450>]}
[0m21:38:55.466875 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.42s]
[0m21:38:55.467801 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:38:55.469281 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.469876 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:38:55.470763 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:38:55.471254 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.477414 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.478626 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:38:55.471557 => 21:38:55.478371
[0m21:38:55.479100 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.481699 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.482371 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.482687 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:38:55.482997 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:55.740488 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:55.742403 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:38:55.743258 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:38:55.776543 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:55.780570 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:38:55.479369 => 21:38:55.780115
[0m21:38:55.781398 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:38:55.813006 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:38:55.815989 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.35s]
[0m21:38:55.817134 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:38:55.818008 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.818972 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:38:55.820092 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:38:55.820670 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.828157 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.829204 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:38:55.821033 => 21:38:55.828925
[0m21:38:55.829689 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:55.832841 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.833668 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:55.834051 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:38:55.834417 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:38:56.159653 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:38:56.161685 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:38:56.163293 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:38:56.205707 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:38:56.210225 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:38:55.829975 => 21:38:56.209774
[0m21:38:56.211068 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:38:56.250607 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:38:56.254557 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.43s]
[0m21:38:56.256811 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:38:56.259512 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:56.259985 [debug] [MainThread]: On master: BEGIN
[0m21:38:56.260407 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:38:56.611425 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:38:56.612676 [debug] [MainThread]: On master: COMMIT
[0m21:38:56.613375 [debug] [MainThread]: Using postgres connection "master"
[0m21:38:56.614010 [debug] [MainThread]: On master: COMMIT
[0m21:38:56.657047 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:38:56.658279 [debug] [MainThread]: On master: Close
[0m21:38:56.660413 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:38:56.661064 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:38:56.661908 [info ] [MainThread]: 
[0m21:38:56.662614 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 46.09 seconds (46.09s).
[0m21:38:56.667038 [debug] [MainThread]: Command end result
[0m21:38:56.682150 [info ] [MainThread]: 
[0m21:38:56.682620 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:38:56.682916 [info ] [MainThread]: 
[0m21:38:56.683210 [error] [MainThread]:   Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "campaign_names_mapping.traffic_source" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 26:     campaign_names_mapping.traffic_source,
               ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m21:38:56.683540 [info ] [MainThread]: 
[0m21:38:56.683850 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=1 SKIP=0 TOTAL=21
[0m21:38:56.686078 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 46.26934, "process_user_time": 1.991585, "process_kernel_time": 0.207605, "process_mem_max_rss": "126517248", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:38:56.686668 [debug] [MainThread]: Command `dbt build` failed at 21:38:56.686536 after 46.27 seconds
[0m21:38:56.687063 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1036d8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103761f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10369c850>]}
[0m21:38:56.687425 [debug] [MainThread]: Flushing usage events
[0m21:41:11.748258 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721f790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292390>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107292a50>]}


============================== 21:41:11.749840 | aeab40e7-d630-4f76-a718-2b02e2defc5a ==============================
[0m21:41:11.749840 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:41:11.750193 [debug] [MainThread]: running dbt with arguments {'write_json': 'True', 'profiles_dir': '/Users/danila/.dbt', 'static_parser': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'send_anonymous_usage_stats': 'True', 'cache_selected_only': 'False', 'debug': 'False', 'no_print': 'None', 'printer_width': '80', 'log_cache_events': 'False', 'invocation_command': 'dbt build', 'quiet': 'False', 'warn_error': 'None', 'version_check': 'True', 'introspect': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager', 'use_experimental_parser': 'False', 'use_colors': 'True', 'partial_parse': 'True', 'fail_fast': 'False', 'log_format': 'default', 'target_path': 'None'}
[0m21:41:11.818981 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10721ecd0>]}
[0m21:41:11.849006 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1068c7650>]}
[0m21:41:11.849413 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:41:11.856318 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:41:11.875726 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:41:11.875943 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:41:11.876449 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:41:11.879260 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079d7950>]}
[0m21:41:11.885242 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107903ed0>]}
[0m21:41:11.885505 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:41:11.886635 [info ] [MainThread]: 
[0m21:41:11.887014 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:41:11.887703 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:41:11.891945 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:41:11.892126 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:41:11.892282 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:41:12.187242 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:41:12.191048 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:41:12.195855 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:41:12.205182 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:41:12.205858 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:41:12.206284 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:41:12.559663 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:41:12.561160 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:41:12.562063 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:41:12.612171 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:41:12.617221 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:41:12.660607 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:41:12.674779 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:12.675365 [debug] [MainThread]: On master: BEGIN
[0m21:41:12.675788 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:41:12.994086 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:12.995385 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:12.996259 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:41:13.045116 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:41:13.046939 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107770410>]}
[0m21:41:13.047351 [debug] [MainThread]: On master: ROLLBACK
[0m21:41:13.086052 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:13.086394 [debug] [MainThread]: On master: BEGIN
[0m21:41:13.161118 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:13.162204 [debug] [MainThread]: On master: COMMIT
[0m21:41:13.162898 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:13.163469 [debug] [MainThread]: On master: COMMIT
[0m21:41:13.201321 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:41:13.202591 [debug] [MainThread]: On master: Close
[0m21:41:13.205762 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:41:13.206735 [info ] [MainThread]: 
[0m21:41:13.213087 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.214089 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:41:13.215264 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:41:13.215887 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.229217 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.230417 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:41:13.216269 => 21:41:13.230150
[0m21:41:13.230856 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:41:13.256657 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.257463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.257731 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:41:13.257956 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:13.539352 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:13.541425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:13.544049 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:41:30.328907 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 17.0 seconds
[0m21:41:30.343779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.345580 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:41:30.377516 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:30.384665 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.385402 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:41:30.417395 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:30.450319 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:41:30.451418 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.451951 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:41:30.483472 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:30.495742 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:41:30.503129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:41:30.503868 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:41:30.547711 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:30.551067 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:41:13.231100 => 21:41:30.550729
[0m21:41:30.551742 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:41:30.553281 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1078f8b50>]}
[0m21:41:30.554253 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 17.34s]
[0m21:41:30.555244 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:41:30.555995 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:41:30.556785 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:41:30.557888 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:41:30.558447 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:41:30.564273 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:41:30.565584 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:41:30.558973 => 21:41:30.565313
[0m21:41:30.566113 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:41:30.571307 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:41:30.572059 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:30.572458 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:41:30.572848 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:30.967003 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:30.968509 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:30.970071 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:41:31.031769 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:41:31.039817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.040447 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:41:31.084065 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.093961 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.095488 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:41:31.139454 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.142310 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:41:31.142788 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.143194 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:41:31.185838 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:31.192271 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:41:31.193484 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:41:31.193981 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:41:31.256836 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:31.260359 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:41:30.566417 => 21:41:31.259615
[0m21:41:31.261734 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:41:31.264690 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b364d0>]}
[0m21:41:31.266724 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.71s]
[0m21:41:31.268754 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:41:31.270287 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.271822 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:41:31.273549 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:41:31.274644 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.280737 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.282798 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:41:31.275246 => 21:41:31.282437
[0m21:41:31.283486 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.289741 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.290967 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.291525 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:41:31.292358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:31.568633 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:31.570278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.571195 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:41:31.625064 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:41:31.627254 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.627507 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:41:31.660993 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.663118 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.663406 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:41:31.698998 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:31.701077 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:41:31.701467 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.701850 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:41:31.735136 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:31.740175 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:41:31.741573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:41:31.742121 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:41:31.793345 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:31.796690 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:41:31.283829 => 21:41:31.796335
[0m21:41:31.797391 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:41:31.799256 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b3b4d0>]}
[0m21:41:31.800280 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.53s]
[0m21:41:31.801275 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:41:31.802013 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:41:31.802962 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:41:31.804491 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:41:31.805082 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:41:31.810642 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:41:31.812231 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:41:31.805482 => 21:41:31.811940
[0m21:41:31.812853 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:41:31.819462 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:41:31.820983 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:31.821671 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:41:31.822350 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:32.082965 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:32.084203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.084941 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:41:32.122709 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:41:32.130206 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.131112 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:41:32.163725 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.173616 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.174470 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:41:32.206048 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.213633 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:41:32.215061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.216404 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:41:32.247819 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:32.256937 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:41:32.259897 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:41:32.260883 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:41:32.311208 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:32.316097 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:41:31.813238 => 21:41:32.315302
[0m21:41:32.317557 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:41:32.320721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10778a990>]}
[0m21:41:32.322681 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.52s]
[0m21:41:32.324727 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:41:32.326056 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.327587 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:41:32.329329 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:41:32.330128 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.338985 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.340824 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:41:32.330622 => 21:41:32.340408
[0m21:41:32.341513 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.348559 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.349649 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.350149 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:41:32.350549 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:32.692205 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:32.693822 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.695379 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:41:32.729550 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:32.737863 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.738494 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:41:32.769779 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.775077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.775750 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:41:32.807475 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:32.814970 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:41:32.816406 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.817840 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:41:32.850192 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:32.860272 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:41:32.862232 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:41:32.863078 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:41:32.912354 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:32.915292 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:41:32.341917 => 21:41:32.914998
[0m21:41:32.915838 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:41:32.917437 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107a09a90>]}
[0m21:41:32.918606 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.59s]
[0m21:41:32.919337 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:41:32.920181 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.921360 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:41:32.923171 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:41:32.923896 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.933781 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.934973 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:41:32.924406 => 21:41:32.934641
[0m21:41:32.935510 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:32.941631 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.942543 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:32.943028 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:41:32.943598 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:33.294338 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:33.295667 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:33.296646 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:41:40.499157 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:41:40.508395 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.509462 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:41:40.560325 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:40.563049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.563398 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:41:40.611824 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:40.620466 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:41:40.621935 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.623253 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:41:40.671447 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:40.677659 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:41:40.678764 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:41:40.679209 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:41:40.747472 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:40.750003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:41:32.935819 => 21:41:40.749676
[0m21:41:40.750716 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:41:40.752180 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10790c690>]}
[0m21:41:40.753165 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.83s]
[0m21:41:40.753957 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:41:40.754498 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.755169 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:41:40.756100 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:41:40.756645 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.759010 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.759710 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:41:40.757140 => 21:41:40.759570
[0m21:41:40.759945 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:40.762775 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.763802 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:40.764019 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:41:40.764213 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:41.023279 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:41.024700 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.025573 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:41:41.058828 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:41.069330 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.070292 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:41:41.102407 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.109479 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.110213 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:41:41.142081 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.148254 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:41:41.149025 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.149652 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:41:41.180684 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:41.186089 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:41:41.187536 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:41:41.188473 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:41:41.239250 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:41.244353 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:41:40.760071 => 21:41:41.243725
[0m21:41:41.245346 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:41:41.246928 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077435d0>]}
[0m21:41:41.247953 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.49s]
[0m21:41:41.248960 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:41:41.249734 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.250997 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:41:41.252251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:41:41.252858 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.258827 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.260265 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:41:41.253328 => 21:41:41.259961
[0m21:41:41.260787 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.266742 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.268026 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.268552 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:41:41.269005 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:41.525807 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:41.527280 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.528025 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:41:41.565306 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:41:41.572899 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.574230 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:41:41.606542 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.614719 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.615408 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.647169 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:41.653346 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:41:41.654836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.656166 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:41:41.688258 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:41.698370 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:41:41.701489 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:41:41.702734 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:41:41.751726 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:41.756834 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:41:41.261108 => 21:41:41.756055
[0m21:41:41.758286 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:41:41.761442 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079a3510>]}
[0m21:41:41.763424 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.51s]
[0m21:41:41.765139 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:41:41.766307 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.767670 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:41:41.769510 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:41:41.770636 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.778174 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.779835 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:41:41.771620 => 21:41:41.779456
[0m21:41:41.780546 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:41.787747 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.789196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:41.790151 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:41:41.790704 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:42.142024 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:42.144000 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:42.145693 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:41:46.722725 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:41:46.734657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.735794 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:41:46.779033 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:46.783878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.784484 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:41:46.827706 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:46.829421 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:41:46.829701 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.829950 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:41:46.872501 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:46.876713 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:41:46.877486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:41:46.877832 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:41:46.937323 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:46.939879 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:41:41.780957 => 21:41:46.939545
[0m21:41:46.940487 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:41:46.941908 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107bc1dd0>]}
[0m21:41:46.942844 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.17s]
[0m21:41:46.943699 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:41:46.944354 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.945076 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:41:46.945960 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:41:46.946423 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.990514 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.991164 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:41:46.946731 => 21:41:46.991022
[0m21:41:46.991406 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:41:46.993920 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.994236 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:46.994408 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:41:46.994565 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:47.349067 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:47.351050 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:47.352624 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:41:50.135358 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:41:50.147584 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.149072 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:41:50.193600 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.204308 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.205368 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:41:50.249722 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.258342 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:41:50.259581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.260482 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:41:50.304331 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:50.313741 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:41:50.316771 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:41:50.317742 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:41:50.377735 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:50.382458 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:41:46.991551 => 21:41:50.381715
[0m21:41:50.383808 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:41:50.386685 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107bc4450>]}
[0m21:41:50.388544 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.44s]
[0m21:41:50.390137 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:41:50.391207 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.392554 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:41:50.394148 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:41:50.395073 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.402112 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.403598 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:41:50.395679 => 21:41:50.403302
[0m21:41:50.404197 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.410305 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.411650 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.412181 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:41:50.412633 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:50.669397 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:50.671344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.672949 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:41:50.746245 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:41:50.759065 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.760591 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:41:50.791933 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.802264 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.803615 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:41:50.835294 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:50.843188 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:41:50.844511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.845775 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:41:50.877385 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:50.887214 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:41:50.889384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:41:50.890327 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:41:50.939525 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:50.944289 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:41:50.404588 => 21:41:50.943529
[0m21:41:50.945666 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:41:50.948523 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b9c950>]}
[0m21:41:50.950425 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.55s]
[0m21:41:50.952046 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:41:50.953118 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test
[0m21:41:50.954352 [info ] [Thread-1 (]: 12 of 21 START sql view model danila.test ...................................... [RUN]
[0m21:41:50.955892 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test)
[0m21:41:50.956569 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test
[0m21:41:50.962706 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test"
[0m21:41:50.964805 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (compile): 21:41:50.957024 => 21:41:50.963963
[0m21:41:50.965376 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test
[0m21:41:50.989620 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test"
[0m21:41:50.990546 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:50.990891 [debug] [Thread-1 (]: On model.campaign_perfomance.test: BEGIN
[0m21:41:50.991208 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:51.316386 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:51.318400 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.319830 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */

  create view "deep-analysis-console"."danila"."test__dbt_tmp"
    
    
  as (
    select 1 as name
-- select 
--     date_parsed, 
--     date
--     geo as country_code, 
--     registrations as signups
-- from "deep-analysis-console"."console"."records" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--     and geo='vn'
--     and brand_name='20bet'
--     and registrations>0
-- order by date_parsed desc


-- select * from "deep-analysis-console"."console"."campaign_names_mapping" where geo='vn'
  );
[0m21:41:51.363256 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:41:51.376556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.377858 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test" rename to "test__dbt_backup"
[0m21:41:51.431838 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:51.443338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.444440 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
alter table "deep-analysis-console"."danila"."test__dbt_tmp" rename to "test"
[0m21:41:51.484649 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:51.491226 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:41:51.492511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.493748 [debug] [Thread-1 (]: On model.campaign_perfomance.test: COMMIT
[0m21:41:51.533674 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:51.543628 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test__dbt_backup"
[0m21:41:51.553302 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test"
[0m21:41:51.554071 [debug] [Thread-1 (]: On model.campaign_perfomance.test: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test"} */
drop view if exists "deep-analysis-console"."danila"."test__dbt_backup" cascade
[0m21:41:51.595975 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:41:51.600733 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test (execute): 21:41:50.965750 => 21:41:51.599982
[0m21:41:51.602061 [debug] [Thread-1 (]: On model.campaign_perfomance.test: Close
[0m21:41:51.604931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b4a350>]}
[0m21:41:51.606803 [info ] [Thread-1 (]: 12 of 21 OK created sql view model danila.test ................................. [[32mCREATE VIEW[0m in 0.65s]
[0m21:41:51.608717 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test
[0m21:41:51.610029 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:41:51.611260 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:41:51.612938 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test, now model.campaign_perfomance.test_write)
[0m21:41:51.613877 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:41:51.619316 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:41:51.620841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:41:51.614375 => 21:41:51.620509
[0m21:41:51.621399 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:41:51.628177 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:41:51.629582 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:51.630031 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:41:51.630442 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:52.013907 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:52.015895 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.017316 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:41:52.057522 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:52.070046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.071361 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:41:52.109381 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.120909 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.122336 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:41:52.159906 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.167456 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:41:52.168807 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.170086 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:41:52.206717 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:52.216690 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:41:52.219677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:41:52.220955 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:41:52.276383 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:52.281075 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:41:51.621746 => 21:41:52.280344
[0m21:41:52.282419 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:41:52.285361 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ae47d0>]}
[0m21:41:52.287310 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.67s]
[0m21:41:52.288983 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:41:52.290109 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:41:52.291442 [info ] [Thread-1 (]: 14 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:41:52.293225 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:41:52.294187 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:41:52.301236 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.303801 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:41:52.294820 => 21:41:52.303450
[0m21:41:52.304433 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:41:52.310985 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.312380 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.313057 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:41:52.313698 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:52.659868 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:52.661877 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.663480 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:41:52.908405 [debug] [Thread-1 (]: SQL status: SELECT 54046 in 0.0 seconds
[0m21:41:52.921693 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.923230 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:41:52.964374 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:52.980296 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:52.981323 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:41:53.021723 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:53.029795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:41:53.031161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:53.032410 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:41:53.072235 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:53.081767 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:41:53.084093 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:41:53.085048 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:41:53.144251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:53.147360 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:41:52.304786 => 21:41:53.146924
[0m21:41:53.148225 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:41:53.149851 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107816fd0>]}
[0m21:41:53.151088 [info ] [Thread-1 (]: 14 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54046[0m in 0.86s]
[0m21:41:53.152769 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:41:53.154344 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.156260 [info ] [Thread-1 (]: 15 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:41:53.158354 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:41:53.159413 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.178620 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.180604 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:41:53.160072 => 21:41:53.180292
[0m21:41:53.181155 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.195535 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.196215 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.196548 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:41:53.196858 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:53.452387 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:53.454485 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:41:53.456015 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:41:53.488038 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:53.495540 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:41:53.181462 => 21:41:53.494648
[0m21:41:53.497093 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:41:53.528023 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:41:53.531641 [info ] [Thread-1 (]: 15 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.37s]
[0m21:41:53.533717 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:41:53.535244 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.536803 [info ] [Thread-1 (]: 16 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:41:53.539235 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:41:53.540247 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.553886 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.555742 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:41:53.540877 => 21:41:53.555389
[0m21:41:53.556383 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.560466 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.561452 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.561926 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:41:53.562405 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:53.821401 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:53.823501 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:41:53.824962 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:41:53.858657 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:53.863897 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:41:53.556726 => 21:41:53.863079
[0m21:41:53.865319 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:41:53.897252 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:41:53.900808 [info ] [Thread-1 (]: 16 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.36s]
[0m21:41:53.902816 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:41:53.904197 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.905665 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:41:53.907291 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:41:53.908335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.916489 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.918084 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:41:53.909058 => 21:41:53.917750
[0m21:41:53.918708 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:53.925257 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.926714 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:53.927231 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:41:53.927894 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:54.182251 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:54.184295 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.185953 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:41:54.652095 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 0.0 seconds
[0m21:41:54.664605 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.665682 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:41:54.719670 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:54.730648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.731693 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:41:54.764276 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:54.771891 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:41:54.773245 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.774519 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:41:54.806246 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:54.816062 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:41:54.818211 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:41:54.819125 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:41:54.873107 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:54.878177 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:41:53.919094 => 21:41:54.877384
[0m21:41:54.879571 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:41:54.882536 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107773650>]}
[0m21:41:54.884480 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 0.98s]
[0m21:41:54.886123 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:41:54.887212 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.888426 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:41:54.890142 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:41:54.891104 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.902261 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.904072 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:41:54.891747 => 21:41:54.903737
[0m21:41:54.904641 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:41:54.911061 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.912473 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:54.913005 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:41:54.913454 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:55.168782 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:55.170763 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.172329 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:41:55.228837 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:41:55.242376 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.243830 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:41:55.275909 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.286621 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.288032 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:41:55.319594 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.327061 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:41:55.328481 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.329800 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:41:55.360430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:55.370240 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:41:55.373334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:41:55.374632 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:41:55.427429 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:41:55.432135 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:41:54.904962 => 21:41:55.431363
[0m21:41:55.433518 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:41:55.436485 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b7d190>]}
[0m21:41:55.438074 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.55s]
[0m21:41:55.439520 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:41:55.440607 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.441885 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:41:55.443587 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:41:55.444555 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.450440 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.451955 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:41:55.445193 => 21:41:55.451647
[0m21:41:55.452542 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.459045 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.460587 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.461138 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:41:55.461764 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:55.738458 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:55.740514 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.741938 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:41:55.779375 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:41:55.791990 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.793495 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:41:55.828100 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:41:55.834684 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:41:55.836154 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.837471 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:41:55.871964 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:41:55.882827 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:41:55.885981 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:41:55.887322 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:41:55.922198 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:41:55.927247 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:41:55.452929 => 21:41:55.926480
[0m21:41:55.928626 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:41:55.931594 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'aeab40e7-d630-4f76-a718-2b02e2defc5a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b7d750>]}
[0m21:41:55.933508 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.49s]
[0m21:41:55.935349 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:41:55.937576 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.938575 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:41:55.939827 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:41:55.940581 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.948828 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.951883 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:41:55.941068 => 21:41:55.951459
[0m21:41:55.952539 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:55.956327 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.957636 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:55.958135 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:41:55.958676 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:56.216700 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.218773 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:41:56.220247 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:41:56.254060 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:56.259438 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:41:55.952909 => 21:41:56.258622
[0m21:41:56.260876 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:41:56.292899 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:41:56.296545 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.36s]
[0m21:41:56.298642 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:41:56.300173 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.301735 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:41:56.304182 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:41:56.305546 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.315567 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.317353 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:41:56.306342 => 21:41:56.316997
[0m21:41:56.318059 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.325786 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.327237 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.327897 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:41:56.328377 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:41:56.585576 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.587673 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:41:56.589145 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:41:56.622451 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:41:56.627830 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:41:56.318428 => 21:41:56.626976
[0m21:41:56.629252 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:41:56.660535 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:41:56.664040 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.36s]
[0m21:41:56.666096 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:41:56.669640 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:56.670529 [debug] [MainThread]: On master: BEGIN
[0m21:41:56.671305 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:41:56.925716 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:41:56.926657 [debug] [MainThread]: On master: COMMIT
[0m21:41:56.927196 [debug] [MainThread]: Using postgres connection "master"
[0m21:41:56.927683 [debug] [MainThread]: On master: COMMIT
[0m21:41:56.959124 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:41:56.960483 [debug] [MainThread]: On master: Close
[0m21:41:56.963453 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:41:56.964544 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:41:56.966007 [info ] [MainThread]: 
[0m21:41:56.967099 [info ] [MainThread]: Finished running 15 table models, 2 view models, 4 tests in 0 hours 0 minutes and 45.08 seconds (45.08s).
[0m21:41:56.973846 [debug] [MainThread]: Command end result
[0m21:41:56.991263 [info ] [MainThread]: 
[0m21:41:56.991841 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:41:56.992273 [info ] [MainThread]: 
[0m21:41:56.992702 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:41:56.995402 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 45.27271, "process_user_time": 2.665297, "process_kernel_time": 0.234102, "process_mem_max_rss": "127303680", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:41:56.996121 [debug] [MainThread]: Command `dbt build` succeeded at 21:41:56.995965 after 45.27 seconds
[0m21:41:56.996596 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106afa790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102ba1f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106b85750>]}
[0m21:41:56.997009 [debug] [MainThread]: Flushing usage events
[0m21:43:43.964837 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10738fb50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107406cd0>]}


============================== 21:43:43.966288 | de570ae7-7030-447a-9a3a-ad7cb80f2b71 ==============================
[0m21:43:43.966288 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:43:43.966621 [debug] [MainThread]: running dbt with arguments {'printer_width': '80', 'log_format': 'default', 'use_colors': 'True', 'static_parser': 'True', 'invocation_command': 'dbt build', 'version_check': 'True', 'write_json': 'True', 'fail_fast': 'False', 'send_anonymous_usage_stats': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'log_path': '/Users/danila/github/dbt/logs', 'warn_error': 'None', 'no_print': 'None', 'debug': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'profiles_dir': '/Users/danila/.dbt', 'indirect_selection': 'eager', 'cache_selected_only': 'False', 'log_cache_events': 'False', 'quiet': 'False', 'introspect': 'True'}
[0m21:43:44.033271 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1b90>]}
[0m21:43:44.064645 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107963cd0>]}
[0m21:43:44.065204 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:43:44.072000 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:43:44.085277 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 1 files added, 0 files changed.
[0m21:43:44.085625 [debug] [MainThread]: Partial parsing: added file: campaign_perfomance://models/brand_performance/outclick_cost_int_new.sql
[0m21:43:44.136050 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:43:44.138277 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c97890>]}
[0m21:43:44.143936 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107c63f90>]}
[0m21:43:44.144224 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:43:44.145344 [info ] [MainThread]: 
[0m21:43:44.145726 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:43:44.146427 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:43:44.150496 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:43:44.150696 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:43:44.150855 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:43:44.560011 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:43:44.563016 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:43:44.565900 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:43:44.572399 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:43:44.572824 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:43:44.573127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:43:45.124808 [debug] [ThreadPool]: SQL status: BEGIN in 1.0 seconds
[0m21:43:45.125976 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:43:45.126686 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:43:45.164099 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:43:45.168537 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:43:45.202536 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:43:45.218362 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.218818 [debug] [MainThread]: On master: BEGIN
[0m21:43:45.219143 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:43:45.532238 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:43:45.533546 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.534505 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:43:45.579745 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:43:45.583575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b2e010>]}
[0m21:43:45.584294 [debug] [MainThread]: On master: ROLLBACK
[0m21:43:45.641467 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.642604 [debug] [MainThread]: On master: BEGIN
[0m21:43:45.709160 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:43:45.710445 [debug] [MainThread]: On master: COMMIT
[0m21:43:45.711256 [debug] [MainThread]: Using postgres connection "master"
[0m21:43:45.711958 [debug] [MainThread]: On master: COMMIT
[0m21:43:45.746701 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:43:45.747909 [debug] [MainThread]: On master: Close
[0m21:43:45.750074 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:43:45.750825 [info ] [MainThread]: 
[0m21:43:45.754876 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.755622 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:43:45.756578 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:43:45.757067 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.767345 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.768252 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:43:45.757331 => 21:43:45.768030
[0m21:43:45.768606 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:43:45.792862 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.793471 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:45.793689 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:43:45.793892 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:43:46.097946 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:43:46.098941 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:43:46.100154 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:44:05.081888 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m21:44:05.099604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.100505 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:44:05.140701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.149220 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.150336 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:44:05.187944 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.210586 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:05.211110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.211444 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:05.248937 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:05.256826 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:44:05.260650 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:05.260962 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:44:05.311739 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:05.313634 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:43:45.768812 => 21:44:05.313299
[0m21:44:05.314142 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:44:05.315363 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d41a10>]}
[0m21:44:05.316125 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.56s]
[0m21:44:05.316875 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:44:05.317413 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:44:05.318032 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:44:05.318852 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:44:05.319285 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:44:05.322457 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:44:05.323321 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:44:05.319544 => 21:44:05.323095
[0m21:44:05.323668 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:44:05.327417 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:44:05.328040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.328376 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:44:05.328680 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:05.640612 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:05.642615 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.644013 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:05.693136 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:44:05.701072 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.701818 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:44:05.733395 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.740704 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.741326 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:44:05.772354 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:05.779716 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:05.780997 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.782124 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:05.812141 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:05.814786 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:44:05.815607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:05.815938 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:44:05.863118 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:05.864902 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:44:05.323877 => 21:44:05.864636
[0m21:44:05.865391 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:44:05.866476 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e1650>]}
[0m21:44:05.867215 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.55s]
[0m21:44:05.867941 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:44:05.868494 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.869059 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:44:05.869777 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:44:05.870166 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.873294 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.874120 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:44:05.870407 => 21:44:05.873897
[0m21:44:05.874516 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:44:05.878175 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.878773 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:05.879095 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:44:05.879435 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:06.202982 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:06.205011 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.206454 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:06.268293 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:44:06.281267 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.281793 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:44:06.321629 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.328948 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.329741 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:44:06.369437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.371269 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:06.371561 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.371804 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:06.410498 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:06.412625 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:44:06.413294 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:06.413584 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:44:06.472534 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:06.474173 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:44:05.874719 => 21:44:06.473902
[0m21:44:06.474658 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:44:06.475671 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079d7550>]}
[0m21:44:06.476366 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.61s]
[0m21:44:06.477084 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:06.477627 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:44:06.478266 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:44:06.479079 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:44:06.479534 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:44:06.482607 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:44:06.483373 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:44:06.479775 => 21:44:06.483164
[0m21:44:06.483753 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:44:06.489294 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:44:06.489909 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.490217 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:44:06.490508 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:06.749309 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:06.751426 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.752547 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:44:06.790884 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:44:06.800217 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.800628 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:44:06.831713 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.834848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.835256 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:44:06.865929 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:06.868362 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:06.868809 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.869232 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:06.899493 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:06.904208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:44:06.905540 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:06.906085 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:44:06.954613 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:06.958705 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:44:06.483982 => 21:44:06.958101
[0m21:44:06.959629 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:44:06.961443 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b79950>]}
[0m21:44:06.962415 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.48s]
[0m21:44:06.963261 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:44:06.963932 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.964872 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:44:06.965848 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:44:06.966329 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.971574 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.972814 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:44:06.966610 => 21:44:06.972511
[0m21:44:06.973369 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:44:06.978374 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.979131 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:06.979458 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:44:06.979771 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:07.261817 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:07.263872 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.265359 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:44:07.299477 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:07.305841 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.306448 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:44:07.337417 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:07.342681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.343536 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:44:07.375299 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:07.380049 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:07.380792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.381330 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:07.412644 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:07.419302 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:44:07.421112 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:07.421837 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:44:07.471063 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:07.475709 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:44:06.973679 => 21:44:07.475232
[0m21:44:07.476570 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:44:07.478231 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cd2210>]}
[0m21:44:07.479186 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.51s]
[0m21:44:07.480030 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:07.480683 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.481655 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:44:07.482548 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:44:07.483027 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.489907 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.490993 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:44:07.483321 => 21:44:07.490730
[0m21:44:07.491474 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:07.496095 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.496704 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.497040 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:44:07.497358 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:07.767399 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:07.769516 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:07.771543 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:44:14.643699 [debug] [Thread-1 (]: SQL status: SELECT 142663 in 7.0 seconds
[0m21:44:14.654101 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.654681 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:44:14.685470 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:14.690981 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.691389 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:44:14.722671 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:14.725756 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:14.726300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.726716 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:14.757053 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:14.812911 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:44:14.813651 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:14.813896 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:44:14.861567 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:14.862700 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:44:07.491740 => 21:44:14.862534
[0m21:44:14.863009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:44:14.863720 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10797bb90>]}
[0m21:44:14.864162 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142663[0m in 7.38s]
[0m21:44:14.864616 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:14.864970 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.865421 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:44:14.866008 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:44:14.866319 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.868332 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.868944 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:44:14.866499 => 21:44:14.868792
[0m21:44:14.869217 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:14.872169 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.872633 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:14.872888 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:44:14.873127 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:15.125606 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:15.127622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.129102 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:44:15.162638 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:15.168423 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.169009 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:44:15.200093 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.204561 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.205103 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:44:15.236224 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.240882 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:15.241580 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.242213 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:15.273434 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:15.282197 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:44:15.283336 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:15.283723 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:44:15.331251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:15.333361 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:44:14.869384 => 21:44:15.333101
[0m21:44:15.333830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:44:15.335208 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b06d50>]}
[0m21:44:15.336021 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.47s]
[0m21:44:15.337083 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:15.337718 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.338442 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:44:15.339369 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:44:15.339850 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.343135 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.344053 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:44:15.340153 => 21:44:15.343802
[0m21:44:15.344476 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.348972 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.349622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.349955 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:44:15.350280 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:15.625722 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:15.627433 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.628311 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:44:15.667958 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:44:15.678790 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.679385 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:15.713297 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.719184 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.719960 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.754428 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:15.759856 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:15.760533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.761059 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:15.795059 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:15.801120 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:15.802250 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:15.802758 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:44:15.854065 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:15.859329 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:44:15.344729 => 21:44:15.858553
[0m21:44:15.860721 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:44:15.862628 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d25dd0>]}
[0m21:44:15.863428 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.52s]
[0m21:44:15.864060 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:15.864497 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.864991 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:44:15.865607 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:44:15.865951 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.868992 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.869769 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:44:15.866177 => 21:44:15.869580
[0m21:44:15.870067 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:15.874871 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.875368 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:15.875660 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:44:15.875936 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:16.178650 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:16.180663 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:16.182376 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:44:20.778552 [debug] [Thread-1 (]: SQL status: SELECT 37210 in 5.0 seconds
[0m21:44:20.788962 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.789773 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:20.826846 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:20.832025 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.832707 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:44:20.869795 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:20.875110 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:20.875865 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.876471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:20.913896 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:20.923965 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:20.925269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:20.925762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:44:20.977918 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:20.981384 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:44:15.870242 => 21:44:20.980925
[0m21:44:20.982224 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:44:20.984068 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1073e36d0>]}
[0m21:44:20.985248 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37210[0m in 5.12s]
[0m21:44:20.986353 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:20.987202 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:20.988004 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:44:20.989003 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:44:20.989565 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:44:20.994546 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:20.995948 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:44:20.989909 => 21:44:20.995554
[0m21:44:20.996519 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:44:21.002098 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.003040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.003492 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:44:21.003867 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:21.283029 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:21.284757 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:21.285640 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:44:24.135882 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:44:24.146261 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.146829 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:44:24.180368 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.186168 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.186797 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:44:24.220621 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.229369 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:24.230743 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.232086 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:24.284994 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:24.292335 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:44:24.293476 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:24.293942 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:44:24.343136 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:24.346618 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:44:20.996815 => 21:44:24.346189
[0m21:44:24.347331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:44:24.348982 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106cf5990>]}
[0m21:44:24.350015 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.36s]
[0m21:44:24.351029 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:24.351812 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.352693 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:44:24.354051 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:44:24.354647 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.359875 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.361442 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:44:24.354964 => 21:44:24.360897
[0m21:44:24.362080 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:24.367961 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.368994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.369502 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:44:24.369915 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:24.756432 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:24.758648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.760353 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:44:24.861590 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:44:24.871305 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.871866 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:24.915550 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.919145 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.919641 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:44:24.963723 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:24.969361 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:24.970244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:24.970932 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:25.015280 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:25.023560 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:25.024637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:25.025066 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:44:25.087712 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:25.091990 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:44:24.362379 => 21:44:25.091537
[0m21:44:25.092833 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:44:25.094641 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b79950>]}
[0m21:44:25.095794 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.74s]
[0m21:44:25.096856 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:25.097667 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:44:25.098613 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:44:25.099850 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:44:25.100369 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:44:25.104920 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:44:25.106139 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:44:25.100690 => 21:44:25.105798
[0m21:44:25.106622 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:44:25.112430 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:44:25.113367 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.113776 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:44:25.114149 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:25.461367 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:25.463511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.465011 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:44:25.506577 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:25.514191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.514759 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:44:25.555161 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:25.565018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.565498 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:44:25.605463 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:25.613121 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:25.613712 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.614138 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:25.652791 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:25.657693 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:44:25.658923 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:25.659349 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:44:25.718273 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:25.722936 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:44:25.106901 => 21:44:25.722512
[0m21:44:25.723677 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:44:25.725475 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ab09d0>]}
[0m21:44:25.726539 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.63s]
[0m21:44:25.727354 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:44:25.727985 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:44:25.728684 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:44:25.729619 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:44:25.730137 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:44:25.735180 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.736257 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:44:25.730455 => 21:44:25.735968
[0m21:44:25.736742 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:44:25.741977 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.742731 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:25.743121 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:44:25.743492 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:26.019516 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:26.021599 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.023099 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:44:26.307220 [debug] [Thread-1 (]: SQL status: SELECT 54050 in 0.0 seconds
[0m21:44:26.317521 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.318007 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:44:26.351007 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:26.353630 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.353933 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:44:26.387494 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:26.388991 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:26.389218 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.389434 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:26.422876 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:26.425989 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:44:26.426638 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:26.426918 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:44:26.479369 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:26.480691 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:44:25.737036 => 21:44:26.480476
[0m21:44:26.481091 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:44:26.481924 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cd4150>]}
[0m21:44:26.482486 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54050[0m in 0.75s]
[0m21:44:26.483113 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:44:26.483557 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.484067 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:44:26.484895 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:44:26.485314 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.495468 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.496149 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:44:26.485558 => 21:44:26.495981
[0m21:44:26.496455 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.506076 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.506598 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.506842 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:44:26.507065 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:26.913477 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:26.915512 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:44:26.916554 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:44:26.953956 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:26.959130 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:44:26.496633 => 21:44:26.958765
[0m21:44:26.959722 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:44:26.995725 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:44:26.997872 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.51s]
[0m21:44:26.998996 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:44:26.999830 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.000648 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:44:27.001903 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:44:27.002581 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.013100 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.014393 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:44:27.003008 => 21:44:27.014041
[0m21:44:27.014950 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.017911 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.018601 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.018990 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:44:27.019366 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:27.354089 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:27.356125 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:44:27.357571 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:44:27.399540 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:27.404528 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:44:27.015243 => 21:44:27.404138
[0m21:44:27.405120 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:44:27.444311 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:44:27.446606 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.45s]
[0m21:44:27.447597 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:44:27.448288 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.449276 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:44:27.450162 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:44:27.450627 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.456502 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.457587 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:44:27.450907 => 21:44:27.457311
[0m21:44:27.458067 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:27.462801 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.463530 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.463908 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:44:27.464272 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:27.740518 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:27.742566 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:27.744241 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:44:28.254799 [debug] [Thread-1 (]: SQL status: SELECT 123963 in 1.0 seconds
[0m21:44:28.265568 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.266092 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:44:28.299297 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.304163 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.304722 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:44:28.338437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.342387 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:44:28.343078 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.343604 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:44:28.376745 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:28.387698 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:44:28.390836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:28.391683 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:44:28.451225 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:28.453827 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:44:27.458347 => 21:44:28.453480
[0m21:44:28.454450 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:44:28.455940 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ab2c50>]}
[0m21:44:28.456840 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123963[0m in 1.01s]
[0m21:44:28.457604 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:28.458186 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.458823 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m21:44:28.459582 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m21:44:28.460009 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.465873 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.466943 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 21:44:28.460260 => 21:44:28.466680
[0m21:44:28.467384 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:28.473959 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.474629 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.474961 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m21:44:28.475274 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:28.731252 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:28.733296 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.735201 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        betting_type,
        NULL as brand_name, 
        NULL as unique_outclicks,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:44:28.843621 [debug] [Thread-1 (]: SQL status: SELECT 45246 in 0.0 seconds
[0m21:44:28.854021 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.854536 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m21:44:28.885505 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.889331 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.889795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m21:44:28.921132 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:28.925005 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:44:28.925657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.926176 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:44:28.957246 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:28.963239 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m21:44:28.964911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:44:28.965456 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m21:44:29.018233 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:29.021923 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 21:44:28.467629 => 21:44:29.021427
[0m21:44:29.022810 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m21:44:29.024759 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e344d0>]}
[0m21:44:29.026013 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45246[0m in 0.57s]
[0m21:44:29.027132 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:44:29.027844 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.028635 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:44:29.029652 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:44:29.030189 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.035775 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.037367 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:44:29.030502 => 21:44:29.037023
[0m21:44:29.037904 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.043205 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.043911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.044285 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:44:29.044632 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:29.304018 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:29.306061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.307676 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:44:29.368213 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:44:29.378189 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.378773 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:44:29.410636 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.416465 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.417192 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:44:29.449141 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.455452 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:44:29.455888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.456251 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:44:29.486727 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:29.491602 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:44:29.492817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:44:29.493326 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:44:29.542073 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:29.546852 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:44:29.038195 => 21:44:29.546088
[0m21:44:29.548202 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:44:29.550169 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107e00750>]}
[0m21:44:29.551049 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.52s]
[0m21:44:29.551844 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:44:29.552411 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.553071 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:44:29.553821 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:44:29.554245 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.557162 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.558082 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:44:29.554502 => 21:44:29.557832
[0m21:44:29.558504 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.573183 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.573741 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.574004 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:44:29.574252 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:29.830106 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:29.832248 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.833455 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:44:29.868321 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:44:29.878354 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.878903 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:44:29.909667 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:29.912317 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:29.912842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.913279 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:29.943709 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:29.952432 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:44:29.957347 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:29.957808 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:44:29.989041 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:44:29.991859 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:44:29.558749 => 21:44:29.991430
[0m21:44:29.992595 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:44:29.994317 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'de570ae7-7030-447a-9a3a-ad7cb80f2b71', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107b06390>]}
[0m21:44:29.995425 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.44s]
[0m21:44:29.996465 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:29.997762 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:29.998450 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:44:29.999355 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:44:29.999863 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.006576 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.007671 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:44:30.000190 => 21:44:30.007381
[0m21:44:30.008177 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.010595 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.011256 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.011644 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:44:30.012016 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:30.315712 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:30.316939 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:44:30.317712 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:44:30.356660 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:30.360888 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:44:30.008434 => 21:44:30.360620
[0m21:44:30.361357 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:44:30.398048 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:44:30.400154 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.40s]
[0m21:44:30.401266 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:44:30.402073 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.402895 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:44:30.404096 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:44:30.404772 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.412201 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.413630 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:44:30.405188 => 21:44:30.413397
[0m21:44:30.414084 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.417298 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.418439 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.418915 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:44:30.419334 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:30.675648 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:30.677401 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:44:30.678181 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:44:30.711792 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:30.718483 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:44:30.414363 => 21:44:30.717599
[0m21:44:30.719976 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:44:30.751832 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:44:30.755484 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.35s]
[0m21:44:30.756713 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:44:30.759208 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:30.759715 [debug] [MainThread]: On master: BEGIN
[0m21:44:30.760147 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:44:31.113103 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:31.114809 [debug] [MainThread]: On master: COMMIT
[0m21:44:31.115984 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:31.117078 [debug] [MainThread]: On master: COMMIT
[0m21:44:31.160115 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:44:31.161597 [debug] [MainThread]: On master: Close
[0m21:44:31.164315 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:44:31.164918 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:44:31.165776 [info ] [MainThread]: 
[0m21:44:31.166452 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 47.02 seconds (47.02s).
[0m21:44:31.171291 [debug] [MainThread]: Command end result
[0m21:44:31.184685 [info ] [MainThread]: 
[0m21:44:31.185276 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:44:31.185665 [info ] [MainThread]: 
[0m21:44:31.186056 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:44:31.188002 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 47.245525, "process_user_time": 2.317974, "process_kernel_time": 0.198467, "process_mem_max_rss": "130678784", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:44:31.188503 [debug] [MainThread]: Command `dbt build` succeeded at 21:44:31.188385 after 47.25 seconds
[0m21:44:31.188878 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102d11f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cf9610>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102c4c850>]}
[0m21:44:31.189229 [debug] [MainThread]: Flushing usage events
[0m21:47:32.730067 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11270b510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112782790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112782e50>]}


============================== 21:47:32.731363 | 68185f43-60ea-4c59-9387-45ae80d92e26 ==============================
[0m21:47:32.731363 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:47:32.731707 [debug] [MainThread]: running dbt with arguments {'profiles_dir': '/Users/danila/.dbt', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'indirect_selection': 'eager', 'static_parser': 'True', 'target_path': 'None', 'send_anonymous_usage_stats': 'True', 'invocation_command': 'dbt build', 'log_format': 'default', 'log_path': '/Users/danila/github/dbt/logs', 'write_json': 'True', 'introspect': 'True', 'fail_fast': 'False', 'version_check': 'True', 'partial_parse': 'True', 'quiet': 'False', 'use_colors': 'True', 'log_cache_events': 'False', 'debug': 'False', 'no_print': 'None', 'warn_error': 'None'}
[0m21:47:32.794643 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11346f3d0>]}
[0m21:47:32.824910 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1134a3dd0>]}
[0m21:47:32.825267 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:47:32.831438 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:47:32.844443 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:47:32.844693 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:47:32.845246 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:47:32.847813 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1127a5490>]}
[0m21:47:32.853120 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113737fd0>]}
[0m21:47:32.853353 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:47:32.854555 [info ] [MainThread]: 
[0m21:47:32.854981 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:47:32.855790 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:47:32.860428 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:47:32.860660 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:47:32.860824 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:47:33.293463 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:47:33.298432 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:47:33.302930 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:47:33.312114 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:47:33.312735 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:47:33.313127 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:47:33.571829 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:47:33.573598 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:47:33.575022 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:47:33.612371 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:47:33.617892 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:47:33.649213 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:47:33.665763 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:33.666270 [debug] [MainThread]: On master: BEGIN
[0m21:47:33.666695 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:47:33.922979 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:33.923494 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:33.923962 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:47:33.969410 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:47:33.974157 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11279f550>]}
[0m21:47:33.974833 [debug] [MainThread]: On master: ROLLBACK
[0m21:47:34.005067 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:34.005551 [debug] [MainThread]: On master: BEGIN
[0m21:47:34.066409 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:34.068224 [debug] [MainThread]: On master: COMMIT
[0m21:47:34.069004 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:34.069691 [debug] [MainThread]: On master: COMMIT
[0m21:47:34.101149 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:47:34.102598 [debug] [MainThread]: On master: Close
[0m21:47:34.105791 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:47:34.106590 [info ] [MainThread]: 
[0m21:47:34.111795 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.112729 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:47:34.114301 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:47:34.114995 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.128085 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.129052 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:47:34.115464 => 21:47:34.128800
[0m21:47:34.129426 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:47:34.155859 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.156384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.156613 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:47:34.156827 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:34.411292 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:34.412706 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:47:34.414266 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:48:02.597861 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 28.0 seconds
[0m21:48:02.610199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.611301 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:48:02.643341 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:02.651648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.652828 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:48:02.685751 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:02.720041 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:48:02.720763 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.721308 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:48:02.753538 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:02.763361 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:48:02.770556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:48:02.771278 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:48:02.816071 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:02.819516 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:47:34.129634 => 21:48:02.819243
[0m21:48:02.820146 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:48:02.821825 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113538290>]}
[0m21:48:02.823074 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 28.71s]
[0m21:48:02.824023 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:48:02.824556 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:48:02.825192 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:48:02.826436 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:48:02.827051 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:48:02.832895 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:48:02.834296 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:48:02.827402 => 21:48:02.833917
[0m21:48:02.834939 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:48:02.841496 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:48:02.842681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:02.843177 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:48:02.843628 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:03.231205 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:03.232454 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.233031 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:48:03.287920 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:48:03.295579 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.296414 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:48:03.334436 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.344115 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.344979 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:48:03.382846 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.387035 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:48:03.387767 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.388342 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:48:03.425236 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:03.432960 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:48:03.434695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:48:03.435440 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:48:03.490267 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:03.493233 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:48:02.835273 => 21:48:03.492817
[0m21:48:03.494070 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:48:03.496022 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139549d0>]}
[0m21:48:03.497485 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1411[0m in 0.67s]
[0m21:48:03.498560 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:48:03.499142 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.499715 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:48:03.500823 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:48:03.501444 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.508075 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.509725 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:48:03.501780 => 21:48:03.509350
[0m21:48:03.510239 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:48:03.517683 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.519452 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.520424 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:48:03.520954 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:03.794352 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:03.796203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.797727 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:48:03.891444 [debug] [Thread-1 (]: SQL status: SELECT 1411 in 0.0 seconds
[0m21:48:03.894631 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.894947 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:48:03.979273 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:03.983982 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:03.984567 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:48:04.016064 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.020214 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:48:04.021018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:04.021491 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:48:04.052376 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:04.057242 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:48:04.058739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:48:04.059347 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:48:04.108215 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:04.111452 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:48:03.510464 => 21:48:04.111041
[0m21:48:04.112085 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:48:04.113443 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11393a810>]}
[0m21:48:04.115251 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1411[0m in 0.61s]
[0m21:48:04.116390 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:48:04.117021 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:48:04.117756 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m21:48:04.118738 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:48:04.119487 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:48:04.125113 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:48:04.126582 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:48:04.119887 => 21:48:04.126216
[0m21:48:04.127172 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:48:04.134868 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:48:04.136324 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.136928 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:48:04.137349 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:04.409134 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:04.410287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.411248 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:48:04.448998 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m21:48:04.457218 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.458348 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:48:04.489926 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.497301 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.498758 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:48:04.530386 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:04.533963 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:48:04.534538 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.535012 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:48:04.565828 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:04.570858 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:48:04.572431 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:48:04.572953 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:48:04.625636 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:04.629314 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:48:04.127568 => 21:48:04.628870
[0m21:48:04.630179 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:48:04.631651 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ad310>]}
[0m21:48:04.632864 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.51s]
[0m21:48:04.634029 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:48:04.634941 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.636146 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:48:04.637412 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:48:04.637986 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.647400 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.649294 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:48:04.638213 => 21:48:04.648778
[0m21:48:04.650093 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:48:04.657234 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.658917 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.659578 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:48:04.660044 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:04.934456 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:04.935797 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.936487 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:48:04.972697 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:04.980050 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:04.980632 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:48:05.014825 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:05.019037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.019546 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:48:05.054158 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:05.059286 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:48:05.060117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.060988 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:48:05.094964 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:05.102522 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:48:05.105590 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:48:05.107020 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:48:05.160512 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:05.162841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:48:04.650794 => 21:48:05.162563
[0m21:48:05.163434 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:48:05.164892 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113511990>]}
[0m21:48:05.165734 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.53s]
[0m21:48:05.166573 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:48:05.167214 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.168186 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:48:05.169180 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:48:05.169751 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.177893 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.179945 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:48:05.170161 => 21:48:05.179603
[0m21:48:05.180566 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:05.187965 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.189547 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.190175 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:48:05.190707 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:05.450447 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:05.451673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:05.452387 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:48:12.318708 [debug] [Thread-1 (]: SQL status: SELECT 142664 in 7.0 seconds
[0m21:48:12.329581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.330480 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:48:12.362356 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.372569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.374080 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:48:12.406755 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.414831 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:48:12.416312 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.417366 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:48:12.449548 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:12.459208 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:48:12.462063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:48:12.463089 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:48:12.511587 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:12.516713 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:48:05.180936 => 21:48:12.515945
[0m21:48:12.518160 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:48:12.521407 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11373eed0>]}
[0m21:48:12.523480 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 142664[0m in 7.35s]
[0m21:48:12.525536 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:48:12.526968 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.528382 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:48:12.530275 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:48:12.531181 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.536687 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.538172 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:48:12.531716 => 21:48:12.537862
[0m21:48:12.538756 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:12.544477 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.545532 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.545994 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:48:12.546394 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:12.857549 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:12.859248 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.860395 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:48:12.897331 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:12.911262 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.912156 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:48:12.948019 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.955948 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.957559 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:48:12.991423 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:12.995482 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:48:12.996483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:12.997133 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:48:13.031190 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:13.036922 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:48:13.039200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:48:13.039995 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:48:13.091439 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:13.094731 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:48:12.539152 => 21:48:13.094345
[0m21:48:13.095376 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:48:13.097661 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139b0310>]}
[0m21:48:13.099402 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.57s]
[0m21:48:13.100290 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:48:13.100997 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.101814 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:48:13.103035 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:48:13.103956 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.110910 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.112776 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:48:13.104327 => 21:48:13.112277
[0m21:48:13.113597 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.121862 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.123913 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.124805 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:48:13.125752 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:13.435667 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:13.437066 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.437862 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:48:13.482083 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:48:13.489146 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.489795 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:48:13.527480 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:13.534273 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.535549 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.574220 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:13.578332 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:48:13.579109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.579766 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:48:13.618011 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:13.623132 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:48:13.624884 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:48:13.625696 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:48:13.681853 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:13.685276 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:48:13.114039 => 21:48:13.684789
[0m21:48:13.686201 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:48:13.687530 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11378dc50>]}
[0m21:48:13.689197 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.58s]
[0m21:48:13.690978 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:48:13.691631 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.692436 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:48:13.693589 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:48:13.694524 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.701956 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.703858 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:48:13.694872 => 21:48:13.703346
[0m21:48:13.704569 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:13.712758 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.714275 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.714802 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:48:13.715226 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:13.994800 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:13.995720 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:13.996347 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m21:48:18.450432 [debug] [Thread-1 (]: SQL status: SELECT 37211 in 4.0 seconds
[0m21:48:18.462427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.463952 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:48:18.500832 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:18.510834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.511908 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:48:18.544192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:18.551530 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:48:18.552953 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.554189 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:48:18.586203 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:18.598525 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:48:18.600190 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:48:18.600958 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:48:18.646992 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:18.651144 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:48:13.705037 => 21:48:18.650623
[0m21:48:18.652047 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:48:18.654232 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113702110>]}
[0m21:48:18.655466 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37211[0m in 4.96s]
[0m21:48:18.657255 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:48:18.658238 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.659443 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:48:18.660865 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:48:18.662124 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.723602 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.724280 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:48:18.662999 => 21:48:18.724136
[0m21:48:18.724521 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:48:18.726953 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.727328 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.727544 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:48:18.727743 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:18.981067 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:18.982039 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:18.982728 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date_parsed as date_cet, 
    geo as country_code,
    CASE
     When right(brand_name,6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:48:21.829326 [debug] [Thread-1 (]: SQL status: SELECT 114197 in 3.0 seconds
[0m21:48:21.837130 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.837776 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:48:21.869268 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:21.876880 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.877659 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:48:21.910165 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:21.917154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:48:21.918138 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.918730 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:48:21.951031 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:21.961212 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:48:21.963774 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:48:21.964791 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:48:22.014702 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:22.017786 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:48:18.724663 => 21:48:22.017518
[0m21:48:22.018328 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:48:22.020533 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x114003210>]}
[0m21:48:22.021457 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114197[0m in 3.36s]
[0m21:48:22.022297 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:48:22.023489 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.025596 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:48:22.026770 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:48:22.027437 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.033915 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.035617 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:48:22.027952 => 21:48:22.035283
[0m21:48:22.036256 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.043606 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.045407 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.046044 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:48:22.047080 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:22.422317 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:22.424206 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.425909 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:48:22.500144 [debug] [Thread-1 (]: SQL status: SELECT 8036 in 0.0 seconds
[0m21:48:22.511782 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.512898 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:48:22.544369 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:22.552027 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.553381 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:48:22.584618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:22.590972 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:48:22.591676 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.592215 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:48:22.624075 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:22.628998 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:48:22.630384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:48:22.630850 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:48:22.679691 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:22.685342 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:48:22.036666 => 21:48:22.684532
[0m21:48:22.686913 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:48:22.689732 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139a5ed0>]}
[0m21:48:22.690548 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8036[0m in 0.66s]
[0m21:48:22.691382 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:48:22.691954 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:48:22.692673 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m21:48:22.693573 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:48:22.694161 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:48:22.699101 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:48:22.700621 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:48:22.694676 => 21:48:22.700160
[0m21:48:22.701417 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:48:22.712000 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:48:22.714014 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:22.714797 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:48:22.715588 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:22.970330 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:22.972295 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:22.973494 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:48:23.007116 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:23.017806 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.018444 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:48:23.049773 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.056790 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.057924 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:48:23.089514 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.094511 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:48:23.095075 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.095452 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:48:23.126220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:23.133988 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:48:23.134924 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:48:23.135660 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:48:23.183714 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:23.188180 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:48:22.701840 => 21:48:23.187463
[0m21:48:23.189492 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:48:23.192275 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137fb110>]}
[0m21:48:23.194057 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.50s]
[0m21:48:23.195436 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:48:23.196505 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:48:23.197738 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:48:23.199438 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:48:23.200402 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:48:23.206910 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.208463 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:48:23.201046 => 21:48:23.208153
[0m21:48:23.209069 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:48:23.215767 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.217230 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.217715 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:48:23.218157 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:23.495283 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:23.497063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.498625 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:48:23.736144 [debug] [Thread-1 (]: SQL status: SELECT 54053 in 0.0 seconds
[0m21:48:23.749019 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.750644 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:48:23.785671 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.796527 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.797996 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:48:23.832234 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:23.836436 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:48:23.837098 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.837663 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:48:23.871304 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:23.875084 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:48:23.876210 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:48:23.876694 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:48:23.929378 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:23.930781 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:48:23.209466 => 21:48:23.930603
[0m21:48:23.931126 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:48:23.931956 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1137ed2d0>]}
[0m21:48:23.932433 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54053[0m in 0.73s]
[0m21:48:23.932890 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:48:23.933257 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.933681 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m21:48:23.934418 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m21:48:23.934783 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.942902 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.943514 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 21:48:23.934984 => 21:48:23.943363
[0m21:48:23.943781 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:23.951580 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.952016 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:23.952223 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m21:48:23.952421 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:24.206346 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:24.208526 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m21:48:24.210136 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:48:24.243376 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:24.251808 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 21:48:23.943933 => 21:48:24.250909
[0m21:48:24.253413 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m21:48:24.288845 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m21:48:24.293480 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.36s]
[0m21:48:24.295922 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m21:48:24.297560 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.299114 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m21:48:24.300140 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m21:48:24.300928 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.317458 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.319386 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 21:48:24.301621 => 21:48:24.318931
[0m21:48:24.319950 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.322951 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.323770 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.324213 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m21:48:24.324633 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:24.671541 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:24.673730 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m21:48:24.676446 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:48:24.719084 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:24.724426 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 21:48:24.320248 => 21:48:24.723504
[0m21:48:24.725307 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m21:48:24.765821 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m21:48:24.768757 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.47s]
[0m21:48:24.770447 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m21:48:24.771757 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.773790 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:48:24.775824 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:48:24.776985 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.783665 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.785069 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:48:24.777772 => 21:48:24.784693
[0m21:48:24.785890 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:24.792392 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.793282 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:24.793723 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:48:24.794120 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:25.049133 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:25.051268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.053289 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


SELECT 
    COALESCE(matomo.date_cet, records.date_cet) as date_cet, 
    COALESCE(matomo.country_code, records.country_code) as country_code, 
    COALESCE(matomo.betting_type, records.betting_type) as betting_type,
    COALESCE(matomo.campaign_name, records.campaign_name) as campaign_name, 
    COALESCE(matomo.ga_campaign_name, records.ga_campaign_name) as ga_campaign_name, 
    COALESCE(matomo.brand_name, records.brand_name) as brand_name,
    matomo.outclicks,
    matomo.unique_outclicks,
    matomo.avg_list_position,
    matomo.pos_list,
    records.signups, 
    records.cpa_count, 
    records.cpa_commissions, 
    records.revshare_commissions, 
    records.gtee_count,
    records.gtee_commissions, 
    records.avg_deposit_amount
FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
FULL OUTER JOIN "deep-analysis-console"."danila"."stg_record__casino_events" records ON 
    matomo.date_cet = records.date_cet 
    AND matomo.country_code = records.country_code 
    AND matomo.betting_type=records.betting_type
    and matomo.campaign_name = records.campaign_name 
    AND matomo.ga_campaign_name = records.ga_campaign_name 
    AND matomo.brand_name = records.brand_name
-- where COALESCE(matomo.country_code, records.country_code)='de'
-- and COALESCE(matomo.date_cet, records.date_cet)='2024-04-23'
-- and COALESCE(matomo.betting_type, records.betting_type)='simple'
-- and COALESCE(matomo.brand_name, records.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:48:25.618285 [debug] [Thread-1 (]: SQL status: SELECT 123964 in 1.0 seconds
[0m21:48:25.627574 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.628475 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:48:25.659269 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:25.668001 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.669518 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:48:25.702848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:25.709856 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:48:25.710581 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.711234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:48:25.742270 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:25.750071 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:48:25.752911 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:48:25.753891 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:48:25.804387 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:25.808937 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:48:24.786285 => 21:48:25.808199
[0m21:48:25.810331 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:48:25.813200 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113834810>]}
[0m21:48:25.815078 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 123964[0m in 1.04s]
[0m21:48:25.817035 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:48:25.818295 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.819524 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m21:48:25.821213 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m21:48:25.822186 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.830940 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.832739 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 21:48:25.822820 => 21:48:25.832314
[0m21:48:25.833419 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:25.840174 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.841575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:25.842067 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m21:48:25.842754 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:26.104546 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:26.106143 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.107989 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:48:26.216949 [debug] [Thread-1 (]: SQL status: SELECT 45247 in 0.0 seconds
[0m21:48:26.224416 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.224927 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m21:48:26.256174 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.266881 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.267640 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m21:48:26.299318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.307665 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:48:26.309034 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.310287 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:48:26.342437 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:26.352095 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m21:48:26.355657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:48:26.357134 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m21:48:26.429738 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:26.434698 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 21:48:25.833868 => 21:48:26.433914
[0m21:48:26.436126 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m21:48:26.439268 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ac810>]}
[0m21:48:26.441290 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45247[0m in 0.62s]
[0m21:48:26.442978 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:48:26.444104 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.445387 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:48:26.447156 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:48:26.448160 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.454984 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.456521 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:48:26.448834 => 21:48:26.456207
[0m21:48:26.457102 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:48:26.466246 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.468002 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.468635 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:48:26.469112 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:26.747281 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:26.748853 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.750475 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:48:26.810966 [debug] [Thread-1 (]: SQL status: SELECT 62 in 0.0 seconds
[0m21:48:26.816122 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.816805 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:48:26.850513 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.857379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.858220 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:48:26.891959 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:26.896058 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:48:26.896649 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.897073 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:48:26.931182 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:26.939049 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:48:26.941957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:48:26.943013 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:48:26.997063 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:48:27.000880 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:48:26.457495 => 21:48:27.000334
[0m21:48:27.001911 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:48:27.004235 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1139ba690>]}
[0m21:48:27.005645 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 62[0m in 0.56s]
[0m21:48:27.007131 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:48:27.008320 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.009762 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:48:27.011639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m21:48:27.012760 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.018885 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.020625 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:48:27.013422 => 21:48:27.020291
[0m21:48:27.021256 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.045716 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.046698 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.047052 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:48:27.047376 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:27.322674 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:27.324119 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.324929 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:48:27.362059 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:48:27.369497 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.370211 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:48:27.403693 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:48:27.408534 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:48:27.409677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.410441 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:48:27.444459 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:48:27.451483 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:48:27.457555 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:48:27.458634 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:48:27.493419 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:48:27.496003 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:48:27.021731 => 21:48:27.495737
[0m21:48:27.496541 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:48:27.498146 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '68185f43-60ea-4c59-9387-45ae80d92e26', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11376c7d0>]}
[0m21:48:27.499315 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.49s]
[0m21:48:27.500550 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:48:27.502179 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.503237 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m21:48:27.504194 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m21:48:27.504578 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.513901 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.516262 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 21:48:27.504812 => 21:48:27.515403
[0m21:48:27.517130 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.521504 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.522943 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.523388 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m21:48:27.523796 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:27.804900 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:27.806624 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m21:48:27.807522 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m21:48:27.842877 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:27.845477 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 21:48:27.517593 => 21:48:27.844978
[0m21:48:27.846189 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m21:48:27.879916 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m21:48:27.882075 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.38s]
[0m21:48:27.883177 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m21:48:27.883886 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.884587 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m21:48:27.885710 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m21:48:27.886587 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.897900 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.900410 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 21:48:27.886922 => 21:48:27.899585
[0m21:48:27.901309 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:27.905190 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.906642 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:27.907053 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m21:48:27.907462 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:48:28.231356 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:48:28.233333 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m21:48:28.234920 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m21:48:28.277870 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:48:28.283818 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 21:48:27.901773 => 21:48:28.283002
[0m21:48:28.285283 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m21:48:28.325310 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m21:48:28.327758 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.44s]
[0m21:48:28.329054 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m21:48:28.333417 [debug] [MainThread]: Using postgres connection "master"
[0m21:48:28.334737 [debug] [MainThread]: On master: BEGIN
[0m21:48:28.335571 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:48:28.659152 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:48:28.660912 [debug] [MainThread]: On master: COMMIT
[0m21:48:28.661427 [debug] [MainThread]: Using postgres connection "master"
[0m21:48:28.661786 [debug] [MainThread]: On master: COMMIT
[0m21:48:28.692725 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:48:28.693863 [debug] [MainThread]: On master: Close
[0m21:48:28.696224 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:48:28.696738 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m21:48:28.697301 [info ] [MainThread]: 
[0m21:48:28.698155 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 55.84 seconds (55.84s).
[0m21:48:28.702587 [debug] [MainThread]: Command end result
[0m21:48:28.721225 [info ] [MainThread]: 
[0m21:48:28.722225 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:48:28.722763 [info ] [MainThread]: 
[0m21:48:28.723281 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m21:48:28.725607 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 56.015503, "process_user_time": 2.516233, "process_kernel_time": 0.245119, "process_mem_max_rss": "126287872", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:48:28.726351 [debug] [MainThread]: Command `dbt build` succeeded at 21:48:28.726174 after 56.02 seconds
[0m21:48:28.726853 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11275d0d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f7df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104f7ded0>]}
[0m21:48:28.727363 [debug] [MainThread]: Flushing usage events
[0m11:20:54.918025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10530b4d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105382d90>]}


============================== 11:20:54.919581 | fb68269a-fb15-4ca6-9cdc-b14d74da6fe4 ==============================
[0m11:20:54.919581 [info ] [MainThread]: Running with dbt=1.7.0
[0m11:20:54.919942 [debug] [MainThread]: running dbt with arguments {'indirect_selection': 'eager', 'debug': 'False', 'target_path': 'None', 'log_format': 'default', 'cache_selected_only': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'warn_error': 'None', 'printer_width': '80', 'log_cache_events': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'quiet': 'False', 'version_check': 'True', 'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'use_colors': 'True', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'fail_fast': 'False', 'partial_parse': 'True', 'invocation_command': 'dbt build', 'static_parser': 'True', 'use_experimental_parser': 'False'}
[0m11:20:54.988897 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103d1ff50>]}
[0m11:20:55.018446 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10617b9d0>]}
[0m11:20:55.018843 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m11:20:55.025442 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m11:20:55.043123 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:20:55.043375 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:20:55.043890 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m11:20:55.046448 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106413150>]}
[0m11:20:55.052554 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10633fdd0>]}
[0m11:20:55.052840 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:20:55.054156 [info ] [MainThread]: 
[0m11:20:55.054648 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:20:55.055493 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m11:20:55.059984 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m11:20:55.060149 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m11:20:55.060292 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:20:55.319808 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m11:20:55.325608 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m11:20:55.328854 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m11:20:55.333913 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:20:55.334234 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m11:20:55.334491 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:20:55.590655 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:20:55.592458 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:20:55.593838 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m11:20:55.629547 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m11:20:55.634041 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m11:20:55.664751 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m11:20:55.678842 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:55.679281 [debug] [MainThread]: On master: BEGIN
[0m11:20:55.679612 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:20:56.100552 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.102318 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.103842 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:20:56.157848 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m11:20:56.165410 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10437c990>]}
[0m11:20:56.165953 [debug] [MainThread]: On master: ROLLBACK
[0m11:20:56.207962 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.208699 [debug] [MainThread]: On master: BEGIN
[0m11:20:56.292999 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.294818 [debug] [MainThread]: On master: COMMIT
[0m11:20:56.296108 [debug] [MainThread]: Using postgres connection "master"
[0m11:20:56.296765 [debug] [MainThread]: On master: COMMIT
[0m11:20:56.339094 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:20:56.340798 [debug] [MainThread]: On master: Close
[0m11:20:56.343992 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m11:20:56.344760 [info ] [MainThread]: 
[0m11:20:56.351499 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.352536 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m11:20:56.353712 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m11:20:56.354315 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.367044 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.368015 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 11:20:56.354718 => 11:20:56.367746
[0m11:20:56.368455 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m11:20:56.394215 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.395116 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.395411 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m11:20:56.395644 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:20:56.717049 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:20:56.719080 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:20:56.721790 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m11:21:16.887732 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 20.0 seconds
[0m11:21:16.902144 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:16.902816 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m11:21:16.942366 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:16.946162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:16.946643 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m11:21:16.985769 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.013270 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:21:17.013738 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:17.014088 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:21:17.052965 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:17.060287 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m11:21:17.065224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:21:17.065587 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m11:21:17.119004 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:17.122542 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 11:20:56.368698 => 11:21:17.122122
[0m11:21:17.123310 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m11:21:17.125084 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106421b10>]}
[0m11:21:17.126212 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 20.77s]
[0m11:21:17.127087 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m11:21:17.127669 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m11:21:17.128423 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m11:21:17.129472 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m11:21:17.129998 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m11:21:17.133663 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m11:21:17.134673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 11:21:17.130316 => 11:21:17.134446
[0m11:21:17.135080 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m11:21:17.139382 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m11:21:17.140109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.140434 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m11:21:17.140755 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:17.481840 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:17.483782 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.485194 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:21:17.538205 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:21:17.545447 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.546187 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m11:21:17.579834 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.589804 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.590332 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m11:21:17.624409 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:17.627758 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:21:17.628269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.628690 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:21:17.661435 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:17.667231 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m11:21:17.668878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:21:17.669550 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m11:21:17.722021 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:17.725888 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 11:21:17.135324 => 11:21:17.725613
[0m11:21:17.726443 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m11:21:17.727885 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106578890>]}
[0m11:21:17.728770 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.60s]
[0m11:21:17.729515 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m11:21:17.730066 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.730692 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m11:21:17.731523 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m11:21:17.731916 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.735270 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.736164 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 11:21:17.732169 => 11:21:17.735931
[0m11:21:17.736568 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m11:21:17.740503 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.741240 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:17.741576 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m11:21:17.741893 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:18.108017 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.110128 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.111629 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:21:18.172590 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:21:18.174624 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.174869 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m11:21:18.213229 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.215286 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.215548 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m11:21:18.254331 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.256405 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:21:18.256792 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.257160 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:21:18.295660 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:18.300115 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m11:21:18.301428 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:21:18.301986 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m11:21:18.358590 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:18.364056 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 11:21:17.736805 => 11:21:18.363281
[0m11:21:18.365495 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m11:21:18.367431 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1062a3510>]}
[0m11:21:18.368518 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.64s]
[0m11:21:18.369522 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m11:21:18.370138 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m11:21:18.370822 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m11:21:18.371666 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m11:21:18.372116 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m11:21:18.375713 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m11:21:18.376574 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 11:21:18.372391 => 11:21:18.376359
[0m11:21:18.376964 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m11:21:18.381192 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m11:21:18.381878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.382194 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m11:21:18.382493 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:18.637004 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:18.639132 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.640495 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m11:21:18.678414 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m11:21:18.688798 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.689155 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m11:21:18.719560 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.722657 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.723070 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m11:21:18.753949 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:18.757381 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:21:18.757905 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.758337 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:21:18.789102 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:18.795164 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m11:21:18.796498 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:21:18.797057 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m11:21:18.846479 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:18.851507 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 11:21:18.377195 => 11:21:18.850742
[0m11:21:18.852515 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m11:21:18.854468 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064213d0>]}
[0m11:21:18.855732 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.48s]
[0m11:21:18.856905 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m11:21:18.857773 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.858759 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m11:21:18.859750 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m11:21:18.860274 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.867994 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.869075 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 11:21:18.860620 => 11:21:18.868788
[0m11:21:18.869568 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m11:21:18.874158 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.874881 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:18.875267 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m11:21:18.875626 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:19.243850 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:19.245985 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.247523 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m11:21:19.294206 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:19.303834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.304439 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m11:21:19.348726 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:19.355598 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.356447 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m11:21:19.401646 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:19.407472 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:21:19.408046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.408520 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:21:19.452813 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:19.462624 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m11:21:19.463690 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:21:19.464123 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m11:21:19.525828 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:19.530709 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 11:21:18.869836 => 11:21:19.530387
[0m11:21:19.531298 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m11:21:19.532721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105358910>]}
[0m11:21:19.533580 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.67s]
[0m11:21:19.534511 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m11:21:19.535216 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.535946 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m11:21:19.536984 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m11:21:19.537442 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.543065 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.543943 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 11:21:19.537719 => 11:21:19.543714
[0m11:21:19.544313 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:19.548068 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.548626 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.548942 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m11:21:19.549240 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:19.802546 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:19.804721 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:19.806839 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m11:21:27.228562 [debug] [Thread-1 (]: SQL status: SELECT 143172 in 7.0 seconds
[0m11:21:27.233334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.233923 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m11:21:27.264866 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.268403 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.268815 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m11:21:27.300318 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.304253 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:21:27.304876 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.305444 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:21:27.336871 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:27.342420 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m11:21:27.343703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:21:27.344338 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m11:21:27.391450 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:27.395358 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 11:21:19.544516 => 11:21:27.394913
[0m11:21:27.396303 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m11:21:27.398518 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065bb810>]}
[0m11:21:27.399782 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143172[0m in 7.86s]
[0m11:21:27.400771 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m11:21:27.401562 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.402429 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m11:21:27.403467 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m11:21:27.404023 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.408831 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.410001 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 11:21:27.404373 => 11:21:27.409706
[0m11:21:27.410500 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:27.415260 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.416161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.416556 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m11:21:27.416926 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:27.742480 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:27.743135 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.743513 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m11:21:27.784907 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:27.791660 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.792098 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m11:21:27.831823 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.837533 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.838064 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m11:21:27.880162 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:27.884554 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:21:27.885276 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.885807 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:21:27.937184 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:27.942925 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m11:21:27.944389 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:21:27.945025 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m11:21:28.000954 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:28.004976 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 11:21:27.410787 => 11:21:28.004513
[0m11:21:28.005910 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m11:21:28.008061 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10644d610>]}
[0m11:21:28.009240 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.60s]
[0m11:21:28.010335 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m11:21:28.011210 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.012190 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m11:21:28.013211 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m11:21:28.013751 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.019152 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.020343 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 11:21:28.014087 => 11:21:28.020056
[0m11:21:28.020796 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.025447 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.026176 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.026549 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m11:21:28.026861 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:28.280354 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:28.282033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.283087 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m11:21:28.320996 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m11:21:28.329563 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.330137 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:21:28.361370 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:28.366699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.367262 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.397574 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:28.401416 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:21:28.402076 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.402602 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:21:28.433460 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:28.435975 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:21:28.436591 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:21:28.436857 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m11:21:28.485341 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:28.486562 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 11:21:28.021035 => 11:21:28.486410
[0m11:21:28.486849 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m11:21:28.487461 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065e6a90>]}
[0m11:21:28.487868 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.47s]
[0m11:21:28.488280 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:21:28.488585 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.488889 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m11:21:28.489425 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m11:21:28.489737 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.491998 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.492523 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 11:21:28.489902 => 11:21:28.492381
[0m11:21:28.492771 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:28.495332 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.495737 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.495958 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m11:21:28.496167 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:28.824094 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:28.826256 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:28.827988 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m11:21:33.807192 [debug] [Thread-1 (]: SQL status: SELECT 37355 in 5.0 seconds
[0m11:21:33.815837 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.816555 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:21:33.854864 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:33.862810 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.864203 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m11:21:33.902178 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:33.906259 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:21:33.906734 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.907646 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:21:33.945515 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:33.957248 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:21:33.958558 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:21:33.959139 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m11:21:34.011476 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:34.015790 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 11:21:28.492915 => 11:21:34.014987
[0m11:21:34.017174 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m11:21:34.019824 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065f8b10>]}
[0m11:21:34.021542 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37355[0m in 5.53s]
[0m11:21:34.023034 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:21:34.024146 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.025344 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m11:21:34.026630 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m11:21:34.027335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.084721 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.085450 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 11:21:34.027803 => 11:21:34.085306
[0m11:21:34.085709 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m11:21:34.088190 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.088556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.088757 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m11:21:34.088946 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:34.342794 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:34.344693 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:34.346471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m11:21:37.386911 [debug] [Thread-1 (]: SQL status: SELECT 114590 in 3.0 seconds
[0m11:21:37.391625 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.393162 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m11:21:37.426048 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:37.431957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.433747 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m11:21:37.465842 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:37.471410 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:21:37.472018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.472512 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:21:37.503734 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:37.510128 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m11:21:37.511871 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:21:37.512359 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m11:21:37.559679 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:37.562530 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 11:21:34.085842 => 11:21:37.562260
[0m11:21:37.563139 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m11:21:37.564313 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065c0990>]}
[0m11:21:37.565612 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114590[0m in 3.54s]
[0m11:21:37.567542 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m11:21:37.568656 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.569737 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m11:21:37.571161 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m11:21:37.571949 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.579545 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.581248 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 11:21:37.572239 => 11:21:37.580847
[0m11:21:37.581965 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:37.589759 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.591019 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.591646 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m11:21:37.592311 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:37.866621 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:37.867801 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.868379 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m11:21:37.959911 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m11:21:37.968129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:37.968811 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:21:38.000073 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.006246 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.007213 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m11:21:38.038214 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.043074 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:21:38.043730 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.044387 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:21:38.076136 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:38.081688 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:21:38.082963 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:21:38.083589 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m11:21:38.138383 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:38.142107 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 11:21:37.582464 => 11:21:38.141324
[0m11:21:38.142933 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m11:21:38.145065 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1065c2810>]}
[0m11:21:38.146234 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.57s]
[0m11:21:38.147474 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:21:38.148766 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m11:21:38.150894 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m11:21:38.152785 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m11:21:38.153772 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m11:21:38.160130 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m11:21:38.162107 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 11:21:38.154256 => 11:21:38.161524
[0m11:21:38.162963 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m11:21:38.174582 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m11:21:38.176021 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.176562 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m11:21:38.177020 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:38.434023 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:38.434838 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.435383 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m11:21:38.468588 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:38.471291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.471605 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m11:21:38.502054 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.504567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.504874 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m11:21:38.535277 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:38.537329 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:21:38.537711 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.538069 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:21:38.568237 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:38.572225 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m11:21:38.573304 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:21:38.573792 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m11:21:38.621494 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:38.626294 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 11:21:38.163440 => 11:21:38.625569
[0m11:21:38.627695 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m11:21:38.630204 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106433a10>]}
[0m11:21:38.631510 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.48s]
[0m11:21:38.632723 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m11:21:38.633595 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m11:21:38.634653 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m11:21:38.636060 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m11:21:38.636688 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m11:21:38.643247 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.646097 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 11:21:38.637147 => 11:21:38.645672
[0m11:21:38.646900 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m11:21:38.653147 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.654249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.654742 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m11:21:38.655184 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:38.978895 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:38.979886 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:38.980775 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m11:21:39.314573 [debug] [Thread-1 (]: SQL status: SELECT 54835 in 0.0 seconds
[0m11:21:39.321827 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.322694 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m11:21:39.361816 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:39.368464 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.369113 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m11:21:39.409063 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:39.414247 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:21:39.415162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.415874 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:21:39.456034 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:39.461083 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m11:21:39.462556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:21:39.463042 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m11:21:39.519203 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:39.523174 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 11:21:38.647463 => 11:21:39.522855
[0m11:21:39.523898 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m11:21:39.525623 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064314d0>]}
[0m11:21:39.526555 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54835[0m in 0.89s]
[0m11:21:39.527374 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m11:21:39.528337 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.529935 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m11:21:39.531371 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m11:21:39.531968 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.550959 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.553335 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 11:21:39.532337 => 11:21:39.552870
[0m11:21:39.553958 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.569313 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.570178 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.570517 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m11:21:39.570840 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:39.891374 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:39.893208 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:21:39.894205 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:21:39.935066 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:39.939840 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 11:21:39.554273 => 11:21:39.939286
[0m11:21:39.940660 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m11:21:39.979410 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m11:21:39.981907 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.45s]
[0m11:21:39.983101 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:21:39.983847 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:39.984487 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m11:21:39.985538 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m11:21:39.986142 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.002796 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.004903 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 11:21:39.986550 => 11:21:40.004483
[0m11:21:40.005632 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.009743 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.011113 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.011627 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m11:21:40.012068 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:40.367386 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:40.368906 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:21:40.370885 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:21:40.415637 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:40.419290 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 11:21:40.006051 => 11:21:40.418842
[0m11:21:40.420168 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m11:21:40.463727 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m11:21:40.467283 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.48s]
[0m11:21:40.468863 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:21:40.469687 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.470998 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m11:21:40.472423 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m11:21:40.473100 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.481512 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.483305 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 11:21:40.473803 => 11:21:40.482869
[0m11:21:40.483996 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.492284 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.494157 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.494683 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m11:21:40.495141 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:40.831054 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:40.832161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:21:40.833018 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        betting_type,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    betting_type, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, 
    sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
  );
  
[0m11:21:40.873588 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "date_cet" does not exist
LINE 42:     date_cet, 
             ^
HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.

[0m11:21:40.875353 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: ROLLBACK
[0m11:21:40.913238 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 11:21:40.484442 => 11:21:40.912647
[0m11:21:40.914120 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m11:21:40.931225 [debug] [Thread-1 (]: Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "date_cet" does not exist
  LINE 42:     date_cet, 
               ^
  HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m11:21:40.932111 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10653c150>]}
[0m11:21:40.933095 [error] [Thread-1 (]: 16 of 21 ERROR creating sql table model danila.outclick_by_brand_int_new ....... [[31mERROR[0m in 0.46s]
[0m11:21:40.934084 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:21:40.934783 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.935696 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m11:21:40.936806 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m11:21:40.937535 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.944932 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.946451 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 11:21:40.937999 => 11:21:40.946123
[0m11:21:40.947004 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:40.952689 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.953567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:40.953960 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m11:21:40.954325 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:41.206718 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:41.208831 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.210306 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m11:21:41.303746 [debug] [Thread-1 (]: SQL status: SELECT 45422 in 0.0 seconds
[0m11:21:41.312292 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.313074 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m11:21:41.344763 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:41.352104 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.353282 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m11:21:41.384826 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:41.389826 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:21:41.390699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.391462 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:21:41.422030 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:41.428195 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m11:21:41.429607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:21:41.430401 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m11:21:41.480283 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:41.484523 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 11:21:40.947293 => 11:21:41.483942
[0m11:21:41.485647 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m11:21:41.488141 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106169c10>]}
[0m11:21:41.489428 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45422[0m in 0.55s]
[0m11:21:41.491474 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m11:21:41.492944 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.494207 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m11:21:41.496223 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m11:21:41.497165 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.505352 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.507482 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 11:21:41.497709 => 11:21:41.506942
[0m11:21:41.508513 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m11:21:41.516360 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.518191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.518856 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m11:21:41.519351 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:41.867802 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:41.869838 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.870843 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m11:21:41.952185 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m11:21:41.961284 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:41.962532 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m11:21:42.005644 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.019697 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.020800 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m11:21:42.063574 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.067776 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:21:42.068506 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.069094 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:21:42.111884 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:42.117660 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m11:21:42.119400 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:21:42.120149 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m11:21:42.182623 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:21:42.186958 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 11:21:41.509062 => 11:21:42.186226
[0m11:21:42.187866 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m11:21:42.189872 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106388290>]}
[0m11:21:42.191071 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.69s]
[0m11:21:42.192303 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m11:21:42.193261 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.194846 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m11:21:42.197003 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m11:21:42.197864 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.203758 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.206341 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 11:21:42.198476 => 11:21:42.205971
[0m11:21:42.207021 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.231223 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.232028 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.232388 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m11:21:42.232712 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:42.587138 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:42.589117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.590592 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m11:21:42.636858 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m11:21:42.642893 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.643593 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m11:21:42.686669 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:21:42.691306 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:21:42.692009 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.692433 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:21:42.734642 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:21:42.742495 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m11:21:42.750957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:21:42.752215 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m11:21:42.795957 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m11:21:42.800082 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 11:21:42.208349 => 11:21:42.799798
[0m11:21:42.800544 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m11:21:42.801772 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'fb68269a-fb15-4ca6-9cdc-b14d74da6fe4', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1064f9910>]}
[0m11:21:42.803461 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.61s]
[0m11:21:42.805456 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m11:21:42.807696 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.808202 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m11:21:42.809251 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m11:21:42.810222 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.820939 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.823821 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 11:21:42.810745 => 11:21:42.823314
[0m11:21:42.824547 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:42.828479 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.830216 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:42.830821 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m11:21:42.831267 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:43.087718 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.088941 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:21:43.089417 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:21:43.122407 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:43.127868 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 11:21:42.824971 => 11:21:43.126989
[0m11:21:43.129394 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m11:21:43.160873 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m11:21:43.164320 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.36s]
[0m11:21:43.165145 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:21:43.165863 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.166800 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m11:21:43.167678 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m11:21:43.168150 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.177796 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.179492 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 11:21:43.168372 => 11:21:43.179023
[0m11:21:43.180259 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.184800 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.186204 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.186671 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m11:21:43.187105 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:21:43.442053 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.442916 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:21:43.443432 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:21:43.476878 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:21:43.478888 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 11:21:43.180750 => 11:21:43.478609
[0m11:21:43.479297 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m11:21:43.511571 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m11:21:43.513311 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.35s]
[0m11:21:43.513944 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:21:43.515114 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:43.515429 [debug] [MainThread]: On master: BEGIN
[0m11:21:43.515647 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m11:21:43.895913 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:21:43.897646 [debug] [MainThread]: On master: COMMIT
[0m11:21:43.898953 [debug] [MainThread]: Using postgres connection "master"
[0m11:21:43.900066 [debug] [MainThread]: On master: COMMIT
[0m11:21:43.974558 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:21:43.976002 [debug] [MainThread]: On master: Close
[0m11:21:43.978805 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:21:43.979901 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m11:21:43.980353 [info ] [MainThread]: 
[0m11:21:43.980702 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 48.93 seconds (48.93s).
[0m11:21:43.987168 [debug] [MainThread]: Command end result
[0m11:21:44.006323 [info ] [MainThread]: 
[0m11:21:44.006713 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m11:21:44.006922 [info ] [MainThread]: 
[0m11:21:44.007132 [error] [MainThread]:   Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "date_cet" does not exist
  LINE 42:     date_cet, 
               ^
  HINT:  There is a column named "date_cet" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m11:21:44.007349 [info ] [MainThread]: 
[0m11:21:44.007556 [info ] [MainThread]: Done. PASS=20 WARN=0 ERROR=1 SKIP=0 TOTAL=21
[0m11:21:44.010697 [debug] [MainThread]: Resource report: {"command_name": "build", "command_wall_clock_time": 49.12375, "process_user_time": 2.297957, "process_kernel_time": 0.233555, "process_mem_max_rss": "125042688", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m11:21:44.011134 [debug] [MainThread]: Command `dbt build` failed at 11:21:44.011049 after 49.12 seconds
[0m11:21:44.011398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100851f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1007c8dd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1007c8f50>]}
[0m11:21:44.011649 [debug] [MainThread]: Flushing usage events
[0m11:30:24.901194 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092ab650>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109322590>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109322c50>]}


============================== 11:30:24.902938 | b1fcdff9-6831-4985-a81f-1e6ecd8fea08 ==============================
[0m11:30:24.902938 [info ] [MainThread]: Running with dbt=1.7.0
[0m11:30:24.903266 [debug] [MainThread]: running dbt with arguments {'quiet': 'False', 'no_print': 'None', 'printer_width': '80', 'debug': 'False', 'version_check': 'True', 'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'target_path': 'None', 'use_experimental_parser': 'False', 'partial_parse': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'log_format': 'default', 'use_colors': 'True', 'introspect': 'True', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'indirect_selection': 'eager', 'static_parser': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt build', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])'}
[0m11:30:24.975447 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092fdb90>]}
[0m11:30:25.006028 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092f97d0>]}
[0m11:30:25.006584 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m11:30:25.014072 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m11:30:25.037741 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m11:30:25.038074 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m11:30:25.038708 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m11:30:25.041500 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10984b5d0>]}
[0m11:30:25.047509 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10998fd50>]}
[0m11:30:25.047774 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m11:30:25.048949 [info ] [MainThread]: 
[0m11:30:25.049327 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m11:30:25.050086 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m11:30:25.054801 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m11:30:25.055019 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m11:30:25.055184 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m11:30:25.455357 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m11:30:25.457538 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m11:30:25.460299 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m11:30:25.468200 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:30:25.468760 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m11:30:25.469224 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m11:30:25.747245 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m11:30:25.749131 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m11:30:25.750542 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m11:30:25.788991 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m11:30:25.792397 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m11:30:25.825949 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m11:30:25.838717 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:25.839313 [debug] [MainThread]: On master: BEGIN
[0m11:30:25.839787 [debug] [MainThread]: Opening a new connection, currently in state init
[0m11:30:26.194525 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.195166 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.195724 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m11:30:26.242832 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m11:30:26.248921 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109893890>]}
[0m11:30:26.249778 [debug] [MainThread]: On master: ROLLBACK
[0m11:30:26.286646 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.287869 [debug] [MainThread]: On master: BEGIN
[0m11:30:26.363375 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.364291 [debug] [MainThread]: On master: COMMIT
[0m11:30:26.364825 [debug] [MainThread]: Using postgres connection "master"
[0m11:30:26.365262 [debug] [MainThread]: On master: COMMIT
[0m11:30:26.403830 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:30:26.404298 [debug] [MainThread]: On master: Close
[0m11:30:26.405042 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m11:30:26.405336 [info ] [MainThread]: 
[0m11:30:26.407339 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.407759 [info ] [Thread-1 (]: 1 of 21 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m11:30:26.408257 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m11:30:26.408542 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.415498 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.416209 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 11:30:26.408712 => 11:30:26.416047
[0m11:30:26.416467 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m11:30:26.437005 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.437687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.437932 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m11:30:26.438132 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:26.790877 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:26.792839 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:26.795623 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m11:30:45.542820 [debug] [Thread-1 (]: SQL status: SELECT 2107 in 19.0 seconds
[0m11:30:45.557429 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.558312 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m11:30:45.601894 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:45.608472 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.609184 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m11:30:45.653595 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:45.682131 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:30:45.682817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.683289 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m11:30:45.726983 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:45.740036 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m11:30:45.745927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m11:30:45.746518 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m11:30:45.802559 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:45.806574 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 11:30:26.416621 => 11:30:45.806306
[0m11:30:45.807444 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m11:30:45.810263 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10998dc10>]}
[0m11:30:45.811361 [info ] [Thread-1 (]: 1 of 21 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2107[0m in 19.40s]
[0m11:30:45.812573 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m11:30:45.813193 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m11:30:45.814437 [info ] [Thread-1 (]: 2 of 21 START sql table model danila.campaign_dim .............................. [RUN]
[0m11:30:45.815433 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m11:30:45.816734 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m11:30:45.822879 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m11:30:45.825118 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 11:30:45.817327 => 11:30:45.824775
[0m11:30:45.825723 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m11:30:45.831688 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m11:30:45.832504 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:45.832914 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m11:30:45.833328 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:46.117879 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:46.118757 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.119240 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:30:46.167864 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:30:46.175396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.176327 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m11:30:46.207038 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.216789 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.217736 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m11:30:46.249057 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.253016 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:30:46.254058 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.255307 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m11:30:46.287039 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:46.294812 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m11:30:46.297001 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m11:30:46.298180 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m11:30:46.347771 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:46.352369 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 11:30:45.826076 => 11:30:46.352114
[0m11:30:46.353224 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m11:30:46.355346 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bc3fd0>]}
[0m11:30:46.357201 [info ] [Thread-1 (]: 2 of 21 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.54s]
[0m11:30:46.358682 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m11:30:46.359765 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.360421 [info ] [Thread-1 (]: 3 of 21 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m11:30:46.361310 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m11:30:46.361784 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.367835 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.369477 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 11:30:46.362183 => 11:30:46.369069
[0m11:30:46.370104 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.376765 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.377990 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.378391 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m11:30:46.378741 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:46.701840 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:46.702540 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.703175 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m11:30:46.763134 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m11:30:46.772061 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.773537 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m11:30:46.814934 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.823149 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.824460 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m11:30:46.865064 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:46.867239 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:30:46.867597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.867879 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m11:30:46.906193 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:46.908745 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m11:30:46.909429 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m11:30:46.909721 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m11:30:46.967184 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:46.969533 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 11:30:46.370412 => 11:30:46.969271
[0m11:30:46.970071 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m11:30:46.971342 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bda4d0>]}
[0m11:30:46.972110 [info ] [Thread-1 (]: 3 of 21 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.61s]
[0m11:30:46.972814 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m11:30:46.973357 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m11:30:46.974253 [info ] [Thread-1 (]: 4 of 21 START sql table model danila.deals_dim ................................. [RUN]
[0m11:30:46.975253 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m11:30:46.975650 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m11:30:46.978663 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m11:30:46.979821 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 11:30:46.975906 => 11:30:46.979533
[0m11:30:46.980336 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m11:30:46.984716 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m11:30:46.985356 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:46.985673 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m11:30:46.985944 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:47.260606 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:47.261785 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.262751 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m11:30:47.305176 [debug] [Thread-1 (]: SQL status: SELECT 164 in 0.0 seconds
[0m11:30:47.313955 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.315339 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m11:30:47.349788 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.357602 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.358730 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m11:30:47.393289 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.399046 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:30:47.400179 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.401247 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m11:30:47.434846 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:47.442219 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m11:30:47.443869 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m11:30:47.444350 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m11:30:47.499510 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:47.502670 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 11:30:46.980624 => 11:30:47.502375
[0m11:30:47.503542 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m11:30:47.506516 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b80810>]}
[0m11:30:47.508103 [info ] [Thread-1 (]: 4 of 21 OK created sql table model danila.deals_dim ............................ [[32mSELECT 164[0m in 0.53s]
[0m11:30:47.509821 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m11:30:47.510432 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.511176 [info ] [Thread-1 (]: 5 of 21 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m11:30:47.513012 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m11:30:47.514364 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.525667 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.527796 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 11:30:47.515279 => 11:30:47.527227
[0m11:30:47.528667 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m11:30:47.535655 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.537038 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.537465 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m11:30:47.537813 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:47.792417 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:47.793673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.794108 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m11:30:47.827474 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:30:47.836424 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.837483 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m11:30:47.869621 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.877779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.879091 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m11:30:47.911637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:47.918702 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:30:47.919378 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.919737 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m11:30:47.950788 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:47.958509 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m11:30:47.960739 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m11:30:47.961300 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m11:30:48.009617 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:48.013115 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 11:30:47.528979 => 11:30:48.012320
[0m11:30:48.014544 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m11:30:48.016932 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a73810>]}
[0m11:30:48.018628 [info ] [Thread-1 (]: 5 of 21 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.50s]
[0m11:30:48.019589 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m11:30:48.020170 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.021597 [info ] [Thread-1 (]: 6 of 21 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m11:30:48.023290 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m11:30:48.024236 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.033373 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.035939 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 11:30:48.024763 => 11:30:48.035200
[0m11:30:48.036788 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:48.041983 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.042854 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.043149 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m11:30:48.043424 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:48.296475 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:48.298300 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:48.299878 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m11:30:55.447370 [debug] [Thread-1 (]: SQL status: SELECT 143172 in 7.0 seconds
[0m11:30:55.453915 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.454977 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m11:30:55.488711 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:55.494415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.495830 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m11:30:55.527849 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:55.535056 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:30:55.536437 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.537663 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m11:30:55.569143 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:55.578355 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m11:30:55.580707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m11:30:55.581711 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m11:30:55.629274 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:55.631571 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 11:30:48.037251 => 11:30:55.631264
[0m11:30:55.632236 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m11:30:55.633930 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c11b50>]}
[0m11:30:55.634999 [info ] [Thread-1 (]: 6 of 21 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143172[0m in 7.61s]
[0m11:30:55.635941 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m11:30:55.636669 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.637532 [info ] [Thread-1 (]: 7 of 21 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m11:30:55.638684 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m11:30:55.639325 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.644248 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.646273 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 11:30:55.639734 => 11:30:55.645884
[0m11:30:55.646887 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:55.653927 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.655384 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:55.655795 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m11:30:55.656277 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:56.002756 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:56.004687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.006139 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m11:30:56.051680 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:30:56.069689 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.070739 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m11:30:56.113019 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.123060 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.124511 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m11:30:56.168339 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.175787 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:30:56.177212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.178585 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m11:30:56.222271 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:56.228597 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m11:30:56.229700 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m11:30:56.230182 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m11:30:56.288189 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:56.292839 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 11:30:55.647151 => 11:30:56.292071
[0m11:30:56.294383 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m11:30:56.297612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b77610>]}
[0m11:30:56.299661 [info ] [Thread-1 (]: 7 of 21 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.66s]
[0m11:30:56.301767 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m11:30:56.303420 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.305274 [info ] [Thread-1 (]: 8 of 21 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m11:30:56.307253 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m11:30:56.308364 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.314912 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.316761 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 11:30:56.309067 => 11:30:56.316338
[0m11:30:56.317758 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.325000 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.326480 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.327029 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m11:30:56.327521 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:56.671495 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:56.673501 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.675024 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m11:30:56.718381 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m11:30:56.730579 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.731396 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:30:56.768409 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.778965 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.779989 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.816963 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:30:56.822074 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:30:56.822856 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.823545 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m11:30:56.860711 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:30:56.863705 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m11:30:56.864556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m11:30:56.864918 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m11:30:56.922471 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:30:56.923787 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 11:30:56.318236 => 11:30:56.923590
[0m11:30:56.924154 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m11:30:56.924947 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10999c9d0>]}
[0m11:30:56.925459 [info ] [Thread-1 (]: 8 of 21 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.62s]
[0m11:30:56.925988 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m11:30:56.926394 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.926920 [info ] [Thread-1 (]: 9 of 21 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m11:30:56.927626 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m11:30:56.928007 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.931070 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.932492 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 11:30:56.928232 => 11:30:56.932310
[0m11:30:56.932802 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:30:56.935922 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.936756 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:56.937030 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m11:30:56.937281 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:30:57.239043 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:30:57.241037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:30:57.241970 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as betting_type,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
group by campaign_name, campaignname, date_cet, brand_name, country_code, betting_type
  );
  
[0m11:31:01.860383 [debug] [Thread-1 (]: SQL status: SELECT 37355 in 5.0 seconds
[0m11:31:01.864490 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.864983 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:31:01.901335 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:01.903204 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.903449 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m11:31:01.939796 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:01.941380 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:31:01.941688 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.941968 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m11:31:01.977869 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:01.982967 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m11:31:01.983859 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m11:31:01.984260 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m11:31:02.036457 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:02.039930 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 11:30:56.932981 => 11:31:02.039486
[0m11:31:02.040773 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m11:31:02.042501 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c308a10>]}
[0m11:31:02.043675 [info ] [Thread-1 (]: 9 of 21 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37355[0m in 5.11s]
[0m11:31:02.044750 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m11:31:02.045590 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.046596 [info ] [Thread-1 (]: 10 of 21 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m11:31:02.047687 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m11:31:02.048212 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.096048 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.096690 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 11:31:02.048527 => 11:31:02.096544
[0m11:31:02.096934 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m11:31:02.099515 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.099940 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.100168 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m11:31:02.100383 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:02.399538 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:02.401514 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:02.403304 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m11:31:05.333968 [debug] [Thread-1 (]: SQL status: SELECT 114590 in 3.0 seconds
[0m11:31:05.346160 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.347704 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m11:31:05.380622 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:05.390896 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.392048 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m11:31:05.423618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:05.432179 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:31:05.433686 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.435056 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m11:31:05.467637 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:05.475779 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m11:31:05.478074 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m11:31:05.478903 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m11:31:05.527269 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:05.531997 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 11:31:02.097076 => 11:31:05.531714
[0m11:31:05.532627 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m11:31:05.534129 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c1f610>]}
[0m11:31:05.536152 [info ] [Thread-1 (]: 10 of 21 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114590[0m in 3.49s]
[0m11:31:05.538151 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m11:31:05.539721 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.541623 [info ] [Thread-1 (]: 11 of 21 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m11:31:05.544026 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m11:31:05.545154 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.551802 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.553206 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 11:31:05.545830 => 11:31:05.552803
[0m11:31:05.553858 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:05.559821 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.560677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.561101 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m11:31:05.561496 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:05.865705 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:05.867527 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.869357 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m11:31:05.951562 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m11:31:05.964036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:05.965584 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:31:06.004109 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.014153 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.015716 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m11:31:06.053859 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.061762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:31:06.063234 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.064612 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m11:31:06.102128 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:06.110820 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m11:31:06.114203 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m11:31:06.115621 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m11:31:06.171203 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:06.176394 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 11:31:05.554221 => 11:31:06.175626
[0m11:31:06.177874 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m11:31:06.180707 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109c41ed0>]}
[0m11:31:06.182660 [info ] [Thread-1 (]: 11 of 21 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.64s]
[0m11:31:06.184585 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m11:31:06.185778 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m11:31:06.186977 [info ] [Thread-1 (]: 12 of 21 START sql table model danila.test_write ............................... [RUN]
[0m11:31:06.188806 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m11:31:06.189607 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m11:31:06.195054 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m11:31:06.196335 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 11:31:06.190106 => 11:31:06.195937
[0m11:31:06.197006 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m11:31:06.205885 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m11:31:06.206703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.207038 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m11:31:06.207314 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:06.481992 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:06.484130 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.485870 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m11:31:06.522761 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:06.535191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.536657 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m11:31:06.571084 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.581452 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.582861 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m11:31:06.616809 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:06.624086 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:31:06.625486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.626699 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m11:31:06.660653 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:06.669769 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m11:31:06.672906 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m11:31:06.674275 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m11:31:06.725665 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:06.730673 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 11:31:06.197369 => 11:31:06.729925
[0m11:31:06.732133 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m11:31:06.735218 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a61f50>]}
[0m11:31:06.736223 [info ] [Thread-1 (]: 12 of 21 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.55s]
[0m11:31:06.738128 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m11:31:06.739505 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m11:31:06.740700 [info ] [Thread-1 (]: 13 of 21 START sql table model danila.outclicks_fct ............................ [RUN]
[0m11:31:06.742639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m11:31:06.743699 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m11:31:06.750101 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.752481 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 11:31:06.744393 => 11:31:06.751946
[0m11:31:06.753143 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m11:31:06.758726 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.760046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:06.760590 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m11:31:06.760966 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:07.118257 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:07.120129 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.121690 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m11:31:07.388068 [debug] [Thread-1 (]: SQL status: SELECT 54842 in 0.0 seconds
[0m11:31:07.399964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.401372 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m11:31:07.441211 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:07.451746 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.453206 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m11:31:07.493853 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:07.501307 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:31:07.502707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.504037 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m11:31:07.544840 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:07.553756 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m11:31:07.556784 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m11:31:07.558105 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m11:31:07.619110 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:07.623785 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 11:31:06.753444 => 11:31:07.623015
[0m11:31:07.625261 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m11:31:07.628614 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a61350>]}
[0m11:31:07.630618 [info ] [Thread-1 (]: 13 of 21 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 54842[0m in 0.89s]
[0m11:31:07.632683 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m11:31:07.634169 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.635641 [info ] [Thread-1 (]: 14 of 21 START test not_null_my_first_dbt_model_id ............................. [RUN]
[0m11:31:07.637406 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m11:31:07.638300 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.654293 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.657099 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 11:31:07.638783 => 11:31:07.656563
[0m11:31:07.657752 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:07.672162 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.672868 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.673215 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: BEGIN
[0m11:31:07.673535 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:07.926305 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:07.928131 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m11:31:07.929635 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:31:07.962768 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:07.970432 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 11:31:07.658073 => 11:31:07.969620
[0m11:31:07.970952 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: ROLLBACK
[0m11:31:08.001578 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710: Close
[0m11:31:08.004879 [info ] [Thread-1 (]: 14 of 21 PASS not_null_my_first_dbt_model_id ................................... [[32mPASS[0m in 0.37s]
[0m11:31:08.006942 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m11:31:08.008432 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.009976 [info ] [Thread-1 (]: 15 of 21 START test unique_my_first_dbt_model_id ............................... [RUN]
[0m11:31:08.011802 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m11:31:08.012792 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.026253 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.027325 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 11:31:08.013401 => 11:31:08.027055
[0m11:31:08.027795 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.030346 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.030897 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.031100 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: BEGIN
[0m11:31:08.031276 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:08.284707 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.287151 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m11:31:08.289368 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_first_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:31:08.321990 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:08.324919 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 11:31:08.028101 => 11:31:08.324428
[0m11:31:08.325515 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: ROLLBACK
[0m11:31:08.356131 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321: Close
[0m11:31:08.357798 [info ] [Thread-1 (]: 15 of 21 PASS unique_my_first_dbt_model_id ..................................... [[32mPASS[0m in 0.35s]
[0m11:31:08.358710 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m11:31:08.359463 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.360438 [info ] [Thread-1 (]: 16 of 21 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m11:31:08.361489 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m11:31:08.362037 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.368326 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.369815 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 11:31:08.362308 => 11:31:08.369420
[0m11:31:08.370726 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:08.379082 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.380401 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.380906 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m11:31:08.381310 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:08.707437 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:08.709462 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:08.711268 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        betting_type,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    betting_type, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
  );
  
[0m11:31:09.066650 [debug] [Thread-1 (]: SQL status: SELECT 151945 in 0.0 seconds
[0m11:31:09.076242 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.077112 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m11:31:09.117176 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.128194 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.129382 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m11:31:09.169561 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.177995 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m11:31:09.179247 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.180303 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m11:31:09.220278 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:09.230537 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m11:31:09.233647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m11:31:09.234962 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m11:31:09.294863 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:09.300118 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 11:31:08.371410 => 11:31:09.299491
[0m11:31:09.301226 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m11:31:09.302676 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bc26d0>]}
[0m11:31:09.303599 [info ] [Thread-1 (]: 16 of 21 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 151945[0m in 0.94s]
[0m11:31:09.304896 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m11:31:09.306253 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.307437 [info ] [Thread-1 (]: 17 of 21 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m11:31:09.309250 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m11:31:09.310479 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.318773 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.321378 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 11:31:09.311251 => 11:31:09.320842
[0m11:31:09.322226 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.329804 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.331110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.331614 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m11:31:09.332091 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:09.633037 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:09.635049 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.636817 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        betting_type,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        betting_type,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m11:31:09.755503 [debug] [Thread-1 (]: SQL status: SELECT 45422 in 0.0 seconds
[0m11:31:09.768496 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.769772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m11:31:09.806732 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.817268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.818376 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m11:31:09.855352 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:09.864119 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:31:09.865381 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.866357 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m11:31:09.903095 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:09.912951 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m11:31:09.916064 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m11:31:09.917418 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m11:31:09.974165 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:09.978944 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 11:31:09.322648 => 11:31:09.978181
[0m11:31:09.980364 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m11:31:09.983464 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097e3510>]}
[0m11:31:09.985448 [info ] [Thread-1 (]: 17 of 21 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45422[0m in 0.67s]
[0m11:31:09.987100 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m11:31:09.988220 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m11:31:09.989524 [info ] [Thread-1 (]: 18 of 21 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m11:31:09.991270 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m11:31:09.992295 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m11:31:09.999110 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.000597 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 11:31:09.992986 => 11:31:10.000288
[0m11:31:10.001209 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m11:31:10.010741 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.012518 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.013088 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m11:31:10.013558 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:10.337283 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:10.338212 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.338832 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m11:31:10.407375 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m11:31:10.419077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.420138 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m11:31:10.460313 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:10.471410 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.472700 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m11:31:10.513348 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:10.522176 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:31:10.523695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.525023 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m11:31:10.564725 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:10.573756 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m11:31:10.576188 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m11:31:10.577306 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m11:31:10.635080 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m11:31:10.638841 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 11:31:10.001632 => 11:31:10.638394
[0m11:31:10.639741 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m11:31:10.642156 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099b1510>]}
[0m11:31:10.643762 [info ] [Thread-1 (]: 18 of 21 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.65s]
[0m11:31:10.644995 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m11:31:10.645950 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.647111 [info ] [Thread-1 (]: 19 of 21 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m11:31:10.648614 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now model.campaign_perfomance.my_second_dbt_model)
[0m11:31:10.649447 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.654879 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.656509 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 11:31:10.649931 => 11:31:10.656185
[0m11:31:10.657018 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m11:31:10.678664 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.679365 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.679689 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m11:31:10.679975 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:10.933729 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:10.935421 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.936912 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m11:31:10.971280 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m11:31:10.983224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:10.984676 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m11:31:11.016750 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m11:31:11.022241 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:31:11.023578 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:11.024837 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m11:31:11.056184 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m11:31:11.064955 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m11:31:11.071225 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m11:31:11.072166 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m11:31:11.103565 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m11:31:11.108120 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 11:31:10.657321 => 11:31:11.107574
[0m11:31:11.109259 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m11:31:11.111154 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b1fcdff9-6831-4985-a81f-1e6ecd8fea08', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a73790>]}
[0m11:31:11.112208 [info ] [Thread-1 (]: 19 of 21 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.46s]
[0m11:31:11.112872 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m11:31:11.114155 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.114734 [info ] [Thread-1 (]: 20 of 21 START test not_null_my_second_dbt_model_id ............................ [RUN]
[0m11:31:11.115546 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m11:31:11.115985 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.122639 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.125330 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 11:31:11.116225 => 11:31:11.124783
[0m11:31:11.126497 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.130800 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.131986 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.132468 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: BEGIN
[0m11:31:11.132929 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:11.385316 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:11.386945 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m11:31:11.388424 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    



select id
from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is null



      
    ) dbt_internal_test
[0m11:31:11.421135 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:11.423442 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 11:31:11.127100 => 11:31:11.423114
[0m11:31:11.424042 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: ROLLBACK
[0m11:31:11.454448 [debug] [Thread-1 (]: On test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778: Close
[0m11:31:11.456809 [info ] [Thread-1 (]: 20 of 21 PASS not_null_my_second_dbt_model_id .................................. [[32mPASS[0m in 0.34s]
[0m11:31:11.457929 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m11:31:11.458772 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.459585 [info ] [Thread-1 (]: 21 of 21 START test unique_my_second_dbt_model_id .............................. [RUN]
[0m11:31:11.460592 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m11:31:11.461125 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.471920 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.474317 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 11:31:11.461488 => 11:31:11.473748
[0m11:31:11.475204 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.479387 [debug] [Thread-1 (]: Writing runtime sql for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.480808 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.481316 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: BEGIN
[0m11:31:11.481723 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m11:31:11.786839 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m11:31:11.787944 [debug] [Thread-1 (]: Using postgres connection "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m11:31:11.788515 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"} */
select
      count(*) as failures,
      count(*) != 0 as should_warn,
      count(*) != 0 as should_error
    from (
      
    
    

select
    id as unique_field,
    count(*) as n_records

from "deep-analysis-console"."danila"."my_second_dbt_model"
where id is not null
group by id
having count(*) > 1



      
    ) dbt_internal_test
[0m11:31:11.827135 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m11:31:11.831085 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 11:31:11.475702 => 11:31:11.830547
[0m11:31:11.831971 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: ROLLBACK
[0m11:31:11.869392 [debug] [Thread-1 (]: On test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493: Close
[0m11:31:11.871042 [info ] [Thread-1 (]: 21 of 21 PASS unique_my_second_dbt_model_id .................................... [[32mPASS[0m in 0.41s]
[0m11:31:11.871774 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m11:31:11.873448 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:11.873916 [debug] [MainThread]: On master: BEGIN
[0m11:31:11.874259 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m11:31:12.177258 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m11:31:12.178658 [debug] [MainThread]: On master: COMMIT
[0m11:31:12.179490 [debug] [MainThread]: Using postgres connection "master"
[0m11:31:12.180105 [debug] [MainThread]: On master: COMMIT
[0m11:31:12.216685 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m11:31:12.217325 [debug] [MainThread]: On master: Close
[0m11:31:12.218633 [debug] [MainThread]: Connection 'master' was properly closed.
[0m11:31:12.219049 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m11:31:12.219630 [info ] [MainThread]: 
[0m11:31:12.220125 [info ] [MainThread]: Finished running 16 table models, 4 tests, 1 view model in 0 hours 0 minutes and 47.17 seconds (47.17s).
[0m11:31:12.227325 [debug] [MainThread]: Command end result
[0m11:31:12.247049 [info ] [MainThread]: 
[0m11:31:12.247809 [info ] [MainThread]: [32mCompleted successfully[0m
[0m11:31:12.248276 [info ] [MainThread]: 
[0m11:31:12.248724 [info ] [MainThread]: Done. PASS=21 WARN=0 ERROR=0 SKIP=0 TOTAL=21
[0m11:31:12.252377 [debug] [MainThread]: Resource report: {"command_name": "build", "command_success": true, "command_wall_clock_time": 47.374134, "process_user_time": 2.58209, "process_kernel_time": 0.240323, "process_mem_max_rss": "123699200", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m11:31:12.253202 [debug] [MainThread]: Command `dbt build` succeeded at 11:31:12.253025 after 47.38 seconds
[0m11:31:12.253769 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108ceefd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c2ded0>]}
[0m11:31:12.254236 [debug] [MainThread]: Flushing usage events
[0m14:47:58.059630 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f9310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10754db50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106f3f150>]}


============================== 14:47:58.061337 | 0a302beb-bee3-4e15-872d-01aedca2ce34 ==============================
[0m14:47:58.061337 [info ] [MainThread]: Running with dbt=1.7.0
[0m14:47:58.061746 [debug] [MainThread]: running dbt with arguments {'log_format': 'default', 'write_json': 'True', 'log_cache_events': 'False', 'use_experimental_parser': 'False', 'cache_selected_only': 'False', 'debug': 'False', 'quiet': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/danila/.dbt', 'warn_error': 'None', 'static_parser': 'True', 'introspect': 'True', 'target_path': 'None', 'printer_width': '80', 'use_colors': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'no_print': 'None', 'partial_parse': 'True', 'fail_fast': 'False', 'invocation_command': 'dbt docs generate', 'version_check': 'True', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True'}
[0m14:47:58.136005 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1074f9910>]}
[0m14:47:58.170679 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107548a90>]}
[0m14:47:58.171387 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m14:47:58.179172 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m14:47:58.194167 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m14:47:58.194421 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m14:47:58.195034 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m14:47:58.197988 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cb3a50>]}
[0m14:47:58.199964 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cdcb90>]}
[0m14:47:58.200211 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m14:47:58.200398 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac8d90>]}
[0m14:47:58.201565 [info ] [MainThread]: 
[0m14:47:58.201957 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m14:47:58.202686 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console_danila'
[0m14:47:58.207961 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m14:47:58.208217 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m14:47:58.208377 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:58.589170 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:47:58.590270 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m14:47:58.591336 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m14:47:58.627664 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m14:47:58.631512 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m14:47:58.663544 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m14:47:58.677515 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:58.677972 [debug] [MainThread]: On master: BEGIN
[0m14:47:58.678291 [debug] [MainThread]: Opening a new connection, currently in state init
[0m14:47:58.934064 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m14:47:58.935350 [debug] [MainThread]: Using postgres connection "master"
[0m14:47:58.936213 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m14:47:58.983537 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m14:47:58.986842 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '0a302beb-bee3-4e15-872d-01aedca2ce34', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107ac8d90>]}
[0m14:47:58.987846 [debug] [MainThread]: On master: ROLLBACK
[0m14:47:59.020292 [debug] [MainThread]: On master: Close
[0m14:47:59.022791 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m14:47:59.023283 [info ] [MainThread]: 
[0m14:47:59.027663 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m14:47:59.029191 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m14:47:59.030051 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m14:47:59.040423 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m14:47:59.040947 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 14:47:59.030489 => 14:47:59.040836
[0m14:47:59.041123 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m14:47:59.041357 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 14:47:59.041224 => 14:47:59.041233
[0m14:47:59.041811 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m14:47:59.042024 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m14:47:59.042453 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m14:47:59.042685 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m14:47:59.044127 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m14:47:59.044569 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 14:47:59.042821 => 14:47:59.044452
[0m14:47:59.044747 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m14:47:59.044948 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 14:47:59.044852 => 14:47:59.044857
[0m14:47:59.045320 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m14:47:59.045494 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m14:47:59.045968 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m14:47:59.046131 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m14:47:59.047879 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m14:47:59.048264 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 14:47:59.046233 => 14:47:59.048160
[0m14:47:59.048432 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m14:47:59.048613 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 14:47:59.048529 => 14:47:59.048533
[0m14:47:59.048956 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m14:47:59.049126 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m14:47:59.049414 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m14:47:59.049575 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m14:47:59.051024 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m14:47:59.051354 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 14:47:59.049678 => 14:47:59.051263
[0m14:47:59.051509 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m14:47:59.051700 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 14:47:59.051604 => 14:47:59.051607
[0m14:47:59.052030 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m14:47:59.052282 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m14:47:59.052637 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m14:47:59.052807 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m14:47:59.055130 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m14:47:59.055458 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 14:47:59.052912 => 14:47:59.055369
[0m14:47:59.055612 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m14:47:59.055806 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 14:47:59.055709 => 14:47:59.055712
[0m14:47:59.056259 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m14:47:59.056446 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m14:47:59.056775 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m14:47:59.056990 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m14:47:59.059159 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m14:47:59.059596 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 14:47:59.057090 => 14:47:59.059499
[0m14:47:59.059765 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m14:47:59.059958 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 14:47:59.059866 => 14:47:59.059870
[0m14:47:59.060321 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m14:47:59.060509 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m14:47:59.060793 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m14:47:59.060955 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m14:47:59.062279 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m14:47:59.062601 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 14:47:59.061050 => 14:47:59.062472
[0m14:47:59.062823 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m14:47:59.063014 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 14:47:59.062924 => 14:47:59.062926
[0m14:47:59.063364 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m14:47:59.063552 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m14:47:59.063852 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m14:47:59.064020 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m14:47:59.065147 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m14:47:59.065446 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 14:47:59.064120 => 14:47:59.065348
[0m14:47:59.065612 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m14:47:59.066013 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 14:47:59.065721 => 14:47:59.065726
[0m14:47:59.066489 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m14:47:59.066682 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m14:47:59.066997 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m14:47:59.067191 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m14:47:59.068604 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m14:47:59.068928 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 14:47:59.067302 => 14:47:59.068835
[0m14:47:59.069095 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m14:47:59.069285 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 14:47:59.069195 => 14:47:59.069197
[0m14:47:59.069650 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m14:47:59.069836 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m14:47:59.070118 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m14:47:59.070289 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m14:47:59.071867 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m14:47:59.072172 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 14:47:59.070388 => 14:47:59.072080
[0m14:47:59.072335 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m14:47:59.072520 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 14:47:59.072434 => 14:47:59.072436
[0m14:47:59.072859 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m14:47:59.073041 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m14:47:59.073349 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m14:47:59.073548 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m14:47:59.075103 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m14:47:59.075833 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 14:47:59.073682 => 14:47:59.075630
[0m14:47:59.076071 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m14:47:59.076295 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 14:47:59.076191 => 14:47:59.076194
[0m14:47:59.076746 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m14:47:59.076961 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m14:47:59.077314 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m14:47:59.077489 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m14:47:59.078844 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m14:47:59.079211 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 14:47:59.077598 => 14:47:59.079114
[0m14:47:59.079375 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m14:47:59.079563 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 14:47:59.079474 => 14:47:59.079477
[0m14:47:59.079932 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m14:47:59.080120 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m14:47:59.080399 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m14:47:59.080558 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m14:47:59.081970 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m14:47:59.082285 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 14:47:59.080659 => 14:47:59.082191
[0m14:47:59.082446 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m14:47:59.082632 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 14:47:59.082545 => 14:47:59.082547
[0m14:47:59.082976 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m14:47:59.083162 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m14:47:59.083470 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m14:47:59.083631 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m14:47:59.084967 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m14:47:59.085422 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 14:47:59.083733 => 14:47:59.085320
[0m14:47:59.085593 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m14:47:59.085781 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 14:47:59.085695 => 14:47:59.085698
[0m14:47:59.086123 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m14:47:59.086309 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m14:47:59.086631 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710)
[0m14:47:59.086822 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m14:47:59.092013 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710"
[0m14:47:59.092459 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (compile): 14:47:59.086940 => 14:47:59.092354
[0m14:47:59.092666 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m14:47:59.092879 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710 (execute): 14:47:59.092779 => 14:47:59.092786
[0m14:47:59.093277 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710
[0m14:47:59.093475 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m14:47:59.093768 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_first_dbt_model_id.5fb22c2710, now test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321)
[0m14:47:59.093928 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m14:47:59.096702 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321"
[0m14:47:59.097036 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (compile): 14:47:59.094038 => 14:47:59.096942
[0m14:47:59.097208 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m14:47:59.097402 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321 (execute): 14:47:59.097310 => 14:47:59.097312
[0m14:47:59.097752 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321
[0m14:47:59.097951 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m14:47:59.098228 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.unique_my_first_dbt_model_id.16e066b321, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m14:47:59.098392 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m14:47:59.100107 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m14:47:59.100476 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 14:47:59.098505 => 14:47:59.100379
[0m14:47:59.100644 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m14:47:59.100838 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 14:47:59.100746 => 14:47:59.100748
[0m14:47:59.101205 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m14:47:59.101391 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m14:47:59.101670 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m14:47:59.101832 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m14:47:59.104422 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m14:47:59.104727 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 14:47:59.101932 => 14:47:59.104635
[0m14:47:59.104886 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m14:47:59.105071 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 14:47:59.104982 => 14:47:59.104984
[0m14:47:59.105451 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m14:47:59.105658 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m14:47:59.105949 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m14:47:59.106116 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m14:47:59.107487 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m14:47:59.107822 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 14:47:59.106219 => 14:47:59.107729
[0m14:47:59.107986 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m14:47:59.108171 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 14:47:59.108085 => 14:47:59.108087
[0m14:47:59.108539 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m14:47:59.108743 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m14:47:59.109037 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_comparison_fi, now test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778)
[0m14:47:59.109201 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m14:47:59.110963 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778"
[0m14:47:59.111292 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (compile): 14:47:59.109311 => 14:47:59.111202
[0m14:47:59.111451 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m14:47:59.111635 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778 (execute): 14:47:59.111548 => 14:47:59.111550
[0m14:47:59.111973 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778
[0m14:47:59.112153 [debug] [Thread-1 (]: Began running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m14:47:59.112421 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly test.campaign_perfomance.not_null_my_second_dbt_model_id.151b76d778, now test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493)
[0m14:47:59.112583 [debug] [Thread-1 (]: Began compiling node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m14:47:59.114195 [debug] [Thread-1 (]: Writing injected SQL for node "test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493"
[0m14:47:59.114484 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (compile): 14:47:59.112683 => 14:47:59.114388
[0m14:47:59.114649 [debug] [Thread-1 (]: Began executing node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m14:47:59.114842 [debug] [Thread-1 (]: Timing info for test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493 (execute): 14:47:59.114751 => 14:47:59.114753
[0m14:47:59.115188 [debug] [Thread-1 (]: Finished running node test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493
[0m14:47:59.115658 [debug] [MainThread]: Connection 'master' was properly closed.
[0m14:47:59.115810 [debug] [MainThread]: Connection 'test.campaign_perfomance.unique_my_second_dbt_model_id.57a0f8c493' was properly closed.
[0m14:47:59.116987 [debug] [MainThread]: Command end result
[0m14:47:59.122877 [debug] [MainThread]: Acquiring new postgres connection 'generate_catalog'
[0m14:47:59.123054 [info ] [MainThread]: Building catalog
[0m14:47:59.124257 [debug] [ThreadPool]: Acquiring new postgres connection 'deep-analysis-console.information_schema'
[0m14:47:59.127687 [debug] [ThreadPool]: Using postgres connection "deep-analysis-console.information_schema"
[0m14:47:59.127891 [debug] [ThreadPool]: On deep-analysis-console.information_schema: BEGIN
[0m14:47:59.128028 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m14:47:59.473251 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m14:47:59.474511 [debug] [ThreadPool]: Using postgres connection "deep-analysis-console.information_schema"
[0m14:47:59.475659 [debug] [ThreadPool]: On deep-analysis-console.information_schema: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "deep-analysis-console.information_schema"} */

    
    

    select
        'deep-analysis-console' as table_database,
        sch.nspname as table_schema,
        tbl.relname as table_name,
        case tbl.relkind
            when 'v' then 'VIEW'
            when 'm' then 'MATERIALIZED VIEW'
            else 'BASE TABLE'
        end as table_type,
        tbl_desc.description as table_comment,
        col.attname as column_name,
        col.attnum as column_index,
        pg_catalog.format_type(col.atttypid, col.atttypmod) as column_type,
        col_desc.description as column_comment,
        pg_get_userbyid(tbl.relowner) as table_owner

    from pg_catalog.pg_namespace sch
    join pg_catalog.pg_class tbl on tbl.relnamespace = sch.oid
    join pg_catalog.pg_attribute col on col.attrelid = tbl.oid
    left outer join pg_catalog.pg_description tbl_desc on (tbl_desc.objoid = tbl.oid and tbl_desc.objsubid = 0)
    left outer join pg_catalog.pg_description col_desc on (col_desc.objoid = tbl.oid and col_desc.objsubid = col.attnum)
    where ((upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('brand_comparison_fi')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('outclick_cost_int_1')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('brand_performance_replacement')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('campaign_dim')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('test_write')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('outclicks_fct')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('stg_record__casino_events')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('stg_matomo_actions_visits__our_page_events')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('my_second_dbt_model')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('daily_campaign_fct')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('stg_campaign_names_mapping__traffic_sources')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('outclick_cost_int_new')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('my_first_dbt_model')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('stg_records_gam_campaign__campaign_costs')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('deals_dim')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('outclick_by_brand_int')) or (upper(sch.nspname) = upper('danila') and
           upper(tbl.relname) = upper('outclick_by_brand_int_new')))
      and not pg_is_other_temp_schema(sch.oid) -- not a temporary schema belonging to another session
      and tbl.relpersistence in ('p', 'u') -- [p]ermanent table or [u]nlogged table. Exclude [t]emporary tables
      and tbl.relkind in ('r', 'v', 'f', 'p', 'm') -- o[r]dinary table, [v]iew, [f]oreign table, [p]artitioned table, [m]aterialized view. Other values are [i]ndex, [S]equence, [c]omposite type, [t]OAST table
      and col.attnum > 0 -- negative numbers are used for system columns such as oid
      and not col.attisdropped -- column as not been dropped

    order by
        sch.nspname,
        tbl.relname,
        col.attnum
[0m14:47:59.570273 [debug] [ThreadPool]: SQL status: SELECT 132 in 0.0 seconds
[0m14:47:59.584963 [debug] [ThreadPool]: On deep-analysis-console.information_schema: ROLLBACK
[0m14:47:59.626153 [debug] [ThreadPool]: On deep-analysis-console.information_schema: Close
[0m14:47:59.648666 [info ] [MainThread]: Catalog written to /Users/danila/github/dbt/target/catalog.json
[0m14:47:59.654141 [debug] [MainThread]: Resource report: {"command_name": "generate", "command_success": true, "command_wall_clock_time": 1.6221031, "process_user_time": 1.083542, "process_kernel_time": 0.104079, "process_mem_max_rss": "125681664", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m14:47:59.654743 [debug] [MainThread]: Command `dbt docs generate` succeeded at 14:47:59.654684 after 1.62 seconds
[0m14:47:59.654933 [debug] [MainThread]: Connection 'generate_catalog' was properly closed.
[0m14:47:59.655111 [debug] [MainThread]: Connection 'deep-analysis-console.information_schema' was properly closed.
[0m14:47:59.655292 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102df4290>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d53810>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107adf250>]}
[0m14:47:59.655507 [debug] [MainThread]: Flushing usage events
[0m14:48:05.663325 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111109d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x111165350>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11118a610>]}


============================== 14:48:05.664600 | 6931a8e2-57bc-4b2e-a0a4-25239b25d3f2 ==============================
[0m14:48:05.664600 [info ] [MainThread]: Running with dbt=1.7.0
[0m14:48:05.664916 [debug] [MainThread]: running dbt with arguments {'warn_error': 'None', 'invocation_command': 'dbt docs serve', 'send_anonymous_usage_stats': 'True', 'quiet': 'False', 'indirect_selection': 'eager', 'log_format': 'default', 'use_colors': 'True', 'printer_width': '80', 'log_path': '/Users/danila/github/dbt/logs', 'no_print': 'None', 'profiles_dir': '/Users/danila/.dbt', 'cache_selected_only': 'False', 'version_check': 'True', 'debug': 'False', 'static_parser': 'True', 'log_cache_events': 'False', 'target_path': 'None', 'fail_fast': 'False', 'introspect': 'True', 'write_json': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'partial_parse': 'True', 'use_experimental_parser': 'False'}
[0m14:48:05.735493 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '6931a8e2-57bc-4b2e-a0a4-25239b25d3f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1115e16d0>]}
[0m14:48:05.769230 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '6931a8e2-57bc-4b2e-a0a4-25239b25d3f2', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1118f3150>]}
[0m16:59:10.368624 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10890be90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107622890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10897eb50>]}


============================== 16:59:10.370498 | 35d63774-e4ab-4563-9012-1ae0814f40f8 ==============================
[0m16:59:10.370498 [info ] [MainThread]: Running with dbt=1.7.0
[0m16:59:10.370845 [debug] [MainThread]: running dbt with arguments {'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'profiles_dir': '/Users/danila/.dbt', 'introspect': 'True', 'version_check': 'True', 'use_colors': 'True', 'warn_error': 'None', 'debug': 'False', 'partial_parse': 'True', 'cache_selected_only': 'False', 'quiet': 'False', 'write_json': 'True', 'use_experimental_parser': 'False', 'no_print': 'None', 'log_cache_events': 'False', 'static_parser': 'True', 'printer_width': '80', 'fail_fast': 'False', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'send_anonymous_usage_stats': 'True', 'target_path': 'None', 'log_path': '/Users/danila/github/dbt/logs', 'log_format': 'default'}
[0m16:59:10.437283 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109826990>]}
[0m16:59:10.467062 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10893f790>]}
[0m16:59:10.467788 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m16:59:10.475322 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m16:59:10.494155 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m16:59:10.494436 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m16:59:10.495017 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m16:59:10.497932 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a23910>]}
[0m16:59:10.503025 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109890ad0>]}
[0m16:59:10.503257 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m16:59:10.503444 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ab3f50>]}
[0m16:59:10.504508 [info ] [MainThread]: 
[0m16:59:10.504876 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m16:59:10.505571 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m16:59:10.509762 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m16:59:10.509948 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m16:59:10.510112 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m16:59:10.886218 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m16:59:10.890713 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m16:59:10.895622 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m16:59:10.904742 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m16:59:10.905297 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m16:59:10.905684 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m16:59:11.195912 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m16:59:11.197770 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m16:59:11.198848 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m16:59:11.416113 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m16:59:11.420664 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m16:59:11.453220 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m16:59:11.468719 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:11.469235 [debug] [MainThread]: On master: BEGIN
[0m16:59:11.469642 [debug] [MainThread]: Opening a new connection, currently in state init
[0m16:59:11.725238 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:59:11.726999 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:11.728160 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m16:59:11.769694 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m16:59:11.773591 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107622950>]}
[0m16:59:11.774248 [debug] [MainThread]: On master: ROLLBACK
[0m16:59:11.804352 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:11.804732 [debug] [MainThread]: On master: BEGIN
[0m16:59:11.865232 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:59:11.867058 [debug] [MainThread]: On master: COMMIT
[0m16:59:11.868427 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:11.869343 [debug] [MainThread]: On master: COMMIT
[0m16:59:11.900300 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:59:11.901902 [debug] [MainThread]: On master: Close
[0m16:59:11.904887 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m16:59:11.905711 [info ] [MainThread]: 
[0m16:59:11.911562 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m16:59:11.912616 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m16:59:11.913992 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m16:59:11.914675 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m16:59:11.926678 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:11.927538 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 16:59:11.915017 => 16:59:11.927300
[0m16:59:11.927934 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m16:59:11.952911 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:11.953451 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:11.953682 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m16:59:11.953896 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:12.226821 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:12.227463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:12.228319 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m16:59:36.360660 [debug] [Thread-1 (]: SQL status: SELECT 2108 in 24.0 seconds
[0m16:59:36.377340 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:36.378379 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m16:59:36.413206 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:36.423763 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:36.425065 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m16:59:36.459583 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:36.488366 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m16:59:36.489191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:36.489709 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m16:59:36.523066 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:36.530957 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m16:59:36.537276 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m16:59:36.537841 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m16:59:36.584987 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:36.589794 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 16:59:11.928147 => 16:59:36.589204
[0m16:59:36.590913 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m16:59:36.592746 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a21f90>]}
[0m16:59:36.594266 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2108[0m in 24.68s]
[0m16:59:36.595890 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m16:59:36.596913 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m16:59:36.597977 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m16:59:36.599527 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m16:59:36.600623 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m16:59:36.606289 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m16:59:36.607658 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 16:59:36.601061 => 16:59:36.607257
[0m16:59:36.608545 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m16:59:36.614216 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m16:59:36.614959 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:36.615193 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m16:59:36.615401 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:37.018394 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:37.019143 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:37.019589 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m16:59:37.076295 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m16:59:37.082724 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:37.083574 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m16:59:37.121580 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:37.132627 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:37.133657 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m16:59:37.171845 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:37.176140 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m16:59:37.177936 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:37.179216 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m16:59:37.217146 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:37.222701 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m16:59:37.224040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m16:59:37.224884 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m16:59:37.279275 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:37.283457 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 16:59:36.609053 => 16:59:37.283152
[0m16:59:37.284488 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m16:59:37.285998 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b65e90>]}
[0m16:59:37.286848 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.69s]
[0m16:59:37.287877 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m16:59:37.288638 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m16:59:37.289854 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m16:59:37.291621 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m16:59:37.292215 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m16:59:37.298960 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.300704 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 16:59:37.292609 => 16:59:37.300234
[0m16:59:37.301382 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m16:59:37.308814 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.309569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.309788 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m16:59:37.309975 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:37.567883 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:37.569023 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.569797 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m16:59:37.626246 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m16:59:37.630773 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.631308 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m16:59:37.662567 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:37.665040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.665297 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m16:59:37.695685 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:37.697223 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m16:59:37.697513 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.697789 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m16:59:37.728551 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:37.731168 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m16:59:37.732053 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m16:59:37.732454 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m16:59:37.785095 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:37.787772 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 16:59:37.301711 => 16:59:37.787377
[0m16:59:37.788574 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m16:59:37.790082 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b549d0>]}
[0m16:59:37.791142 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.50s]
[0m16:59:37.791974 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m16:59:37.792606 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m16:59:37.793302 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m16:59:37.794314 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m16:59:37.794839 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m16:59:37.799235 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m16:59:37.800925 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 16:59:37.795069 => 16:59:37.800277
[0m16:59:37.801619 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m16:59:37.807273 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m16:59:37.808524 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:37.808956 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m16:59:37.809322 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:38.065076 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:38.066158 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:38.067014 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m16:59:38.106319 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m16:59:38.111837 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:38.113530 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m16:59:38.145566 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:38.151074 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:38.151684 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m16:59:38.183860 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:38.187092 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m16:59:38.188283 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:38.188762 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m16:59:38.220527 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:38.225390 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m16:59:38.226729 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m16:59:38.227324 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m16:59:38.279188 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:38.281651 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 16:59:37.801967 => 16:59:38.281310
[0m16:59:38.282421 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m16:59:38.283725 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109acfc50>]}
[0m16:59:38.284518 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.49s]
[0m16:59:38.285338 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m16:59:38.286367 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m16:59:38.287646 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m16:59:38.289231 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m16:59:38.290017 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m16:59:38.297032 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.298716 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 16:59:38.290431 => 16:59:38.298175
[0m16:59:38.299463 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m16:59:38.305777 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.306442 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.306657 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m16:59:38.306862 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:38.632895 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:38.633556 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.633964 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m16:59:38.684921 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:59:38.690802 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.691598 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m16:59:38.737439 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:38.745080 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.745655 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m16:59:38.790108 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:38.796067 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m16:59:38.797046 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.797769 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m16:59:38.831547 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:38.838623 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m16:59:38.840371 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m16:59:38.840817 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m16:59:38.889452 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:38.894481 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 16:59:38.299904 => 16:59:38.893718
[0m16:59:38.895959 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m16:59:38.898064 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bcb410>]}
[0m16:59:38.899347 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.61s]
[0m16:59:38.900477 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m16:59:38.901510 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m16:59:38.903326 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m16:59:38.904735 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m16:59:38.905448 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m16:59:38.915092 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:38.916795 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 16:59:38.906001 => 16:59:38.916308
[0m16:59:38.917491 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m16:59:38.924825 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:38.925986 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:38.926358 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m16:59:38.926636 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:39.369750 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:39.371622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:39.373197 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m16:59:49.774561 [debug] [Thread-1 (]: SQL status: SELECT 143292 in 10.0 seconds
[0m16:59:49.782034 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:49.782953 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m16:59:49.822697 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:49.829124 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:49.829729 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m16:59:49.870050 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:49.876707 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m16:59:49.877758 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:49.879084 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m16:59:49.918957 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:49.926183 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m16:59:49.927263 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m16:59:49.928583 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m16:59:49.988031 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:49.991252 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 16:59:38.917841 => 16:59:49.990965
[0m16:59:49.991800 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m16:59:49.993256 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1099f8d50>]}
[0m16:59:49.994386 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143292[0m in 11.09s]
[0m16:59:49.995323 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m16:59:49.996107 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m16:59:49.996755 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m16:59:49.997748 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m16:59:49.998202 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m16:59:50.002091 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.003646 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 16:59:49.998475 => 16:59:50.003281
[0m16:59:50.004377 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m16:59:50.010750 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.012178 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.012813 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m16:59:50.013298 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:50.315819 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:50.316502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.316913 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m16:59:50.356527 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:59:50.365709 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.366358 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m16:59:50.403520 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:50.410023 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.411271 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m16:59:50.447806 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:50.453528 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m16:59:50.455131 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.456097 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m16:59:50.493020 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:50.500540 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m16:59:50.503681 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m16:59:50.504971 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m16:59:50.563476 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:50.566345 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 16:59:50.004702 => 16:59:50.566095
[0m16:59:50.567027 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m16:59:50.569948 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b64750>]}
[0m16:59:50.571843 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.57s]
[0m16:59:50.573391 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m16:59:50.574657 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m16:59:50.575705 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m16:59:50.576603 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m16:59:50.577543 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m16:59:50.584369 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:50.586183 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 16:59:50.578219 => 16:59:50.585719
[0m16:59:50.586927 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m16:59:50.594389 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:50.595892 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:50.596493 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m16:59:50.596920 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:50.998066 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:50.999968 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.000755 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m16:59:51.255488 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m16:59:51.264228 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.265962 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m16:59:51.320355 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:51.329841 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.330879 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.375266 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:51.380686 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m16:59:51.381514 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.382821 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m16:59:51.422747 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:51.430377 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m16:59:51.433372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m16:59:51.434056 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m16:59:51.495542 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:51.499689 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 16:59:50.587346 => 16:59:51.498887
[0m16:59:51.500727 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m16:59:51.503534 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b75690>]}
[0m16:59:51.504938 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.93s]
[0m16:59:51.506558 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m16:59:51.508136 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m16:59:51.509193 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m16:59:51.510542 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m16:59:51.511263 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m16:59:51.517539 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m16:59:51.519165 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 16:59:51.511750 => 16:59:51.518707
[0m16:59:51.519930 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m16:59:51.527478 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m16:59:51.528864 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m16:59:51.529601 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m16:59:51.530242 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:51.788541 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:51.789755 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m16:59:51.791236 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    and country_code='at'
    and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m16:59:51.826070 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "country_code" does not exist
LINE 39:     and country_code='at'
                 ^
HINT:  Perhaps you meant to reference the column "matomo_visits.countrycode".

[0m16:59:51.827970 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: ROLLBACK
[0m16:59:51.860215 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 16:59:51.520364 => 16:59:51.859504
[0m16:59:51.861176 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m16:59:51.871773 [debug] [Thread-1 (]: Database Error in model stg_matomo_actions_visits__our_page_events (models/staging/stg_matomo_actions_visits__our_page_events.sql)
  column "country_code" does not exist
  LINE 39:     and country_code='at'
                   ^
  HINT:  Perhaps you meant to reference the column "matomo_visits.countrycode".
  compiled Code at target/run/campaign_perfomance/models/staging/stg_matomo_actions_visits__our_page_events.sql
[0m16:59:51.872633 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109bb2010>]}
[0m16:59:51.873562 [error] [Thread-1 (]: 9 of 17 ERROR creating sql table model danila.stg_matomo_actions_visits__our_page_events  [[31mERROR[0m in 0.36s]
[0m16:59:51.874445 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m16:59:51.875100 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m16:59:51.875837 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m16:59:51.876707 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m16:59:51.877167 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m16:59:51.883724 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:51.885328 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 16:59:51.877455 => 16:59:51.884915
[0m16:59:51.886070 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m16:59:51.893154 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:51.894472 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:51.894986 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m16:59:51.895453 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:52.149204 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:52.150365 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:52.151040 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m16:59:56.123056 [debug] [Thread-1 (]: SQL status: SELECT 114674 in 4.0 seconds
[0m16:59:56.129063 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:56.129580 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m16:59:56.160399 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:56.209037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:56.209392 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m16:59:56.240100 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:56.242190 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m16:59:56.242506 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:56.242772 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m16:59:56.273337 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:56.276402 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m16:59:56.277235 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m16:59:56.277588 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m16:59:56.324579 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:56.327853 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 16:59:51.886485 => 16:59:56.327508
[0m16:59:56.328523 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m16:59:56.329934 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ba58890>]}
[0m16:59:56.330814 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114674[0m in 4.45s]
[0m16:59:56.331473 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m16:59:56.332025 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m16:59:56.333087 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m16:59:56.334267 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m16:59:56.334844 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m16:59:56.339747 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.340887 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 16:59:56.335175 => 16:59:56.340631
[0m16:59:56.341331 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m16:59:56.345896 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.346773 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.347172 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m16:59:56.347541 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:56.614128 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:56.615186 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.615827 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m16:59:56.690375 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m16:59:56.696306 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.696976 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m16:59:56.728729 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:56.734509 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.735180 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m16:59:56.767267 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:56.771339 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m16:59:56.772036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.772565 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m16:59:56.803001 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:56.808559 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m16:59:56.811502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m16:59:56.812955 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m16:59:56.863873 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:56.866448 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 16:59:56.341573 => 16:59:56.866192
[0m16:59:56.867024 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m16:59:56.868204 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108df9610>]}
[0m16:59:56.869207 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.53s]
[0m16:59:56.870167 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m16:59:56.870742 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m16:59:56.871637 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test_write ............................... [RUN]
[0m16:59:56.872733 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m16:59:56.873299 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m16:59:56.878177 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m16:59:56.879641 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 16:59:56.873636 => 16:59:56.879298
[0m16:59:56.880457 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m16:59:56.889704 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m16:59:56.891549 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:56.892339 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m16:59:56.892850 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:57.152172 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:57.154178 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:57.154814 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m16:59:57.188424 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m16:59:57.194154 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:57.194732 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m16:59:57.226902 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:57.236066 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:57.237588 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m16:59:57.268753 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:57.272184 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m16:59:57.272798 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:57.273233 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m16:59:57.303759 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:57.312602 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m16:59:57.314031 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m16:59:57.314583 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m16:59:57.361918 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:57.364986 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 16:59:56.881056 => 16:59:57.364712
[0m16:59:57.365518 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m16:59:57.366850 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b45510>]}
[0m16:59:57.367681 [info ] [Thread-1 (]: 12 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m16:59:57.368547 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m16:59:57.369200 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m16:59:57.369805 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m16:59:57.370769 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m16:59:57.371275 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m16:59:57.377285 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m16:59:57.379092 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 16:59:57.371530 => 16:59:57.378591
[0m16:59:57.379801 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m16:59:57.388483 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m16:59:57.390222 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:57.390869 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m16:59:57.391450 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:57.688441 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:57.689823 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:57.691364 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m16:59:57.967416 [debug] [Thread-1 (]: SQL status: SELECT 55138 in 0.0 seconds
[0m16:59:57.976397 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:57.977056 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m16:59:58.012925 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:58.019796 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:58.020419 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m16:59:58.057377 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:58.063312 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m16:59:58.064708 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:58.065465 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m16:59:58.104026 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:58.109813 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m16:59:58.111019 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m16:59:58.111448 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m16:59:58.166914 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:58.169794 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 16:59:57.380109 => 16:59:58.169497
[0m16:59:58.170378 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m16:59:58.171784 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109b30a10>]}
[0m16:59:58.172888 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55138[0m in 0.80s]
[0m16:59:58.173793 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m16:59:58.174406 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m16:59:58.175208 [info ] [Thread-1 (]: 14 of 17 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m16:59:58.176174 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m16:59:58.176696 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m16:59:58.181748 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.183413 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 16:59:58.177015 => 16:59:58.183097
[0m16:59:58.184400 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m16:59:58.210487 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.211716 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.212144 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m16:59:58.212532 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:58.533805 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:58.534923 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.535521 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m16:59:58.578848 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m16:59:58.584787 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.585907 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m16:59:58.626665 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:58.629768 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m16:59:58.630383 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.630875 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m16:59:58.670219 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:58.675473 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m16:59:58.680923 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m16:59:58.681547 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m16:59:58.721839 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m16:59:58.726210 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 16:59:58.184819 => 16:59:58.725660
[0m16:59:58.727287 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m16:59:58.728736 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104333810>]}
[0m16:59:58.729689 [info ] [Thread-1 (]: 14 of 17 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.55s]
[0m16:59:58.730564 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m16:59:58.731071 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m16:59:58.731819 [info ] [Thread-1 (]: 15 of 17 SKIP relation danila.outclick_by_brand_int_new ........................ [[33mSKIP[0m]
[0m16:59:58.732292 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m16:59:58.732831 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m16:59:58.733283 [info ] [Thread-1 (]: 16 of 17 SKIP relation danila.outclick_cost_int_new ............................ [[33mSKIP[0m]
[0m16:59:58.733736 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m16:59:58.734147 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m16:59:58.734634 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m16:59:58.735439 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.brand_comparison_fi)
[0m16:59:58.735946 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m16:59:58.741824 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:58.743596 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 16:59:58.736366 => 16:59:58.743293
[0m16:59:58.744128 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m16:59:58.755621 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:58.756820 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:58.757282 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m16:59:58.757692 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m16:59:59.079497 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m16:59:59.081076 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:59.081759 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m16:59:59.145601 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m16:59:59.152565 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:59.153491 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m16:59:59.192897 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:59.198912 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:59.200378 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m16:59:59.240747 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m16:59:59.244548 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m16:59:59.245152 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:59.246032 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m16:59:59.285426 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m16:59:59.291341 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m16:59:59.293071 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m16:59:59.293705 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m16:59:59.351326 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m16:59:59.354729 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 16:59:58.744472 => 16:59:59.354378
[0m16:59:59.355346 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m16:59:59.356823 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '35d63774-e4ab-4563-9012-1ae0814f40f8', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a4ffd0>]}
[0m16:59:59.358464 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.62s]
[0m16:59:59.359573 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m16:59:59.361970 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:59.362614 [debug] [MainThread]: On master: BEGIN
[0m16:59:59.362939 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m16:59:59.638587 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m16:59:59.640077 [debug] [MainThread]: On master: COMMIT
[0m16:59:59.640474 [debug] [MainThread]: Using postgres connection "master"
[0m16:59:59.641631 [debug] [MainThread]: On master: COMMIT
[0m16:59:59.675507 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m16:59:59.676727 [debug] [MainThread]: On master: Close
[0m16:59:59.678995 [debug] [MainThread]: Connection 'master' was properly closed.
[0m16:59:59.680346 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m16:59:59.681785 [info ] [MainThread]: 
[0m16:59:59.682980 [info ] [MainThread]: Finished running 16 table models, 1 view model in 0 hours 0 minutes and 49.18 seconds (49.18s).
[0m16:59:59.688810 [debug] [MainThread]: Command end result
[0m16:59:59.704321 [info ] [MainThread]: 
[0m16:59:59.705032 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m16:59:59.705424 [info ] [MainThread]: 
[0m16:59:59.705791 [error] [MainThread]:   Database Error in model stg_matomo_actions_visits__our_page_events (models/staging/stg_matomo_actions_visits__our_page_events.sql)
  column "country_code" does not exist
  LINE 39:     and country_code='at'
                   ^
  HINT:  Perhaps you meant to reference the column "matomo_visits.countrycode".
  compiled Code at target/run/campaign_perfomance/models/staging/stg_matomo_actions_visits__our_page_events.sql
[0m16:59:59.706183 [info ] [MainThread]: 
[0m16:59:59.706568 [info ] [MainThread]: Done. PASS=14 WARN=0 ERROR=1 SKIP=2 TOTAL=17
[0m16:59:59.709529 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 49.364002, "process_user_time": 2.03213, "process_kernel_time": 0.204404, "process_mem_max_rss": "127762432", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m16:59:59.710203 [debug] [MainThread]: Command `dbt run` failed at 16:59:59.710059 after 49.36 seconds
[0m16:59:59.710667 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102e14e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1079c6fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102dd8850>]}
[0m16:59:59.711088 [debug] [MainThread]: Flushing usage events
[0m17:01:04.853978 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad0bd90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad5c750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109a22890>]}


============================== 17:01:04.855463 | f6a3165d-2335-4a1e-97a0-19948fbf5549 ==============================
[0m17:01:04.855463 [info ] [MainThread]: Running with dbt=1.7.0
[0m17:01:04.855781 [debug] [MainThread]: running dbt with arguments {'log_path': '/Users/danila/github/dbt/logs', 'quiet': 'False', 'cache_selected_only': 'False', 'use_colors': 'True', 'log_format': 'default', 'static_parser': 'True', 'introspect': 'True', 'partial_parse': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'warn_error': 'None', 'no_print': 'None', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'invocation_command': 'dbt run', 'indirect_selection': 'eager', 'version_check': 'True', 'debug': 'False', 'profiles_dir': '/Users/danila/.dbt', 'target_path': 'None', 'printer_width': '80', 'write_json': 'True', 'send_anonymous_usage_stats': 'True', 'log_cache_events': 'False'}
[0m17:01:04.922184 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad9ddd0>]}
[0m17:01:04.954126 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b15e910>]}
[0m17:01:04.954850 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m17:01:04.962122 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m17:01:04.975690 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:01:04.975943 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:01:04.976507 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m17:01:04.979222 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b351790>]}
[0m17:01:04.983958 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b16a350>]}
[0m17:01:04.984177 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:01:04.984348 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b09b890>]}
[0m17:01:04.985396 [info ] [MainThread]: 
[0m17:01:04.985756 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:01:04.986541 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m17:01:04.990917 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m17:01:04.991137 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m17:01:04.991300 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:01:05.425549 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m17:01:05.428302 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m17:01:05.431211 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m17:01:05.437058 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:01:05.437380 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m17:01:05.437658 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:01:05.736955 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:01:05.738051 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:01:05.738960 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m17:01:05.780535 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m17:01:05.784512 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m17:01:05.820777 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m17:01:05.836995 [debug] [MainThread]: Using postgres connection "master"
[0m17:01:05.837683 [debug] [MainThread]: On master: BEGIN
[0m17:01:05.838003 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:01:06.130117 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:01:06.130948 [debug] [MainThread]: Using postgres connection "master"
[0m17:01:06.131466 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:01:06.179924 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m17:01:06.185953 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ada9590>]}
[0m17:01:06.186981 [debug] [MainThread]: On master: ROLLBACK
[0m17:01:06.220512 [debug] [MainThread]: Using postgres connection "master"
[0m17:01:06.221521 [debug] [MainThread]: On master: BEGIN
[0m17:01:06.287731 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:01:06.289065 [debug] [MainThread]: On master: COMMIT
[0m17:01:06.289820 [debug] [MainThread]: Using postgres connection "master"
[0m17:01:06.290617 [debug] [MainThread]: On master: COMMIT
[0m17:01:06.324008 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:01:06.325042 [debug] [MainThread]: On master: Close
[0m17:01:06.326784 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m17:01:06.327453 [info ] [MainThread]: 
[0m17:01:06.332986 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m17:01:06.334181 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m17:01:06.335723 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m17:01:06.336349 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m17:01:06.349691 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:06.350733 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 17:01:06.336812 => 17:01:06.350465
[0m17:01:06.351180 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m17:01:06.377956 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:06.378608 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:06.378849 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m17:01:06.379065 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:06.635724 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:06.636225 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:06.636930 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m17:01:35.135408 [debug] [Thread-1 (]: SQL status: SELECT 2108 in 28.0 seconds
[0m17:01:35.149483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:35.150317 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m17:01:35.182577 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:35.190171 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:35.191336 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m17:01:35.223327 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:35.254367 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:01:35.255289 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:35.255727 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:01:35.286844 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:35.297982 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m17:01:35.304099 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:01:35.304657 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m17:01:35.348239 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:35.351313 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 17:01:06.351435 => 17:01:35.350924
[0m17:01:35.352018 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m17:01:35.353931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b33df90>]}
[0m17:01:35.354926 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2108[0m in 29.02s]
[0m17:01:35.356151 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m17:01:35.357474 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m17:01:35.358384 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m17:01:35.359464 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m17:01:35.360080 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m17:01:35.366029 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m17:01:35.367761 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 17:01:35.360449 => 17:01:35.367325
[0m17:01:35.368418 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m17:01:35.375003 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m17:01:35.376092 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:35.376532 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m17:01:35.376928 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:35.810624 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:35.811852 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:35.812348 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:01:35.876864 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:01:35.883394 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:35.884933 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m17:01:35.929352 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:35.938908 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:35.939829 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m17:01:35.983003 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:35.986915 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:01:35.987647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:35.988084 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:01:36.031913 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:36.038847 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m17:01:36.041366 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:01:36.041912 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m17:01:36.104883 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:36.108166 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 17:01:35.368760 => 17:01:36.107872
[0m17:01:36.108796 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m17:01:36.110224 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b481c90>]}
[0m17:01:36.111196 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.75s]
[0m17:01:36.112335 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m17:01:36.113438 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m17:01:36.115462 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m17:01:36.116963 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m17:01:36.118194 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m17:01:36.124450 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.126242 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 17:01:36.118933 => 17:01:36.125812
[0m17:01:36.126990 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m17:01:36.135263 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.136929 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.137574 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m17:01:36.138015 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:36.411537 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:36.412078 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.412436 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:01:36.465422 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:01:36.468647 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.469049 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m17:01:36.502164 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:36.505969 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.506469 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m17:01:36.540086 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:36.543895 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:01:36.544799 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.545310 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:01:36.579220 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:36.587570 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m17:01:36.588906 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:01:36.589336 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m17:01:36.641464 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:36.645725 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 17:01:36.127479 => 17:01:36.645447
[0m17:01:36.646283 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m17:01:36.648248 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b47de10>]}
[0m17:01:36.649453 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.53s]
[0m17:01:36.650425 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m17:01:36.650989 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m17:01:36.651601 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m17:01:36.653395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m17:01:36.653909 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m17:01:36.659980 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m17:01:36.661997 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 17:01:36.654223 => 17:01:36.661538
[0m17:01:36.662695 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m17:01:36.670580 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m17:01:36.672128 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:36.672727 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m17:01:36.673507 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:36.931605 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:36.933005 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:36.933955 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m17:01:36.972240 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m17:01:36.978848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:36.979840 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m17:01:37.010826 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:37.019198 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:37.020368 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m17:01:37.052200 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:37.056278 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:01:37.057086 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:37.057446 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:01:37.088243 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:37.092837 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m17:01:37.095440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:01:37.096003 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m17:01:37.149431 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:37.153964 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 17:01:36.663019 => 17:01:37.153625
[0m17:01:37.154655 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m17:01:37.155924 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b32cd10>]}
[0m17:01:37.157529 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.50s]
[0m17:01:37.158531 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m17:01:37.160541 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m17:01:37.162060 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m17:01:37.163097 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m17:01:37.163787 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m17:01:37.172702 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.174419 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 17:01:37.164211 => 17:01:37.173913
[0m17:01:37.175181 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m17:01:37.181836 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.183403 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.183922 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m17:01:37.184407 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:37.442742 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:37.443783 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.444415 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m17:01:37.479663 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:01:37.488260 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.488915 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m17:01:37.521010 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:37.529358 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.530078 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m17:01:37.561869 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:37.567242 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:01:37.567919 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.568282 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:01:37.600394 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:37.607034 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m17:01:37.608663 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:01:37.609231 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m17:01:37.661862 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:37.664310 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 17:01:37.175528 => 17:01:37.664033
[0m17:01:37.664910 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m17:01:37.666399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2b4690>]}
[0m17:01:37.667330 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.50s]
[0m17:01:37.668076 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m17:01:37.668763 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m17:01:37.669549 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m17:01:37.670424 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m17:01:37.670911 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m17:01:37.678742 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:37.680434 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 17:01:37.671234 => 17:01:37.680058
[0m17:01:37.681011 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m17:01:37.687620 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:37.688992 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:37.689544 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m17:01:37.689938 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:38.011306 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:38.012521 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:38.013220 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m17:01:47.732952 [debug] [Thread-1 (]: SQL status: SELECT 143292 in 10.0 seconds
[0m17:01:47.740483 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:47.741777 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m17:01:47.782653 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:47.791137 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:47.792098 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m17:01:47.831852 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:47.836922 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:01:47.837673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:47.838222 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:01:47.878702 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:47.885743 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m17:01:47.888644 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:01:47.890123 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m17:01:47.950228 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:47.954395 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 17:01:37.681324 => 17:01:47.953957
[0m17:01:47.955184 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m17:01:47.956792 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad08fd0>]}
[0m17:01:47.957992 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143292[0m in 10.29s]
[0m17:01:47.958925 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m17:01:47.959441 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m17:01:47.960055 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m17:01:47.960893 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m17:01:47.961396 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m17:01:47.966971 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:47.968445 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 17:01:47.961704 => 17:01:47.968043
[0m17:01:47.969051 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m17:01:47.975071 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:47.976232 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:47.976717 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m17:01:47.977155 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:48.313512 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:48.315495 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:48.316323 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m17:01:48.357856 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:01:48.370274 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:48.371120 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m17:01:48.449426 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:48.457834 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:48.458802 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m17:01:48.498039 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:48.502780 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:01:48.503754 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:48.504250 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:01:48.542759 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:48.550078 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m17:01:48.551737 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:01:48.552685 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m17:01:48.607695 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:48.612114 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 17:01:47.969427 => 17:01:48.611771
[0m17:01:48.612807 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m17:01:48.614350 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b494c10>]}
[0m17:01:48.615716 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.65s]
[0m17:01:48.616955 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m17:01:48.618582 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:01:48.620007 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m17:01:48.621389 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m17:01:48.622264 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:01:48.629090 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:48.630984 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 17:01:48.622682 => 17:01:48.630363
[0m17:01:48.632445 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:01:48.640742 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:48.642120 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:48.642761 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m17:01:48.643245 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:48.978319 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:48.979531 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:48.980282 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m17:01:49.020574 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m17:01:49.023902 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:49.024267 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:01:49.057198 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:49.059723 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:49.060052 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m17:01:49.093578 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:49.096371 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:01:49.096949 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:49.097404 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:01:49.131309 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:49.135493 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:01:49.136883 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:01:49.137390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m17:01:49.188851 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:49.192281 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 17:01:48.633082 => 17:01:49.191828
[0m17:01:49.193419 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m17:01:49.195889 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b1bdbd0>]}
[0m17:01:49.197520 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.57s]
[0m17:01:49.198509 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:01:49.199524 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:01:49.200492 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m17:01:49.201532 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m17:01:49.202389 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:01:49.209380 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:49.211178 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 17:01:49.202833 => 17:01:49.210732
[0m17:01:49.211828 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:01:49.218856 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:49.219977 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:49.220399 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m17:01:49.220813 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:49.542629 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:49.543810 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:49.544609 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m17:01:56.340867 [debug] [Thread-1 (]: SQL status: SELECT 37393 in 7.0 seconds
[0m17:01:56.349461 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:56.350591 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:01:56.390901 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:56.397257 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:56.398186 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m17:01:56.438325 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:01:56.442276 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:01:56.442999 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:56.443519 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:01:56.483278 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:01:56.492913 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:01:56.494478 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:01:56.495420 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m17:01:56.549089 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:01:56.552282 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 17:01:49.212198 => 17:01:56.551864
[0m17:01:56.553067 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m17:01:56.554472 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b506a10>]}
[0m17:01:56.555603 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37393[0m in 7.35s]
[0m17:01:56.557391 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:01:56.558076 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m17:01:56.558859 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m17:01:56.559939 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m17:01:56.560522 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m17:01:56.616110 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:01:56.616934 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 17:01:56.560870 => 17:01:56.616764
[0m17:01:56.617231 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m17:01:56.620176 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:01:56.620752 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:01:56.620999 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m17:01:56.621229 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:01:57.002019 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:01:57.003636 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:01:57.004285 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as betting_type,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m17:02:00.846077 [debug] [Thread-1 (]: SQL status: SELECT 114674 in 4.0 seconds
[0m17:02:00.852793 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:02:00.853530 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m17:02:00.896709 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:00.904933 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:02:00.906582 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m17:02:00.950111 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:00.956317 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:02:00.957586 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:02:00.958092 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:02:01.000523 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:01.006473 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m17:02:01.008294 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:02:01.008881 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m17:02:01.068251 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:02:01.070422 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 17:01:56.617392 => 17:02:01.070051
[0m17:02:01.071159 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m17:02:01.072688 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b507c10>]}
[0m17:02:01.073962 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114674[0m in 4.51s]
[0m17:02:01.075515 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m17:02:01.077013 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:02:01.078466 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m17:02:01.079787 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m17:02:01.080802 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:02:01.087161 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.088832 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 17:02:01.081530 => 17:02:01.088400
[0m17:02:01.089512 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:02:01.096800 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.097817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.098298 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m17:02:01.098687 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:01.396019 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:01.397126 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.397827 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as betting_type,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m17:02:01.478660 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m17:02:01.486469 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.487165 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:02:01.523991 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:01.531787 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.533018 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m17:02:01.570145 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:01.574983 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:02:01.575780 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.576314 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:02:01.613155 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:01.620229 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:02:01.621835 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:02:01.622491 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m17:02:01.677342 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:02:01.681937 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 17:02:01.089963 => 17:02:01.681058
[0m17:02:01.683011 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m17:02:01.684385 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b36f5d0>]}
[0m17:02:01.685824 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.61s]
[0m17:02:01.686536 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:02:01.687047 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m17:02:01.687807 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test_write ............................... [RUN]
[0m17:02:01.688656 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m17:02:01.689094 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m17:02:01.694175 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m17:02:01.695892 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 17:02:01.689343 => 17:02:01.695432
[0m17:02:01.696703 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m17:02:01.707767 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m17:02:01.708918 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:01.709423 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m17:02:01.709862 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:01.968437 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:01.970199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:01.970836 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m17:02:02.004435 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:02:02.011195 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:02.012161 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m17:02:02.043734 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:02.050741 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:02.051862 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m17:02:02.082893 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:02.087778 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:02:02.088397 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:02.089667 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:02:02.121869 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:02.128256 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m17:02:02.130688 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:02:02.131399 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m17:02:02.182275 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:02:02.185072 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 17:02:01.697126 => 17:02:02.184796
[0m17:02:02.185664 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m17:02:02.187028 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2a48d0>]}
[0m17:02:02.188434 [info ] [Thread-1 (]: 12 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.50s]
[0m17:02:02.189278 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m17:02:02.189809 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m17:02:02.190746 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m17:02:02.191794 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m17:02:02.192393 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m17:02:02.199398 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.201233 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 17:02:02.192728 => 17:02:02.200827
[0m17:02:02.201808 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m17:02:02.210102 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.211746 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.212747 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m17:02:02.213434 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:02.471361 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:02.473413 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.474482 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m17:02:02.776064 [debug] [Thread-1 (]: SQL status: SELECT 55142 in 0.0 seconds
[0m17:02:02.783085 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.783915 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m17:02:02.815810 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:02.821545 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.822246 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m17:02:02.854523 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:02.860369 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:02:02.861351 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.862258 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:02:02.894733 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:02.902072 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m17:02:02.904249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:02:02.905192 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m17:02:02.957404 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:02:02.961839 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 17:02:02.202112 => 17:02:02.961477
[0m17:02:02.962880 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m17:02:02.965757 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b457390>]}
[0m17:02:02.966798 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55142[0m in 0.77s]
[0m17:02:02.967501 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m17:02:02.968015 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m17:02:02.968864 [info ] [Thread-1 (]: 14 of 17 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m17:02:02.970127 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m17:02:02.970737 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m17:02:02.976720 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:02.978482 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 17:02:02.971106 => 17:02:02.978067
[0m17:02:02.979092 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m17:02:03.004172 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.005316 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.005773 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m17:02:03.006173 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:03.265904 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:03.267309 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.268754 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m17:02:03.304062 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m17:02:03.310517 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.311294 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m17:02:03.343595 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:03.353501 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:02:03.354597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.354977 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:02:03.386367 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:03.391274 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m17:02:03.398058 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:02:03.399441 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m17:02:03.432057 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m17:02:03.436683 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 17:02:02.979401 => 17:02:03.436356
[0m17:02:03.437360 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m17:02:03.438553 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b483090>]}
[0m17:02:03.440546 [info ] [Thread-1 (]: 14 of 17 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.47s]
[0m17:02:03.441377 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m17:02:03.442160 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:02:03.443007 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m17:02:03.444094 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m17:02:03.444746 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:02:03.451833 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:02:03.453690 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 17:02:03.445272 => 17:02:03.453273
[0m17:02:03.454439 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:02:03.463686 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:02:03.465358 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:02:03.466025 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m17:02:03.466533 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:03.723373 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:03.724824 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:02:03.725876 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
where  actions.country_code='at' and date_cet='2024-04-24'
  );
  
[0m17:02:03.759822 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "campaign_vertical" does not exist
LINE 50:     campaign_vertical, 
             ^
HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.

[0m17:02:03.761238 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: ROLLBACK
[0m17:02:03.793036 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 17:02:03.454803 => 17:02:03.792215
[0m17:02:03.794335 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m17:02:03.805901 [debug] [Thread-1 (]: Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "campaign_vertical" does not exist
  LINE 50:     campaign_vertical, 
               ^
  HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m17:02:03.807510 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4e20d0>]}
[0m17:02:03.808731 [error] [Thread-1 (]: 15 of 17 ERROR creating sql table model danila.outclick_by_brand_int_new ....... [[31mERROR[0m in 0.36s]
[0m17:02:03.809994 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:02:03.810926 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m17:02:03.812008 [info ] [Thread-1 (]: 16 of 17 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m17:02:03.813386 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m17:02:03.813931 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m17:02:03.822237 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:02:03.824125 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 17:02:03.814257 => 17:02:03.823628
[0m17:02:03.825159 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m17:02:03.829621 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:02:03.830524 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:02:03.830896 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m17:02:03.831235 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:04.087359 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:04.088108 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:02:04.088700 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m17:02:04.123981 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "campaign_vertical" does not exist
LINE 48:         campaign_vertical,
                 ^
HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.

[0m17:02:04.125168 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: ROLLBACK
[0m17:02:04.156986 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 17:02:03.825521 => 17:02:04.155891
[0m17:02:04.158201 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m17:02:04.163977 [debug] [Thread-1 (]: Database Error in model outclick_cost_int_new (models/brand_performance/outclick_cost_int_new.sql)
  column "campaign_vertical" does not exist
  LINE 48:         campaign_vertical,
                   ^
  HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_cost_int_new.sql
[0m17:02:04.165237 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b415a90>]}
[0m17:02:04.166262 [error] [Thread-1 (]: 16 of 17 ERROR creating sql table model danila.outclick_cost_int_new ........... [[31mERROR[0m in 0.35s]
[0m17:02:04.167519 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m17:02:04.168306 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m17:02:04.169073 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m17:02:04.170168 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m17:02:04.170783 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m17:02:04.176590 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.177971 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 17:02:04.171114 => 17:02:04.177594
[0m17:02:04.178530 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m17:02:04.183791 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.184783 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.185177 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m17:02:04.185569 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:02:04.442813 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:02:04.443902 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.444864 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m17:02:04.502056 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m17:02:04.510560 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.511693 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m17:02:04.543978 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:04.551744 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.552511 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m17:02:04.583549 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:02:04.588572 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:02:04.590033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.590803 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:02:04.621256 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:02:04.627108 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m17:02:04.628803 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:02:04.629496 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m17:02:04.679755 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:02:04.682682 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 17:02:04.178840 => 17:02:04.682356
[0m17:02:04.683572 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m17:02:04.686316 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'f6a3165d-2335-4a1e-97a0-19948fbf5549', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b48b890>]}
[0m17:02:04.687226 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.52s]
[0m17:02:04.688118 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m17:02:04.690905 [debug] [MainThread]: Using postgres connection "master"
[0m17:02:04.691511 [debug] [MainThread]: On master: BEGIN
[0m17:02:04.691927 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:02:04.951847 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:02:04.953424 [debug] [MainThread]: On master: COMMIT
[0m17:02:04.954016 [debug] [MainThread]: Using postgres connection "master"
[0m17:02:04.954528 [debug] [MainThread]: On master: COMMIT
[0m17:02:04.985677 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:02:04.986728 [debug] [MainThread]: On master: Close
[0m17:02:04.988642 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:02:04.989290 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m17:02:04.989897 [info ] [MainThread]: 
[0m17:02:04.990514 [info ] [MainThread]: Finished running 16 table models, 1 view model in 0 hours 1 minutes and 0.00 seconds (60.00s).
[0m17:02:04.995095 [debug] [MainThread]: Command end result
[0m17:02:05.015551 [info ] [MainThread]: 
[0m17:02:05.016250 [info ] [MainThread]: [31mCompleted with 2 errors and 0 warnings:[0m
[0m17:02:05.016631 [info ] [MainThread]: 
[0m17:02:05.016988 [error] [MainThread]:   Database Error in model outclick_by_brand_int_new (models/brand_performance/outclick_by_brand_int_new.sql)
  column "campaign_vertical" does not exist
  LINE 50:     campaign_vertical, 
               ^
  HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_by_brand_int_new.sql
[0m17:02:05.017355 [info ] [MainThread]: 
[0m17:02:05.017684 [error] [MainThread]:   Database Error in model outclick_cost_int_new (models/brand_performance/outclick_cost_int_new.sql)
  column "campaign_vertical" does not exist
  LINE 48:         campaign_vertical,
                   ^
  HINT:  There is a column named "campaign_vertical" in table "*SELECT* 1", but it cannot be referenced from this part of the query.
  compiled Code at target/run/campaign_perfomance/models/brand_performance/outclick_cost_int_new.sql
[0m17:02:05.018049 [info ] [MainThread]: 
[0m17:02:05.018429 [info ] [MainThread]: Done. PASS=15 WARN=0 ERROR=2 SKIP=0 TOTAL=17
[0m17:02:05.021504 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 60.189945, "process_user_time": 2.189608, "process_kernel_time": 0.221171, "process_mem_max_rss": "129073152", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m17:02:05.022486 [debug] [MainThread]: Command `dbt run` failed at 17:02:05.022307 after 60.19 seconds
[0m17:02:05.023065 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1039b1f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103928e10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103928dd0>]}
[0m17:02:05.023573 [debug] [MainThread]: Flushing usage events
[0m17:05:03.118350 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112808fd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11287e150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11287e810>]}


============================== 17:05:03.119617 | d0ccaf2b-1160-4104-b36f-692838fec2cc ==============================
[0m17:05:03.119617 [info ] [MainThread]: Running with dbt=1.7.0
[0m17:05:03.119951 [debug] [MainThread]: running dbt with arguments {'static_parser': 'True', 'target_path': 'None', 'log_cache_events': 'False', 'write_json': 'True', 'warn_error': 'None', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'invocation_command': 'dbt run', 'profiles_dir': '/Users/danila/.dbt', 'cache_selected_only': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'log_format': 'default', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'partial_parse': 'True', 'quiet': 'False', 'debug': 'False', 'introspect': 'True', 'no_print': 'None', 'printer_width': '80', 'use_colors': 'True'}
[0m17:05:03.182565 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112c88910>]}
[0m17:05:03.212588 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11283f8d0>]}
[0m17:05:03.212962 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m17:05:03.219582 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m17:05:03.233833 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:05:03.234080 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:05:03.234724 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m17:05:03.237421 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f0d310>]}
[0m17:05:03.242176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11303f8d0>]}
[0m17:05:03.242394 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:05:03.242576 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112ca3710>]}
[0m17:05:03.243594 [info ] [MainThread]: 
[0m17:05:03.243955 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:05:03.244673 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m17:05:03.249116 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m17:05:03.249289 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m17:05:03.249433 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:05:03.568125 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m17:05:03.571884 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m17:05:03.576723 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m17:05:03.586292 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:05:03.586923 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m17:05:03.587309 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:05:03.887686 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:05:03.889008 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:05:03.889847 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m17:05:03.927366 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m17:05:03.929935 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m17:05:03.960701 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m17:05:03.970366 [debug] [MainThread]: Using postgres connection "master"
[0m17:05:03.970748 [debug] [MainThread]: On master: BEGIN
[0m17:05:03.971024 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:05:04.230001 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:05:04.231701 [debug] [MainThread]: Using postgres connection "master"
[0m17:05:04.232623 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:05:04.274290 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m17:05:04.281269 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1130065d0>]}
[0m17:05:04.282307 [debug] [MainThread]: On master: ROLLBACK
[0m17:05:04.312948 [debug] [MainThread]: Using postgres connection "master"
[0m17:05:04.313568 [debug] [MainThread]: On master: BEGIN
[0m17:05:04.374871 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:05:04.375257 [debug] [MainThread]: On master: COMMIT
[0m17:05:04.375512 [debug] [MainThread]: Using postgres connection "master"
[0m17:05:04.375753 [debug] [MainThread]: On master: COMMIT
[0m17:05:04.407201 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:05:04.407581 [debug] [MainThread]: On master: Close
[0m17:05:04.408294 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m17:05:04.408567 [info ] [MainThread]: 
[0m17:05:04.410353 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m17:05:04.410790 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m17:05:04.411347 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m17:05:04.411650 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m17:05:04.419260 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:04.419946 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 17:05:04.411845 => 17:05:04.419772
[0m17:05:04.420240 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m17:05:04.441536 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:04.442097 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:04.442305 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m17:05:04.442508 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:04.771804 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:04.773474 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:04.774867 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m17:05:33.327603 [debug] [Thread-1 (]: SQL status: SELECT 2108 in 29.0 seconds
[0m17:05:33.342609 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:33.343521 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m17:05:33.381526 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:33.387930 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:33.388942 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m17:05:33.426096 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:33.458664 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:05:33.459699 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:33.460322 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:05:33.497548 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:33.508116 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m17:05:33.515502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:05:33.516566 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m17:05:33.566694 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:33.569406 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 17:05:04.420398 => 17:05:33.569128
[0m17:05:33.570043 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m17:05:33.571860 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113098690>]}
[0m17:05:33.573012 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2108[0m in 29.16s]
[0m17:05:33.574098 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m17:05:33.574812 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m17:05:33.575824 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m17:05:33.577028 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m17:05:33.577684 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m17:05:33.583575 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m17:05:33.584993 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 17:05:33.578002 => 17:05:33.584622
[0m17:05:33.585605 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m17:05:33.592557 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m17:05:33.593709 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:33.594251 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m17:05:33.594583 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:34.005035 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:34.006152 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:34.006794 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:05:34.063634 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:05:34.071782 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:34.072506 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m17:05:34.114548 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:34.122748 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:34.123750 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m17:05:34.164701 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:34.169790 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:05:34.171490 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:34.171954 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:05:34.212193 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:34.219360 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m17:05:34.220650 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:05:34.221142 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m17:05:34.280142 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:34.283151 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 17:05:33.585973 => 17:05:34.282859
[0m17:05:34.284083 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m17:05:34.286144 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113251050>]}
[0m17:05:34.287013 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.71s]
[0m17:05:34.288412 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m17:05:34.289051 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m17:05:34.289758 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m17:05:34.290713 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m17:05:34.291232 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m17:05:34.297917 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.300090 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 17:05:34.291508 => 17:05:34.299560
[0m17:05:34.300781 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m17:05:34.309315 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.311410 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.312347 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m17:05:34.313156 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:34.577278 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:34.578155 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.578706 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:05:34.628924 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:05:34.632817 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.633321 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m17:05:34.664514 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:34.667653 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.668013 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m17:05:34.698366 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:34.700504 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:05:34.700897 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.701226 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:05:34.731885 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:34.736964 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m17:05:34.738239 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:05:34.738664 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m17:05:34.789839 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:34.793106 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 17:05:34.301112 => 17:05:34.792680
[0m17:05:34.793766 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m17:05:34.795627 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131fd150>]}
[0m17:05:34.796937 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.51s]
[0m17:05:34.797807 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m17:05:34.798516 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m17:05:34.799506 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m17:05:34.800974 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m17:05:34.801598 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m17:05:34.807456 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m17:05:34.809210 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 17:05:34.802020 => 17:05:34.808779
[0m17:05:34.810381 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m17:05:34.817445 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m17:05:34.818430 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:34.818750 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m17:05:34.819039 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:35.092630 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:35.093722 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:35.094150 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m17:05:35.134393 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m17:05:35.141441 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:35.142212 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m17:05:35.175780 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:35.181978 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:35.182784 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m17:05:35.216320 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:35.219962 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:05:35.221220 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:35.221569 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:05:35.255032 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:35.260376 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m17:05:35.262334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:05:35.262868 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m17:05:35.314594 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:35.318679 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 17:05:34.810950 => 17:05:35.318333
[0m17:05:35.319287 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m17:05:35.321696 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1130275d0>]}
[0m17:05:35.323068 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.52s]
[0m17:05:35.324324 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m17:05:35.325236 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m17:05:35.326437 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m17:05:35.327799 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m17:05:35.328461 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m17:05:35.337245 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.339234 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 17:05:35.328895 => 17:05:35.338606
[0m17:05:35.340045 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m17:05:35.346587 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.347717 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.348043 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m17:05:35.348327 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:35.623956 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:35.625010 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.625641 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m17:05:35.662195 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:05:35.669415 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.670090 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m17:05:35.704032 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:35.710196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.711631 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m17:05:35.746388 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:35.750631 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:05:35.751343 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.751705 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:05:35.784973 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:35.790770 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m17:05:35.792474 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:05:35.793381 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m17:05:35.846970 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:35.851334 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 17:05:35.340582 => 17:05:35.851046
[0m17:05:35.852129 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m17:05:35.853339 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113149710>]}
[0m17:05:35.855045 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.53s]
[0m17:05:35.855888 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m17:05:35.856568 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m17:05:35.857425 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m17:05:35.858395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m17:05:35.858978 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m17:05:35.867475 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:35.869272 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 17:05:35.859309 => 17:05:35.868735
[0m17:05:35.870228 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m17:05:35.877742 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:35.878855 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:35.879234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m17:05:35.879535 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:36.133372 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:36.134659 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:36.135420 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m17:05:46.945079 [debug] [Thread-1 (]: SQL status: SELECT 143302 in 11.0 seconds
[0m17:05:46.954864 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:46.956259 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m17:05:46.988091 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:46.997627 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:46.999452 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m17:05:47.030953 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:47.034904 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:05:47.035587 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:47.035944 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:05:47.068023 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:47.078278 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m17:05:47.079519 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:05:47.080392 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m17:05:47.127480 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:47.132037 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 17:05:35.870695 => 17:05:47.131280
[0m17:05:47.133472 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m17:05:47.136643 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131374d0>]}
[0m17:05:47.138734 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143302[0m in 11.28s]
[0m17:05:47.140598 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m17:05:47.141685 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m17:05:47.143451 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m17:05:47.144366 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m17:05:47.144773 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m17:05:47.152182 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.153954 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 17:05:47.145336 => 17:05:47.153569
[0m17:05:47.154510 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m17:05:47.162361 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.164071 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.164808 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m17:05:47.165366 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:47.419775 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:47.421516 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.421989 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m17:05:47.455871 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:05:47.467000 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.467882 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m17:05:47.499497 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:47.505641 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.506507 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m17:05:47.536919 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:47.540605 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:05:47.541226 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.541640 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:05:47.572375 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:47.577786 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m17:05:47.580319 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:05:47.580788 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m17:05:47.632891 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:47.636407 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 17:05:47.154805 => 17:05:47.636097
[0m17:05:47.637159 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m17:05:47.638839 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113284310>]}
[0m17:05:47.639822 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.49s]
[0m17:05:47.640661 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m17:05:47.641271 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:05:47.642058 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m17:05:47.643365 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m17:05:47.644019 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:05:47.650709 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:47.652194 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 17:05:47.644253 => 17:05:47.651728
[0m17:05:47.653097 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:05:47.661470 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:47.663152 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:47.663713 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m17:05:47.664139 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:48.017669 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:48.019059 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.019585 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m17:05:48.068154 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m17:05:48.073809 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.074570 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:05:48.118001 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:48.124016 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.124704 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.168083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:48.170699 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:05:48.171272 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.171739 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:05:48.213651 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:48.216223 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:05:48.216886 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:05:48.217201 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m17:05:48.276864 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:48.279456 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 17:05:47.653476 => 17:05:48.279162
[0m17:05:48.280095 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m17:05:48.281575 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x113238890>]}
[0m17:05:48.282748 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.64s]
[0m17:05:48.283775 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:05:48.284332 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:05:48.284958 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m17:05:48.285878 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m17:05:48.286480 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:05:48.290822 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:48.291749 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 17:05:48.286754 => 17:05:48.291540
[0m17:05:48.292069 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:05:48.295792 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:48.296842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:48.297208 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m17:05:48.297440 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:48.551551 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:48.552621 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:48.553331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m17:05:55.137305 [debug] [Thread-1 (]: SQL status: SELECT 37393 in 7.0 seconds
[0m17:05:55.145198 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:55.146022 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:05:55.177881 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:55.184873 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:55.185861 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m17:05:55.217458 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:55.223463 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:05:55.224382 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:55.225107 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:05:55.256265 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:55.266470 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:05:55.268505 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:05:55.269143 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m17:05:55.318960 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:55.322037 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 17:05:48.292319 => 17:05:55.321754
[0m17:05:55.322664 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m17:05:55.323982 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x11329e450>]}
[0m17:05:55.324814 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37393[0m in 7.04s]
[0m17:05:55.325635 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:05:55.326437 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m17:05:55.327085 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m17:05:55.329745 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m17:05:55.330342 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m17:05:55.395565 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:55.396316 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 17:05:55.330665 => 17:05:55.396172
[0m17:05:55.396565 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m17:05:55.399159 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:55.399592 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:55.399804 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m17:05:55.400000 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:55.669635 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:55.670629 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:55.671372 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m17:05:59.370817 [debug] [Thread-1 (]: SQL status: SELECT 114687 in 4.0 seconds
[0m17:05:59.376779 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:59.377554 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m17:05:59.408637 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:59.415535 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:59.417127 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m17:05:59.449274 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:05:59.455021 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:05:59.455744 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:59.456190 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:05:59.488147 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:05:59.493497 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m17:05:59.494978 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:05:59.495357 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m17:05:59.544189 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:05:59.547738 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 17:05:55.396699 => 17:05:59.547443
[0m17:05:59.549091 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m17:05:59.551159 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x110e7ce10>]}
[0m17:05:59.552342 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114687[0m in 4.22s]
[0m17:05:59.553054 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m17:05:59.553801 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:05:59.554882 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m17:05:59.556040 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m17:05:59.556695 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:05:59.563034 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:05:59.564874 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 17:05:59.557065 => 17:05:59.564433
[0m17:05:59.565492 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:05:59.573393 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:05:59.574558 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:05:59.574931 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m17:05:59.575258 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:05:59.872096 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:05:59.873062 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:05:59.874442 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, betting_type, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m17:05:59.915299 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "betting_type" does not exist
LINE 36: ...y, country_code, campaign_name, ga_campaign_name, betting_ty...
                                                              ^

[0m17:05:59.917168 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: ROLLBACK
[0m17:05:59.954640 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 17:05:59.565752 => 17:05:59.953922
[0m17:05:59.955527 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m17:05:59.965583 [debug] [Thread-1 (]: Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "betting_type" does not exist
  LINE 36: ...y, country_code, campaign_name, ga_campaign_name, betting_ty...
                                                                ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m17:05:59.966783 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1132bc710>]}
[0m17:05:59.967575 [error] [Thread-1 (]: 11 of 17 ERROR creating sql table model danila.stg_records_gam_campaign__campaign_costs  [[31mERROR[0m in 0.41s]
[0m17:05:59.968287 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:05:59.968821 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m17:05:59.969612 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test_write ............................... [RUN]
[0m17:05:59.970664 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m17:05:59.971202 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m17:05:59.976735 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m17:05:59.978273 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 17:05:59.971510 => 17:05:59.977861
[0m17:05:59.979102 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m17:05:59.983865 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m17:05:59.984728 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:05:59.985077 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m17:05:59.985396 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:00.239132 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:06:00.240269 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:06:00.240881 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m17:06:00.273860 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:06:00.280727 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:06:00.282236 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m17:06:00.314062 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:00.320025 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:06:00.321311 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m17:06:00.352892 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:00.357100 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:06:00.357846 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:06:00.358365 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:06:00.389315 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:06:00.398394 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m17:06:00.401145 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:06:00.401843 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m17:06:00.451700 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:06:00.454728 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 17:05:59.979493 => 17:06:00.454264
[0m17:06:00.455435 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m17:06:00.456933 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1130376d0>]}
[0m17:06:00.457927 [info ] [Thread-1 (]: 12 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m17:06:00.458918 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m17:06:00.459906 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m17:06:00.460713 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m17:06:00.462035 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m17:06:00.462945 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m17:06:00.469850 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m17:06:00.471430 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 17:06:00.463326 => 17:06:00.471080
[0m17:06:00.472189 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m17:06:00.479755 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m17:06:00.481278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:00.481905 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m17:06:00.482419 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:00.737126 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:06:00.738339 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:00.739074 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m17:06:00.980251 [debug] [Thread-1 (]: SQL status: SELECT 55152 in 0.0 seconds
[0m17:06:00.987723 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:00.988648 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m17:06:01.020236 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:01.025935 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:01.026822 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m17:06:01.058659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:01.062214 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:06:01.062919 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:01.063395 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:06:01.095270 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:06:01.102479 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m17:06:01.104965 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:06:01.105592 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m17:06:01.161000 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:06:01.164370 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 17:06:00.472771 => 17:06:01.164094
[0m17:06:01.164961 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m17:06:01.167199 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1131fc390>]}
[0m17:06:01.168178 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55152[0m in 0.71s]
[0m17:06:01.169027 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m17:06:01.169654 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m17:06:01.170478 [info ] [Thread-1 (]: 14 of 17 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m17:06:01.171455 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m17:06:01.172051 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m17:06:01.177942 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.179426 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 17:06:01.172417 => 17:06:01.179060
[0m17:06:01.180076 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m17:06:01.201568 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.202649 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.203080 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m17:06:01.203377 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:01.459164 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:06:01.460703 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.461792 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m17:06:01.495291 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m17:06:01.501718 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.503141 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m17:06:01.534982 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:01.538855 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:06:01.539542 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.540028 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:06:01.571207 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:06:01.576388 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m17:06:01.584174 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:06:01.585068 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m17:06:01.617148 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m17:06:01.619998 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 17:06:01.180380 => 17:06:01.619723
[0m17:06:01.620680 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m17:06:01.622152 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112823a50>]}
[0m17:06:01.623139 [info ] [Thread-1 (]: 14 of 17 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.45s]
[0m17:06:01.624076 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m17:06:01.624763 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:06:01.625579 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m17:06:01.627113 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m17:06:01.627877 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:06:01.635316 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:01.636942 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 17:06:01.628196 => 17:06:01.636488
[0m17:06:01.637604 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:06:01.648589 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:01.649813 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:01.650167 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m17:06:01.650463 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:02.254688 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m17:06:02.256073 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:02.257080 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
where  country_code='at' and date_cet='2024-04-24'
  );
  
[0m17:06:02.319657 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m17:06:02.326786 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:02.327700 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m17:06:02.365640 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:02.370654 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:02.371810 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m17:06:02.409022 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:02.413807 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:06:02.414470 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:02.414971 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:06:02.452267 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:06:02.457650 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m17:06:02.459341 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:06:02.460163 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m17:06:02.521572 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:06:02.525929 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 17:06:01.637944 => 17:06:02.525640
[0m17:06:02.526506 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m17:06:02.528917 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x112f2c490>]}
[0m17:06:02.530280 [info ] [Thread-1 (]: 15 of 17 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 45[0m in 0.90s]
[0m17:06:02.531257 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:06:02.531991 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m17:06:02.532665 [info ] [Thread-1 (]: 16 of 17 SKIP relation danila.outclick_cost_int_new ............................ [[33mSKIP[0m]
[0m17:06:02.533954 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m17:06:02.534446 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m17:06:02.535137 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m17:06:02.536297 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m17:06:02.537000 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m17:06:02.543294 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.545328 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 17:06:02.537425 => 17:06:02.544837
[0m17:06:02.546199 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m17:06:02.554166 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.555942 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.556680 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m17:06:02.557045 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:02.812304 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:06:02.813644 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.814192 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m17:06:02.873806 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m17:06:02.881082 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.882670 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m17:06:02.915432 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:02.921972 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.923000 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m17:06:02.954692 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:06:02.958340 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:06:02.959451 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:02.960098 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:06:02.991964 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:06:02.997484 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m17:06:03.000245 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:06:03.000981 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m17:06:03.049888 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:06:03.053039 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 17:06:02.546625 => 17:06:03.052725
[0m17:06:03.053684 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m17:06:03.055514 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'd0ccaf2b-1160-4104-b36f-692838fec2cc', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1130eec10>]}
[0m17:06:03.056555 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.52s]
[0m17:06:03.057334 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m17:06:03.059808 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:03.060393 [debug] [MainThread]: On master: BEGIN
[0m17:06:03.060808 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:06:03.316231 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:06:03.316944 [debug] [MainThread]: On master: COMMIT
[0m17:06:03.317276 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:03.317610 [debug] [MainThread]: On master: COMMIT
[0m17:06:03.348822 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:06:03.349762 [debug] [MainThread]: On master: Close
[0m17:06:03.351169 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:06:03.352061 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m17:06:03.352513 [info ] [MainThread]: 
[0m17:06:03.352908 [info ] [MainThread]: Finished running 16 table models, 1 view model in 0 hours 1 minutes and 0.11 seconds (60.11s).
[0m17:06:03.356580 [debug] [MainThread]: Command end result
[0m17:06:03.376310 [info ] [MainThread]: 
[0m17:06:03.377408 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m17:06:03.377837 [info ] [MainThread]: 
[0m17:06:03.378186 [error] [MainThread]:   Database Error in model stg_records_gam_campaign__campaign_costs (models/staging/stg_records_gam_campaign__campaign_costs.sql)
  column "betting_type" does not exist
  LINE 36: ...y, country_code, campaign_name, ga_campaign_name, betting_ty...
                                                                ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_records_gam_campaign__campaign_costs.sql
[0m17:06:03.378510 [info ] [MainThread]: 
[0m17:06:03.378799 [info ] [MainThread]: Done. PASS=15 WARN=0 ERROR=1 SKIP=1 TOTAL=17
[0m17:06:03.381419 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 60.283485, "process_user_time": 2.097417, "process_kernel_time": 0.209257, "process_mem_max_rss": "127614976", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m17:06:03.382305 [debug] [MainThread]: Command `dbt run` failed at 17:06:03.382164 after 60.28 seconds
[0m17:06:03.382726 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103295f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10320ce10>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10320cdd0>]}
[0m17:06:03.383253 [debug] [MainThread]: Flushing usage events
[0m17:06:49.603533 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dab910>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e1e310>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e1e990>]}


============================== 17:06:49.604857 | 03482969-6cda-420d-9df4-5a9c55e669ce ==============================
[0m17:06:49.604857 [info ] [MainThread]: Running with dbt=1.7.0
[0m17:06:49.605165 [debug] [MainThread]: running dbt with arguments {'log_path': '/Users/danila/github/dbt/logs', 'invocation_command': 'dbt run', 'fail_fast': 'False', 'indirect_selection': 'eager', 'log_cache_events': 'False', 'cache_selected_only': 'False', 'printer_width': '80', 'debug': 'False', 'profiles_dir': '/Users/danila/.dbt', 'warn_error': 'None', 'send_anonymous_usage_stats': 'True', 'use_colors': 'True', 'no_print': 'None', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'version_check': 'True', 'log_format': 'default', 'partial_parse': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'static_parser': 'True', 'target_path': 'None', 'write_json': 'True'}
[0m17:06:49.668433 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2ce610>]}
[0m17:06:49.698428 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a2cb850>]}
[0m17:06:49.699125 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m17:06:49.705526 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m17:06:49.718899 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:06:49.719154 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:06:49.719701 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m17:06:49.722628 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e3e3d0>]}
[0m17:06:49.727461 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a487e10>]}
[0m17:06:49.727695 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:06:49.727874 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a603a90>]}
[0m17:06:49.728933 [info ] [MainThread]: 
[0m17:06:49.729307 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:06:49.730048 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m17:06:49.734449 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m17:06:49.734657 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m17:06:49.734818 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:06:50.014470 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m17:06:50.017410 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m17:06:50.020972 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m17:06:50.029900 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:06:50.030554 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m17:06:50.030973 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:06:50.359465 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:06:50.361198 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:06:50.362092 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m17:06:50.407592 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m17:06:50.410919 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m17:06:50.450386 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m17:06:50.464319 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:50.465104 [debug] [MainThread]: On master: BEGIN
[0m17:06:50.465450 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:06:50.821895 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:06:50.822686 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:50.823276 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:06:50.876994 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m17:06:50.880779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109dcdbd0>]}
[0m17:06:50.881263 [debug] [MainThread]: On master: ROLLBACK
[0m17:06:50.923566 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:50.923988 [debug] [MainThread]: On master: BEGIN
[0m17:06:51.009022 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:06:51.009956 [debug] [MainThread]: On master: COMMIT
[0m17:06:51.010416 [debug] [MainThread]: Using postgres connection "master"
[0m17:06:51.010831 [debug] [MainThread]: On master: COMMIT
[0m17:06:51.053870 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:06:51.055311 [debug] [MainThread]: On master: Close
[0m17:06:51.057235 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m17:06:51.057995 [info ] [MainThread]: 
[0m17:06:51.062748 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m17:06:51.063662 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m17:06:51.064891 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m17:06:51.065720 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m17:06:51.079850 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:06:51.081010 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 17:06:51.066163 => 17:06:51.080764
[0m17:06:51.081427 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m17:06:51.109539 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:06:51.110355 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:06:51.110627 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m17:06:51.110853 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:06:51.412698 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:06:51.413548 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:06:51.415392 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m17:07:20.847614 [debug] [Thread-1 (]: SQL status: SELECT 2108 in 29.0 seconds
[0m17:07:20.858174 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:07:20.859159 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m17:07:20.891435 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:20.896244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:07:20.897061 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m17:07:20.928867 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:20.954693 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:07:20.955460 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:07:20.955886 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:07:20.987432 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:20.996067 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m17:07:21.001160 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:07:21.001597 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m17:07:21.045259 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:21.047600 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 17:06:51.081643 => 17:07:21.047308
[0m17:07:21.048163 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m17:07:21.049465 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a652cd0>]}
[0m17:07:21.050357 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2108[0m in 29.99s]
[0m17:07:21.051147 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m17:07:21.051715 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m17:07:21.052358 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m17:07:21.053203 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m17:07:21.053648 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m17:07:21.057160 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m17:07:21.058031 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 17:07:21.053919 => 17:07:21.057833
[0m17:07:21.058372 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m17:07:21.062334 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m17:07:21.063112 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.063446 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m17:07:21.063734 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:21.415093 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:21.416708 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.417726 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:07:21.478142 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:07:21.483338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.483969 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m17:07:21.524169 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:21.531224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.531914 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m17:07:21.572310 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:21.576105 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:07:21.576882 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.577408 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:07:21.616734 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:21.623090 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m17:07:21.625090 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:07:21.625623 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m17:07:21.683838 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:21.687623 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 17:07:21.058578 => 17:07:21.687228
[0m17:07:21.688228 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m17:07:21.689952 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6b91d0>]}
[0m17:07:21.691213 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.64s]
[0m17:07:21.692230 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m17:07:21.692984 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m17:07:21.693642 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m17:07:21.694567 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m17:07:21.695188 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m17:07:21.700694 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:21.702290 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 17:07:21.695619 => 17:07:21.701755
[0m17:07:21.702953 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m17:07:21.708472 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:21.709454 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:21.709931 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m17:07:21.710472 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:21.986144 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:21.987844 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:21.988796 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:07:22.047649 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:07:22.054494 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:22.055106 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m17:07:22.088627 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:22.091697 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:22.092017 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m17:07:22.125642 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:22.127428 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:07:22.127717 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:22.127955 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:07:22.160857 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:22.163193 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m17:07:22.163872 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:07:22.164158 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m17:07:22.219370 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:22.221411 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 17:07:21.703290 => 17:07:22.221180
[0m17:07:22.221887 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m17:07:22.223155 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a52f6d0>]}
[0m17:07:22.223914 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.53s]
[0m17:07:22.224603 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m17:07:22.225178 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m17:07:22.225858 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m17:07:22.226740 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m17:07:22.227180 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m17:07:22.230790 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m17:07:22.231679 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 17:07:22.227464 => 17:07:22.231478
[0m17:07:22.232024 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m17:07:22.236133 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m17:07:22.237186 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.237498 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m17:07:22.237782 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:22.512977 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:22.514847 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.515809 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m17:07:22.556105 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m17:07:22.563794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.564615 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m17:07:22.598635 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:22.604569 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.605525 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m17:07:22.640058 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:22.645179 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:07:22.645783 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.646170 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:07:22.679582 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:22.684837 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m17:07:22.686819 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:07:22.687381 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m17:07:22.739905 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:22.743233 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 17:07:22.232231 => 17:07:22.742721
[0m17:07:22.744063 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m17:07:22.745840 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6f4390>]}
[0m17:07:22.746824 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.52s]
[0m17:07:22.747574 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m17:07:22.748166 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m17:07:22.749166 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m17:07:22.750689 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m17:07:22.751259 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m17:07:22.759946 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:22.761277 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 17:07:22.751574 => 17:07:22.760953
[0m17:07:22.761797 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m17:07:22.767419 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:22.768573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:22.768953 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m17:07:22.769283 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:23.190202 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:23.191695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:23.192518 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m17:07:23.234906 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:07:23.241313 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:23.242310 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m17:07:23.302481 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:23.308811 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:23.309649 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m17:07:23.350174 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:23.355298 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:07:23.356176 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:23.356858 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:07:23.396401 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:23.402217 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m17:07:23.403516 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:07:23.404065 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m17:07:23.461085 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:23.464821 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 17:07:22.762097 => 17:07:23.464388
[0m17:07:23.465538 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m17:07:23.466783 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a717b50>]}
[0m17:07:23.467742 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.72s]
[0m17:07:23.468586 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m17:07:23.469186 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m17:07:23.470011 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m17:07:23.471395 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m17:07:23.472038 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m17:07:23.479447 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:23.480865 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 17:07:23.472354 => 17:07:23.480418
[0m17:07:23.481371 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m17:07:23.486088 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:23.487285 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:23.487634 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m17:07:23.487971 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:23.744913 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:23.745919 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:23.746707 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m17:07:33.646625 [debug] [Thread-1 (]: SQL status: SELECT 143304 in 10.0 seconds
[0m17:07:33.655946 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:33.656772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m17:07:33.688570 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:33.695448 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:33.696172 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m17:07:33.728066 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:33.735006 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:07:33.736575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:33.737049 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:07:33.769243 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:33.774287 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m17:07:33.776244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:07:33.777094 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m17:07:33.825412 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:33.829063 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 17:07:23.481626 => 17:07:33.828783
[0m17:07:33.829663 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m17:07:33.832396 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a682410>]}
[0m17:07:33.833888 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143304[0m in 10.36s]
[0m17:07:33.834761 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m17:07:33.835358 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m17:07:33.836150 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m17:07:33.837639 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m17:07:33.838322 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m17:07:33.844343 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:33.846226 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 17:07:33.838715 => 17:07:33.845693
[0m17:07:33.846924 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m17:07:33.854820 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:33.855884 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:33.856235 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m17:07:33.856540 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:34.109471 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:34.110539 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:34.111067 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m17:07:34.144965 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:07:34.156385 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:34.157780 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m17:07:34.189365 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:34.198969 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:34.199654 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m17:07:34.230924 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:34.236474 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:07:34.237484 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:34.238305 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:07:34.269679 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:34.275475 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m17:07:34.277580 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:07:34.278851 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m17:07:34.327176 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:34.330556 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 17:07:33.847227 => 17:07:34.330125
[0m17:07:34.331439 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m17:07:34.333573 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a6d4150>]}
[0m17:07:34.335223 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.50s]
[0m17:07:34.336883 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m17:07:34.337773 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:07:34.338690 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m17:07:34.340026 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m17:07:34.340889 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:07:34.346869 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.348630 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 17:07:34.341263 => 17:07:34.348186
[0m17:07:34.349240 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:07:34.356736 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.357950 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.358219 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m17:07:34.358697 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:34.656245 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:34.657803 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.658532 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m17:07:34.703744 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m17:07:34.711278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.712128 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:07:34.749712 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:34.755898 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.756776 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.793090 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:34.798001 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:07:34.799607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.800155 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:07:34.836124 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:34.842897 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:07:34.845814 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:07:34.846465 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m17:07:34.911519 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:34.912940 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 17:07:34.349546 => 17:07:34.912762
[0m17:07:34.913285 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m17:07:34.914048 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a731a90>]}
[0m17:07:34.914514 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.57s]
[0m17:07:34.914976 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:07:34.915514 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:07:34.915911 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m17:07:34.916370 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m17:07:34.916639 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:07:34.919242 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:34.919875 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 17:07:34.916803 => 17:07:34.919735
[0m17:07:34.920129 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:07:34.922993 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:34.923753 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:34.923995 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m17:07:34.924215 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:35.183347 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:35.184935 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:35.186593 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m17:07:39.789502 [debug] [Thread-1 (]: SQL status: SELECT 37393 in 5.0 seconds
[0m17:07:39.799110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:39.800142 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:07:39.833171 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:39.840224 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:39.840964 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m17:07:39.872623 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:39.875165 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:07:39.875675 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:39.876005 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:07:39.907048 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:39.911198 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:07:39.911867 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:07:39.912155 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m17:07:39.958478 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:39.959998 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 17:07:34.920275 => 17:07:39.959818
[0m17:07:39.960412 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m17:07:39.961153 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a739a90>]}
[0m17:07:39.961649 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37393[0m in 5.04s]
[0m17:07:39.962156 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:07:39.962513 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m17:07:39.963020 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m17:07:39.963660 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m17:07:39.963997 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m17:07:40.018652 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:40.019352 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 17:07:39.964221 => 17:07:40.019244
[0m17:07:40.019532 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m17:07:40.021677 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:40.022196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:40.022398 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m17:07:40.022558 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:40.282782 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:40.284534 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:40.286305 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m17:07:43.270809 [debug] [Thread-1 (]: SQL status: SELECT 114691 in 3.0 seconds
[0m17:07:43.278648 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:43.279388 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m17:07:43.310652 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:43.316069 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:43.317009 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m17:07:43.348898 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:43.355112 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:07:43.356180 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:43.357486 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:07:43.389119 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:43.395700 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m17:07:43.397880 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:07:43.399325 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m17:07:43.448498 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:43.451797 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 17:07:40.019642 => 17:07:43.451466
[0m17:07:43.452499 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m17:07:43.454377 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a73aed0>]}
[0m17:07:43.456493 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114691[0m in 3.49s]
[0m17:07:43.457480 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m17:07:43.458102 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:07:43.459278 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m17:07:43.461360 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m17:07:43.462177 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:07:43.468393 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:43.470004 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 17:07:43.462472 => 17:07:43.469580
[0m17:07:43.470697 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:07:43.478573 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:43.479938 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:43.480531 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m17:07:43.481083 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:43.893153 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:43.895254 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:43.896060 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m17:07:43.998978 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m17:07:44.008312 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:44.009478 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:07:44.053544 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:44.061507 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:44.062482 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m17:07:44.106514 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:44.112189 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:07:44.113053 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:44.113614 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:07:44.157095 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:44.163757 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:07:44.165972 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:07:44.166571 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m17:07:44.229269 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:44.233039 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 17:07:43.471033 => 17:07:44.232708
[0m17:07:44.233739 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m17:07:44.235228 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a739790>]}
[0m17:07:44.236304 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.77s]
[0m17:07:44.237485 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:07:44.238101 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m17:07:44.238912 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test_write ............................... [RUN]
[0m17:07:44.240642 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m17:07:44.241205 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m17:07:44.247486 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m17:07:44.249163 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 17:07:44.241519 => 17:07:44.248643
[0m17:07:44.249819 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m17:07:44.260557 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m17:07:44.262032 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.262568 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m17:07:44.262973 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:44.521976 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:44.523933 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.524769 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m17:07:44.558408 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:07:44.567260 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.568436 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m17:07:44.602805 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:44.609104 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.610317 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m17:07:44.642284 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:44.647289 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:07:44.648018 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.649188 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:07:44.680889 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:44.686967 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m17:07:44.688515 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:07:44.689678 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m17:07:44.737943 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:44.740853 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 17:07:44.250143 => 17:07:44.740102
[0m17:07:44.741666 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m17:07:44.744054 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a493910>]}
[0m17:07:44.745596 [info ] [Thread-1 (]: 12 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.50s]
[0m17:07:44.746474 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m17:07:44.747181 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m17:07:44.747936 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m17:07:44.749070 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m17:07:44.750021 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m17:07:44.757220 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m17:07:44.758826 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 17:07:44.750484 => 17:07:44.758457
[0m17:07:44.759471 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m17:07:44.767554 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m17:07:44.769124 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:44.769701 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m17:07:44.770157 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:45.025898 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:45.027567 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:45.028193 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m17:07:45.254467 [debug] [Thread-1 (]: SQL status: SELECT 55154 in 0.0 seconds
[0m17:07:45.262661 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:45.263601 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m17:07:45.295205 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:45.302192 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:45.303425 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m17:07:45.402941 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:45.407955 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:07:45.408552 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:45.409413 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:07:45.441248 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:45.447774 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m17:07:45.449396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:07:45.449970 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m17:07:45.505907 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:45.510800 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 17:07:44.759877 => 17:07:45.510050
[0m17:07:45.512059 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m17:07:45.513506 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a702110>]}
[0m17:07:45.514298 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55154[0m in 0.76s]
[0m17:07:45.516116 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m17:07:45.516748 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m17:07:45.518484 [info ] [Thread-1 (]: 14 of 17 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m17:07:45.520628 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m17:07:45.521230 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m17:07:45.527064 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.529029 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 17:07:45.521646 => 17:07:45.528576
[0m17:07:45.529941 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m17:07:45.552923 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.554148 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.554551 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m17:07:45.554882 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:45.878469 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:45.879617 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.881004 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m17:07:45.924111 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m17:07:45.932495 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.933274 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m17:07:45.974839 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:45.984229 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:07:45.985090 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:45.985607 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:07:46.025127 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:46.030872 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m17:07:46.038191 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:07:46.039084 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m17:07:46.079018 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m17:07:46.081864 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 17:07:45.530569 => 17:07:46.081532
[0m17:07:46.082872 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m17:07:46.084790 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a651110>]}
[0m17:07:46.086907 [info ] [Thread-1 (]: 14 of 17 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.56s]
[0m17:07:46.087725 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m17:07:46.088654 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:07:46.090146 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m17:07:46.091643 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m17:07:46.092607 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:07:46.100782 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.102443 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 17:07:46.093206 => 17:07:46.102009
[0m17:07:46.103200 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:07:46.111383 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.112465 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.112845 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m17:07:46.113176 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:46.472868 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:46.473925 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.474783 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
where  country_code='at' and date_cet='2024-04-24'
  );
  
[0m17:07:46.545202 [debug] [Thread-1 (]: SQL status: SELECT 45 in 0.0 seconds
[0m17:07:46.552334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.553897 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m17:07:46.599183 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:46.606726 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.608020 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m17:07:46.653158 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:46.658629 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:07:46.660088 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.661397 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:07:46.707087 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:46.712642 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m17:07:46.714356 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:07:46.715370 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m17:07:46.778152 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:46.782048 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 17:07:46.103748 => 17:07:46.781730
[0m17:07:46.782734 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m17:07:46.784253 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a68e3d0>]}
[0m17:07:46.785286 [info ] [Thread-1 (]: 15 of 17 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 45[0m in 0.69s]
[0m17:07:46.786230 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:07:46.787405 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m17:07:46.788265 [info ] [Thread-1 (]: 16 of 17 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m17:07:46.789558 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m17:07:46.790853 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m17:07:46.799160 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:46.801117 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 17:07:46.791257 => 17:07:46.800583
[0m17:07:46.801956 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m17:07:46.810171 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:46.811547 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:46.812101 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m17:07:46.812522 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:47.068894 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:47.070537 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:47.071946 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m17:07:47.162010 [debug] [Thread-1 (]: SQL status: SELECT 45460 in 0.0 seconds
[0m17:07:47.170185 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:47.171524 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m17:07:47.203787 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:47.211054 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:47.212150 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m17:07:47.242901 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:47.249965 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m17:07:47.250707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:47.251252 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m17:07:47.282512 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:47.288138 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m17:07:47.291200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:07:47.291735 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m17:07:47.342158 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:47.345051 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 17:07:46.802490 => 17:07:47.344781
[0m17:07:47.345752 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m17:07:47.347259 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a59ff50>]}
[0m17:07:47.348367 [info ] [Thread-1 (]: 16 of 17 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45460[0m in 0.56s]
[0m17:07:47.349368 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m17:07:47.350160 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m17:07:47.351061 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m17:07:47.353578 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m17:07:47.354396 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m17:07:47.362544 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.364239 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 17:07:47.355233 => 17:07:47.363736
[0m17:07:47.365023 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m17:07:47.376948 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.378004 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.378434 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m17:07:47.378812 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:07:47.656048 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:07:47.656920 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.657453 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m17:07:47.716324 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m17:07:47.724343 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.725311 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m17:07:47.759039 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:47.764218 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.764941 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m17:07:47.798242 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:07:47.805336 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:07:47.806984 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.807425 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:07:47.841509 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:07:47.847785 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m17:07:47.850139 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:07:47.850787 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m17:07:47.902079 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:07:47.905141 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 17:07:47.365534 => 17:07:47.904801
[0m17:07:47.905885 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m17:07:47.907903 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '03482969-6cda-420d-9df4-5a9c55e669ce', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a549d90>]}
[0m17:07:47.908980 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.56s]
[0m17:07:47.909671 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m17:07:47.912554 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:47.913173 [debug] [MainThread]: On master: BEGIN
[0m17:07:47.913615 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:07:48.239056 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:07:48.240199 [debug] [MainThread]: On master: COMMIT
[0m17:07:48.240755 [debug] [MainThread]: Using postgres connection "master"
[0m17:07:48.241117 [debug] [MainThread]: On master: COMMIT
[0m17:07:48.280519 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:07:48.281731 [debug] [MainThread]: On master: Close
[0m17:07:48.283935 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:07:48.285052 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m17:07:48.286391 [info ] [MainThread]: 
[0m17:07:48.287237 [info ] [MainThread]: Finished running 16 table models, 1 view model in 0 hours 0 minutes and 58.56 seconds (58.56s).
[0m17:07:48.291364 [debug] [MainThread]: Command end result
[0m17:07:48.309832 [info ] [MainThread]: 
[0m17:07:48.310599 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:07:48.310996 [info ] [MainThread]: 
[0m17:07:48.311390 [info ] [MainThread]: Done. PASS=17 WARN=0 ERROR=0 SKIP=0 TOTAL=17
[0m17:07:48.314349 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 58.73453, "process_user_time": 2.24197, "process_kernel_time": 0.208988, "process_mem_max_rss": "126976000", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m17:07:48.314974 [debug] [MainThread]: Command `dbt run` succeeded at 17:07:48.314859 after 58.74 seconds
[0m17:07:48.315396 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10572df90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10572ded0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1056a4dd0>]}
[0m17:07:48.315813 [debug] [MainThread]: Flushing usage events
[0m17:08:47.870534 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10972fad0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109784790>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097a3090>]}


============================== 17:08:47.872353 | 126ff3a1-48b1-4461-bbda-eddc1d557fac ==============================
[0m17:08:47.872353 [info ] [MainThread]: Running with dbt=1.7.0
[0m17:08:47.872739 [debug] [MainThread]: running dbt with arguments {'cache_selected_only': 'False', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'introspect': 'True', 'quiet': 'False', 'partial_parse': 'True', 'warn_error': 'None', 'write_json': 'True', 'use_experimental_parser': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'debug': 'False', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'send_anonymous_usage_stats': 'True', 'no_print': 'None', 'printer_width': '80', 'profiles_dir': '/Users/danila/.dbt', 'log_format': 'default', 'version_check': 'True', 'fail_fast': 'False', 'use_colors': 'True', 'invocation_command': 'dbt run', 'target_path': 'None'}
[0m17:08:47.940176 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097868d0>]}
[0m17:08:47.970732 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d17810>]}
[0m17:08:47.971220 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m17:08:47.984339 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m17:08:47.998078 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m17:08:47.998318 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m17:08:47.998845 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m17:08:48.001696 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109747a10>]}
[0m17:08:48.006740 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109e0be10>]}
[0m17:08:48.006976 [info ] [MainThread]: Found 17 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m17:08:48.007151 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097c2610>]}
[0m17:08:48.008198 [info ] [MainThread]: 
[0m17:08:48.008569 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m17:08:48.009300 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m17:08:48.013721 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m17:08:48.013920 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m17:08:48.014074 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m17:08:48.310123 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m17:08:48.312483 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m17:08:48.315786 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m17:08:48.325450 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:08:48.326180 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m17:08:48.326610 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m17:08:48.581672 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m17:08:48.582294 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m17:08:48.582624 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m17:08:48.617485 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m17:08:48.620177 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m17:08:48.651510 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m17:08:48.659351 [debug] [MainThread]: Using postgres connection "master"
[0m17:08:48.659807 [debug] [MainThread]: On master: BEGIN
[0m17:08:48.660165 [debug] [MainThread]: Opening a new connection, currently in state init
[0m17:08:48.933862 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:08:48.934650 [debug] [MainThread]: Using postgres connection "master"
[0m17:08:48.935227 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m17:08:48.978866 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m17:08:48.984362 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108a64c10>]}
[0m17:08:48.985389 [debug] [MainThread]: On master: ROLLBACK
[0m17:08:49.018847 [debug] [MainThread]: Using postgres connection "master"
[0m17:08:49.019450 [debug] [MainThread]: On master: BEGIN
[0m17:08:49.085074 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:08:49.085547 [debug] [MainThread]: On master: COMMIT
[0m17:08:49.085924 [debug] [MainThread]: Using postgres connection "master"
[0m17:08:49.086133 [debug] [MainThread]: On master: COMMIT
[0m17:08:49.119397 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:08:49.119969 [debug] [MainThread]: On master: Close
[0m17:08:49.120554 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m17:08:49.120756 [info ] [MainThread]: 
[0m17:08:49.123150 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m17:08:49.123501 [info ] [Thread-1 (]: 1 of 17 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m17:08:49.123958 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m17:08:49.124173 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m17:08:49.129982 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:08:49.130965 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 17:08:49.124303 => 17:08:49.130797
[0m17:08:49.131165 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m17:08:49.151396 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m17:08:49.152154 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:08:49.152379 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m17:08:49.152571 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:08:49.475601 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:08:49.476980 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:08:49.477779 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m17:09:11.541664 [debug] [Thread-1 (]: SQL status: SELECT 2108 in 22.0 seconds
[0m17:09:11.559166 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:09:11.559966 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m17:09:11.602023 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:11.611500 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:09:11.612637 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m17:09:11.677362 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:11.711926 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:09:11.712700 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:09:11.713213 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m17:09:11.752666 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:11.764643 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m17:09:11.771562 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m17:09:11.772163 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m17:09:11.824682 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:11.829964 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 17:08:49.131274 => 17:09:11.829181
[0m17:09:11.831094 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m17:09:11.833931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109eade50>]}
[0m17:09:11.835326 [info ] [Thread-1 (]: 1 of 17 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2108[0m in 22.71s]
[0m17:09:11.836582 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m17:09:11.837485 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m17:09:11.838672 [info ] [Thread-1 (]: 2 of 17 START sql table model danila.campaign_dim .............................. [RUN]
[0m17:09:11.840070 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m17:09:11.840842 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m17:09:11.846072 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m17:09:11.847849 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 17:09:11.841345 => 17:09:11.847556
[0m17:09:11.848454 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m17:09:11.854620 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m17:09:11.855690 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:11.856193 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m17:09:11.856647 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:12.275402 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:12.277436 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:12.278932 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:09:12.338481 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:09:12.345223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:12.345883 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m17:09:12.406681 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:12.422713 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:12.423854 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m17:09:12.464284 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:12.472054 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:09:12.473507 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:12.474526 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m17:09:12.514985 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:12.524600 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m17:09:12.526934 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m17:09:12.527928 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m17:09:12.584834 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:12.588655 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 17:09:11.848822 => 17:09:12.588190
[0m17:09:12.589629 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m17:09:12.591561 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a03ca50>]}
[0m17:09:12.592895 [info ] [Thread-1 (]: 2 of 17 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.75s]
[0m17:09:12.594228 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m17:09:12.595479 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m17:09:12.596801 [info ] [Thread-1 (]: 3 of 17 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m17:09:12.598553 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m17:09:12.599633 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m17:09:12.606045 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:12.607605 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 17:09:12.600248 => 17:09:12.607308
[0m17:09:12.608201 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m17:09:12.614866 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:12.616610 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:12.617204 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m17:09:12.617669 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:12.916166 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:12.916607 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:12.916921 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m17:09:12.967000 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m17:09:12.970999 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:12.971485 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m17:09:13.002618 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:13.009748 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:13.010439 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m17:09:13.042724 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:13.050105 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:09:13.051123 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:13.051825 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m17:09:13.082789 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:13.093076 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m17:09:13.095428 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m17:09:13.096433 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m17:09:13.150341 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:13.153678 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 17:09:12.608572 => 17:09:13.153205
[0m17:09:13.154744 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m17:09:13.157306 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109fe6690>]}
[0m17:09:13.158949 [info ] [Thread-1 (]: 3 of 17 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.56s]
[0m17:09:13.160591 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m17:09:13.161776 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m17:09:13.163094 [info ] [Thread-1 (]: 4 of 17 START sql table model danila.deals_dim ................................. [RUN]
[0m17:09:13.164489 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m17:09:13.165427 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m17:09:13.171531 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m17:09:13.173148 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 17:09:13.165952 => 17:09:13.172837
[0m17:09:13.173722 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m17:09:13.180186 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m17:09:13.181100 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.181562 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m17:09:13.182003 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:13.505129 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:13.507571 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.509208 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m17:09:13.555648 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m17:09:13.566968 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.568094 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m17:09:13.631711 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:13.641691 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.642754 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m17:09:13.682249 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:13.689798 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:09:13.690873 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.691807 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m17:09:13.731374 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:13.741362 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m17:09:13.744043 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m17:09:13.745033 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m17:09:13.807300 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:13.813444 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 17:09:13.174100 => 17:09:13.812513
[0m17:09:13.814926 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m17:09:13.817634 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a098390>]}
[0m17:09:13.819214 [info ] [Thread-1 (]: 4 of 17 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.65s]
[0m17:09:13.820372 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m17:09:13.821238 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m17:09:13.822465 [info ] [Thread-1 (]: 5 of 17 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m17:09:13.823670 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m17:09:13.824239 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m17:09:13.832579 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:13.834178 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 17:09:13.824624 => 17:09:13.833868
[0m17:09:13.834754 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m17:09:13.840355 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:13.841275 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:13.841730 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m17:09:13.842150 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:14.316140 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:14.318271 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:14.319807 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m17:09:14.362616 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:09:14.375557 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:14.376755 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m17:09:14.417317 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:14.423918 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:14.424588 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m17:09:14.464921 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:14.473018 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:09:14.474456 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:14.475786 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m17:09:14.515561 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:14.525608 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m17:09:14.527974 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m17:09:14.528997 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m17:09:14.586544 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:14.591599 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 17:09:13.835179 => 17:09:14.590840
[0m17:09:14.593032 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m17:09:14.596495 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a072890>]}
[0m17:09:14.598281 [info ] [Thread-1 (]: 5 of 17 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.77s]
[0m17:09:14.599871 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m17:09:14.601032 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m17:09:14.602538 [info ] [Thread-1 (]: 6 of 17 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m17:09:14.604255 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m17:09:14.605335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m17:09:14.613702 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:14.615414 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 17:09:14.605904 => 17:09:14.615051
[0m17:09:14.616061 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m17:09:14.623116 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:14.624192 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:14.624672 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m17:09:14.625107 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:14.929860 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:14.931486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:14.932592 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m17:09:25.158855 [debug] [Thread-1 (]: SQL status: SELECT 143326 in 10.0 seconds
[0m17:09:25.170614 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:25.171772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m17:09:25.208894 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:25.214388 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:25.215073 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m17:09:25.252152 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:25.260178 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:09:25.260665 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:25.261087 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m17:09:25.297358 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:25.302853 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m17:09:25.305877 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m17:09:25.307002 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m17:09:25.359871 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:25.364576 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 17:09:14.616476 => 17:09:25.364177
[0m17:09:25.365398 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m17:09:25.368093 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ef9010>]}
[0m17:09:25.369782 [info ] [Thread-1 (]: 6 of 17 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143326[0m in 10.76s]
[0m17:09:25.371362 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m17:09:25.372533 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m17:09:25.373540 [info ] [Thread-1 (]: 7 of 17 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m17:09:25.375628 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m17:09:25.376845 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m17:09:25.383655 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.384857 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 17:09:25.377556 => 17:09:25.384571
[0m17:09:25.385374 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m17:09:25.391840 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.393048 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.393526 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m17:09:25.393937 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:25.684818 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:25.686379 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.686989 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m17:09:25.720988 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:09:25.734173 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.734973 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m17:09:25.766237 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:25.771305 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.771771 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m17:09:25.804316 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:25.808433 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:09:25.809228 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.810146 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m17:09:25.841415 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:25.850636 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m17:09:25.852933 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m17:09:25.853994 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m17:09:25.902850 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:25.907505 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 17:09:25.385726 => 17:09:25.906778
[0m17:09:25.908885 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m17:09:25.912103 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a027890>]}
[0m17:09:25.914112 [info ] [Thread-1 (]: 7 of 17 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.54s]
[0m17:09:25.915816 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m17:09:25.916987 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:09:25.918396 [info ] [Thread-1 (]: 8 of 17 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m17:09:25.920198 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m17:09:25.921234 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:09:25.927640 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:25.929176 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 17:09:25.922103 => 17:09:25.928864
[0m17:09:25.929786 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:09:25.936009 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:25.937456 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:25.938009 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m17:09:25.938784 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:26.198945 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:26.201196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.202385 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m17:09:26.241228 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m17:09:26.250821 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.251724 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:09:26.298250 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:26.304889 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.305607 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.336848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:26.342407 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:09:26.343318 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.344001 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m17:09:26.374706 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:26.379882 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m17:09:26.381670 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m17:09:26.382858 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m17:09:26.434494 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:26.435688 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 17:09:25.930193 => 17:09:26.435556
[0m17:09:26.435955 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m17:09:26.436511 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a048b10>]}
[0m17:09:26.436849 [info ] [Thread-1 (]: 8 of 17 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.52s]
[0m17:09:26.437254 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m17:09:26.437504 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:09:26.438036 [info ] [Thread-1 (]: 9 of 17 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m17:09:26.438574 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m17:09:26.438809 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:09:26.440983 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:26.441506 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 17:09:26.439037 => 17:09:26.441390
[0m17:09:26.441707 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:09:26.444073 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:26.444639 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:26.444853 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m17:09:26.445050 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:26.698643 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:26.700036 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:26.701509 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m17:09:31.814793 [debug] [Thread-1 (]: SQL status: SELECT 37393 in 5.0 seconds
[0m17:09:31.823161 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:31.824077 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:09:31.856023 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:31.866311 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:31.866939 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m17:09:31.897940 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:31.902086 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:09:31.902912 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:31.903801 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m17:09:31.934931 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:31.948049 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m17:09:31.951144 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m17:09:31.952172 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m17:09:31.997979 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:32.000332 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 17:09:26.441823 => 17:09:32.000029
[0m17:09:32.000924 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m17:09:32.002739 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a093010>]}
[0m17:09:32.003979 [info ] [Thread-1 (]: 9 of 17 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37393[0m in 5.56s]
[0m17:09:32.005248 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m17:09:32.006248 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m17:09:32.007273 [info ] [Thread-1 (]: 10 of 17 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m17:09:32.008663 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m17:09:32.009408 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m17:09:32.062355 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:32.063177 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 17:09:32.009856 => 17:09:32.063004
[0m17:09:32.063482 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m17:09:32.066305 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:32.066713 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:32.066954 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m17:09:32.067185 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:32.568882 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m17:09:32.570931 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:32.572762 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m17:09:36.627652 [debug] [Thread-1 (]: SQL status: SELECT 114712 in 4.0 seconds
[0m17:09:36.639307 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:36.640926 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m17:09:36.672600 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:36.679353 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:36.680171 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m17:09:36.711290 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:36.719543 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:09:36.720374 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:36.721123 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m17:09:36.752630 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:36.762741 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m17:09:36.765870 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m17:09:36.767118 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m17:09:36.815700 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:36.820905 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 17:09:32.063653 => 17:09:36.820142
[0m17:09:36.822362 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m17:09:36.825703 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cf1d50>]}
[0m17:09:36.827741 [info ] [Thread-1 (]: 10 of 17 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 114712[0m in 4.82s]
[0m17:09:36.829789 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m17:09:36.831190 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:09:36.832603 [info ] [Thread-1 (]: 11 of 17 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m17:09:36.834638 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m17:09:36.835606 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:09:36.841860 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:36.843219 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 17:09:36.836113 => 17:09:36.842891
[0m17:09:36.843882 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:09:36.850463 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:36.851706 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:36.852228 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m17:09:36.852687 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:37.113678 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:37.115215 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:37.116217 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m17:09:37.208617 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m17:09:37.217291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:37.219057 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:09:37.250994 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:37.259713 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:37.261242 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m17:09:37.293450 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:37.301266 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:09:37.302994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:37.304272 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m17:09:37.336084 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:37.344165 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m17:09:37.345582 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m17:09:37.346336 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m17:09:37.397002 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:37.400854 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 17:09:36.844253 => 17:09:37.400176
[0m17:09:37.402038 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m17:09:37.404997 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10973da90>]}
[0m17:09:37.407008 [info ] [Thread-1 (]: 11 of 17 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.57s]
[0m17:09:37.409168 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m17:09:37.410823 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m17:09:37.412887 [info ] [Thread-1 (]: 12 of 17 START sql table model danila.test_write ............................... [RUN]
[0m17:09:37.415216 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m17:09:37.416309 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m17:09:37.422874 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m17:09:37.424322 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 17:09:37.417008 => 17:09:37.423986
[0m17:09:37.424961 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m17:09:37.436484 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m17:09:37.437602 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:37.438122 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m17:09:37.438571 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:37.788702 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:37.789427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:37.790087 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m17:09:37.835734 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m17:09:37.844359 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:37.845696 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m17:09:37.890756 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:37.901622 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:37.903142 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m17:09:37.947247 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:37.954766 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:09:37.956151 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:37.957432 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m17:09:38.001589 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:38.006380 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m17:09:38.007472 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m17:09:38.007905 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m17:09:38.066940 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:38.070473 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 17:09:37.425376 => 17:09:38.069937
[0m17:09:38.071863 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m17:09:38.074371 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d93310>]}
[0m17:09:38.075928 [info ] [Thread-1 (]: 12 of 17 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.66s]
[0m17:09:38.077461 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m17:09:38.078612 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m17:09:38.079923 [info ] [Thread-1 (]: 13 of 17 START sql table model danila.outclicks_fct ............................ [RUN]
[0m17:09:38.081435 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m17:09:38.082270 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m17:09:38.088055 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.089392 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 17:09:38.082807 => 17:09:38.089092
[0m17:09:38.090077 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m17:09:38.098324 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.099611 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.100109 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m17:09:38.100580 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:38.359646 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:38.361451 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.363015 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m17:09:38.624880 [debug] [Thread-1 (]: SQL status: SELECT 55157 in 0.0 seconds
[0m17:09:38.631506 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.632246 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m17:09:38.663619 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:38.670378 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.671651 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m17:09:38.704440 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:38.712153 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:09:38.713285 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.714293 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m17:09:38.745430 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:38.754912 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m17:09:38.758055 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m17:09:38.759421 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m17:09:38.815221 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:38.820053 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 17:09:38.090493 => 17:09:38.819325
[0m17:09:38.821503 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m17:09:38.824072 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d30690>]}
[0m17:09:38.825576 [info ] [Thread-1 (]: 13 of 17 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55157[0m in 0.74s]
[0m17:09:38.827066 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m17:09:38.828216 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m17:09:38.829866 [info ] [Thread-1 (]: 14 of 17 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m17:09:38.831336 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m17:09:38.832089 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m17:09:38.836971 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:38.838511 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 17:09:38.832609 => 17:09:38.838225
[0m17:09:38.839049 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m17:09:38.860796 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:38.861705 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:38.862066 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m17:09:38.862394 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:39.120454 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:39.121888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:39.123316 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m17:09:39.158309 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m17:09:39.168068 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:39.169268 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m17:09:39.200433 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:39.206067 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:09:39.206737 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:39.207287 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m17:09:39.238431 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:39.243567 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m17:09:39.253037 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m17:09:39.254063 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m17:09:39.285542 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m17:09:39.287821 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 17:09:38.839528 => 17:09:39.287526
[0m17:09:39.288459 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m17:09:39.289997 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097a3110>]}
[0m17:09:39.290945 [info ] [Thread-1 (]: 14 of 17 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.46s]
[0m17:09:39.291887 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m17:09:39.292752 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:09:39.293543 [info ] [Thread-1 (]: 15 of 17 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m17:09:39.294630 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m17:09:39.295536 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:09:39.303536 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.305361 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 17:09:39.296013 => 17:09:39.304975
[0m17:09:39.306124 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:09:39.314160 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.315783 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.316351 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m17:09:39.316838 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:39.571879 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:39.573334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.574334 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
--where  country_code='at' and date_cet='2024-04-24'
  );
  
[0m17:09:39.904284 [debug] [Thread-1 (]: SQL status: SELECT 152105 in 0.0 seconds
[0m17:09:39.915011 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.916048 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m17:09:39.947734 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:39.956078 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.957167 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m17:09:39.988829 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:39.996365 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:09:39.997855 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:39.999238 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m17:09:40.031323 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:40.036775 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m17:09:40.038601 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m17:09:40.039381 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m17:09:40.092227 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:40.097102 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 17:09:39.306640 => 17:09:40.096351
[0m17:09:40.098898 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m17:09:40.102128 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109ff6f10>]}
[0m17:09:40.103841 [info ] [Thread-1 (]: 15 of 17 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 152105[0m in 0.81s]
[0m17:09:40.105366 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m17:09:40.106544 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m17:09:40.107908 [info ] [Thread-1 (]: 16 of 17 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m17:09:40.109793 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m17:09:40.110910 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m17:09:40.119272 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.121181 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 17:09:40.111512 => 17:09:40.120786
[0m17:09:40.121880 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m17:09:40.129998 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.131093 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.131516 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m17:09:40.131911 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:40.392284 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:40.394077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.395909 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m17:09:40.519378 [debug] [Thread-1 (]: SQL status: SELECT 45460 in 0.0 seconds
[0m17:09:40.529901 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.531028 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m17:09:40.578784 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:40.588656 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.590358 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m17:09:40.622529 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:40.630482 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m17:09:40.632197 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.633651 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m17:09:40.665429 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:40.674744 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m17:09:40.677175 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m17:09:40.678209 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m17:09:40.733969 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:40.738749 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 17:09:40.122310 => 17:09:40.737953
[0m17:09:40.739866 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m17:09:40.742079 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a0792d0>]}
[0m17:09:40.743472 [info ] [Thread-1 (]: 16 of 17 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45460[0m in 0.63s]
[0m17:09:40.744954 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m17:09:40.746092 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m17:09:40.747275 [info ] [Thread-1 (]: 17 of 17 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m17:09:40.748796 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m17:09:40.749667 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m17:09:40.754762 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:40.756165 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 17:09:40.750197 => 17:09:40.755903
[0m17:09:40.756712 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m17:09:40.766584 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:40.767870 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:40.768392 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m17:09:40.768857 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m17:09:41.024729 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m17:09:41.025964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:41.027102 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m17:09:41.091060 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m17:09:41.103110 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:41.104622 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m17:09:41.136000 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:41.144957 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:41.145583 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m17:09:41.176767 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m17:09:41.181276 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:09:41.182017 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:41.182722 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m17:09:41.213724 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m17:09:41.222537 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m17:09:41.224888 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m17:09:41.225897 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m17:09:41.278924 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m17:09:41.283627 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 17:09:40.757103 => 17:09:41.282840
[0m17:09:41.285070 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m17:09:41.287941 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '126ff3a1-48b1-4461-bbda-eddc1d557fac', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109d01f90>]}
[0m17:09:41.289817 [info ] [Thread-1 (]: 17 of 17 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.54s]
[0m17:09:41.291433 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m17:09:41.294824 [debug] [MainThread]: Using postgres connection "master"
[0m17:09:41.295677 [debug] [MainThread]: On master: BEGIN
[0m17:09:41.296476 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m17:09:41.553586 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m17:09:41.554718 [debug] [MainThread]: On master: COMMIT
[0m17:09:41.555419 [debug] [MainThread]: Using postgres connection "master"
[0m17:09:41.556051 [debug] [MainThread]: On master: COMMIT
[0m17:09:41.586591 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m17:09:41.588112 [debug] [MainThread]: On master: Close
[0m17:09:41.590333 [debug] [MainThread]: Connection 'master' was properly closed.
[0m17:09:41.590836 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m17:09:41.592019 [info ] [MainThread]: 
[0m17:09:41.592588 [info ] [MainThread]: Finished running 16 table models, 1 view model in 0 hours 0 minutes and 53.58 seconds (53.58s).
[0m17:09:41.599988 [debug] [MainThread]: Command end result
[0m17:09:41.616119 [info ] [MainThread]: 
[0m17:09:41.616858 [info ] [MainThread]: [32mCompleted successfully[0m
[0m17:09:41.617248 [info ] [MainThread]: 
[0m17:09:41.617633 [info ] [MainThread]: Done. PASS=17 WARN=0 ERROR=0 SKIP=0 TOTAL=17
[0m17:09:41.620889 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 53.773888, "process_user_time": 2.450799, "process_kernel_time": 0.24586, "process_mem_max_rss": "127369216", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m17:09:41.621626 [debug] [MainThread]: Command `dbt run` succeeded at 17:09:41.621465 after 53.77 seconds
[0m17:09:41.622096 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050b1f90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1050b2010>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109cbc210>]}
[0m17:09:41.622537 [debug] [MainThread]: Flushing usage events
[0m21:44:15.265656 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad08e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad0a6d0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10ad7ec10>]}


============================== 21:44:15.267413 | b4047557-4af5-4780-a4b1-d31f54512be1 ==============================
[0m21:44:15.267413 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:44:15.267768 [debug] [MainThread]: running dbt with arguments {'partial_parse': 'True', 'cache_selected_only': 'False', 'version_check': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'send_anonymous_usage_stats': 'True', 'profiles_dir': '/Users/danila/.dbt', 'write_json': 'True', 'use_experimental_parser': 'False', 'quiet': 'False', 'log_cache_events': 'False', 'target_path': 'None', 'introspect': 'True', 'fail_fast': 'False', 'indirect_selection': 'eager', 'printer_width': '80', 'log_format': 'default', 'static_parser': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'debug': 'False', 'no_print': 'None', 'invocation_command': 'dbt run', 'use_colors': 'True', 'warn_error': 'None'}
[0m21:44:15.338536 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b30da50>]}
[0m21:44:15.368496 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b27bc90>]}
[0m21:44:15.369025 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:44:15.376233 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:44:15.390016 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:44:15.390303 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:44:15.390843 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:44:15.393456 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b4ecfd0>]}
[0m21:44:15.398890 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b350610>]}
[0m21:44:15.399125 [info ] [MainThread]: Found 18 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:44:15.399313 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b27fc90>]}
[0m21:44:15.400361 [info ] [MainThread]: 
[0m21:44:15.400720 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:44:15.401407 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:44:15.405782 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:44:15.406011 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:44:15.406172 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:44:15.803447 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:44:15.808084 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:44:15.812469 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:44:15.820835 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:44:15.821384 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:44:15.821790 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:44:16.169462 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:44:16.170461 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:44:16.171160 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:44:16.218818 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:44:16.222996 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:44:16.265013 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:44:16.282245 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:16.282896 [debug] [MainThread]: On master: BEGIN
[0m21:44:16.283311 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:44:16.540112 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:16.542017 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:16.543643 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:44:16.586482 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:44:16.593788 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2627d0>]}
[0m21:44:16.594704 [debug] [MainThread]: On master: ROLLBACK
[0m21:44:16.625154 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:16.625866 [debug] [MainThread]: On master: BEGIN
[0m21:44:16.687458 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:44:16.689210 [debug] [MainThread]: On master: COMMIT
[0m21:44:16.690414 [debug] [MainThread]: Using postgres connection "master"
[0m21:44:16.691312 [debug] [MainThread]: On master: COMMIT
[0m21:44:16.722160 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:44:16.723507 [debug] [MainThread]: On master: Close
[0m21:44:16.726352 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:44:16.727229 [info ] [MainThread]: 
[0m21:44:16.733294 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:44:16.734157 [info ] [Thread-1 (]: 1 of 18 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:44:16.735236 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:44:16.735765 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:44:16.748309 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:16.749178 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:44:16.736104 => 21:44:16.748950
[0m21:44:16.749564 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:44:16.775584 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:16.776244 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:16.776488 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:44:16.776708 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:17.034506 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:17.036632 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:17.038250 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:44:36.947346 [debug] [Thread-1 (]: SQL status: SELECT 2110 in 20.0 seconds
[0m21:44:36.961198 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:36.962075 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:44:36.993410 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:37.000219 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:37.001123 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:44:37.033221 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:37.061450 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:37.062172 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:37.062545 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:44:37.094080 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:37.100810 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:44:37.105227 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:44:37.105580 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:44:37.149362 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:37.151871 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:44:16.749775 => 21:44:37.151541
[0m21:44:37.152415 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:44:37.153547 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b30c4d0>]}
[0m21:44:37.154322 [info ] [Thread-1 (]: 1 of 18 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2110[0m in 20.42s]
[0m21:44:37.155025 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:44:37.155500 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:44:37.156200 [info ] [Thread-1 (]: 2 of 18 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:44:37.157007 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:44:37.157436 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:44:37.160654 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:44:37.161579 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:44:37.157702 => 21:44:37.161382
[0m21:44:37.161935 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:44:37.165766 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:44:37.166444 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.166754 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:44:37.167019 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:37.452686 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:37.454619 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.455461 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:37.503806 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m21:44:37.511126 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.511871 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:44:37.543963 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:37.555060 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.555828 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:44:37.587642 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:37.593398 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:37.594364 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.595151 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:44:37.626822 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:37.634523 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:44:37.636344 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:44:37.637134 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:44:37.686130 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:37.690524 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:44:37.162140 => 21:44:37.690026
[0m21:44:37.691500 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:44:37.693538 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b66a090>]}
[0m21:44:37.694533 [info ] [Thread-1 (]: 2 of 18 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.54s]
[0m21:44:37.695490 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:44:37.696157 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:37.697049 [info ] [Thread-1 (]: 3 of 18 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:44:37.698125 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:44:37.698632 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:44:37.703623 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:37.704996 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:44:37.698946 => 21:44:37.704683
[0m21:44:37.705497 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:44:37.710064 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:37.710789 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:37.711134 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:44:37.711458 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:38.014177 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:38.015707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:38.016654 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:44:38.073765 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m21:44:38.082673 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:38.083570 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:44:38.121294 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:38.128436 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:38.129199 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:44:38.166112 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:38.170129 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:38.170766 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:38.171306 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:44:38.207724 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:38.209723 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:44:38.210278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:44:38.210505 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:44:38.265058 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:38.266324 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:44:37.705761 => 21:44:38.266129
[0m21:44:38.266684 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:44:38.267445 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b659750>]}
[0m21:44:38.267960 [info ] [Thread-1 (]: 3 of 18 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.57s]
[0m21:44:38.268481 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:44:38.268877 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:44:38.269376 [info ] [Thread-1 (]: 4 of 18 START sql table model danila.deals_dim ................................. [RUN]
[0m21:44:38.270056 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:44:38.270409 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:44:38.273112 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:44:38.273730 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:44:38.270626 => 21:44:38.273564
[0m21:44:38.274025 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:44:38.277239 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:44:38.277774 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.278055 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:44:38.278313 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:38.531467 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:38.533196 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.533986 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:44:38.572162 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m21:44:38.579518 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.580089 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:44:38.611106 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:38.616992 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.617768 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:44:38.648515 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:38.652782 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:38.653520 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.654189 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:44:38.685911 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:38.693044 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:44:38.694424 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:44:38.694954 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:44:38.743969 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:38.748282 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:44:38.274200 => 21:44:38.747819
[0m21:44:38.749055 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:44:38.750931 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b67c710>]}
[0m21:44:38.751968 [info ] [Thread-1 (]: 4 of 18 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.48s]
[0m21:44:38.752843 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:44:38.753671 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:38.754523 [info ] [Thread-1 (]: 5 of 18 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:44:38.755430 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:44:38.755892 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:44:38.763389 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:38.764411 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:44:38.756191 => 21:44:38.764157
[0m21:44:38.764855 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:44:38.769384 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:38.770024 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:38.770354 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:44:38.770665 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:39.048111 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:39.050133 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:39.051273 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:44:39.085888 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:39.093590 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:39.094163 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:44:39.125848 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:39.132596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:39.133375 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:44:39.164878 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:39.169746 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:39.170574 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:39.171276 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:44:39.203270 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:39.210491 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:44:39.211798 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:44:39.212341 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:44:39.261071 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:39.265221 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:44:38.765115 => 21:44:39.264720
[0m21:44:39.266049 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:44:39.267855 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b53cf90>]}
[0m21:44:39.268784 [info ] [Thread-1 (]: 5 of 18 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.51s]
[0m21:44:39.269638 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:44:39.270295 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:39.271256 [info ] [Thread-1 (]: 6 of 18 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:44:39.272257 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:44:39.272770 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:39.279629 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:39.280609 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:44:39.273082 => 21:44:39.280371
[0m21:44:39.281052 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:39.285703 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:39.286306 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:39.286624 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:44:39.286924 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:39.564226 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:39.566302 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:39.567125 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:44:46.775029 [debug] [Thread-1 (]: SQL status: SELECT 143734 in 7.0 seconds
[0m21:44:46.781555 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:46.782297 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:44:46.816473 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:46.822904 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:46.823761 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:44:46.857484 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:46.862076 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:46.862940 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:46.863697 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:44:46.898135 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:46.905002 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:44:46.906718 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:44:46.907422 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:44:46.956730 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:46.960921 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:44:39.281312 => 21:44:46.960523
[0m21:44:46.961720 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:44:46.963394 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b6baa50>]}
[0m21:44:46.964346 [info ] [Thread-1 (]: 6 of 18 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143734[0m in 7.69s]
[0m21:44:46.965227 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:44:46.965916 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:46.966790 [info ] [Thread-1 (]: 7 of 18 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:44:46.967765 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:44:46.968292 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:46.972252 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:46.973774 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:44:46.968602 => 21:44:46.973454
[0m21:44:46.974268 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:46.978997 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:46.979784 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:46.980177 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:44:46.980497 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:47.238116 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:47.240184 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:47.241358 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:44:47.274901 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:47.285444 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:47.286078 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:44:47.318030 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:47.323369 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:47.324057 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:44:47.355110 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:47.357772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:47.358243 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:47.358677 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:44:47.389336 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:47.396113 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:44:47.398040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:44:47.398885 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:44:47.447889 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:47.452006 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:44:46.974522 => 21:44:47.451555
[0m21:44:47.452910 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:44:47.454905 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b45d710>]}
[0m21:44:47.455931 [info ] [Thread-1 (]: 7 of 18 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.49s]
[0m21:44:47.456873 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:44:47.457687 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:47.458620 [info ] [Thread-1 (]: 8 of 18 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:44:47.459822 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:44:47.460433 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:47.465253 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.466520 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:44:47.460803 => 21:44:47.466219
[0m21:44:47.467023 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:47.471749 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.472419 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.472759 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:44:47.473071 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:47.748852 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:47.750819 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.751785 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:44:47.791389 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:44:47.799697 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.800296 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:47.833540 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:47.838133 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.838694 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.871538 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:47.875390 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:47.876200 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.876947 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:44:47.910529 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:47.917046 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:44:47.918765 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:44:47.919373 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:44:47.971344 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:47.975353 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:44:47.467310 => 21:44:47.974914
[0m21:44:47.976190 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:44:47.978139 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b40ea90>]}
[0m21:44:47.979089 [info ] [Thread-1 (]: 8 of 18 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.52s]
[0m21:44:47.980027 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:44:47.980722 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:44:47.981502 [info ] [Thread-1 (]: 9 of 18 START sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [RUN]
[0m21:44:47.982417 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name)
[0m21:44:47.982908 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:44:47.988147 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:44:47.989613 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (compile): 21:44:47.983220 => 21:44:47.989297
[0m21:44:47.990104 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:44:47.994576 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:44:47.995374 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:44:47.995771 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: BEGIN
[0m21:44:47.996092 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:48.358180 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:48.359598 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:44:48.360413 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, country_code, campaign_vertical
  );
  
[0m21:44:48.401350 [debug] [Thread-1 (]: Postgres adapter: Postgres error: column "matomo_actions.eventname" must appear in the GROUP BY clause or be used in an aggregate function
LINE 24:     "right"(matomo_actions.eventname::text, length(matomo_ac...
                     ^

[0m21:44:48.402617 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: ROLLBACK
[0m21:44:48.440626 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (execute): 21:44:47.990348 => 21:44:48.439973
[0m21:44:48.441768 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: Close
[0m21:44:48.457490 [debug] [Thread-1 (]: Database Error in model stg_matomo_actions_visits__aggregated_wo_brand_name (models/staging/stg_matomo_actions_visits__aggregated_wo_brand_name.sql)
  column "matomo_actions.eventname" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 24:     "right"(matomo_actions.eventname::text, length(matomo_ac...
                       ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_matomo_actions_visits__aggregated_wo_brand_name.sql
[0m21:44:48.458218 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b659150>]}
[0m21:44:48.459069 [error] [Thread-1 (]: 9 of 18 ERROR creating sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [[31mERROR[0m in 0.48s]
[0m21:44:48.460130 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:44:48.460863 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:48.461678 [info ] [Thread-1 (]: 10 of 18 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:44:48.462582 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:44:48.463074 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:48.468197 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:48.469530 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:44:48.463384 => 21:44:48.469047
[0m21:44:48.470294 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:48.475741 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:48.476731 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:48.477175 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:44:48.477561 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:48.765673 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:48.767639 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:48.769612 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m21:44:53.533533 [debug] [Thread-1 (]: SQL status: SELECT 37418 in 5.0 seconds
[0m21:44:53.547824 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:53.548891 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:53.580534 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:53.634425 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:53.634793 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:44:53.665323 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:53.667018 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:53.667315 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:53.667576 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:44:53.698214 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:53.703678 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:44:53.704991 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:44:53.705526 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:44:53.750495 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:53.752884 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:44:48.470642 => 21:44:53.752649
[0m21:44:53.754248 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:44:53.757183 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b2f7290>]}
[0m21:44:53.759185 [info ] [Thread-1 (]: 10 of 18 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37418[0m in 5.29s]
[0m21:44:53.761320 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:44:53.762557 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:53.763167 [info ] [Thread-1 (]: 11 of 18 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:44:53.763878 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:44:53.764431 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:44:53.773533 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:53.775251 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:44:53.765234 => 21:44:53.774831
[0m21:44:53.776518 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:44:53.782836 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:53.783929 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:53.784344 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:44:53.784710 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:54.040629 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:54.042512 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:54.044252 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m21:44:57.016099 [debug] [Thread-1 (]: SQL status: SELECT 115115 in 3.0 seconds
[0m21:44:57.029150 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:57.030410 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:44:57.062662 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:57.072943 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:57.074067 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:44:57.105283 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:57.113478 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:57.114804 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:57.115769 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:44:57.147995 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:57.157643 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:44:57.159972 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:44:57.160991 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:44:57.208167 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:57.213149 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:44:53.776907 => 21:44:57.212397
[0m21:44:57.214571 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:44:57.217666 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b639150>]}
[0m21:44:57.219601 [info ] [Thread-1 (]: 11 of 18 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 115115[0m in 3.45s]
[0m21:44:57.221147 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:44:57.222259 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:57.223729 [info ] [Thread-1 (]: 12 of 18 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:44:57.225472 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:44:57.226540 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:57.234153 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.235952 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:44:57.227227 => 21:44:57.235575
[0m21:44:57.236715 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:57.243058 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.244376 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.245019 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:44:57.245502 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:57.535103 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:57.537338 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.539212 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:44:57.614732 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m21:44:57.621334 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.621994 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:57.653551 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:57.661277 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.662380 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:44:57.694823 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:57.702745 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:57.703843 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.704827 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:44:57.735667 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:57.749336 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:44:57.751548 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:44:57.752335 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:44:57.803569 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:57.808499 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:44:57.237136 => 21:44:57.807747
[0m21:44:57.809867 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:44:57.812211 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b46b610>]}
[0m21:44:57.813713 [info ] [Thread-1 (]: 12 of 18 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.59s]
[0m21:44:57.815268 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:44:57.816427 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:44:57.817864 [info ] [Thread-1 (]: 13 of 18 START sql table model danila.test_write ............................... [RUN]
[0m21:44:57.819195 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:44:57.819903 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:44:57.824991 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:44:57.826542 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:44:57.820382 => 21:44:57.826278
[0m21:44:57.827053 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:44:57.832602 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:44:57.834093 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:57.834843 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:44:57.835311 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:58.093905 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:58.095999 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:58.097479 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:44:58.132122 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:44:58.144420 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:58.145586 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:44:58.178055 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:58.186287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:58.187105 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:44:58.218506 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:58.220855 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:58.221258 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:58.221594 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:44:58.251638 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:58.253541 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:44:58.254131 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:44:58.254387 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:44:58.302253 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:58.303621 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:44:57.827383 => 21:44:58.303399
[0m21:44:58.304029 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:44:58.304894 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b650bd0>]}
[0m21:44:58.305469 [info ] [Thread-1 (]: 13 of 18 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m21:44:58.306062 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:44:58.306511 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:44:58.307047 [info ] [Thread-1 (]: 14 of 18 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:44:58.307795 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:44:58.308200 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:44:58.311671 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:58.312517 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:44:58.308448 => 21:44:58.312293
[0m21:44:58.312914 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:44:58.316543 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:44:58.317162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:58.317491 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:44:58.317809 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:58.595204 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:58.597357 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:58.598890 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:44:59.165812 [debug] [Thread-1 (]: SQL status: SELECT 55505 in 1.0 seconds
[0m21:44:59.176679 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:59.177674 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:44:59.211962 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:59.222394 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:59.223466 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:44:59.257835 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:59.265478 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:59.266828 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:59.267758 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:44:59.301410 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:59.311982 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:44:59.314566 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:44:59.315626 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:44:59.365698 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:44:59.370825 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:44:58.313119 => 21:44:59.370074
[0m21:44:59.372213 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:44:59.374612 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b444c50>]}
[0m21:44:59.376129 [info ] [Thread-1 (]: 14 of 18 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55505[0m in 1.07s]
[0m21:44:59.377628 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:44:59.378766 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:59.380022 [info ] [Thread-1 (]: 15 of 18 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:44:59.381313 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m21:44:59.382016 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:44:59.387175 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.388672 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:44:59.382525 => 21:44:59.388392
[0m21:44:59.389230 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:44:59.413817 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.414656 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.415002 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:44:59.415292 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:44:59.673230 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:44:59.675308 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.676777 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:44:59.711800 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:44:59.723896 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.725400 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:44:59.757264 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:44:59.764336 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:59.765702 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.767047 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:44:59.798763 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:44:59.807766 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:44:59.818042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:44:59.819199 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:44:59.851140 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:44:59.856377 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:44:59.389598 => 21:44:59.855617
[0m21:44:59.857804 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:44:59.860908 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b6e44d0>]}
[0m21:44:59.862662 [info ] [Thread-1 (]: 15 of 18 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.48s]
[0m21:44:59.864174 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:44:59.865293 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:59.866608 [info ] [Thread-1 (]: 16 of 18 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:44:59.868386 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:44:59.869378 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:59.876569 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:59.878132 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:44:59.869937 => 21:44:59.877868
[0m21:44:59.878682 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:44:59.885667 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:59.886715 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:44:59.887188 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:44:59.887622 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:45:00.215698 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:45:00.217690 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:45:00.219484 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
--where  country_code='at' and date_cet='2024-04-24'

-- select country_code, sum(outclicks)
-- from danila.outclick_by_brand_int_new
-- where country_code='at'
-- and date_cet='2024-04-24'
-- group by country_code
  );
  
[0m21:45:00.499275 [debug] [Thread-1 (]: SQL status: SELECT 152533 in 0.0 seconds
[0m21:45:00.512021 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:45:00.513234 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:45:00.554542 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:45:00.564162 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:45:00.565233 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:45:00.606052 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:45:00.613917 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:45:00.614991 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:45:00.615958 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:45:00.656498 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:45:00.666496 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:45:00.668993 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:45:00.670010 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:45:00.733240 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:45:00.738327 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:44:59.879047 => 21:45:00.737618
[0m21:45:00.739378 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:45:00.741724 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b42cc50>]}
[0m21:45:00.743174 [info ] [Thread-1 (]: 16 of 18 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 152533[0m in 0.87s]
[0m21:45:00.744652 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:45:00.745768 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:45:00.746789 [info ] [Thread-1 (]: 17 of 18 SKIP relation danila.outclick_cost_int_new ............................ [[33mSKIP[0m]
[0m21:45:00.747786 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:45:00.748636 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:45:00.749604 [info ] [Thread-1 (]: 18 of 18 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:45:00.750875 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:45:00.751455 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:45:00.756565 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:00.758038 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:45:00.751835 => 21:45:00.757770
[0m21:45:00.758561 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:45:00.765563 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:00.766653 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:00.767129 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:45:00.767563 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:45:01.029720 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:45:01.031486 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:01.033034 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:45:01.094844 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m21:45:01.105635 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:01.106757 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:45:01.138248 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:45:01.147866 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:01.148670 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:45:01.179889 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:45:01.188251 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:45:01.189208 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:01.190010 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:45:01.221050 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:45:01.226865 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:45:01.228706 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:45:01.229482 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:45:01.279069 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:45:01.281815 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:45:00.758917 => 21:45:01.281407
[0m21:45:01.282644 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:45:01.284820 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'b4047557-4af5-4780-a4b1-d31f54512be1', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10b435550>]}
[0m21:45:01.285769 [info ] [Thread-1 (]: 18 of 18 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.53s]
[0m21:45:01.286724 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:45:01.289296 [debug] [MainThread]: Using postgres connection "master"
[0m21:45:01.289912 [debug] [MainThread]: On master: BEGIN
[0m21:45:01.290635 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:45:01.551763 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:45:01.553578 [debug] [MainThread]: On master: COMMIT
[0m21:45:01.554725 [debug] [MainThread]: Using postgres connection "master"
[0m21:45:01.555411 [debug] [MainThread]: On master: COMMIT
[0m21:45:01.586422 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:45:01.587365 [debug] [MainThread]: On master: Close
[0m21:45:01.589298 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:45:01.589967 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:45:01.590869 [info ] [MainThread]: 
[0m21:45:01.591644 [info ] [MainThread]: Finished running 17 table models, 1 view model in 0 hours 0 minutes and 46.19 seconds (46.19s).
[0m21:45:01.595349 [debug] [MainThread]: Command end result
[0m21:45:01.614817 [info ] [MainThread]: 
[0m21:45:01.615677 [info ] [MainThread]: [31mCompleted with 1 error and 0 warnings:[0m
[0m21:45:01.616156 [info ] [MainThread]: 
[0m21:45:01.616610 [error] [MainThread]:   Database Error in model stg_matomo_actions_visits__aggregated_wo_brand_name (models/staging/stg_matomo_actions_visits__aggregated_wo_brand_name.sql)
  column "matomo_actions.eventname" must appear in the GROUP BY clause or be used in an aggregate function
  LINE 24:     "right"(matomo_actions.eventname::text, length(matomo_ac...
                       ^
  compiled Code at target/run/campaign_perfomance/models/staging/stg_matomo_actions_visits__aggregated_wo_brand_name.sql
[0m21:45:01.617086 [info ] [MainThread]: 
[0m21:45:01.617704 [info ] [MainThread]: Done. PASS=16 WARN=0 ERROR=1 SKIP=1 TOTAL=18
[0m21:45:01.620921 [debug] [MainThread]: Resource report: {"command_name": "run", "command_wall_clock_time": 46.378796, "process_user_time": 2.256856, "process_kernel_time": 0.236584, "process_mem_max_rss": "128876544", "command_success": false, "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:45:01.621828 [debug] [MainThread]: Command `dbt run` failed at 21:45:01.621649 after 46.38 seconds
[0m21:45:01.622439 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10a3ad710>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103c00f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103c00210>]}
[0m21:45:01.622977 [debug] [MainThread]: Flushing usage events
[0m21:46:25.495039 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108518bd0>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108560150>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10857f050>]}


============================== 21:46:25.496239 | 57ac932b-2875-4b66-8e44-f0fa42fbc884 ==============================
[0m21:46:25.496239 [info ] [MainThread]: Running with dbt=1.7.0
[0m21:46:25.496557 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'write_json': 'True', 'log_cache_events': 'False', 'quiet': 'False', 'partial_parse': 'True', 'log_path': '/Users/danila/github/dbt/logs', 'use_colors': 'True', 'warn_error': 'None', 'log_format': 'default', 'debug': 'False', 'printer_width': '80', 'fail_fast': 'False', 'use_experimental_parser': 'False', 'target_path': 'None', 'profiles_dir': '/Users/danila/.dbt', 'send_anonymous_usage_stats': 'True', 'indirect_selection': 'eager', 'version_check': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'cache_selected_only': 'False', 'introspect': 'True', 'invocation_command': 'dbt run', 'static_parser': 'True'}
[0m21:46:25.559614 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108509b50>]}
[0m21:46:25.589757 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092bb0d0>]}
[0m21:46:25.590103 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m21:46:25.596384 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m21:46:25.609635 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m21:46:25.609858 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m21:46:25.610368 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m21:46:25.612984 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109720150>]}
[0m21:46:25.619395 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109637f10>]}
[0m21:46:25.619640 [info ] [MainThread]: Found 18 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m21:46:25.619826 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104163b50>]}
[0m21:46:25.620937 [info ] [MainThread]: 
[0m21:46:25.621318 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m21:46:25.622052 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m21:46:25.626427 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m21:46:25.626598 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m21:46:25.626766 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m21:46:25.956303 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m21:46:25.960985 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m21:46:25.965144 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m21:46:25.973975 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:46:25.975609 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m21:46:25.976031 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m21:46:26.301346 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m21:46:26.302835 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m21:46:26.303893 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m21:46:26.348845 [debug] [ThreadPool]: SQL status: SELECT 18 in 0.0 seconds
[0m21:46:26.352010 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m21:46:26.391327 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m21:46:26.397829 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:26.398103 [debug] [MainThread]: On master: BEGIN
[0m21:46:26.398331 [debug] [MainThread]: Opening a new connection, currently in state init
[0m21:46:26.700861 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:46:26.702152 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:26.703104 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m21:46:26.747001 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m21:46:26.754318 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x106c7ce10>]}
[0m21:46:26.755303 [debug] [MainThread]: On master: ROLLBACK
[0m21:46:26.788196 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:26.789514 [debug] [MainThread]: On master: BEGIN
[0m21:46:26.856691 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:46:26.858234 [debug] [MainThread]: On master: COMMIT
[0m21:46:26.859797 [debug] [MainThread]: Using postgres connection "master"
[0m21:46:26.860804 [debug] [MainThread]: On master: COMMIT
[0m21:46:26.894689 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:46:26.896080 [debug] [MainThread]: On master: Close
[0m21:46:26.898627 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m21:46:26.899356 [info ] [MainThread]: 
[0m21:46:26.904319 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m21:46:26.905184 [info ] [Thread-1 (]: 1 of 18 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m21:46:26.906289 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m21:46:26.906827 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m21:46:26.919228 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:26.920171 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 21:46:26.907199 => 21:46:26.919954
[0m21:46:26.920565 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m21:46:26.946011 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:26.946552 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:26.946793 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m21:46:26.947017 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:27.266544 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:27.268306 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:27.269781 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m21:46:47.301892 [debug] [Thread-1 (]: SQL status: SELECT 2110 in 20.0 seconds
[0m21:46:47.315519 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:47.316185 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m21:46:47.347177 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:47.353918 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:47.354578 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m21:46:47.386247 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:47.413475 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:46:47.414126 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:47.414557 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m21:46:47.445473 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:47.452721 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m21:46:47.457501 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m21:46:47.457872 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m21:46:47.501363 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:47.504380 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 21:46:26.920767 => 21:46:47.504040
[0m21:46:47.505026 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m21:46:47.506953 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10934a390>]}
[0m21:46:47.508054 [info ] [Thread-1 (]: 1 of 18 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2110[0m in 20.60s]
[0m21:46:47.508863 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m21:46:47.509436 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m21:46:47.510211 [info ] [Thread-1 (]: 2 of 18 START sql table model danila.campaign_dim .............................. [RUN]
[0m21:46:47.511037 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m21:46:47.511481 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m21:46:47.514782 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m21:46:47.515826 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 21:46:47.511754 => 21:46:47.515585
[0m21:46:47.516220 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m21:46:47.520170 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m21:46:47.520874 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:47.521204 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m21:46:47.521515 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:47.922270 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:47.924078 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:47.924987 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:46:47.982716 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m21:46:47.990691 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:47.991320 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m21:46:48.032385 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:48.041469 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:48.042079 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m21:46:48.081705 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:48.087483 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:46:48.088227 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:48.088877 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m21:46:48.128441 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:48.134974 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m21:46:48.136618 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m21:46:48.137314 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m21:46:48.194137 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:48.198167 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 21:46:47.516426 => 21:46:48.197765
[0m21:46:48.198951 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m21:46:48.200723 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109869f90>]}
[0m21:46:48.201636 [info ] [Thread-1 (]: 2 of 18 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.69s]
[0m21:46:48.202519 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m21:46:48.203311 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m21:46:48.204133 [info ] [Thread-1 (]: 3 of 18 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m21:46:48.205107 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m21:46:48.205595 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m21:46:48.210462 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.211670 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 21:46:48.205925 => 21:46:48.211360
[0m21:46:48.212166 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m21:46:48.217034 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.217853 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.218238 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m21:46:48.218582 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:48.491996 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:48.494127 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.494986 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m21:46:48.544908 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m21:46:48.547693 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.548025 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m21:46:48.578775 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:48.580897 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.581172 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m21:46:48.612170 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:48.613980 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:46:48.614323 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.614637 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m21:46:48.645347 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:48.648361 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m21:46:48.649390 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m21:46:48.649837 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m21:46:48.699396 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:48.702731 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 21:46:48.212460 => 21:46:48.702280
[0m21:46:48.703565 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m21:46:48.705557 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093f3410>]}
[0m21:46:48.706668 [info ] [Thread-1 (]: 3 of 18 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.50s]
[0m21:46:48.707537 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m21:46:48.708222 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m21:46:48.708998 [info ] [Thread-1 (]: 4 of 18 START sql table model danila.deals_dim ................................. [RUN]
[0m21:46:48.710079 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m21:46:48.710570 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m21:46:48.715372 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m21:46:48.716371 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 21:46:48.710871 => 21:46:48.716104
[0m21:46:48.716838 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m21:46:48.721609 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m21:46:48.722332 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:48.722706 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m21:46:48.723062 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:49.004742 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:49.006878 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:49.008135 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m21:46:49.046602 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m21:46:49.054089 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:49.054637 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m21:46:49.085243 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:49.091493 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:49.092291 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m21:46:49.124083 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:49.129357 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:46:49.130090 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:49.130850 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m21:46:49.161810 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:49.168140 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m21:46:49.169431 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m21:46:49.169969 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m21:46:49.218697 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:49.222762 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 21:46:48.717124 => 21:46:49.222353
[0m21:46:49.223514 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m21:46:49.225327 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109433150>]}
[0m21:46:49.226268 [info ] [Thread-1 (]: 4 of 18 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.52s]
[0m21:46:49.227287 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m21:46:49.228014 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m21:46:49.228944 [info ] [Thread-1 (]: 5 of 18 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m21:46:49.229887 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m21:46:49.230335 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m21:46:49.237868 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.238795 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 21:46:49.230622 => 21:46:49.238560
[0m21:46:49.239253 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m21:46:49.243751 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.244360 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.244688 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m21:46:49.244999 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:49.571158 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:49.573028 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.573876 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m21:46:49.616686 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:46:49.625215 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.625919 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m21:46:49.665973 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:49.672931 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.673468 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m21:46:49.713165 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:49.718927 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:46:49.719723 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.720272 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m21:46:49.759386 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:49.766593 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m21:46:49.767871 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m21:46:49.768387 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m21:46:49.824808 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:49.829327 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 21:46:49.239510 => 21:46:49.828912
[0m21:46:49.830114 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m21:46:49.831616 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109625110>]}
[0m21:46:49.832533 [info ] [Thread-1 (]: 5 of 18 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.60s]
[0m21:46:49.833314 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m21:46:49.833909 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m21:46:49.834844 [info ] [Thread-1 (]: 6 of 18 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m21:46:49.835819 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m21:46:49.836548 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m21:46:49.843139 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:49.844312 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 21:46:49.837128 => 21:46:49.844047
[0m21:46:49.844772 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m21:46:49.849110 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:49.849794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:49.850124 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m21:46:49.850434 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:50.124795 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:50.126866 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:50.128492 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m21:46:57.540724 [debug] [Thread-1 (]: SQL status: SELECT 143734 in 7.0 seconds
[0m21:46:57.549582 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:57.550469 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m21:46:57.584090 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:57.591076 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:57.591803 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m21:46:57.625645 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:57.631089 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:46:57.631775 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:57.632439 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m21:46:57.666694 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:57.672909 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m21:46:57.674881 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m21:46:57.675778 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m21:46:57.727932 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:57.731216 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 21:46:49.845013 => 21:46:57.730892
[0m21:46:57.731912 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m21:46:57.733585 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098bab90>]}
[0m21:46:57.734512 [info ] [Thread-1 (]: 6 of 18 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143734[0m in 7.90s]
[0m21:46:57.735342 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m21:46:57.736053 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m21:46:57.736918 [info ] [Thread-1 (]: 7 of 18 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m21:46:57.738026 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m21:46:57.738711 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m21:46:57.743605 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:57.745438 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 21:46:57.739192 => 21:46:57.744889
[0m21:46:57.746076 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m21:46:57.751400 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:57.752287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:57.752700 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m21:46:57.753085 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:58.010461 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:58.011805 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:58.012718 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m21:46:58.046255 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:46:58.050427 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:58.050781 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m21:46:58.082261 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:58.088278 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:58.088680 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m21:46:58.119038 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:58.121001 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:46:58.121353 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:58.121674 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m21:46:58.152154 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:58.154925 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m21:46:58.155795 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m21:46:58.156190 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m21:46:58.203987 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:58.206792 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 21:46:57.746381 => 21:46:58.206437
[0m21:46:58.207473 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m21:46:58.209185 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5310>]}
[0m21:46:58.210182 [info ] [Thread-1 (]: 7 of 18 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.47s]
[0m21:46:58.210864 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m21:46:58.211450 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:46:58.212299 [info ] [Thread-1 (]: 8 of 18 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m21:46:58.213289 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m21:46:58.213788 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:46:58.217550 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.218499 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 21:46:58.214084 => 21:46:58.218242
[0m21:46:58.218913 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:46:58.223169 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.223816 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.224148 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m21:46:58.224469 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:58.482545 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:58.483245 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.483716 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m21:46:58.520649 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m21:46:58.529532 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.530363 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:46:58.562007 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:58.569375 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.570142 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.601289 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:46:58.606925 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:46:58.607798 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.608538 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m21:46:58.640191 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:46:58.646408 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m21:46:58.647836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m21:46:58.648468 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m21:46:58.696839 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:46:58.701282 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 21:46:58.219154 => 21:46:58.700810
[0m21:46:58.702228 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m21:46:58.704440 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098e5d10>]}
[0m21:46:58.705729 [info ] [Thread-1 (]: 8 of 18 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.49s]
[0m21:46:58.706967 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m21:46:58.707898 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:46:58.708906 [info ] [Thread-1 (]: 9 of 18 START sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [RUN]
[0m21:46:58.710428 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name)
[0m21:46:58.711052 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:46:58.716792 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:46:58.717894 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (compile): 21:46:58.711460 => 21:46:58.717599
[0m21:46:58.718399 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:46:58.723211 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:46:58.723956 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:46:58.724350 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: BEGIN
[0m21:46:58.724722 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:46:58.977192 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:46:58.979179 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:46:58.980288 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    --"right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, country_code, campaign_vertical
  );
  
[0m21:47:03.582128 [debug] [Thread-1 (]: SQL status: SELECT 7099 in 5.0 seconds
[0m21:47:03.589814 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:47:03.590629 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp" rename to "stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:47:03.622381 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:03.627507 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m21:47:03.628474 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:47:03.629263 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m21:47:03.660696 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:03.667318 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup"
[0m21:47:03.669167 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m21:47:03.670136 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup" cascade
[0m21:47:03.702520 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:03.706990 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (execute): 21:46:58.718701 => 21:47:03.706630
[0m21:47:03.707778 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: Close
[0m21:47:03.709647 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10857e850>]}
[0m21:47:03.710655 [info ] [Thread-1 (]: 9 of 18 OK created sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [[32mSELECT 7099[0m in 5.00s]
[0m21:47:03.711448 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m21:47:03.712074 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:47:03.712879 [info ] [Thread-1 (]: 10 of 18 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m21:47:03.713848 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m21:47:03.714892 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:47:03.721745 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:03.722773 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 21:47:03.715273 => 21:47:03.722524
[0m21:47:03.723208 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:47:03.765839 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:03.766349 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:03.766550 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m21:47:03.766736 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:04.115042 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:04.117362 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:04.118782 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m21:47:08.906885 [debug] [Thread-1 (]: SQL status: SELECT 37418 in 5.0 seconds
[0m21:47:08.913020 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:08.913978 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:47:08.957208 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:08.963431 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:08.964131 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m21:47:09.008482 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:09.014084 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:47:09.014899 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:09.015587 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m21:47:09.060149 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:09.067471 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m21:47:09.069007 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m21:47:09.069699 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m21:47:09.127465 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:09.130681 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 21:47:03.723465 => 21:47:09.130310
[0m21:47:09.131471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m21:47:09.133130 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10c003bd0>]}
[0m21:47:09.134020 [info ] [Thread-1 (]: 10 of 18 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37418[0m in 5.42s]
[0m21:47:09.135093 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m21:47:09.135849 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m21:47:09.136528 [info ] [Thread-1 (]: 11 of 18 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m21:47:09.137443 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m21:47:09.137939 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m21:47:09.141997 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:09.142901 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 21:47:09.138250 => 21:47:09.142676
[0m21:47:09.143298 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m21:47:09.147544 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:09.148249 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:09.148578 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m21:47:09.148896 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:09.492669 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:09.494604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:09.495479 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m21:47:12.394924 [debug] [Thread-1 (]: SQL status: SELECT 115115 in 3.0 seconds
[0m21:47:12.403315 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:12.404489 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m21:47:12.442825 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:12.449946 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:12.450907 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m21:47:12.488900 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:12.493252 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:47:12.493950 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:12.494431 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m21:47:12.531749 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:12.537574 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m21:47:12.538774 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m21:47:12.539263 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m21:47:12.595368 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:12.598465 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 21:47:09.143536 => 21:47:12.598158
[0m21:47:12.599269 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m21:47:12.600545 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098cd090>]}
[0m21:47:12.601345 [info ] [Thread-1 (]: 11 of 18 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 115115[0m in 3.46s]
[0m21:47:12.602109 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m21:47:12.602653 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:47:12.603199 [info ] [Thread-1 (]: 12 of 18 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m21:47:12.603969 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m21:47:12.604383 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:47:12.608475 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:12.609341 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 21:47:12.604651 => 21:47:12.609138
[0m21:47:12.609695 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:47:12.613425 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:12.614023 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:12.614347 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m21:47:12.614650 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:12.871919 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:12.873653 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:12.875126 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m21:47:12.955375 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m21:47:12.964252 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:12.964983 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:47:12.996020 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:13.002966 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:13.003881 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m21:47:13.035519 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:13.040457 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:47:13.041311 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:13.042049 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m21:47:13.073605 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:13.076836 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m21:47:13.077670 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m21:47:13.078020 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m21:47:13.130258 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:13.133512 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 21:47:12.609895 => 21:47:13.133200
[0m21:47:13.134188 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m21:47:13.135337 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092e2b90>]}
[0m21:47:13.136087 [info ] [Thread-1 (]: 12 of 18 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.53s]
[0m21:47:13.136830 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m21:47:13.137387 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m21:47:13.138061 [info ] [Thread-1 (]: 13 of 18 START sql table model danila.test_write ............................... [RUN]
[0m21:47:13.138946 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m21:47:13.139351 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m21:47:13.142429 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m21:47:13.143263 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 21:47:13.139590 => 21:47:13.143075
[0m21:47:13.143589 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m21:47:13.147327 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m21:47:13.147927 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.148241 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m21:47:13.148559 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:13.400647 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:13.402767 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.404096 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m21:47:13.438398 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m21:47:13.447053 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.448039 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m21:47:13.479533 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:13.484771 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.485420 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m21:47:13.516795 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:13.521409 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:47:13.522195 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.522777 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m21:47:13.554318 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:13.561154 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m21:47:13.562928 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m21:47:13.563734 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m21:47:13.612482 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:13.617068 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 21:47:13.143796 => 21:47:13.616709
[0m21:47:13.617773 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m21:47:13.619532 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109645b10>]}
[0m21:47:13.620469 [info ] [Thread-1 (]: 13 of 18 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.48s]
[0m21:47:13.621327 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m21:47:13.622052 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m21:47:13.622725 [info ] [Thread-1 (]: 14 of 18 START sql table model danila.outclicks_fct ............................ [RUN]
[0m21:47:13.623587 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m21:47:13.624212 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m21:47:13.628912 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m21:47:13.630005 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 21:47:13.624703 => 21:47:13.629761
[0m21:47:13.630434 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m21:47:13.634839 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m21:47:13.635459 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:13.635776 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m21:47:13.636077 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:13.938941 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:13.940234 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:13.941146 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m21:47:14.177798 [debug] [Thread-1 (]: SQL status: SELECT 55506 in 0.0 seconds
[0m21:47:14.185940 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:14.186636 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m21:47:14.224009 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:14.230711 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:14.231516 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m21:47:14.268966 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:14.274039 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:47:14.274576 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:14.275012 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m21:47:14.312781 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:14.324157 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m21:47:14.325732 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m21:47:14.326376 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m21:47:14.384000 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:14.386529 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 21:47:13.630682 => 21:47:14.386244
[0m21:47:14.387156 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m21:47:14.388767 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109884cd0>]}
[0m21:47:14.389684 [info ] [Thread-1 (]: 14 of 18 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55506[0m in 0.77s]
[0m21:47:14.390501 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m21:47:14.391121 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m21:47:14.392071 [info ] [Thread-1 (]: 15 of 18 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m21:47:14.393078 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m21:47:14.393654 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m21:47:14.398776 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.400173 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 21:47:14.394012 => 21:47:14.399907
[0m21:47:14.400722 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m21:47:14.419881 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.420560 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.420858 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m21:47:14.421144 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:14.677018 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:14.679308 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.680629 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m21:47:14.714618 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m21:47:14.722223 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.722908 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m21:47:14.754656 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:14.759135 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:47:14.759774 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.760329 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m21:47:14.791266 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:14.797131 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m21:47:14.803372 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m21:47:14.803990 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m21:47:14.835764 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m21:47:14.839002 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 21:47:14.401058 => 21:47:14.838589
[0m21:47:14.839849 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m21:47:14.841677 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1098ee550>]}
[0m21:47:14.842637 [info ] [Thread-1 (]: 15 of 18 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.45s]
[0m21:47:14.843559 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m21:47:14.844260 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:47:14.845073 [info ] [Thread-1 (]: 16 of 18 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m21:47:14.845988 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m21:47:14.846500 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:47:14.852276 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:14.853230 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 21:47:14.846839 => 21:47:14.853001
[0m21:47:14.853639 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:47:14.858338 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:14.858902 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:14.859223 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m21:47:14.859530 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:15.113906 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:15.115929 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:15.117021 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
--where  country_code='at' and date_cet='2024-04-24'

-- select country_code, sum(outclicks)
-- from danila.outclick_by_brand_int_new
-- where country_code='at'
-- and date_cet='2024-04-24'
-- group by country_code
  );
  
[0m21:47:15.460737 [debug] [Thread-1 (]: SQL status: SELECT 152533 in 0.0 seconds
[0m21:47:15.469340 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:15.470091 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m21:47:15.501374 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:15.507756 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:15.508564 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m21:47:15.540789 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:15.547585 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:47:15.548368 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:15.548957 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m21:47:15.579958 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:15.586787 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m21:47:15.588187 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m21:47:15.588772 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m21:47:15.645343 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:15.648826 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 21:47:14.853883 => 21:47:15.648508
[0m21:47:15.649470 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m21:47:15.650979 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x109862810>]}
[0m21:47:15.651869 [info ] [Thread-1 (]: 16 of 18 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 152533[0m in 0.81s]
[0m21:47:15.652669 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m21:47:15.653274 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m21:47:15.653982 [info ] [Thread-1 (]: 17 of 18 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m21:47:15.654917 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m21:47:15.655817 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m21:47:15.661688 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:15.662776 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 21:47:15.656286 => 21:47:15.662530
[0m21:47:15.663197 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m21:47:15.669309 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:15.669953 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:15.670285 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m21:47:15.670597 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:15.976483 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:15.978597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:15.979875 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        --brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        --NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m21:47:16.052236 [debug] [Thread-1 (]: SQL status: SELECT 15166 in 0.0 seconds
[0m21:47:16.060922 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:16.061555 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m21:47:16.098151 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:16.104724 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:16.105549 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m21:47:16.143308 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:16.149548 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:47:16.150335 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:16.150876 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m21:47:16.188188 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:16.194932 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m21:47:16.196314 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m21:47:16.196920 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m21:47:16.255391 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:16.259513 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 21:47:15.663458 => 21:47:16.259089
[0m21:47:16.260328 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m21:47:16.262195 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1093d6790>]}
[0m21:47:16.263160 [info ] [Thread-1 (]: 17 of 18 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 15166[0m in 0.61s]
[0m21:47:16.264037 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m21:47:16.264651 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m21:47:16.265367 [info ] [Thread-1 (]: 18 of 18 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m21:47:16.266242 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m21:47:16.266869 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m21:47:16.271374 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.272565 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 21:47:16.267192 => 21:47:16.272267
[0m21:47:16.273071 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m21:47:16.278198 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.278950 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.279343 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m21:47:16.279684 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m21:47:16.607534 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m21:47:16.609972 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.611282 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m21:47:16.678501 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m21:47:16.686897 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.687640 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m21:47:16.729405 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:16.734146 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.734727 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m21:47:16.773970 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m21:47:16.779995 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:47:16.780860 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.781585 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m21:47:16.820935 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m21:47:16.828288 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m21:47:16.829608 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m21:47:16.830171 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m21:47:16.887804 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m21:47:16.892047 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 21:47:16.273366 => 21:47:16.891625
[0m21:47:16.892876 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m21:47:16.894721 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '57ac932b-2875-4b66-8e44-f0fa42fbc884', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1097309d0>]}
[0m21:47:16.895680 [info ] [Thread-1 (]: 18 of 18 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.63s]
[0m21:47:16.896739 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m21:47:16.898941 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:16.899398 [debug] [MainThread]: On master: BEGIN
[0m21:47:16.899813 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m21:47:17.253242 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m21:47:17.255110 [debug] [MainThread]: On master: COMMIT
[0m21:47:17.255912 [debug] [MainThread]: Using postgres connection "master"
[0m21:47:17.256546 [debug] [MainThread]: On master: COMMIT
[0m21:47:17.299199 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m21:47:17.300015 [debug] [MainThread]: On master: Close
[0m21:47:17.301505 [debug] [MainThread]: Connection 'master' was properly closed.
[0m21:47:17.301993 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m21:47:17.302621 [info ] [MainThread]: 
[0m21:47:17.303124 [info ] [MainThread]: Finished running 17 table models, 1 view model in 0 hours 0 minutes and 51.68 seconds (51.68s).
[0m21:47:17.306688 [debug] [MainThread]: Command end result
[0m21:47:17.323084 [info ] [MainThread]: 
[0m21:47:17.323656 [info ] [MainThread]: [32mCompleted successfully[0m
[0m21:47:17.324033 [info ] [MainThread]: 
[0m21:47:17.324414 [info ] [MainThread]: Done. PASS=18 WARN=0 ERROR=0 SKIP=0 TOTAL=18
[0m21:47:17.326477 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 51.85187, "process_user_time": 2.134479, "process_kernel_time": 0.208766, "process_mem_max_rss": "125091840", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m21:47:17.327061 [debug] [MainThread]: Command `dbt run` succeeded at 21:47:17.326930 after 51.85 seconds
[0m21:47:17.327484 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x102dcdf90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10974a890>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1092b7e50>]}
[0m21:47:17.327901 [debug] [MainThread]: Flushing usage events
[0m22:04:12.876571 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077c3e90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10709e850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10783abd0>]}


============================== 22:04:12.878064 | 3e2d6245-c03c-4c03-b625-263b1b2f115a ==============================
[0m22:04:12.878064 [info ] [MainThread]: Running with dbt=1.7.0
[0m22:04:12.878440 [debug] [MainThread]: running dbt with arguments {'no_print': 'None', 'target_path': 'None', 'static_parser': 'True', 'invocation_command': 'dbt run', 'printer_width': '80', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'fail_fast': 'False', 'write_json': 'True', 'profiles_dir': '/Users/danila/.dbt', 'log_path': '/Users/danila/github/dbt/logs', 'version_check': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'log_cache_events': 'False', 'indirect_selection': 'eager', 'partial_parse': 'True', 'use_colors': 'True', 'introspect': 'True', 'warn_error': 'None', 'quiet': 'False', 'debug': 'False', 'log_format': 'default', 'cache_selected_only': 'False'}
[0m22:04:12.942368 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cf7150>]}
[0m22:04:12.972711 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d90490>]}
[0m22:04:12.973091 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m22:04:12.979845 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m22:04:12.992818 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:04:12.993026 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:04:12.993562 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m22:04:12.996360 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10783a190>]}
[0m22:04:13.001370 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107cf4290>]}
[0m22:04:13.001619 [info ] [MainThread]: Found 18 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m22:04:13.001805 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1077fc390>]}
[0m22:04:13.002830 [info ] [MainThread]: 
[0m22:04:13.003222 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:04:13.003983 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m22:04:13.008359 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m22:04:13.008536 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m22:04:13.008684 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:04:13.379155 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m22:04:13.382016 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m22:04:13.385880 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m22:04:13.392635 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m22:04:13.393071 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m22:04:13.393360 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:04:13.715063 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:04:13.715813 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m22:04:13.716240 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m22:04:13.760011 [debug] [ThreadPool]: SQL status: SELECT 19 in 0.0 seconds
[0m22:04:13.761989 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m22:04:13.800813 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m22:04:13.809781 [debug] [MainThread]: Using postgres connection "master"
[0m22:04:13.810182 [debug] [MainThread]: On master: BEGIN
[0m22:04:13.810465 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:04:14.067945 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:04:14.068720 [debug] [MainThread]: Using postgres connection "master"
[0m22:04:14.069233 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:04:14.109685 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m22:04:14.113729 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10783afd0>]}
[0m22:04:14.114354 [debug] [MainThread]: On master: ROLLBACK
[0m22:04:14.148436 [debug] [MainThread]: Using postgres connection "master"
[0m22:04:14.149459 [debug] [MainThread]: On master: BEGIN
[0m22:04:14.210517 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:04:14.210984 [debug] [MainThread]: On master: COMMIT
[0m22:04:14.211293 [debug] [MainThread]: Using postgres connection "master"
[0m22:04:14.211579 [debug] [MainThread]: On master: COMMIT
[0m22:04:14.241909 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:04:14.242305 [debug] [MainThread]: On master: Close
[0m22:04:14.243273 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:04:14.243716 [info ] [MainThread]: 
[0m22:04:14.246301 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m22:04:14.246934 [info ] [Thread-1 (]: 1 of 18 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m22:04:14.247702 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m22:04:14.248127 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m22:04:14.257961 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:14.258735 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 22:04:14.248392 => 22:04:14.258547
[0m22:04:14.259064 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m22:04:14.282834 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:14.283375 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:14.283597 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m22:04:14.283802 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:14.540203 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:14.542811 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:14.544524 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m22:04:34.320569 [debug] [Thread-1 (]: SQL status: SELECT 2110 in 20.0 seconds
[0m22:04:34.334511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:34.335256 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m22:04:34.367615 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:34.373376 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:34.374023 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m22:04:34.405146 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:34.432611 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m22:04:34.433254 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:34.433621 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m22:04:34.464737 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:34.471988 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m22:04:34.476804 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:04:34.477161 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m22:04:34.520776 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:34.523583 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 22:04:14.259249 => 22:04:34.523267
[0m22:04:34.524147 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m22:04:34.525822 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107edd3d0>]}
[0m22:04:34.526714 [info ] [Thread-1 (]: 1 of 18 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2110[0m in 20.28s]
[0m22:04:34.527518 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m22:04:34.528092 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m22:04:34.528782 [info ] [Thread-1 (]: 2 of 18 START sql table model danila.campaign_dim .............................. [RUN]
[0m22:04:34.529507 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m22:04:34.529898 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m22:04:34.532962 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m22:04:34.533907 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 22:04:34.530143 => 22:04:34.533676
[0m22:04:34.534314 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m22:04:34.538283 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m22:04:34.538966 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:34.539289 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m22:04:34.539593 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:34.928688 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:34.930695 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:34.931683 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m22:04:34.988524 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m22:04:34.995746 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:34.996299 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m22:04:35.036050 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:35.046270 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:35.047031 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m22:04:35.087243 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:35.092654 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m22:04:35.093442 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:35.093970 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m22:04:35.133376 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:35.140300 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m22:04:35.141677 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:04:35.142232 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m22:04:35.198206 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:35.202083 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 22:04:34.534564 => 22:04:35.201675
[0m22:04:35.202968 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m22:04:35.204736 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080e2b10>]}
[0m22:04:35.205662 [info ] [Thread-1 (]: 2 of 18 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.68s]
[0m22:04:35.206517 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m22:04:35.207170 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m22:04:35.207949 [info ] [Thread-1 (]: 3 of 18 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m22:04:35.208916 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m22:04:35.209418 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m22:04:35.214729 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.216170 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 22:04:35.209733 => 22:04:35.215850
[0m22:04:35.216623 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m22:04:35.221687 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.222445 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.222805 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m22:04:35.223114 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:35.481501 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:35.483511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.484677 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m22:04:35.534558 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m22:04:35.541482 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.542097 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m22:04:35.573293 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:35.575512 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.575774 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m22:04:35.606478 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:35.607994 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m22:04:35.608258 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.608504 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m22:04:35.638779 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:35.641058 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m22:04:35.641796 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:04:35.642118 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m22:04:35.689574 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:35.691935 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 22:04:35.216896 => 22:04:35.691633
[0m22:04:35.692516 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m22:04:35.693662 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10807c310>]}
[0m22:04:35.694388 [info ] [Thread-1 (]: 3 of 18 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.49s]
[0m22:04:35.695138 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m22:04:35.695686 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m22:04:35.696344 [info ] [Thread-1 (]: 4 of 18 START sql table model danila.deals_dim ................................. [RUN]
[0m22:04:35.697204 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m22:04:35.697675 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m22:04:35.701048 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m22:04:35.701895 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 22:04:35.697965 => 22:04:35.701666
[0m22:04:35.702284 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m22:04:35.706337 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m22:04:35.707040 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:35.707359 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m22:04:35.707662 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:35.961733 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:35.963880 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:35.965003 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m22:04:36.003503 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m22:04:36.011527 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:36.012109 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m22:04:36.044182 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:36.051213 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:36.052036 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m22:04:36.083885 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:36.089276 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m22:04:36.089980 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:36.090510 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m22:04:36.121909 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:36.127809 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m22:04:36.129140 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:04:36.129694 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m22:04:36.182189 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:36.186445 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 22:04:35.702524 => 22:04:36.185981
[0m22:04:36.187256 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m22:04:36.189061 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10806f710>]}
[0m22:04:36.189978 [info ] [Thread-1 (]: 4 of 18 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.49s]
[0m22:04:36.190856 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m22:04:36.191491 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m22:04:36.192367 [info ] [Thread-1 (]: 5 of 18 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m22:04:36.193245 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m22:04:36.193723 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m22:04:36.201115 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.202455 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 22:04:36.194020 => 22:04:36.202150
[0m22:04:36.202903 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m22:04:36.207449 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.208108 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.208454 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m22:04:36.208769 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:36.569703 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:36.571721 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.573129 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m22:04:36.620139 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:04:36.628995 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.629677 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m22:04:36.674741 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:36.682429 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.683230 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m22:04:36.728417 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:36.734205 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m22:04:36.734979 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.735633 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m22:04:36.779811 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:36.787107 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m22:04:36.788444 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:04:36.788948 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m22:04:36.849756 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:36.854117 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 22:04:36.203156 => 22:04:36.853691
[0m22:04:36.854934 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m22:04:36.856618 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080ff710>]}
[0m22:04:36.857542 [info ] [Thread-1 (]: 5 of 18 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.66s]
[0m22:04:36.858409 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m22:04:36.859063 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m22:04:36.859919 [info ] [Thread-1 (]: 6 of 18 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m22:04:36.860803 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m22:04:36.861305 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m22:04:36.868358 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:36.869462 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 22:04:36.861600 => 22:04:36.869209
[0m22:04:36.869921 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m22:04:36.874517 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:36.875153 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:36.875485 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m22:04:36.875798 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:37.151935 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:37.154095 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:37.155401 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m22:04:44.220830 [debug] [Thread-1 (]: SQL status: SELECT 143734 in 7.0 seconds
[0m22:04:44.229604 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:44.230311 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m22:04:44.264816 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:44.272068 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:44.272880 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m22:04:44.308199 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:44.313846 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m22:04:44.314659 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:44.315261 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m22:04:44.348626 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:44.355664 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m22:04:44.356964 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:04:44.357534 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m22:04:44.407315 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:44.411821 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 22:04:36.870213 => 22:04:44.411410
[0m22:04:44.412616 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m22:04:44.414128 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107dbb610>]}
[0m22:04:44.415038 [info ] [Thread-1 (]: 6 of 18 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143734[0m in 7.55s]
[0m22:04:44.415896 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m22:04:44.416567 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m22:04:44.417315 [info ] [Thread-1 (]: 7 of 18 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m22:04:44.418388 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m22:04:44.418959 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m22:04:44.423546 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.424926 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 22:04:44.419269 => 22:04:44.424648
[0m22:04:44.425395 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m22:04:44.430070 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.430765 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.431105 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m22:04:44.431420 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:44.710532 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:44.712597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.713497 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m22:04:44.750660 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:04:44.762440 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.763149 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m22:04:44.798668 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:44.805511 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.806309 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m22:04:44.841252 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:44.846939 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m22:04:44.847836 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.848434 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m22:04:44.881997 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:44.889303 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m22:04:44.890684 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:04:44.891249 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m22:04:44.941884 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:44.946094 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 22:04:44.425654 => 22:04:44.945671
[0m22:04:44.946892 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m22:04:44.948769 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1080f4e50>]}
[0m22:04:44.949723 [info ] [Thread-1 (]: 7 of 18 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.53s]
[0m22:04:44.950597 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m22:04:44.951271 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:04:44.952109 [info ] [Thread-1 (]: 8 of 18 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m22:04:44.953018 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m22:04:44.953516 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:04:44.958577 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:44.959936 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 22:04:44.953817 => 22:04:44.959610
[0m22:04:44.960464 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:04:44.965291 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:44.966115 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:44.966511 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m22:04:44.966846 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:45.223623 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:45.225463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.226282 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m22:04:45.263282 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m22:04:45.272268 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.273148 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m22:04:45.305240 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:45.312631 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.313250 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.344192 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:45.349165 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m22:04:45.350034 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.350757 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m22:04:45.382376 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:45.389633 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m22:04:45.390970 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:04:45.391526 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m22:04:45.439374 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:45.443343 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 22:04:44.960718 => 22:04:45.442915
[0m22:04:45.444155 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m22:04:45.445949 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107eac490>]}
[0m22:04:45.446856 [info ] [Thread-1 (]: 8 of 18 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.49s]
[0m22:04:45.447741 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:04:45.448433 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:04:45.449263 [info ] [Thread-1 (]: 9 of 18 START sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [RUN]
[0m22:04:45.450127 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name)
[0m22:04:45.450609 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:04:45.456113 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:45.457404 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (compile): 22:04:45.450918 => 22:04:45.457116
[0m22:04:45.457867 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:04:45.462654 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:45.463416 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:45.463754 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: BEGIN
[0m22:04:45.464071 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:45.771108 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:45.773033 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:45.774115 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    --"right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, country_code, campaign_vertical
  );
  
[0m22:04:50.396029 [debug] [Thread-1 (]: SQL status: SELECT 7099 in 5.0 seconds
[0m22:04:50.398339 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:50.398613 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name" rename to "stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup"
[0m22:04:50.429766 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:50.432676 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:50.433097 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp" rename to "stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:50.464123 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:50.466323 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m22:04:50.466707 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:50.467045 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m22:04:50.497725 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:50.502577 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup"
[0m22:04:50.503499 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:04:50.503910 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup" cascade
[0m22:04:50.548629 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:50.551348 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (execute): 22:04:45.458118 => 22:04:50.551018
[0m22:04:50.551919 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: Close
[0m22:04:50.553058 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10816be50>]}
[0m22:04:50.553806 [info ] [Thread-1 (]: 9 of 18 OK created sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [[32mSELECT 7099[0m in 5.10s]
[0m22:04:50.554548 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:04:50.555094 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:04:50.555422 [info ] [Thread-1 (]: 10 of 18 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m22:04:50.555821 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m22:04:50.556115 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:04:50.590179 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:50.590792 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 22:04:50.556292 => 22:04:50.590645
[0m22:04:50.591023 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:04:50.593499 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:50.593946 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:50.594148 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m22:04:50.594335 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:50.852872 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:50.854923 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:50.856205 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m22:04:55.512701 [debug] [Thread-1 (]: SQL status: SELECT 37418 in 5.0 seconds
[0m22:04:55.517573 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:55.518132 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m22:04:55.549002 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:55.552626 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:55.553103 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m22:04:55.583769 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:55.585304 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m22:04:55.585554 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:55.585782 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m22:04:55.615925 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:55.617746 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m22:04:55.618319 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:04:55.618576 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m22:04:55.664076 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:55.665648 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 22:04:50.591149 => 22:04:55.665436
[0m22:04:55.666039 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m22:04:55.666791 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fb5bd0>]}
[0m22:04:55.667240 [info ] [Thread-1 (]: 10 of 18 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 37418[0m in 5.11s]
[0m22:04:55.667705 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:04:55.668064 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m22:04:55.668506 [info ] [Thread-1 (]: 11 of 18 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m22:04:55.669127 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m22:04:55.669453 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m22:04:55.672214 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:55.672886 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 22:04:55.669652 => 22:04:55.672716
[0m22:04:55.673189 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m22:04:55.676381 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:55.676827 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:55.677089 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m22:04:55.677331 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:55.987470 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:55.987954 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:55.988329 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m22:04:58.895786 [debug] [Thread-1 (]: SQL status: SELECT 115115 in 3.0 seconds
[0m22:04:58.904228 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:58.905000 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m22:04:58.939298 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:58.946639 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:58.947331 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m22:04:58.980856 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:58.986471 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m22:04:58.987263 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:58.987969 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m22:04:59.022100 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:59.027605 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m22:04:59.028882 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:04:59.029399 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m22:04:59.078980 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:59.083060 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 22:04:55.673364 => 22:04:59.082640
[0m22:04:59.083867 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m22:04:59.085918 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107d90550>]}
[0m22:04:59.086883 [info ] [Thread-1 (]: 11 of 18 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 115115[0m in 3.42s]
[0m22:04:59.087768 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m22:04:59.088400 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:04:59.089244 [info ] [Thread-1 (]: 12 of 18 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m22:04:59.090148 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m22:04:59.090649 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:04:59.096438 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.097814 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 22:04:59.090962 => 22:04:59.097510
[0m22:04:59.098276 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:04:59.104633 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.105316 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.105665 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m22:04:59.105989 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:59.363653 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:59.365772 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.366754 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m22:04:59.440627 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m22:04:59.448500 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.449237 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m22:04:59.480354 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:59.486994 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.487780 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m22:04:59.519454 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:59.525268 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m22:04:59.526043 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.526731 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m22:04:59.557752 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:04:59.565349 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m22:04:59.566684 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:04:59.567247 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m22:04:59.616523 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:04:59.620858 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 22:04:59.098538 => 22:04:59.620436
[0m22:04:59.621647 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m22:04:59.623399 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107856f90>]}
[0m22:04:59.624512 [info ] [Thread-1 (]: 12 of 18 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.53s]
[0m22:04:59.625612 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:04:59.626439 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m22:04:59.627537 [info ] [Thread-1 (]: 13 of 18 START sql table model danila.test_write ............................... [RUN]
[0m22:04:59.628689 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m22:04:59.629383 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m22:04:59.634339 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m22:04:59.635628 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 22:04:59.629796 => 22:04:59.635308
[0m22:04:59.636162 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m22:04:59.641543 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m22:04:59.642378 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:04:59.642763 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m22:04:59.643115 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:04:59.902999 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:04:59.905107 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:04:59.906489 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m22:04:59.940549 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:04:59.949643 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:04:59.950310 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m22:04:59.982380 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:04:59.989530 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:04:59.990300 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m22:05:00.021659 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:00.026540 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m22:05:00.027347 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:05:00.028101 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m22:05:00.059859 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:00.065138 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m22:05:00.066485 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:05:00.067296 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m22:05:00.116069 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:05:00.119886 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 22:04:59.636470 => 22:05:00.119639
[0m22:05:00.120347 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m22:05:00.121560 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107863810>]}
[0m22:05:00.122213 [info ] [Thread-1 (]: 13 of 18 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.49s]
[0m22:05:00.123149 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m22:05:00.123955 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m22:05:00.124906 [info ] [Thread-1 (]: 14 of 18 START sql table model danila.outclicks_fct ............................ [RUN]
[0m22:05:00.125948 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m22:05:00.126507 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m22:05:00.132372 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.133535 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 22:05:00.126846 => 22:05:00.133246
[0m22:05:00.134030 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m22:05:00.139225 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.140057 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.140447 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m22:05:00.140808 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:05:00.402972 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:05:00.405149 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.406141 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m22:05:00.633264 [debug] [Thread-1 (]: SQL status: SELECT 55521 in 0.0 seconds
[0m22:05:00.635730 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.636032 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m22:05:00.666743 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:00.671032 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.671378 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m22:05:00.711437 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:00.713860 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m22:05:00.714321 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.714757 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m22:05:00.745577 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:00.750848 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m22:05:00.752210 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:05:00.752885 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m22:05:00.801970 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:05:00.806515 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 22:05:00.134319 => 22:05:00.806077
[0m22:05:00.807349 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m22:05:00.809128 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbd3d0>]}
[0m22:05:00.810121 [info ] [Thread-1 (]: 14 of 18 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55521[0m in 0.68s]
[0m22:05:00.811056 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m22:05:00.811772 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m22:05:00.812729 [info ] [Thread-1 (]: 15 of 18 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m22:05:00.813786 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m22:05:00.814314 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m22:05:00.819291 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:00.820495 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 22:05:00.814626 => 22:05:00.820246
[0m22:05:00.820935 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m22:05:00.836804 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:00.837401 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:00.837695 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m22:05:00.837973 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:05:01.572123 [debug] [Thread-1 (]: SQL status: BEGIN in 1.0 seconds
[0m22:05:01.574151 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:01.575027 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m22:05:01.618198 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m22:05:01.626111 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:01.626849 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m22:05:01.667234 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:01.671972 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m22:05:01.672571 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:01.673064 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m22:05:01.712626 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:01.719227 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m22:05:01.724282 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:05:01.725076 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m22:05:01.765621 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m22:05:01.768947 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 22:05:00.821178 => 22:05:01.768504
[0m22:05:01.769772 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m22:05:01.771618 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x108103fd0>]}
[0m22:05:01.772806 [info ] [Thread-1 (]: 15 of 18 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.96s]
[0m22:05:01.774000 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m22:05:01.774876 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:05:01.775690 [info ] [Thread-1 (]: 16 of 18 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m22:05:01.776701 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m22:05:01.777265 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:05:01.783219 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:01.784348 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 22:05:01.777608 => 22:05:01.784041
[0m22:05:01.784854 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:05:01.790474 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:01.791281 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:01.791685 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m22:05:01.792059 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:05:02.099224 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:05:02.101345 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:02.102722 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
--where  country_code='at' and date_cet='2024-04-24'

-- select country_code, sum(outclicks)
-- from danila.outclick_by_brand_int_new
-- where country_code='at'
-- and date_cet='2024-04-24'
-- group by country_code
  );
  
[0m22:05:02.377225 [debug] [Thread-1 (]: SQL status: SELECT 152533 in 0.0 seconds
[0m22:05:02.385853 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:02.386572 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m22:05:02.424412 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:02.431276 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:02.432051 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m22:05:02.469310 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:02.476071 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m22:05:02.477042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:02.477677 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m22:05:02.515634 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:02.522522 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m22:05:02.523828 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:05:02.524391 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m22:05:02.586229 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:05:02.590337 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 22:05:01.785139 => 22:05:02.589905
[0m22:05:02.591129 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m22:05:02.592913 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107fbd3d0>]}
[0m22:05:02.593856 [info ] [Thread-1 (]: 16 of 18 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 152533[0m in 0.82s]
[0m22:05:02.594906 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:05:02.595620 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m22:05:02.596386 [info ] [Thread-1 (]: 17 of 18 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m22:05:02.597343 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m22:05:02.597808 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m22:05:02.604246 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:02.605260 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 22:05:02.598104 => 22:05:02.605031
[0m22:05:02.605671 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m22:05:02.612454 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:02.613127 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:02.613474 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m22:05:02.613793 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:05:02.875349 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:05:02.877396 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:02.878486 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        --brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        --NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m22:05:02.983570 [debug] [Thread-1 (]: SQL status: SELECT 45485 in 0.0 seconds
[0m22:05:02.992599 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:02.993315 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m22:05:03.025524 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:03.032487 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:03.033247 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m22:05:03.064704 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:03.070313 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m22:05:03.070901 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:03.071413 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m22:05:03.102660 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:03.109417 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m22:05:03.110731 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:05:03.111262 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m22:05:03.160511 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:05:03.164195 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 22:05:02.605921 => 22:05:03.163774
[0m22:05:03.164885 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m22:05:03.166418 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107dc6f90>]}
[0m22:05:03.167294 [info ] [Thread-1 (]: 17 of 18 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 45485[0m in 0.57s]
[0m22:05:03.168106 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m22:05:03.168687 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m22:05:03.169370 [info ] [Thread-1 (]: 18 of 18 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m22:05:03.170424 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m22:05:03.171081 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m22:05:03.175291 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.176334 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 22:05:03.171404 => 22:05:03.176081
[0m22:05:03.176760 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m22:05:03.181804 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.182481 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.182809 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m22:05:03.183116 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:05:03.443592 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:05:03.445757 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.446984 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m22:05:03.504019 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m22:05:03.511980 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.512672 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m22:05:03.543785 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:03.550193 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.550956 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m22:05:03.582242 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:05:03.588567 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m22:05:03.589451 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.590168 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m22:05:03.621770 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:05:03.628295 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m22:05:03.629646 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:05:03.630166 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m22:05:03.678731 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:05:03.682711 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 22:05:03.177011 => 22:05:03.682259
[0m22:05:03.683511 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m22:05:03.685198 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': '3e2d6245-c03c-4c03-b625-263b1b2f115a', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1071ce910>]}
[0m22:05:03.686103 [info ] [Thread-1 (]: 18 of 18 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.52s]
[0m22:05:03.686943 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m22:05:03.689170 [debug] [MainThread]: Using postgres connection "master"
[0m22:05:03.689634 [debug] [MainThread]: On master: BEGIN
[0m22:05:03.690043 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:05:04.348048 [debug] [MainThread]: SQL status: BEGIN in 1.0 seconds
[0m22:05:04.348547 [debug] [MainThread]: On master: COMMIT
[0m22:05:04.348853 [debug] [MainThread]: Using postgres connection "master"
[0m22:05:04.349144 [debug] [MainThread]: On master: COMMIT
[0m22:05:04.391776 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:05:04.392588 [debug] [MainThread]: On master: Close
[0m22:05:04.393964 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:05:04.394433 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m22:05:04.395042 [info ] [MainThread]: 
[0m22:05:04.395480 [info ] [MainThread]: Finished running 17 table models, 1 view model in 0 hours 0 minutes and 51.39 seconds (51.39s).
[0m22:05:04.399068 [debug] [MainThread]: Command end result
[0m22:05:04.410578 [info ] [MainThread]: 
[0m22:05:04.410996 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:05:04.411312 [info ] [MainThread]: 
[0m22:05:04.411626 [info ] [MainThread]: Done. PASS=18 WARN=0 ERROR=0 SKIP=0 TOTAL=18
[0m22:05:04.413042 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 51.55732, "process_user_time": 2.094253, "process_kernel_time": 0.190556, "process_mem_max_rss": "123928576", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:05:04.413473 [debug] [MainThread]: Command `dbt run` succeeded at 22:05:04.413373 after 51.56 seconds
[0m22:05:04.413779 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x107030750>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103145f50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x103080850>]}
[0m22:05:04.414071 [debug] [MainThread]: Flushing usage events
[0m22:10:43.808174 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'start', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105364d90>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105365510>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1053ced50>]}


============================== 22:10:43.809585 | c67e9dce-081b-4155-80f8-1a6b1a9be125 ==============================
[0m22:10:43.809585 [info ] [MainThread]: Running with dbt=1.7.0
[0m22:10:43.809923 [debug] [MainThread]: running dbt with arguments {'log_cache_events': 'False', 'target_path': 'None', 'no_print': 'None', 'fail_fast': 'False', 'write_json': 'True', 'cache_selected_only': 'False', 'quiet': 'False', 'partial_parse': 'True', 'static_parser': 'True', 'version_check': 'True', 'use_colors': 'True', 'warn_error_options': 'WarnErrorOptions(include=[], exclude=[])', 'profiles_dir': '/Users/danila/.dbt', 'invocation_command': 'dbt run', 'printer_width': '80', 'indirect_selection': 'eager', 'log_format': 'default', 'debug': 'False', 'log_path': '/Users/danila/github/dbt/logs', 'introspect': 'True', 'send_anonymous_usage_stats': 'True', 'use_experimental_parser': 'False', 'warn_error': 'None'}
[0m22:10:43.872575 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'project_id', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105359b50>]}
[0m22:10:43.902288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'adapter_info', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104c32610>]}
[0m22:10:43.903406 [info ] [MainThread]: Registered adapter: postgres=1.7.0
[0m22:10:43.909853 [debug] [MainThread]: checksum: 8434eacd4ffdf0ca3ab22bf0e2d55b45306c9599613e842b959405abc489e606, vars: {}, profile: , target: , version: 1.7.0
[0m22:10:43.930388 [debug] [MainThread]: Partial parsing enabled: 0 files deleted, 0 files added, 0 files changed.
[0m22:10:43.930602 [debug] [MainThread]: Partial parsing enabled, no changes found, skipping parsing
[0m22:10:43.931127 [warn ] [MainThread]: [[33mWARNING[0m]: Configuration paths exist in your dbt_project.yml file which do not apply to any resources.
There are 1 unused configuration paths:
- models.brand_performance
[0m22:10:43.933908 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'load_project', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b13950>]}
[0m22:10:43.938714 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'resource_counts', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a36750>]}
[0m22:10:43.938918 [info ] [MainThread]: Found 18 models, 4 tests, 14 sources, 0 exposures, 0 metrics, 401 macros, 0 groups, 0 semantic models
[0m22:10:43.939094 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1058a1350>]}
[0m22:10:43.940134 [info ] [MainThread]: 
[0m22:10:43.940498 [debug] [MainThread]: Acquiring new postgres connection 'master'
[0m22:10:43.941218 [debug] [ThreadPool]: Acquiring new postgres connection 'list_deep-analysis-console'
[0m22:10:43.945517 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console"
[0m22:10:43.945707 [debug] [ThreadPool]: On list_deep-analysis-console: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console"} */

    select distinct nspname from pg_namespace
  
[0m22:10:43.945853 [debug] [ThreadPool]: Opening a new connection, currently in state init
[0m22:10:44.233431 [debug] [ThreadPool]: SQL status: SELECT 9 in 0.0 seconds
[0m22:10:44.238368 [debug] [ThreadPool]: On list_deep-analysis-console: Close
[0m22:10:44.242807 [debug] [ThreadPool]: Re-using an available connection from the pool (formerly list_deep-analysis-console, now list_deep-analysis-console_danila)
[0m22:10:44.252189 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m22:10:44.252856 [debug] [ThreadPool]: On list_deep-analysis-console_danila: BEGIN
[0m22:10:44.253214 [debug] [ThreadPool]: Opening a new connection, currently in state closed
[0m22:10:44.509374 [debug] [ThreadPool]: SQL status: BEGIN in 0.0 seconds
[0m22:10:44.511121 [debug] [ThreadPool]: Using postgres connection "list_deep-analysis-console_danila"
[0m22:10:44.512440 [debug] [ThreadPool]: On list_deep-analysis-console_danila: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "list_deep-analysis-console_danila"} */
select
      'deep-analysis-console' as database,
      tablename as name,
      schemaname as schema,
      'table' as type
    from pg_tables
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      viewname as name,
      schemaname as schema,
      'view' as type
    from pg_views
    where schemaname ilike 'danila'
    union all
    select
      'deep-analysis-console' as database,
      matviewname as name,
      schemaname as schema,
      'materialized_view' as type
    from pg_matviews
    where schemaname ilike 'danila'
  
[0m22:10:44.547631 [debug] [ThreadPool]: SQL status: SELECT 19 in 0.0 seconds
[0m22:10:44.552780 [debug] [ThreadPool]: On list_deep-analysis-console_danila: ROLLBACK
[0m22:10:44.583638 [debug] [ThreadPool]: On list_deep-analysis-console_danila: Close
[0m22:10:44.600470 [debug] [MainThread]: Using postgres connection "master"
[0m22:10:44.600974 [debug] [MainThread]: On master: BEGIN
[0m22:10:44.601354 [debug] [MainThread]: Opening a new connection, currently in state init
[0m22:10:44.962713 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:10:44.964523 [debug] [MainThread]: Using postgres connection "master"
[0m22:10:44.965734 [debug] [MainThread]: On master: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "connection_name": "master"} */
with relation as (
        select
            pg_rewrite.ev_class as class,
            pg_rewrite.oid as id
        from pg_rewrite
    ),
    class as (
        select
            oid as id,
            relname as name,
            relnamespace as schema,
            relkind as kind
        from pg_class
    ),
    dependency as (
        select distinct
            pg_depend.objid as id,
            pg_depend.refobjid as ref
        from pg_depend
    ),
    schema as (
        select
            pg_namespace.oid as id,
            pg_namespace.nspname as name
        from pg_namespace
        where nspname != 'information_schema' and nspname not like 'pg\_%'
    ),
    referenced as (
        select
            relation.id AS id,
            referenced_class.name ,
            referenced_class.schema ,
            referenced_class.kind
        from relation
        join class as referenced_class on relation.class=referenced_class.id
        where referenced_class.kind in ('r', 'v', 'm')
    ),
    relationships as (
        select
            referenced.name as referenced_name,
            referenced.schema as referenced_schema_id,
            dependent_class.name as dependent_name,
            dependent_class.schema as dependent_schema_id,
            referenced.kind as kind
        from referenced
        join dependency on referenced.id=dependency.id
        join class as dependent_class on dependency.ref=dependent_class.id
        where
            (referenced.name != dependent_class.name or
             referenced.schema != dependent_class.schema)
    )

    select
        referenced_schema.name as referenced_schema,
        relationships.referenced_name as referenced_name,
        dependent_schema.name as dependent_schema,
        relationships.dependent_name as dependent_name
    from relationships
    join schema as dependent_schema on relationships.dependent_schema_id=dependent_schema.id
    join schema as referenced_schema on relationships.referenced_schema_id=referenced_schema.id
    group by referenced_schema, referenced_name, dependent_schema, dependent_name
    order by referenced_schema, referenced_name, dependent_schema, dependent_name;
[0m22:10:45.020453 [debug] [MainThread]: SQL status: SELECT 47 in 0.0 seconds
[0m22:10:45.028288 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'runnable_timing', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a98cd0>]}
[0m22:10:45.029541 [debug] [MainThread]: On master: ROLLBACK
[0m22:10:45.073270 [debug] [MainThread]: Using postgres connection "master"
[0m22:10:45.073630 [debug] [MainThread]: On master: BEGIN
[0m22:10:45.160782 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:10:45.161859 [debug] [MainThread]: On master: COMMIT
[0m22:10:45.162390 [debug] [MainThread]: Using postgres connection "master"
[0m22:10:45.162917 [debug] [MainThread]: On master: COMMIT
[0m22:10:45.207627 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:10:45.209037 [debug] [MainThread]: On master: Close
[0m22:10:45.211536 [info ] [MainThread]: Concurrency: 1 threads (target='dev')
[0m22:10:45.212109 [info ] [MainThread]: 
[0m22:10:45.216949 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_performance_replacement
[0m22:10:45.217907 [info ] [Thread-1 (]: 1 of 18 START sql table model danila.brand_performance_replacement ............. [RUN]
[0m22:10:45.219073 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly list_deep-analysis-console_danila, now model.campaign_perfomance.brand_performance_replacement)
[0m22:10:45.219636 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_performance_replacement
[0m22:10:45.232506 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_performance_replacement"
[0m22:10:45.233628 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (compile): 22:10:45.220006 => 22:10:45.233351
[0m22:10:45.234048 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_performance_replacement
[0m22:10:45.259906 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_performance_replacement"
[0m22:10:45.260463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:10:45.260705 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: BEGIN
[0m22:10:45.260922 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:10:45.566356 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:10:45.568518 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:10:45.570327 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH outclick_cost AS ( 
select 
sum(d.cost)/sum(d.unique_outclicks) as unique_outclick_cost
from (
/*outclicks aggregated data from matomo tables*/
    select 
        date(timestamp - interval '2 hours') as date, 
        "left"(matomo_actions.eventname::text, 2) as country_code, 
        lower(sitename) as campaign_name, 
        campaignname as ga_campaign_name, 
        "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
        count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
        NULL as cost
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        AND date(timestamp - interval '2 hours')>'2024-02-16'
    group by campaign_name, campaignname, date, brand_name, country_code
    union all
    select 
        day as date, 
        geo as country_code, 
        console_campaign_name as campaign_name, 
        campaign as ga_campaign_name, 
        NULL as brand_name, NULL as unique_outclicks, 
        sum(cost) as cost
    from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
    left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
    where 
        campaign_names_mapping.campaign_vertical='casino'
        and day >'2024-02-16'
    group by day, country_code, campaign_name, ga_campaign_name
) d
)

select 
    d.country_code,
    d.brand_name, 
    'https://clickstorm.cashstormcreative.ee/dashboard/53-brand-performance-daily-details?date=past20days&country_code=' || d.country_code || '&brand=' || d.brand_name || '' as Details,
    coalesce(sum(d.outclicks),0) as outclicks, 
    sum(d.unique_outclicks) as unique_outclicks, 
    sum(d.signups) as signups, 
    sum(d.cpa_count) as FTDs, 
    sum(d.gtee_commissions) as gtee_commissions, 
    avg(d.avg_deposit_amount) as avg_deposit_amount, 
    avg(d.avg_list_position) as avg_position,
    (sum(d.signups)/NULLIF(sum(d.unique_outclicks),0)*100)  as signup_rate,
    (sum(d.cpa_count)/NULLIF(sum(d.unique_outclicks),0)*100) as conversion_rate,
    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks) 
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))
    END as EPC,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 
            THEN (((sum(d.cpa_commissions)+sum(d.gtee_commissions)+sum(d.revshare_commissions))/sum(d.unique_outclicks))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
        ELSE ((sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0))*100/NULLIF((select unique_outclick_cost from outclick_cost),0))-100
    END as ROI,

    CASE 
        WHEN sum(d.gtee_count)<>0 or sum(d.revshare_commissions)<>0 THEN (sum(d.cpa_commissions)/NULLIF(sum(unique_outclicks),0)) 
        ELSE NULL
    END as EPC_excl_gtee_rs,
    (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0)) as avg_commission,
    CASE 
        WHEN sum(d.gtee_commissions)>0 THEN ((sum(d.cpa_commissions)+sum(d.gtee_commissions))/NULLIF(sum(d.cpa_count),0))   
        ELSE (sum(d.cpa_commissions)/NULLIF(sum(d.cpa_count),0))
    END as avg_commission_incl_gtee,
    nullif(sum(d.revshare_commissions),0) as revshare_commissions
from (
/*outclicks aggregated data from matomo tables*/
    select date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
    from "deep-analysis-console"."console"."matomo_actions" matomo_actions
    left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
    on matomo_actions.matomo_visit_id=matomo_visits.id
    where 
        matomo_actions.type = 'event' 
        AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        and date(timestamp - interval '2 hours') >'2024-02-16'
    --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
    -- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    -- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
    group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
    union all
    select 
        date_parsed as date, 
        geo as country_code, 
        CASE  
            WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
            WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
            WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
            ELSE campaign_name
        END as campaign_name, 
        lower(adgroup_name) as ga_campaign_name, 
        CASE
            WHEN campaign_name::text = 'email' THEN brand_name || ' email'
            WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
            ELSE brand_name
        END as brand_name, 
        NULL as outclicks, NULL as unique_outclicks, NULL as avg_list_position, NULL as pos_list,
        sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
        coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
        sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
        avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
    from "deep-analysis-console"."console"."records" records
    where right(brand_name,6)<>'sports'
    --[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
    -- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
    -- [[ and  ]]
    group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
) d
group by d.country_code, d.brand_name
having sum(d.outclicks)>0 or sum(d.signups)>0  or sum(d.cpa_count)>0 or sum(d.gtee_count)>0 or sum(d.revshare_commissions)<>0
order by EPC desc NULLS last, FTDs desc NULLS last, unique_outclicks desc NULLS last, d.country_code
  );
  
[0m22:11:09.687657 [debug] [Thread-1 (]: SQL status: SELECT 2110 in 24.0 seconds
[0m22:11:09.702814 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:11:09.703902 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement" rename to "brand_performance_replacement__dbt_backup"
[0m22:11:09.756372 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:09.763289 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:11:09.763895 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
alter table "deep-analysis-console"."danila"."brand_performance_replacement__dbt_tmp" rename to "brand_performance_replacement"
[0m22:11:09.801590 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:09.837010 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m22:11:09.837717 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:11:09.838148 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: COMMIT
[0m22:11:09.875083 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:09.885470 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup"
[0m22:11:09.891794 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_performance_replacement"
[0m22:11:09.892452 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_performance_replacement"} */
drop table if exists "deep-analysis-console"."danila"."brand_performance_replacement__dbt_backup" cascade
[0m22:11:09.945281 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:09.949882 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_performance_replacement (execute): 22:10:45.234270 => 22:11:09.949283
[0m22:11:09.950988 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_performance_replacement: Close
[0m22:11:09.953763 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c34b50>]}
[0m22:11:09.955069 [info ] [Thread-1 (]: 1 of 18 OK created sql table model danila.brand_performance_replacement ........ [[32mSELECT 2110[0m in 24.73s]
[0m22:11:09.955892 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_performance_replacement
[0m22:11:09.956493 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.campaign_dim
[0m22:11:09.957217 [info ] [Thread-1 (]: 2 of 18 START sql table model danila.campaign_dim .............................. [RUN]
[0m22:11:09.958183 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.brand_performance_replacement, now model.campaign_perfomance.campaign_dim)
[0m22:11:09.958846 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.campaign_dim
[0m22:11:09.964148 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.campaign_dim"
[0m22:11:09.965627 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (compile): 22:11:09.959152 => 22:11:09.965280
[0m22:11:09.966245 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.campaign_dim
[0m22:11:09.972880 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.campaign_dim"
[0m22:11:09.974502 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:09.975188 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: BEGIN
[0m22:11:09.975644 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:10.309697 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:10.311597 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:10.312948 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    id as id
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m22:11:10.363285 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m22:11:10.374602 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:10.375698 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim" rename to "campaign_dim__dbt_backup"
[0m22:11:10.407866 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:10.420664 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:10.421711 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
alter table "deep-analysis-console"."danila"."campaign_dim__dbt_tmp" rename to "campaign_dim"
[0m22:11:10.454356 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:10.461808 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m22:11:10.463199 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:10.464343 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: COMMIT
[0m22:11:10.496225 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:10.506210 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."campaign_dim__dbt_backup"
[0m22:11:10.509237 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.campaign_dim"
[0m22:11:10.510202 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.campaign_dim"} */
drop table if exists "deep-analysis-console"."danila"."campaign_dim__dbt_backup" cascade
[0m22:11:10.558589 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:10.563632 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.campaign_dim (execute): 22:11:09.966723 => 22:11:10.562900
[0m22:11:10.565021 [debug] [Thread-1 (]: On model.campaign_perfomance.campaign_dim: Close
[0m22:11:10.568176 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b48290>]}
[0m22:11:10.569716 [info ] [Thread-1 (]: 2 of 18 OK created sql table model danila.campaign_dim ......................... [[32mSELECT 1442[0m in 0.61s]
[0m22:11:10.571233 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.campaign_dim
[0m22:11:10.572449 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.daily_campaign_fct
[0m22:11:10.573812 [info ] [Thread-1 (]: 3 of 18 START sql table model danila.daily_campaign_fct ........................ [RUN]
[0m22:11:10.575621 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.campaign_dim, now model.campaign_perfomance.daily_campaign_fct)
[0m22:11:10.576513 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.daily_campaign_fct
[0m22:11:10.582516 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:10.584120 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (compile): 22:11:10.577015 => 22:11:10.583820
[0m22:11:10.584714 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.daily_campaign_fct
[0m22:11:10.590822 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:10.592557 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:10.593217 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: BEGIN
[0m22:11:10.593705 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:10.896431 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:10.898421 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:10.900062 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH records_gap_campaigns AS (
    SELECT * FROM "deep-analysis-console"."console"."records_gap_campaigns"
)

select 
    campaign as ga_campaign_id,
    day as date, 
    clicks as clicks, 
    cost as ad_costs, 
    budget as budget
from records_gap_campaigns
where day>'2024-04-01'
  );
  
[0m22:11:10.958237 [debug] [Thread-1 (]: SQL status: SELECT 1442 in 0.0 seconds
[0m22:11:10.968042 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:10.968932 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct" rename to "daily_campaign_fct__dbt_backup"
[0m22:11:11.002474 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:11.005508 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:11.005849 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
alter table "deep-analysis-console"."danila"."daily_campaign_fct__dbt_tmp" rename to "daily_campaign_fct"
[0m22:11:11.045183 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:11.046929 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m22:11:11.047230 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:11.047505 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: COMMIT
[0m22:11:11.080670 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:11.083342 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup"
[0m22:11:11.084219 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.daily_campaign_fct"
[0m22:11:11.084602 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.daily_campaign_fct"} */
drop table if exists "deep-analysis-console"."danila"."daily_campaign_fct__dbt_backup" cascade
[0m22:11:11.136112 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:11.138808 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.daily_campaign_fct (execute): 22:11:10.585107 => 22:11:11.138468
[0m22:11:11.139611 [debug] [Thread-1 (]: On model.campaign_perfomance.daily_campaign_fct: Close
[0m22:11:11.141424 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c62810>]}
[0m22:11:11.142405 [info ] [Thread-1 (]: 3 of 18 OK created sql table model danila.daily_campaign_fct ................... [[32mSELECT 1442[0m in 0.57s]
[0m22:11:11.143249 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.daily_campaign_fct
[0m22:11:11.143901 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.deals_dim
[0m22:11:11.144690 [info ] [Thread-1 (]: 4 of 18 START sql table model danila.deals_dim ................................. [RUN]
[0m22:11:11.145636 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.daily_campaign_fct, now model.campaign_perfomance.deals_dim)
[0m22:11:11.146070 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.deals_dim
[0m22:11:11.151036 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.deals_dim"
[0m22:11:11.152092 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (compile): 22:11:11.146333 => 22:11:11.151810
[0m22:11:11.152567 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.deals_dim
[0m22:11:11.157907 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.deals_dim"
[0m22:11:11.158590 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.158955 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: BEGIN
[0m22:11:11.159301 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:11.456196 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:11.458592 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.460134 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */

  
    

  create  table "deep-analysis-console"."danila"."deals_dim__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


WITH deals AS (
    SELECT * FROM "deep-analysis-console"."console"."deals"
)

select 
    id as id,
    geo as geo_id,
    created_at as created_at_cet, 
    deal_start_date as started_at, 
    deal_end_date as ended_at,
    deal_cpa as cpa, 
    deal_gtee as deal_guarantee, 
    deal_revshare as deal_revenue_share,
    --deal_guarantee_started_at, 
    --deal_guarantee_ended_at, 
    --campaign_group,
    gap_campaign_name as ga_campaign_id 
    --vertical, 
    --traffic_source
from deals
where created_at>'2024-04-01'
  );
  
[0m22:11:11.503355 [debug] [Thread-1 (]: SQL status: SELECT 168 in 0.0 seconds
[0m22:11:11.513980 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.514801 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim" rename to "deals_dim__dbt_backup"
[0m22:11:11.551477 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:11.562291 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.563939 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
alter table "deep-analysis-console"."danila"."deals_dim__dbt_tmp" rename to "deals_dim"
[0m22:11:11.601138 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:11.608926 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m22:11:11.610311 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.611601 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: COMMIT
[0m22:11:11.647734 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:11.656739 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."deals_dim__dbt_backup"
[0m22:11:11.658453 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.deals_dim"
[0m22:11:11.659202 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.deals_dim"} */
drop table if exists "deep-analysis-console"."danila"."deals_dim__dbt_backup" cascade
[0m22:11:11.713729 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:11.717522 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.deals_dim (execute): 22:11:11.152849 => 22:11:11.716685
[0m22:11:11.718912 [debug] [Thread-1 (]: On model.campaign_perfomance.deals_dim: Close
[0m22:11:11.720196 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x1059bb510>]}
[0m22:11:11.721585 [info ] [Thread-1 (]: 4 of 18 OK created sql table model danila.deals_dim ............................ [[32mSELECT 168[0m in 0.57s]
[0m22:11:11.722331 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.deals_dim
[0m22:11:11.722899 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_first_dbt_model
[0m22:11:11.723686 [info ] [Thread-1 (]: 5 of 18 START sql table model danila.my_first_dbt_model ........................ [RUN]
[0m22:11:11.724745 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.deals_dim, now model.campaign_perfomance.my_first_dbt_model)
[0m22:11:11.725357 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_first_dbt_model
[0m22:11:11.735931 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:11.737460 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (compile): 22:11:11.725674 => 22:11:11.737121
[0m22:11:11.738144 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_first_dbt_model
[0m22:11:11.745533 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:11.746778 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:11.747263 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: BEGIN
[0m22:11:11.747641 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:12.003784 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:12.004993 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:12.005855 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */

  
    

  create  table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp"
  
  
    as
  
  (
    /*
    Welcome to your first dbt model!
    Did you know that you can also configure models directly within SQL files?
    This will override configurations stated in dbt_project.yml

    Try changing "table" to "view" below
*/



with source_data as (

    select 1 as id
--    union all
--    select null as id

)

select *
from source_data

/*
    Uncomment the line below to remove records with null `id` values
*/

-- where id is not null
  );
  
[0m22:11:12.040226 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:11:12.050580 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:12.051699 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model" rename to "my_first_dbt_model__dbt_backup"
[0m22:11:12.084534 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:12.094932 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:12.096251 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_first_dbt_model__dbt_tmp" rename to "my_first_dbt_model"
[0m22:11:12.128400 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:12.135799 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m22:11:12.137183 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:12.138496 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: COMMIT
[0m22:11:12.170333 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:12.179819 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup"
[0m22:11:12.182848 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_first_dbt_model"
[0m22:11:12.183913 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_first_dbt_model"} */
drop table if exists "deep-analysis-console"."danila"."my_first_dbt_model__dbt_backup" cascade
[0m22:11:12.237253 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:12.241816 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_first_dbt_model (execute): 22:11:11.738689 => 22:11:12.241076
[0m22:11:12.243249 [debug] [Thread-1 (]: On model.campaign_perfomance.my_first_dbt_model: Close
[0m22:11:12.246445 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cabb50>]}
[0m22:11:12.248372 [info ] [Thread-1 (]: 5 of 18 OK created sql table model danila.my_first_dbt_model ................... [[32mSELECT 1[0m in 0.52s]
[0m22:11:12.250322 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_first_dbt_model
[0m22:11:12.251658 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int
[0m22:11:12.253116 [info ] [Thread-1 (]: 6 of 18 START sql table model danila.outclick_by_brand_int ..................... [RUN]
[0m22:11:12.254902 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_first_dbt_model, now model.campaign_perfomance.outclick_by_brand_int)
[0m22:11:12.255988 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int
[0m22:11:12.265624 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:12.267437 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (compile): 22:11:12.256961 => 22:11:12.267074
[0m22:11:12.268130 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int
[0m22:11:12.274559 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:12.276127 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:12.276942 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: BEGIN
[0m22:11:12.277491 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:12.591756 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:12.593857 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:12.595965 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list,
    NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits 
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
--[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
-- [[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
-- [[ and "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) in ( select distinct brand_name from records WHERE  ) ]]
group by campaign_name, campaignname, date, brand_name, country_code
/*affiliate records aggregated data from records table*/
union all
select 
    date_parsed as date, 
    geo as country_code, 
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name, 
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
where right(brand_name,6)<>'sports'
    and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
  );
  
[0m22:11:22.385285 [debug] [Thread-1 (]: SQL status: SELECT 143735 in 10.0 seconds
[0m22:11:22.397163 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:22.398342 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int" rename to "outclick_by_brand_int__dbt_backup"
[0m22:11:22.433562 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:22.444596 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:22.445796 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_tmp" rename to "outclick_by_brand_int"
[0m22:11:22.480105 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:22.488117 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m22:11:22.489355 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:22.490355 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: COMMIT
[0m22:11:22.525119 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:22.534852 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup"
[0m22:11:22.537219 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int"
[0m22:11:22.538236 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int__dbt_backup" cascade
[0m22:11:22.593607 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:22.598733 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int (execute): 22:11:12.268516 => 22:11:22.597985
[0m22:11:22.600155 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int: Close
[0m22:11:22.603523 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cbb9d0>]}
[0m22:11:22.605716 [info ] [Thread-1 (]: 6 of 18 OK created sql table model danila.outclick_by_brand_int ................ [[32mSELECT 143735[0m in 10.35s]
[0m22:11:22.607803 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int
[0m22:11:22.609253 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_1
[0m22:11:22.610641 [info ] [Thread-1 (]: 7 of 18 START sql table model danila.outclick_cost_int_1 ....................... [RUN]
[0m22:11:22.612532 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int, now model.campaign_perfomance.outclick_cost_int_1)
[0m22:11:22.613409 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_1
[0m22:11:22.619025 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:22.620662 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (compile): 22:11:22.613942 => 22:11:22.620351
[0m22:11:22.621242 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_1
[0m22:11:22.627422 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:22.628915 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:22.629548 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: BEGIN
[0m22:11:22.630046 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:22.985083 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:22.987366 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:22.989055 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 1
  );
  
[0m22:11:23.035509 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:11:23.047213 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:23.048137 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1" rename to "outclick_cost_int_1__dbt_backup"
[0m22:11:23.092940 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:23.102294 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:23.103394 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_tmp" rename to "outclick_cost_int_1"
[0m22:11:23.147649 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:23.155485 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m22:11:23.157000 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:23.158392 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: COMMIT
[0m22:11:23.203295 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:23.213922 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup"
[0m22:11:23.216566 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_1"
[0m22:11:23.217581 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_1"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_1__dbt_backup" cascade
[0m22:11:23.278359 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:23.283391 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_1 (execute): 22:11:22.621619 => 22:11:23.282627
[0m22:11:23.284842 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_1: Close
[0m22:11:23.288107 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10594e2d0>]}
[0m22:11:23.290072 [info ] [Thread-1 (]: 7 of 18 OK created sql table model danila.outclick_cost_int_1 .................. [[32mSELECT 1[0m in 0.68s]
[0m22:11:23.292062 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_1
[0m22:11:23.293437 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:11:23.294790 [info ] [Thread-1 (]: 8 of 18 START sql table model danila.stg_campaign_names_mapping__traffic_sources  [RUN]
[0m22:11:23.296647 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_1, now model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources)
[0m22:11:23.297473 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:11:23.303330 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.304849 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (compile): 22:11:23.297978 => 22:11:23.304588
[0m22:11:23.305389 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:11:23.311350 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.313166 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.314035 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: BEGIN
[0m22:11:23.314650 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:23.638685 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:23.639997 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.640761 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select DISTINCT 
    lower(tracking_template_campaign_name) as affiliate_campaign_name, 
    traffic_source
from "deep-analysis-console"."console"."campaign_names_mapping"
  );
  
[0m22:11:23.687392 [debug] [Thread-1 (]: SQL status: SELECT 342 in 0.0 seconds
[0m22:11:23.689842 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.690141 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" rename to "stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m22:11:23.728774 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:23.731651 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.732069 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
alter table "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_tmp" rename to "stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.770511 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:23.773351 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m22:11:23.773929 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.774467 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: COMMIT
[0m22:11:23.814456 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:23.821285 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup"
[0m22:11:23.823263 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"
[0m22:11:23.824082 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources"} */
drop table if exists "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources__dbt_backup" cascade
[0m22:11:23.885712 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:23.891295 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources (execute): 22:11:23.305733 => 22:11:23.890486
[0m22:11:23.892792 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources: Close
[0m22:11:23.896005 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a3c310>]}
[0m22:11:23.897564 [info ] [Thread-1 (]: 8 of 18 OK created sql table model danila.stg_campaign_names_mapping__traffic_sources  [[32mSELECT 342[0m in 0.60s]
[0m22:11:23.899118 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources
[0m22:11:23.900339 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:11:23.901829 [info ] [Thread-1 (]: 9 of 18 START sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [RUN]
[0m22:11:23.903656 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_campaign_names_mapping__traffic_sources, now model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name)
[0m22:11:23.904654 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:11:23.911727 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:23.913427 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (compile): 22:11:23.905245 => 22:11:23.913086
[0m22:11:23.914169 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:11:23.921529 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:23.922575 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:23.923060 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: BEGIN
[0m22:11:23.923507 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:24.189430 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:24.191435 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:24.193503 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    CASE
     When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
     else 'simple'
    END as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    --"right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, country_code, campaign_vertical
  );
  
[0m22:11:30.579040 [debug] [Thread-1 (]: SQL status: SELECT 7099 in 6.0 seconds
[0m22:11:30.590637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:30.591823 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name" rename to "stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup"
[0m22:11:30.624233 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:30.635625 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:30.636857 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_tmp" rename to "stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:30.668826 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:30.676613 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m22:11:30.678104 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:30.679555 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: COMMIT
[0m22:11:30.710848 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:30.726483 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup"
[0m22:11:30.728980 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"
[0m22:11:30.730067 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__aggregated_wo_brand_name__dbt_backup" cascade
[0m22:11:30.776832 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:30.781121 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name (execute): 22:11:23.914592 => 22:11:30.780703
[0m22:11:30.781942 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name: Close
[0m22:11:30.783990 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105d02410>]}
[0m22:11:30.785363 [info ] [Thread-1 (]: 9 of 18 OK created sql table model danila.stg_matomo_actions_visits__aggregated_wo_brand_name  [[32mSELECT 7099[0m in 6.88s]
[0m22:11:30.786718 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name
[0m22:11:30.787617 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:11:30.788726 [info ] [Thread-1 (]: 10 of 18 START sql table model danila.stg_matomo_actions_visits__our_page_events  [RUN]
[0m22:11:30.790182 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__aggregated_wo_brand_name, now model.campaign_perfomance.stg_matomo_actions_visits__our_page_events)
[0m22:11:30.791021 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:11:30.849325 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:30.849982 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (compile): 22:11:30.791544 => 22:11:30.849823
[0m22:11:30.850262 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:11:30.852604 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:30.852981 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:30.853176 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: BEGIN
[0m22:11:30.853348 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:31.206572 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:31.208156 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:31.209486 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


select 
    date(timestamp - interval '2 hours') as date_cet, 
    "left"(matomo_actions.eventname::text, 2) as country_code, 
    -- CASE
    --  When right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)='sports' Then 'sports'
    --  else 'simple'
    -- END as campaign_vertical,
    'simple' as campaign_vertical,
    lower(sitename) as campaign_name, 
    campaignname as ga_campaign_name, 
    "right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3) as brand_name,
    count(matomo_actions.id) as outclicks,
    count(DISTINCT matomo_visits.visitorid) AS unique_outclicks,
    round(avg(eventvalue), 2) AS avg_list_position,
    string_agg(DISTINCT eventvalue::character varying::text, ';'::text) AS pos_list--,
    --NULL as signups, NULL as cpa_count, NULL as cpa_commissions, NULL as revshare_commissions, NULL as gtee_count,
    -- NULL as gtee_commissions, NULL as avg_deposit_amount
from "deep-analysis-console"."console"."matomo_actions" matomo_actions
left join "deep-analysis-console"."console"."matomo_visits" matomo_visits
on matomo_actions.matomo_visit_id=matomo_visits.id
where 
    matomo_actions.type = 'event' 
    AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
    and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
    and date(timestamp - interval '2 hours') >'2023-12-31'
    -- and "left"(matomo_actions.eventname::text, 2)='at'
    -- and date(timestamp - interval '2 hours')='2024-04-24'
group by campaign_name, campaignname, date_cet, brand_name, country_code, campaign_vertical
  );
  
[0m22:11:37.642630 [debug] [Thread-1 (]: SQL status: SELECT 33092 in 6.0 seconds
[0m22:11:37.655461 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:37.656709 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" rename to "stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m22:11:37.697344 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:37.701109 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:37.701579 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
alter table "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_tmp" rename to "stg_matomo_actions_visits__our_page_events"
[0m22:11:37.741144 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:37.745122 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m22:11:37.745765 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:37.746287 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: COMMIT
[0m22:11:37.813067 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:37.823641 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup"
[0m22:11:37.826167 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"
[0m22:11:37.827256 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_matomo_actions_visits__our_page_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events__dbt_backup" cascade
[0m22:11:37.884819 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:37.890211 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_matomo_actions_visits__our_page_events (execute): 22:11:30.850408 => 22:11:37.889395
[0m22:11:37.891732 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_matomo_actions_visits__our_page_events: Close
[0m22:11:37.895062 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x104d65a50>]}
[0m22:11:37.897209 [info ] [Thread-1 (]: 10 of 18 OK created sql table model danila.stg_matomo_actions_visits__our_page_events  [[32mSELECT 33092[0m in 7.11s]
[0m22:11:37.899070 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_matomo_actions_visits__our_page_events
[0m22:11:37.900306 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_record__casino_events
[0m22:11:37.901698 [info ] [Thread-1 (]: 11 of 18 START sql table model danila.stg_record__casino_events ................ [RUN]
[0m22:11:37.903707 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_matomo_actions_visits__our_page_events, now model.campaign_perfomance.stg_record__casino_events)
[0m22:11:37.904873 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_record__casino_events
[0m22:11:37.912526 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:37.914277 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (compile): 22:11:37.905567 => 22:11:37.913929
[0m22:11:37.914895 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_record__casino_events
[0m22:11:37.921362 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:37.922821 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:37.923414 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: BEGIN
[0m22:11:37.923894 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:38.304301 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:38.306538 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:38.308473 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

-- with records as (
select 
    date_parsed as date_cet, 
    records.geo as country_code,
    CASE
    When right(brand_name,6)='sports' Then 'sports'
    else 'simple'
    END as campaign_vertical,
    CASE  
        WHEN campaign_name::text = 'jpluckyslotsonline'::text THEN 'luckyslotsonline'::character varying
        WHEN campaign_name::text = 'ficashstormslots'::text THEN 'cashstormslots'::character varying
        WHEN campaign_name::text = 'goldenlion'::text THEN 'goldenliongames'::character varying
        ELSE campaign_name
    END as campaign_name, 
    lower(adgroup_name) as ga_campaign_name,
    campaign_names_mapping.traffic_source,  
    CASE
        WHEN campaign_name::text = 'email' THEN brand_name || ' email'
        WHEN campaign_name::text = 'PA' THEN brand_name || ' PA'
        ELSE brand_name
    END as brand_name, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    sum(registrations) as signups, 
    sum(cpa_count) as cpa_count, sum(cpa_commissions) AS cpa_commissions,
    coalesce(sum(total_commission-cpa_commissions) filter(where total_commission-cpa_commissions<>0 and gtee_count=0),0) AS revshare_commissions,
    sum(gtee_count) as gtee_count, 
    sum(gtee_commissions) as gtee_commissions,
    avg(deposits) FILTER(where cpa_count>0) AS avg_deposit_amount
from "deep-analysis-console"."console"."records" records
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records.adgroup_name
where date_parsed > '2023-12-31'
group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name, campaign_names_mapping.traffic_source
-- )

-- select 
--     records.*,
--     campaign_names_mapping.traffic_source
-- from records
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records.adgroup_name  --records.ga_campaign_name
-- where campaign_names_mapping.traffic_source='GoogleAds'
  );
  
[0m22:11:42.143921 [debug] [Thread-1 (]: SQL status: SELECT 115115 in 4.0 seconds
[0m22:11:42.155708 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:42.156957 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events" rename to "stg_record__casino_events__dbt_backup"
[0m22:11:42.201438 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:42.208585 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:42.209797 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
alter table "deep-analysis-console"."danila"."stg_record__casino_events__dbt_tmp" rename to "stg_record__casino_events"
[0m22:11:42.383553 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:42.390073 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m22:11:42.390847 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:42.391489 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: COMMIT
[0m22:11:42.434927 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:42.441485 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup"
[0m22:11:42.443250 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_record__casino_events"
[0m22:11:42.444231 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_record__casino_events"} */
drop table if exists "deep-analysis-console"."danila"."stg_record__casino_events__dbt_backup" cascade
[0m22:11:42.527036 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:42.532332 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_record__casino_events (execute): 22:11:37.915283 => 22:11:42.531581
[0m22:11:42.533763 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_record__casino_events: Close
[0m22:11:42.536807 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x10591a190>]}
[0m22:11:42.538279 [info ] [Thread-1 (]: 11 of 18 OK created sql table model danila.stg_record__casino_events ........... [[32mSELECT 115115[0m in 4.63s]
[0m22:11:42.539970 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_record__casino_events
[0m22:11:42.541168 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:11:42.542658 [info ] [Thread-1 (]: 12 of 18 START sql table model danila.stg_records_gam_campaign__campaign_costs . [RUN]
[0m22:11:42.544459 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_record__casino_events, now model.campaign_perfomance.stg_records_gam_campaign__campaign_costs)
[0m22:11:42.545262 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:11:42.552244 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:42.553927 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (compile): 22:11:42.545774 => 22:11:42.553495
[0m22:11:42.554565 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:11:42.564263 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:42.565430 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:42.565941 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: BEGIN
[0m22:11:42.566395 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:42.891401 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:42.892928 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:42.893715 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */

  
    

  create  table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


--with tmp as (
select 
    day as date_cet, 
    geo as country_code, 
    CASE
     When campaign_names_mapping.campaign_vertical='casino' Then 'simple'
     When campaign_names_mapping.campaign_vertical='sports' THEN 'sports'
     else 'other'
    END as campaign_vertical,
    console_campaign_name as campaign_name, 
    lower(campaign) as ga_campaign_name,
    campaign_names_mapping.traffic_source,
    sum(cost) as cost
from "deep-analysis-console"."console"."records_gap_campaigns"  records_gap_campaigns
-- left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
-- on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
left join "deep-analysis-console"."console"."campaign_names_mapping" campaign_names_mapping 
on campaign_names_mapping.gap_campaign_name=records_gap_campaigns.campaign
where 
    day >'2023-12-31' --matomo
    and campaign_names_mapping.campaign_vertical is not NULL -- exclude all the missing for the campaign vertical data
group by day, country_code, campaign_name, ga_campaign_name, campaign_vertical, campaign_names_mapping.traffic_source, campaign_names_mapping.campaign_vertical

-- select betting_type, 
-- count(*) 
-- from tmp group by betting_type
-- select camp
-- from tmp 
-- where betting_type='other' and camp is not NULL
  );
  
[0m22:11:42.973510 [debug] [Thread-1 (]: SQL status: SELECT 8067 in 0.0 seconds
[0m22:11:42.985416 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:42.986591 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" rename to "stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m22:11:43.024443 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:43.035661 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:43.036792 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
alter table "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_tmp" rename to "stg_records_gam_campaign__campaign_costs"
[0m22:11:43.074893 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:43.082822 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m22:11:43.084566 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:43.085542 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: COMMIT
[0m22:11:43.123337 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:43.133345 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup"
[0m22:11:43.135849 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"
[0m22:11:43.136896 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.stg_records_gam_campaign__campaign_costs"} */
drop table if exists "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs__dbt_backup" cascade
[0m22:11:43.192729 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:43.197146 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.stg_records_gam_campaign__campaign_costs (execute): 22:11:42.554958 => 22:11:43.196679
[0m22:11:43.198061 [debug] [Thread-1 (]: On model.campaign_perfomance.stg_records_gam_campaign__campaign_costs: Close
[0m22:11:43.200083 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105a0e390>]}
[0m22:11:43.201438 [info ] [Thread-1 (]: 12 of 18 OK created sql table model danila.stg_records_gam_campaign__campaign_costs  [[32mSELECT 8067[0m in 0.66s]
[0m22:11:43.202839 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.stg_records_gam_campaign__campaign_costs
[0m22:11:43.203759 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.test_write
[0m22:11:43.205011 [info ] [Thread-1 (]: 13 of 18 START sql table model danila.test_write ............................... [RUN]
[0m22:11:43.206383 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.stg_records_gam_campaign__campaign_costs, now model.campaign_perfomance.test_write)
[0m22:11:43.207157 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.test_write
[0m22:11:43.213715 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.test_write"
[0m22:11:43.215298 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (compile): 22:11:43.207721 => 22:11:43.214980
[0m22:11:43.216136 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.test_write
[0m22:11:43.223866 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.test_write"
[0m22:11:43.225245 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.225808 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: BEGIN
[0m22:11:43.226257 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:43.482463 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:43.484426 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.485837 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */

  
    

  create  table "deep-analysis-console"."danila"."test_write__dbt_tmp"
  
  
    as
  
  (
    -- models/test_write.sql


select 1 as danila
  );
  
[0m22:11:43.520498 [debug] [Thread-1 (]: SQL status: SELECT 1 in 0.0 seconds
[0m22:11:43.531345 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.532551 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write" rename to "test_write__dbt_backup"
[0m22:11:43.564423 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:43.572095 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.572929 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
alter table "deep-analysis-console"."danila"."test_write__dbt_tmp" rename to "test_write"
[0m22:11:43.605413 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:43.609857 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m22:11:43.610552 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.611087 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: COMMIT
[0m22:11:43.642287 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:43.647470 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."test_write__dbt_backup"
[0m22:11:43.648894 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.test_write"
[0m22:11:43.649476 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.test_write"} */
drop table if exists "deep-analysis-console"."danila"."test_write__dbt_backup" cascade
[0m22:11:43.697927 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:43.703852 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.test_write (execute): 22:11:43.216706 => 22:11:43.703065
[0m22:11:43.705363 [debug] [Thread-1 (]: On model.campaign_perfomance.test_write: Close
[0m22:11:43.708034 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cbccd0>]}
[0m22:11:43.709436 [info ] [Thread-1 (]: 13 of 18 OK created sql table model danila.test_write .......................... [[32mSELECT 1[0m in 0.50s]
[0m22:11:43.710900 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.test_write
[0m22:11:43.712066 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclicks_fct
[0m22:11:43.713600 [info ] [Thread-1 (]: 14 of 18 START sql table model danila.outclicks_fct ............................ [RUN]
[0m22:11:43.715032 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.test_write, now model.campaign_perfomance.outclicks_fct)
[0m22:11:43.715819 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclicks_fct
[0m22:11:43.721882 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclicks_fct"
[0m22:11:43.723447 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (compile): 22:11:43.716363 => 22:11:43.723125
[0m22:11:43.724056 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclicks_fct
[0m22:11:43.730887 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclicks_fct"
[0m22:11:43.732236 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:43.732746 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: BEGIN
[0m22:11:43.733193 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:44.010642 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:44.011041 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:44.011355 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */

  
    

  create  table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp"
  
  
    as
  
  (
    -- -- models/test_write.sql


WITH outclicks AS (
    SELECT * FROM "deep-analysis-console"."console"."postbacks_outgoing"
),
deals AS (
    SELECT * FROM "deep-analysis-console"."danila"."deals_dim"
)

select 
    outclicks.id as outclick_id,
    outclicks.timestamp as created_at_cet, 
    outclicks.user_id, 
    outclicks.deal_id,
    outclicks.adclickid as ad_click_id,
    outclicks.money_page_name as moneypage_template_id, 
    outclicks.provider_id as affiliated_account_id,
    --site_id ??
    outclicks.geo as geo_id,
    deals.ga_campaign_id as ga_campaign_id
from outclicks
left join deals
on outclicks.deal_id = deals.id



where timestamp>'2024-04-01'
  );
  
[0m22:11:44.503587 [debug] [Thread-1 (]: SQL status: SELECT 55526 in 0.0 seconds
[0m22:11:44.517115 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:44.518404 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct" rename to "outclicks_fct__dbt_backup"
[0m22:11:44.553225 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:44.571171 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:44.572375 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
alter table "deep-analysis-console"."danila"."outclicks_fct__dbt_tmp" rename to "outclicks_fct"
[0m22:11:44.607885 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:44.615689 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m22:11:44.617101 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:44.618415 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: COMMIT
[0m22:11:44.652286 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:44.662445 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclicks_fct__dbt_backup"
[0m22:11:44.665077 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclicks_fct"
[0m22:11:44.666101 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclicks_fct"} */
drop table if exists "deep-analysis-console"."danila"."outclicks_fct__dbt_backup" cascade
[0m22:11:44.717921 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:44.722933 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclicks_fct (execute): 22:11:43.724457 => 22:11:44.722153
[0m22:11:44.724414 [debug] [Thread-1 (]: On model.campaign_perfomance.outclicks_fct: Close
[0m22:11:44.727726 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c64390>]}
[0m22:11:44.729780 [info ] [Thread-1 (]: 14 of 18 OK created sql table model danila.outclicks_fct ....................... [[32mSELECT 55526[0m in 1.01s]
[0m22:11:44.731710 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclicks_fct
[0m22:11:44.732858 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.my_second_dbt_model
[0m22:11:44.734388 [info ] [Thread-1 (]: 15 of 18 START sql view model danila.my_second_dbt_model ....................... [RUN]
[0m22:11:44.736151 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclicks_fct, now model.campaign_perfomance.my_second_dbt_model)
[0m22:11:44.737254 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.my_second_dbt_model
[0m22:11:44.743881 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:44.745445 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (compile): 22:11:44.737936 => 22:11:44.745120
[0m22:11:44.746043 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.my_second_dbt_model
[0m22:11:44.765999 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:44.766583 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:44.766762 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: BEGIN
[0m22:11:44.766925 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:45.119750 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:45.122135 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:45.123695 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */

  create view "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp"
    
    
  as (
    -- Use the `ref` function to select from other models

select *
from "deep-analysis-console"."danila"."my_first_dbt_model"
where id = 1
  );
[0m22:11:45.171141 [debug] [Thread-1 (]: SQL status: CREATE VIEW in 0.0 seconds
[0m22:11:45.178029 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:45.178722 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
alter table "deep-analysis-console"."danila"."my_second_dbt_model__dbt_tmp" rename to "my_second_dbt_model"
[0m22:11:45.222363 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:45.229867 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m22:11:45.231339 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:45.232682 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: COMMIT
[0m22:11:45.276542 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:45.285036 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup"
[0m22:11:45.293373 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.my_second_dbt_model"
[0m22:11:45.294178 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.my_second_dbt_model"} */
drop view if exists "deep-analysis-console"."danila"."my_second_dbt_model__dbt_backup" cascade
[0m22:11:45.338485 [debug] [Thread-1 (]: SQL status: DROP VIEW in 0.0 seconds
[0m22:11:45.343359 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.my_second_dbt_model (execute): 22:11:44.746429 => 22:11:45.342608
[0m22:11:45.345003 [debug] [Thread-1 (]: On model.campaign_perfomance.my_second_dbt_model: Close
[0m22:11:45.347618 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105c22cd0>]}
[0m22:11:45.349220 [info ] [Thread-1 (]: 15 of 18 OK created sql view model danila.my_second_dbt_model .................. [[32mCREATE VIEW[0m in 0.61s]
[0m22:11:45.350771 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.my_second_dbt_model
[0m22:11:45.351952 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:11:45.353277 [info ] [Thread-1 (]: 16 of 18 START sql table model danila.outclick_by_brand_int_new ................ [RUN]
[0m22:11:45.354654 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.my_second_dbt_model, now model.campaign_perfomance.outclick_by_brand_int_new)
[0m22:11:45.355558 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:11:45.361986 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:45.363448 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (compile): 22:11:45.356063 => 22:11:45.363178
[0m22:11:45.363987 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:11:45.370713 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:45.371855 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:45.372364 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: BEGIN
[0m22:11:45.372819 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:45.737034 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:45.739423 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:45.741446 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql

with main as (


(
    select 
        actions.date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name,
        traffic_source, 
        brand_name,
        campaign_vertical,
        outclicks,
        unique_outclicks,
        avg_list_position,
        pos_list,
        NULL as signups, 
        NULL as cpa_count, 
        NULL AS cpa_commissions,
        NULL AS revshare_commissions,
        NULL as gtee_count, 
        NULL as gtee_commissions,
        NULL AS avg_deposit_amount
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
)
union all
(
select 
    date_cet, 
    country_code, 
    campaign_name, 
    ga_campaign_name, 
    traffic_source,
    brand_name,
    campaign_vertical, 
    NULL as outclicks, 
    NULL as unique_outclicks, 
    NULL as avg_list_position, 
    NULL as pos_list,
    signups, 
    cpa_count, 
    cpa_commissions,
    revshare_commissions,
    gtee_count, 
    gtee_commissions,
    avg_deposit_amount
from "deep-analysis-console"."danila"."stg_record__casino_events" records
-- where right(brand_name,6)<>'sports'
--     and date_parsed > '2023-12-31'
--[[ and date_parsed in ( select date_parsed from calendar where  ) ]]
-- [[ and geo in (select distinct geo from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and campaign_name in ( select distinct console_campaign_name from campaign_names_mapping WHERE ) ]]
-- [[ and  ]]
--group by date_parsed, country_code, campaign_name, ga_campaign_name, brand_name
)
)
select * 
from main 
--where  country_code='at' and date_cet='2024-04-24'

-- select country_code, sum(outclicks)
-- from danila.outclick_by_brand_int_new
-- where country_code='at'
-- and date_cet='2024-04-24'
-- group by country_code
  );
  
[0m22:11:46.039881 [debug] [Thread-1 (]: SQL status: SELECT 148207 in 0.0 seconds
[0m22:11:46.052835 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:46.053981 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new" rename to "outclick_by_brand_int_new__dbt_backup"
[0m22:11:46.099590 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:46.109548 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:46.110617 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_tmp" rename to "outclick_by_brand_int_new"
[0m22:11:46.155391 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:46.160871 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m22:11:46.161637 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:46.162310 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: COMMIT
[0m22:11:46.207324 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:46.217531 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup"
[0m22:11:46.220687 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_by_brand_int_new"
[0m22:11:46.221911 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_by_brand_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_by_brand_int_new__dbt_backup" cascade
[0m22:11:46.288485 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:46.293508 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_by_brand_int_new (execute): 22:11:45.364338 => 22:11:46.292747
[0m22:11:46.295342 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_by_brand_int_new: Close
[0m22:11:46.297764 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105b3da10>]}
[0m22:11:46.299256 [info ] [Thread-1 (]: 16 of 18 OK created sql table model danila.outclick_by_brand_int_new ........... [[32mSELECT 148207[0m in 0.94s]
[0m22:11:46.300713 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_by_brand_int_new
[0m22:11:46.301810 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.outclick_cost_int_new
[0m22:11:46.303012 [info ] [Thread-1 (]: 17 of 18 START sql table model danila.outclick_cost_int_new .................... [RUN]
[0m22:11:46.304486 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_by_brand_int_new, now model.campaign_perfomance.outclick_cost_int_new)
[0m22:11:46.305281 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.outclick_cost_int_new
[0m22:11:46.312529 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.314156 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (compile): 22:11:46.305767 => 22:11:46.313839
[0m22:11:46.314739 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.outclick_cost_int_new
[0m22:11:46.324747 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.325808 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.326282 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: BEGIN
[0m22:11:46.326721 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:46.632386 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:46.634463 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.636627 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */

  
    

  create  table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


(
    select 
        date_cet, 
        country_code, 
        campaign_name, 
        ga_campaign_name, 
        brand_name,
        unique_outclicks,
        campaign_vertical,
        sources.traffic_source,
        NULL as cost
    from "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" actions
    left join "deep-analysis-console"."danila"."stg_campaign_names_mapping__traffic_sources" sources
    on actions.ga_campaign_name=sources.affiliate_campaign_name
    --where  
        --matomo_actions.type = 'event' 
        --AND matomo_actions.subtitle = 'Category: "OutClicks, Action: "Click on casino banner"'
        --and right("right"(matomo_actions.eventname::text, length(matomo_actions.eventname::text) - 3),6)<>'sports'
        --[[ and parse_matomo_timestamp(timestamp) in ( select date_parsed from calendar where  ) ]]
        --[[ and "left"(matomo_actions.eventname::text, 2) in ( select distinct geo from campaign_names_mapping WHERE  ) ]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
        --[[ and lower(sitename) in ( select distinct console_campaign_name from campaign_names_mapping WHERE )]]
    --group by campaign_name, ga_campaign_name, date_cet, brand_name, country_code, traffic_source
)
/*GAP campaigns aggregated data from records_gap_campaigns table*/
union all
(    select 
        date_cet,
        country_code, 
        campaign_name, 
        ga_campaign_name,
        NULL as brand_name, 
        NULL as unique_outclicks, 
        campaign_vertical,
        traffic_source,
        cost
    from "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs"
--    group by date_cet, country_code, campaign_name, ga_campaign_name, brand_name, unique_outclicks, betting_type, traffic_source
)

-- SELECT 
--     COALESCE(matomo.date_cet, cost.date_cet) as date_cet,
--     COALESCE(matomo.country_code, cost.country_code) as country_code,
--     COALESCE(matomo.betting_type, cost.betting_type) as betting_type,
--     COALESCE(matomo.campaign_name, cost.campaign_name) as campaign_name,
--     COALESCE(matomo.ga_campaign_name, cost.ga_campaign_name) as ga_campaign_name,
--     matomo.brand_name,
--     matomo.unique_outclicks,
--     cost.cost
-- FROM "deep-analysis-console"."danila"."stg_matomo_actions_visits__our_page_events" matomo
-- FULL OUTER JOIN "deep-analysis-console"."danila"."stg_records_gam_campaign__campaign_costs" cost
-- on matomo.date_cet = cost.date_cet
--     AND matomo.country_code = cost.country_code
--     and matomo.betting_type=cost.betting_type
--     AND matomo.campaign_name = cost.campaign_name
--     AND matomo.ga_campaign_name = cost.ga_campaign_name

-- where COALESCE(matomo.country_code, cost.country_code)='de'
--     and COALESCE(matomo.date_cet, cost.date_cet)='2024-04-23'
--     and COALESCE(matomo.betting_type, cost.betting_type)='simple'
--     and COALESCE(matomo.brand_name, cost.brand_name)='ninecas'
-- order by campaign_name, ga_campaign_name
  );
  
[0m22:11:46.729616 [debug] [Thread-1 (]: SQL status: SELECT 41159 in 0.0 seconds
[0m22:11:46.743117 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.744313 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new" rename to "outclick_cost_int_new__dbt_backup"
[0m22:11:46.782481 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:46.793479 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.794911 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
alter table "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_tmp" rename to "outclick_cost_int_new"
[0m22:11:46.833000 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:46.841221 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m22:11:46.842311 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.843295 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: COMMIT
[0m22:11:46.880995 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:46.890866 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup"
[0m22:11:46.894353 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.outclick_cost_int_new"
[0m22:11:46.895738 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.outclick_cost_int_new"} */
drop table if exists "deep-analysis-console"."danila"."outclick_cost_int_new__dbt_backup" cascade
[0m22:11:46.956348 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:46.961472 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.outclick_cost_int_new (execute): 22:11:46.315242 => 22:11:46.960710
[0m22:11:46.962884 [debug] [Thread-1 (]: On model.campaign_perfomance.outclick_cost_int_new: Close
[0m22:11:46.965968 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105984cd0>]}
[0m22:11:46.967747 [info ] [Thread-1 (]: 17 of 18 OK created sql table model danila.outclick_cost_int_new ............... [[32mSELECT 41159[0m in 0.66s]
[0m22:11:46.969249 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.outclick_cost_int_new
[0m22:11:46.970366 [debug] [Thread-1 (]: Began running node model.campaign_perfomance.brand_comparison_fi
[0m22:11:46.971614 [info ] [Thread-1 (]: 18 of 18 START sql table model danila.brand_comparison_fi ...................... [RUN]
[0m22:11:46.973376 [debug] [Thread-1 (]: Re-using an available connection from the pool (formerly model.campaign_perfomance.outclick_cost_int_new, now model.campaign_perfomance.brand_comparison_fi)
[0m22:11:46.974381 [debug] [Thread-1 (]: Began compiling node model.campaign_perfomance.brand_comparison_fi
[0m22:11:46.980922 [debug] [Thread-1 (]: Writing injected SQL for node "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:46.982544 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (compile): 22:11:46.974990 => 22:11:46.982227
[0m22:11:46.983109 [debug] [Thread-1 (]: Began executing node model.campaign_perfomance.brand_comparison_fi
[0m22:11:46.990254 [debug] [Thread-1 (]: Writing runtime sql for node "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:46.991666 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:46.992249 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: BEGIN
[0m22:11:46.992729 [debug] [Thread-1 (]: Opening a new connection, currently in state closed
[0m22:11:47.468580 [debug] [Thread-1 (]: SQL status: BEGIN in 0.0 seconds
[0m22:11:47.470738 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:47.472327 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */

  
    

  create  table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp"
  
  
    as
  
  (
    -- models/campaign_level_data.sql


WITH agg_outclicks AS (
    -- Assuming `outclicks_fct` needs to join with `deals_dim` to get `ga_campaign_id`
    SELECT
        date(created_at_cet) as date,
        ga_campaign_id,
        count(*) as total_outclicks
    FROM "deep-analysis-console"."danila"."outclicks_fct"
    GROUP BY 1, 2
),

combined_campaign_data AS (
    -- Then, merge this data with the daily_campaign_fct
    SELECT
        co.date,
        co.ga_campaign_id,
        co.total_outclicks,
        dc.clicks,
        dc.ad_costs,
        dc.budget
    FROM agg_outclicks co
    LEFT JOIN "deep-analysis-console"."danila"."daily_campaign_fct" dc 
    ON co.ga_campaign_id = dc.ga_campaign_id 
        AND co.date = dc.date
)

SELECT
    date,
    ga_campaign_id,
    total_outclicks,
    clicks,
    ad_costs,
    budget
FROM combined_campaign_data
ORDER BY date, ga_campaign_id
  );
  
[0m22:11:47.552086 [debug] [Thread-1 (]: SQL status: SELECT 64 in 0.0 seconds
[0m22:11:47.565535 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:47.566762 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi" rename to "brand_comparison_fi__dbt_backup"
[0m22:11:47.606847 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:47.614287 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:47.615550 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
alter table "deep-analysis-console"."danila"."brand_comparison_fi__dbt_tmp" rename to "brand_comparison_fi"
[0m22:11:47.656654 [debug] [Thread-1 (]: SQL status: ALTER TABLE in 0.0 seconds
[0m22:11:47.664846 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m22:11:47.665931 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:47.666944 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: COMMIT
[0m22:11:47.707139 [debug] [Thread-1 (]: SQL status: COMMIT in 0.0 seconds
[0m22:11:47.716016 [debug] [Thread-1 (]: Applying DROP to: "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup"
[0m22:11:47.717898 [debug] [Thread-1 (]: Using postgres connection "model.campaign_perfomance.brand_comparison_fi"
[0m22:11:47.718721 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: /* {"app": "dbt", "dbt_version": "1.7.0", "profile_name": "piter", "target_name": "dev", "node_id": "model.campaign_perfomance.brand_comparison_fi"} */
drop table if exists "deep-analysis-console"."danila"."brand_comparison_fi__dbt_backup" cascade
[0m22:11:47.777288 [debug] [Thread-1 (]: SQL status: DROP TABLE in 0.0 seconds
[0m22:11:47.780090 [debug] [Thread-1 (]: Timing info for model.campaign_perfomance.brand_comparison_fi (execute): 22:11:46.983472 => 22:11:47.779788
[0m22:11:47.780733 [debug] [Thread-1 (]: On model.campaign_perfomance.brand_comparison_fi: Close
[0m22:11:47.782377 [debug] [Thread-1 (]: Sending event: {'category': 'dbt', 'action': 'run_model', 'label': 'c67e9dce-081b-4155-80f8-1a6b1a9be125', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x105cf8310>]}
[0m22:11:47.783292 [info ] [Thread-1 (]: 18 of 18 OK created sql table model danila.brand_comparison_fi ................. [[32mSELECT 64[0m in 0.81s]
[0m22:11:47.784094 [debug] [Thread-1 (]: Finished running node model.campaign_perfomance.brand_comparison_fi
[0m22:11:47.785887 [debug] [MainThread]: Using postgres connection "master"
[0m22:11:47.786481 [debug] [MainThread]: On master: BEGIN
[0m22:11:47.786980 [debug] [MainThread]: Opening a new connection, currently in state closed
[0m22:11:48.087995 [debug] [MainThread]: SQL status: BEGIN in 0.0 seconds
[0m22:11:48.089801 [debug] [MainThread]: On master: COMMIT
[0m22:11:48.091044 [debug] [MainThread]: Using postgres connection "master"
[0m22:11:48.091817 [debug] [MainThread]: On master: COMMIT
[0m22:11:48.128937 [debug] [MainThread]: SQL status: COMMIT in 0.0 seconds
[0m22:11:48.129748 [debug] [MainThread]: On master: Close
[0m22:11:48.131638 [debug] [MainThread]: Connection 'master' was properly closed.
[0m22:11:48.132234 [debug] [MainThread]: Connection 'model.campaign_perfomance.brand_comparison_fi' was properly closed.
[0m22:11:48.132890 [info ] [MainThread]: 
[0m22:11:48.133455 [info ] [MainThread]: Finished running 17 table models, 1 view model in 0 hours 1 minutes and 4.19 seconds (64.19s).
[0m22:11:48.137226 [debug] [MainThread]: Command end result
[0m22:11:48.154535 [info ] [MainThread]: 
[0m22:11:48.155168 [info ] [MainThread]: [32mCompleted successfully[0m
[0m22:11:48.155533 [info ] [MainThread]: 
[0m22:11:48.155903 [info ] [MainThread]: Done. PASS=18 WARN=0 ERROR=0 SKIP=0 TOTAL=18
[0m22:11:48.158548 [debug] [MainThread]: Resource report: {"command_name": "run", "command_success": true, "command_wall_clock_time": 64.37229, "process_user_time": 2.610787, "process_kernel_time": 0.232115, "process_mem_max_rss": "125534208", "process_in_blocks": "0", "process_out_blocks": "0"}
[0m22:11:48.159235 [debug] [MainThread]: Command `dbt run` succeeded at 22:11:48.159096 after 64.37 seconds
[0m22:11:48.159925 [debug] [MainThread]: Sending event: {'category': 'dbt', 'action': 'invocation', 'label': 'end', 'context': [<snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100cddf50>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100c18850>, <snowplow_tracker.self_describing_json.SelfDescribingJson object at 0x100c541d0>]}
[0m22:11:48.160423 [debug] [MainThread]: Flushing usage events
